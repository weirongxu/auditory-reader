(()=>{"use strict";var e,t,i,n,a,r,o={4150(e,t,i){i.d(t,{j:()=>f,s:()=>j});var n=i(9511),a=i(5129),r=i(547),o=i(1454),s=i(5555),l=i.n(s),c=i(9001),d=i.n(c),h=i(8825),u=i(5157);function*p(e,t,i){let[n,...a]=t;if(!n){if(i)for(let t of e.querySelectorAll(i))yield t;else yield e;return}for(let t of e.children)("*"===n||t.tagName.toLowerCase()===n.toLowerCase())&&(yield*p(t,a,i))}let f='nav[epub\\:type="toc"]';var g=new WeakMap,m=new WeakMap,v=new WeakMap,y=new WeakMap,x=new WeakMap,w=new WeakMap,k=new WeakMap,b=new WeakMap;class j{static async getRootPath(e){var t;let i=await e.htmlDom("META-INF/container.xml");if(!i)return void console.error("Parse META-INF/container.xml error");let n=null==(t=i.querySelector("rootfile"))?void 0:t.getAttribute("full-path");return n?l().join("/",n):void console.error("rootfile full-path not found")}static async read(e){let t=await d().loadAsync(e),i=new u.PD(t),n=await this.getRootPath(i);if(!n)return void console.error(`epub root-path(${n}) not found`);let a=await i.xmlDom(n);return a?new j(t,i,a,l().dirname(n)):void console.error("epub root document not found")}get version(){if(!(0,n._)(this,g)){let e=this.rootPkg.getAttribute("version")??"2.0";(0,r._)(this,g,parseFloat(e)>=3?3:2)}return(0,n._)(this,g)}get title(){if(!(0,n._)(this,m)){var e,t;let i=null==(e=this.rootPkg.findDescendant("metadata"))?void 0:e.findDescendant("dc:title");(0,r._)(this,m,(null==i||null==(t=i.text())?void 0:t.trim())??null)}return(0,n._)(this,m)}get language(){if(!(0,n._)(this,v)){var e,t;let i=null==(e=this.rootPkg.findDescendant("metadata"))?void 0:e.findDescendant("dc:language");(0,r._)(this,v,(null==i||null==(t=i.text())?void 0:t.trim())??null)}return(0,n._)(this,v)}get manifestItems(){if(!(0,n._)(this,y)){var e;let t=(null==(e=this.rootPkg.findDescendant("manifest"))?void 0:e.childrenFilter("item"))??[];(0,r._)(this,y,t.map(e=>({id:e.getAttribute("id"),href:l().join(this.rootDir,e.getAttribute("href")),mediaType:e.getAttribute("media-type"),properties:e.getAttribute("properties")??void 0})))}return(0,n._)(this,y)}get spine(){if(!(0,n._)(this,x)&&((0,r._)(this,x,this.rootPkg.findDescendant("spine")??void 0),!(0,n._)(this,x)))throw Error("spine not found");return(0,n._)(this,x)}get spineItems(){return(0,n._)(this,w)||(0,r._)(this,w,(0,h.oE)([...this.spine.childrenFilter("itemref")].map(e=>{let t=e.getAttribute("idref"),i=this.manifestItems.find(e=>e.id===t);if(i)return{manifest:i,idref:t,linear:e.getAttribute("linear")}}))),(0,n._)(this,w)}get spines(){return(0,n._)(this,k)||(0,r._)(this,k,this.spineItems.map(e=>({href:e.manifest.href,id:e.idref}))),(0,n._)(this,k)}async file(e){let t=await this.xmlLoader.file(e);if(!t)return;let i=await t.arrayBuffer(),n=e.startsWith("/")?e:`/${e}`,a=this.manifestItems.find(e=>e.href==n);return{buffer:i,mediaType:null==a?void 0:a.mediaType}}async cover(){var e;let t=null==(e=this.rootPkg.findDescendant("metadata"))?void 0:e.findDescendants("meta").find(e=>"cover"===e.getAttribute("name"));if(!t)return;let i=t.getAttribute("content");if(!i)return;let n=this.manifestItems.find(e=>e.id===i);if(!(null==n?void 0:n.href))return;let a=await this.xmlLoader.file(n.href);if(a)return{buffer:await a.arrayBuffer(),mediaType:n.mediaType}}async content(e){return this.xmlLoader.content(e)}async xmlDom(e){return this.xmlLoader.xmlDom(e)}async htmlDom(e){return this.xmlLoader.htmlDom(e)}dirBySpineIndex(e){let t=this.spineItems[e];if(t)return l().dirname(t.manifest.href)}getSpineIndexByHref(e){let t=this.spineItems.findIndex(t=>t.manifest.href===e);if(-1!==t)return t}async loadNav3(){let e=this.manifestItems.find(e=>"nav"===e.properties);if(!e)return this.loadNav2();let t=await this.htmlDom(e.href),i=l().dirname(e.href);if(!t)return[];let n=t.querySelector(`${f}>ol`);return n?this.parseNav3(n,i):[]}parseNav3(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return(0,h.oE)(Array.from(p(e,["li"])).map(e=>{let n,a,r,o,s=Array.from(e.children).find(e=>"ol"!==e.tagName.toLowerCase());if(!s)return;let c=s.textContent??"";if("a"===s.tagName.toLowerCase()){let e=s.getAttribute("href");e&&(n=l().join(t,e),[a,r]=n.split("#",2),a&&(o=this.getSpineIndexByHref(a)))}let d=p(e,["ol"],void 0).next().value??null;return{level:i,label:c,href:n,hrefBase:a,hrefAnchor:r,spineIndex:o,children:d?this.parseNav3(d,t,i+1):[]}}))}async loadNav2(){let e=this.spine.getAttribute("toc")??"ncx",t=this.manifestItems.find(t=>t.id===e);if(!t)return[];let i=await this.xmlDom(t.href),n=l().dirname(t.href);if(!i)return[];let a=i.findDescendant("navMap");return a?this.parseNav2(a,n):[]}parseNav2(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return(0,h.oE)(e.childrenFilter("navPoint").map(e=>{var n,a,r;let o,s,c,d,h=null==(a=e.findChild("navLabel"))||null==(n=a.findChild("text"))?void 0:n.text();if(!h)return;let u=null==(r=e.findChild("content"))?void 0:r.getAttribute("src");return u&&(o=l().join(t,u),[s,c]=o.split("#",2),s&&(d=this.getSpineIndexByHref(s))),{level:i,label:h,href:o,hrefBase:s,hrefAnchor:c,spineIndex:d,children:this.parseNav2(e,t,i+1)}}))}async navs(){return(0,n._)(this,b)||(this.version>=3?(0,r._)(this,b,await this.loadNav3()):(0,r._)(this,b,await this.loadNav2())),(0,n._)(this,b)}constructor(e,t,i,n){(0,o._)(this,"zip",void 0),(0,o._)(this,"xmlLoader",void 0),(0,o._)(this,"rootPkg",void 0),(0,o._)(this,"rootDir",void 0),(0,a._)(this,g,{writable:!0,value:void 0}),(0,a._)(this,m,{writable:!0,value:void 0}),(0,a._)(this,v,{writable:!0,value:void 0}),(0,a._)(this,y,{writable:!0,value:void 0}),(0,a._)(this,x,{writable:!0,value:void 0}),(0,a._)(this,w,{writable:!0,value:void 0}),(0,a._)(this,k,{writable:!0,value:void 0}),(0,a._)(this,b,{writable:!0,value:void 0}),this.zip=e,this.xmlLoader=t,this.rootPkg=i,this.rootDir=n}}},6026(e,t,i){i.d(t,{Gi:()=>f,JB:()=>n,JQ:()=>r,Mo:()=>u,R8:()=>d,Xd:()=>g,ZG:()=>c,aK:()=>p,b_:()=>l,if:()=>s,kG:()=>a,lS:()=>h,xm:()=>o});let n="auditory-reader",a="__para_box__",r="__para_ignore__",o="__para_active__",s="__para_annotation__",l="__root_annotation_highlight__",c="__root_keyword_highlight__",d="__root_utterer_highlight__",h="__img_max_width__",u="__img_max_height__",p="__color_scheme_dark__",f="__column_break__",g={妳:{word:"乃",pinyin:"naǐ"},她:{word:"伊",pinyin:"yī"},它:{word:"牠",pinyin:"tu\xf3"}}},5165(e,t,i){i.d(t,{X:()=>l,r:()=>c});var n=i(2895),a=i(529),r=i(4362),o=i(4533),s=i(6026);async function l(e,t,i){let n=(0,r.dF)(e).map(e=>`<p>${e}</p>`).join("\r\n");n=e.replace(/<p>/g,'<p class="para">').replace(/<h1>/g,'<h1 class="heading">');let a=`
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="UTF-8">
    <title>${t}</title>
  </head>
  <body>
    ${n}
  </body>
  </html>
  `;return await c(a,i)}async function c(e,t,i){let r=(0,a.Ph)(e),l=await (0,a._0)(r.doc),c=(0,n.A)(),d=new Date;return await new o.n({title:r.doc.title,date:d,htmlContent:l,lang:t,publisher:s.JB,sourceURL:i,uuid:c}).gen()}},254(e,t,i){i.d(t,{R_:()=>s,fB:()=>l});var n=i(758),a=i(8825);let r=[{code:"ab",name:"Abkhazian"},{code:"aa",name:"Afar"},{code:"af",name:"Afrikaans"},{code:"ak",name:"Akan"},{code:"sq",name:"Albanian"},{code:"am",name:"Amharic"},{code:"ar",name:"Arabic"},{code:"an",name:"Aragonese"},{code:"hy",name:"Armenian"},{code:"as",name:"Assamese"},{code:"av",name:"Avaric"},{code:"ae",name:"Avestan"},{code:"ay",name:"Aymara"},{code:"az",name:"Azerbaijani"},{code:"bm",name:"Bambara"},{code:"ba",name:"Bashkir"},{code:"eu",name:"Basque"},{code:"be",name:"Belarusian"},{code:"bn",name:"Bengali (Bangla)"},{code:"bh",name:"Bihari"},{code:"bi",name:"Bislama"},{code:"bs",name:"Bosnian"},{code:"br",name:"Breton"},{code:"bg",name:"Bulgarian"},{code:"my",name:"Burmese"},{code:"ca",name:"Catalan"},{code:"ch",name:"Chamorro"},{code:"ce",name:"Chechen"},{code:"ny",name:"Chichewa, Chewa, Nyanja"},{code:"zh",name:"Chinese"},{code:"cv",name:"Chuvash"},{code:"kw",name:"Cornish"},{code:"co",name:"Corsican"},{code:"cr",name:"Cree"},{code:"hr",name:"Croatian"},{code:"cs",name:"Czech"},{code:"da",name:"Danish"},{code:"dv",name:"Divehi, Dhivehi, Maldivian"},{code:"nl",name:"Dutch"},{code:"dz",name:"Dzongkha"},{code:"en",name:"English"},{code:"eo",name:"Esperanto"},{code:"et",name:"Estonian"},{code:"ee",name:"Ewe"},{code:"fo",name:"Faroese"},{code:"fj",name:"Fijian"},{code:"fi",name:"Finnish"},{code:"fr",name:"French"},{code:"ff",name:"Fula, Fulah, Pulaar, Pular"},{code:"gl",name:"Galician"},{code:"gd",name:"Gaelic (Scottish)"},{code:"gv",name:"Gaelic (Manx)"},{code:"ka",name:"Georgian"},{code:"de",name:"German"},{code:"el",name:"Greek"},{code:"kl",name:"Greenlandic"},{code:"gn",name:"Guarani"},{code:"gu",name:"Gujarati"},{code:"ht",name:"Haitian Creole"},{code:"ha",name:"Hausa"},{code:"he",name:"Hebrew"},{code:"hz",name:"Herero"},{code:"hi",name:"Hindi"},{code:"ho",name:"Hiri Motu"},{code:"hu",name:"Hungarian"},{code:"is",name:"Icelandic"},{code:"io",name:"Ido"},{code:"ig",name:"Igbo"},{code:"id, in",name:"Indonesian"},{code:"ia",name:"Interlingua"},{code:"ie",name:"Interlingue"},{code:"iu",name:"Inuktitut"},{code:"ik",name:"Inupiak"},{code:"ga",name:"Irish"},{code:"it",name:"Italian"},{code:"ja",name:"Japanese"},{code:"jv",name:"Javanese"},{code:"kl",name:"Kalaallisut, Greenlandic"},{code:"kn",name:"Kannada"},{code:"kr",name:"Kanuri"},{code:"ks",name:"Kashmiri"},{code:"kk",name:"Kazakh"},{code:"km",name:"Khmer"},{code:"ki",name:"Kikuyu"},{code:"rw",name:"Kinyarwanda (Rwanda)"},{code:"rn",name:"Kirundi"},{code:"ky",name:"Kyrgyz"},{code:"kv",name:"Komi"},{code:"kg",name:"Kongo"},{code:"ko",name:"Korean"},{code:"ku",name:"Kurdish"},{code:"kj",name:"Kwanyama"},{code:"lo",name:"Lao"},{code:"la",name:"Latin"},{code:"lv",name:"Latvian (Lettish)"},{code:"li",name:"Limburgish ( Limburger)"},{code:"ln",name:"Lingala"},{code:"lt",name:"Lithuanian"},{code:"lu",name:"Luga-Katanga"},{code:"lg",name:"Luganda, Ganda"},{code:"lb",name:"Luxembourgish"},{code:"gv",name:"Manx"},{code:"mk",name:"Macedonian"},{code:"mg",name:"Malagasy"},{code:"ms",name:"Malay"},{code:"ml",name:"Malayalam"},{code:"mt",name:"Maltese"},{code:"mi",name:"Maori"},{code:"mr",name:"Marathi"},{code:"mh",name:"Marshallese"},{code:"mo",name:"Moldavian"},{code:"mn",name:"Mongolian"},{code:"na",name:"Nauru"},{code:"nv",name:"Navajo"},{code:"ng",name:"Ndonga"},{code:"nd",name:"Northern Ndebele"},{code:"ne",name:"Nepali"},{code:"no",name:"Norwegian"},{code:"nb",name:"Norwegian bokm\xe5l"},{code:"nn",name:"Norwegian nynorsk"},{code:"ii",name:"Nuosu"},{code:"oc",name:"Occitan"},{code:"oj",name:"Ojibwe"},{code:"cu",name:"Old Church Slavonic, Old Bulgarian"},{code:"or",name:"Oriya"},{code:"om",name:"Oromo (Afaan Oromo)"},{code:"os",name:"Ossetian"},{code:"pi",name:"Pāli"},{code:"ps",name:"Pashto, Pushto"},{code:"fa",name:"Persian (Farsi)"},{code:"pl",name:"Polish"},{code:"pt",name:"Portuguese"},{code:"pa",name:"Punjabi (Eastern)"},{code:"qu",name:"Quechua"},{code:"rm",name:"Romansh"},{code:"ro",name:"Romanian"},{code:"ru",name:"Russian"},{code:"se",name:"Sami"},{code:"sm",name:"Samoan"},{code:"sg",name:"Sango"},{code:"sa",name:"Sanskrit"},{code:"sr",name:"Serbian"},{code:"sh",name:"Serbo-Croatian"},{code:"st",name:"Sesotho"},{code:"tn",name:"Setswana"},{code:"sn",name:"Shona"},{code:"ii",name:"Sichuan Yi"},{code:"sd",name:"Sindhi"},{code:"si",name:"Sinhalese"},{code:"ss",name:"Siswati"},{code:"sk",name:"Slovak"},{code:"sl",name:"Slovenian"},{code:"so",name:"Somali"},{code:"nr",name:"Southern Ndebele"},{code:"es",name:"Spanish"},{code:"su",name:"Sundanese"},{code:"sw",name:"Swahili (Kiswahili)"},{code:"ss",name:"Swati"},{code:"sv",name:"Swedish"},{code:"tl",name:"Tagalog"},{code:"ty",name:"Tahitian"},{code:"tg",name:"Tajik"},{code:"ta",name:"Tamil"},{code:"tt",name:"Tatar"},{code:"te",name:"Telugu"},{code:"th",name:"Thai"},{code:"bo",name:"Tibetan"},{code:"ti",name:"Tigrinya"},{code:"to",name:"Tonga"},{code:"ts",name:"Tsonga"},{code:"tr",name:"Turkish"},{code:"tk",name:"Turkmen"},{code:"tw",name:"Twi"},{code:"ug",name:"Uyghur"},{code:"uk",name:"Ukrainian"},{code:"ur",name:"Urdu"},{code:"uz",name:"Uzbek"},{code:"ve",name:"Venda"},{code:"vi",name:"Vietnamese"},{code:"vo",name:"Volap\xfck"},{code:"wa",name:"Wallon"},{code:"cy",name:"Welsh"},{code:"wo",name:"Wolof"},{code:"fy",name:"Western Frisian"},{code:"xh",name:"Xhosa"},{code:"yi",name:"Yiddish"},{code:"ji",name:"Yiddish"},{code:"yo",name:"Yoruba"},{code:"za",name:"Zhuang, Chuang"},{code:"zu",name:"Zulu"}],o=r.map(e=>e.code),s=e=>{if(e&&(e.includes("-")&&(e=e.split("-")[0]),e)){if((e.includes("_")&&(e=e.split("_")[0]),e)&&(e=e.toLowerCase(),o.includes(e)))return e}},l=()=>{let e,t=(e=(0,n.useMemo)(()=>i.g.navigator.languages,[]),(0,n.useMemo)(()=>(0,a.My)(r,"asc",t=>+(-1!==e.indexOf(t.code))),[e]));return(0,n.useMemo)(()=>t.map((e,t)=>({key:t,value:e.code,label:`${e.name} (${e.code})`})),[t])}},7666(e,t,i){i.d(t,{Hb:()=>c,KT:()=>d,lZ:()=>h,wg:()=>u,y3:()=>p});var n=i(1454),a=i(5555),r=i.n(a),o=i(758),s=i(543),l=i(9648);class c extends Error{constructor(){super()}}class d extends Error{constructor(e){super(),(0,n._)(this,"message",void 0),this.message=e}}class h extends Error{constructor(e){super(),(0,n._)(this,"data",void 0),this.data=e}}function u(e){return r().join(l._.appApiRoot,e)}function p(e,t,i){let n=(0,s.Zp)(),a=(0,o.useRef)(t);a.current=t;let r=JSON.stringify(t),l=(0,o.useRef)(i);l.current=i;let[d,h]=(0,o.useState)(),[u,p]=(0,o.useState)(),f=(0,o.useCallback)(t=>{e.json(a.current).then(e=>{t.aborted||h(e)}).catch(e=>{if(!t.aborted)if(e instanceof c)return n("/login"),null;else p(e)})},[n,e]),g=(0,o.useCallback)(e=>{var t;(null==(t=l.current)?void 0:t.clearWhenReload)!==!1&&(h(void 0),p(void 0)),f((null==e?void 0:e.signal)??new AbortController().signal)},[f]);return(0,o.useEffect)(()=>{if(!r||(null==i?void 0:i.request)===!1)return;let e=new AbortController;return g({signal:e.signal}),()=>{e.abort()}},[r,null==i?void 0:i.request,g]),{data:d,reload:g,error:u}}},8930(e,t,i){i.d(t,{li:()=>n}),i(9648);class n extends Error{}},4576(e,t,i){i.d(t,{J3:()=>s,Nh:()=>d,TI:()=>o,_b:()=>c,dM:()=>l,h8:()=>h});var n=i(8825),a=i(529),r=i(4362);function o(){return".epub"}function s(e){return(0,r.uz)(e).map(e=>e.trim()).find(e=>!!e)}async function l(e){return(0,a.Ph)(e).doc.title}function c(e){return{name:e.name,langCode:e.langCode,isFavorited:e.isFavorited,isArchived:!!e.isArchived,uuid:e.uuid,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt),isTmp:e.isTmp,position:e.position??null,pageParagraphCounts:e.pageParagraphCounts??null}}function d(e,t){let i=t.section;return((0,n.cz)(e.slice(0,i))+t.paragraph)/(0,n.cz)(e)}function h(e){let t=null;return e.position&&e.pageParagraphCounts&&(t=d(e.pageParagraphCounts,e.position)),{name:e.name,langCode:e.langCode,isFavorited:e.isFavorited,isArchived:!!e.isArchived,uuid:e.uuid,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt),isTmp:e.isTmp,position:e.position,progress:t}}},1421(e,t,i){i.d(t,{Bd:()=>a,Fr:()=>o,WU:()=>r,gm:()=>l,nr:()=>s});var n=i(9738);let a="u">typeof self,r="ontouchstart"in(a?globalThis.window??{}:{}),o=a&&(0,n.A)(navigator.userAgent).any,s=a&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent),l=a&&navigator.userAgent.toLowerCase().includes("firefox")},8825(e,t,i){function n(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e<t?1:-1,n=[];if(i>0)for(let a=e;a<t;a+=i)n.push(a);else if(i<0)for(let a=e;a>t;a+=i)n.push(a);return n}function a(e){return e.filter(e=>!!e)}function r(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length-1,n=i;for(;n>=0;){let i=e[n];if(i){if(t(i,n,e))return[i,n];n-=1}}return[void 0,void 0]}function o(e,t,i){return r(e,t,i)[1]}function s(e,t,i){return r(e,t,i)[0]}function l(e,t,i){let n=[...e.entries()],a=(e,t)=>{if("string"==typeof e&&"string"==typeof t)return e.localeCompare(t);if("number"==typeof e&&"number"==typeof t)return e-t;if("boolean"==typeof e&&"boolean"==typeof t)return Number(e)-Number(t);if(Array.isArray(e)&&Array.isArray(t)){for(let[i,n]of e.entries()){let e=t.at(i);if(void 0===e)break;let r=a(n,e);if(0!==r)return r}return 0}throw Error(`no support order by type(${typeof e} vs ${typeof t})`)};return n.sort((t,n)=>{let[r,o]=t,[s,l]=n;return a(i(o,r,e),i(l,s,e))}),"desc"===t&&n.reverse(),n.map(e=>e[1])}function c(e){return e.reduce((e,t)=>e+t,0)}i.d(t,{Kl:()=>o,My:()=>l,UY:()=>r,Uk:()=>s,cz:()=>c,oE:()=>a,y1:()=>n})},529(e,t,i){i.d(t,{A6:()=>f,B6:()=>l,DE:()=>function e(t){for(let i of t.childNodes)if(p(i)&&("br"===i.tagName.toLowerCase()||e(i)))return!0;return!1},N8:()=>h,Ph:()=>c,Sh:()=>y,_0:()=>g,aI:()=>x,ir:()=>u,m3:()=>function e(t){let i=[],n=[];for(let a of t.childNodes)n.push(a),p(a)&&("br"===a.tagName.toLowerCase()?(i.push(n),n=[]):(n.pop(),i.push(...e(a))));return n.length>0&&i.push(n),i},nN:()=>w,vq:()=>p});var n=i(8678),a=i(9648),r=i(9105),o=i(8820);let s=Symbol("DOMView");function l(e){return!!(e instanceof Element&&["textarea","input"].includes(e.tagName.toLowerCase()))||!1}function c(e){let t=new globalThis.JSDOM("",{pretendToBeVisual:!0}),i=new t.window.DOMParser().parseFromString(e,"text/html");return i[s]=t.window,{view:t.window,doc:i}}function d(e){var t,i;return(null==e?void 0:e.defaultView)||(null==e||null==(t=e.ownerDocument)?void 0:t.defaultView)||(null==e||null==(i=e.ownerDocument)?void 0:i[s])}function h(e){let t=d(e);if(!t)throw Error("no dom view");return t}function u(e){let t=d(e);return!!t&&e instanceof t.Text}function p(e){let t=d(e);return!!t&&e instanceof t.HTMLElement}function f(e){let t=d(e);return!!t&&e instanceof t.HTMLImageElement}async function g(e,t){let i=new n.Readability(e).parse();if(!i)throw Error("parse article error");let r=c(i.content),o=r.doc;return"server"===a._.appMode&&await m(o.body,{baseURL:t}),function(e){let{view:t,doc:i}=e,n=Array.from(i.body.childNodes),a="";for(let e of n)e.nodeType===t.Node.TEXT_NODE?a+=e.textContent:a+=new t.XMLSerializer().serializeToString(e);return a}(r)}async function m(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t.baseURL?new URL(t.baseURL):void 0,n=[...e.querySelectorAll("img")],a=new Headers({...t.referrer?{Referer:t.referrer??void 0}:{}});for(let e of n){let t=e.src||e.getAttribute("data-src")||e.getAttribute("data-original");if(t&&!t.startsWith("data:"))try{if(t.startsWith("//")&&i&&(t=`${i.protocol}:${t}`),!(0,o.g)(t))return;let n=await fetch(t,{headers:a}),s=n.headers.get("Content-Type"),l=await n.arrayBuffer();e.src=`data:${s};base64,${(0,r.Yi)(l)}`}catch(e){console.error(e)}}}async function v(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=[...e.querySelectorAll("image")],n=new Headers({...t.referrer?{Referer:t.referrer??void 0}:{}});for(let e of i){let i=e.href.baseVal;if(!i)continue;let a=t.baseURL?new URL(i,t.baseURL):i;try{let t=await fetch(a,{headers:n}),i=t.headers.get("Content-Type"),o=await t.arrayBuffer();e.setAttribute("href",`data:${i};base64,${(0,r.Yi)(o)}`)}catch(e){console.error(e)}}}async function y(e,t){let i=e.cloneNode(!0);await v(i,{baseURL:t}),i.setAttribute("width",`${e.clientWidth}px`);let n=new XMLSerializer().serializeToString(i);e.cloneNode();let a=window.btoa(n);return`data:image/svg+xml;base64,${a}`}function x(e){e.preventDefault(),e.stopPropagation()}function w(e,t){if(!e[0])throw Error("no nodes");let i=d(e[0]);if(!i)throw Error("no dom view");let n=i.document.createElement(t);for(let t of(e[0].before(n),e))n.appendChild(t);return n}},9035(e,t,i){i.d(t,{Dw:()=>u,TP:()=>l,vl:()=>d});var n=i(9511),a=i(5129),r=i(547),o=i(1454),s=new WeakMap;class l{on(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i={cb:e,options:{...this.defaultOptions,...t}};return(0,n._)(this,s).push(i),()=>{this.off(i)}}fire(e){for(let t of[...(0,n._)(this,s)])t.options.once&&this.off(t),Promise.resolve(t.cb(e)).catch(console.error)}off(e){let t=(0,n._)(this,s).findIndex(()=>e);-1!==t&&(0,n._)(this,s).splice(t,1)}constructor(e={}){(0,o._)(this,"defaultOptions",void 0),(0,a._)(this,s,{writable:!0,value:void 0}),this.defaultOptions=e,(0,r._)(this,s,[])}}var c=new WeakMap;class d{on(e,t){let i=(0,n._)(this,c).get(e);return i||(i=new l,(0,n._)(this,c).set(e,i)),i.on(t)}fire(e,t){let i=(0,n._)(this,c).get(e);i&&Promise.resolve(i.fire(t)).catch(console.error)}off(e){(0,n._)(this,c).delete(e)}constructor(){(0,a._)(this,c,{writable:!0,value:new Map})}}var h=new WeakMap;class u extends d{on(e,t){return super.on(e,i=>t(i,(0,n._)(this,h).get(e)))}fire(e,t){(0,n._)(this,h).has(e)&&(0,n._)(this,h).get(e)===t||((0,n._)(this,h).set(e,t),super.fire(e,t))}constructor(...e){super(...e),(0,a._)(this,h,{writable:!0,value:new Map})}}},692(e,t,i){i.d(t,{bI:()=>n,dY:()=>r,yy:()=>a});let n=e=>{e().catch(console.error)},a=e=>new Promise(t=>{setTimeout(t,e)}),r=()=>new Promise(e=>{setTimeout(()=>{e()})})},4362(e,t,i){function n(e){return e.split(/\r?\n/)}function a(e){return e.split(/\r?\n\r?\n/)}function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}function o(e,t){function i(e,t){let i=[],n=0,a=e.length;for(;n<a;){let a=e.indexOf(t,n);if(-1===a)break;i.push(a),n=a+t.length}return i}let n=i(e,t.keyword).map(e=>[e,t.keyword.length]),a=[];if(t.alias)for(let r of t.alias){let t=r.length,o=i(e,r).filter(e=>!n.some(i=>i[0]<=e&&i[0]+i[1]>=e+t));a.push(...o.map(e=>[e,t]))}return[...n,...a]}i.d(t,{JG:()=>o,ZH:()=>r,dF:()=>a,uz:()=>n})},8820(e,t,i){function n(e){let[t,i]=e.split("#",2);return[decodeURIComponent(t??""),decodeURIComponent(i??"")]}function a(e){try{return new URL(e),!0}catch{return!1}}i.d(t,{R:()=>n,g:()=>a})},5938(e,t,i){i.d(t,{OT:()=>d,iA:()=>p,p2:()=>f,ph:()=>h});var n=i(8507),a=i(9747),r=i(3202),o=i(4124),s=i(697),l=i(758);let c=(0,n.eU)(null),d=()=>{let e=s.J.get(c);return e||r.Ay};function h(){let[e,t]=r.Ay.useNotification({placement:"top",duration:3}),[,i]=(0,a.fp)(c);return(0,l.useEffect)(()=>{i(e)},[e,i]),t}let u=(0,n.eU)(null),p=()=>{let e=s.J.get(u);return e||o.Ay};function f(){let[e,t]=o.Ay.useMessage({duration:3}),[,i]=(0,a.fp)(u);return(0,l.useEffect)(()=>{i(e)},[e,i]),t}},1993(e,t,i){let n,a;var r=i(6070);i(2200);var o=i(9576),s=i(7848),l=i(2868),c=i(2475),d=i(3867),h=i(8368),u=i(5397);window.API={book:{add:async e=>await l.G.json(e),fetchUrlInfo:async e=>await c.h.json(e),addByUrl:async e=>await s.K.json(e),async update(e){await u.N.json(e)},async top(e){await d.K.json(e)},search:async e=>await h.O.json(e)}};var p=i(8924);i(9852);var f=i(9747),g=i(758),m=i(5727),v=i(8692),y=i(6026),x=i(751),w=i(5102),k=i(8448),b=i(8598),j=i(7134),C=i(8507),S=i(8825),A=i(529),L=i(4362);let P=(0,C.eU)({win:null});var _=i(697);let I=(0,C.eU)([]),E="";function N(e){if(Array.isArray(e))return e.map(N).join(" ");{if("string"==typeof e)return e.toLowerCase();let t="";return e.shift&&(t+="shift+"),e.ctrl&&(t+="ctrl+"),e.alt&&(t+="alt+"),t+=e.key.toLowerCase()}}function R(e){let t="";return e.length>1?t+=(0,L.ZH)(e):" "===e?t+="Space":t+=e,t}function T(){let e=(0,g.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=_.J.get(I),n=[];for(let[a,r,o]of e){let e=N(a),s=function e(t){if(Array.isArray(t))return t.map(e).flat();{if("string"==typeof t)return[R(t)];let e="",i=t.shift||t.ctrl||t.alt;return i&&(e+="<"),t.shift&&(e+="Shift-"),t.ctrl&&(e+="Ctrl-"),t.alt&&(e+="Alt-"),e+=R(t.key),i&&(e+=">"),[e]}}(a),l=t.level??1,c=i.find(t=>{let[i]=t;return i===e});if(c){if(c[3].has(l))throw Error(`Hotkey ${JSON.stringify(a)} level: ${l} already exists`);c[3].set(l,o)}else c=[e,s,r,new Map([[l,o]])],i.push(c);n.push({item:c,level:l})}return _.J.set(I,[...i]),function(){let e=_.J.get(I),t=[];for(let{item:e,level:i}of n)e[3].delete(i),e[3].size||t.push(e);_.J.set(I,e.filter(e=>!t.includes(e)))}},[]);return{addHotkey:(0,g.useCallback)(function(t,i,n){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return e([[t,i,n]],a)},[e]),addHotkeys:e}}function M(){return e=>{if((0,A.B6)(e.target))return;let t=_.J.get(I),i=N({shift:e.shiftKey,ctrl:e.ctrlKey,alt:e.altKey,key:e.key.toLowerCase()});console.log("triggered-key:",i);let a=E+i,r=a+" ",o=t.find(e=>{let[t]=e;return t===a}),s=t.find(e=>{let[t]=e;return t.startsWith(r)});if(o||s){if((0,A.aI)(e),E="",clearTimeout(n),s)E=r,n=setTimeout(()=>{E=""},1e3);else if(o){var l;let e=Math.max(...o[3].keys());e&&(null==(l=o[3].get(e))||l())}}}}function $(){let[e,t]=(0,g.useState)(!1),{addHotkey:i}=T(),[n]=(0,f.fp)(I);return!function(){let[e]=(0,f.fp)(P);(0,g.useEffect)(()=>{let e=M();return window.addEventListener("keydown",e,{passive:!1}),()=>{window.removeEventListener("keydown",e)}},[]),(0,g.useEffect)(()=>{if(!e.win)return;let t=M();return e.win.addEventListener("keydown",t,{passive:!1}),()=>{var i;null==(i=e.win)||i.removeEventListener("keydown",t)}},[e])}(),(0,g.useEffect)(()=>i({shift:!0,key:"?"},(0,j.t)("hotkey.helper"),()=>{t(!0)}),[i]),W(()=>{t(!1)},{enable:e,level:200}),(0,r.jsx)(w.A,{open:e,width:"auto",style:{maxWidth:"1000px"},onCancel:()=>{t(!1)},title:(0,j.t)("hotkey.title"),footer:!1,zIndex:1e4,children:(0,r.jsx)("ul",{className:"hotkeyList-X2vODR",children:(0,S.My)(n,"asc",e=>{let[t]=e;return t}).map((e,t)=>{let[,i,n]=e;return(0,r.jsxs)("li",{children:[(0,r.jsx)("div",{className:"keys",children:i.map((e,t)=>(0,r.jsx)("kbd",{children:e},t))}),(0,r.jsx)("div",{className:"desc",children:n})]},t)})})})}function W(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{enable:i=!0,level:n=100}=t,a=(0,g.useRef)(e),{addHotkey:r}=T();(0,g.useEffect)(()=>{a.current=e},[e]),(0,g.useEffect)(()=>{if(i)return r("escape",(0,j.t)("hotkey.escape"),()=>{a.current()},{level:n})},[r,i,n])}var F=i(4368);function U(e){let{icon:t,size:i,style:n,onClick:a,color:o}=e;return(0,r.jsx)(F.g,{icon:t,size:i??"lg",color:o,style:{paddingLeft:"6px",paddingRight:"6px",...n},onClick:a})}var z=i(2980);let D=(0,C.eU)(null);function O(e){return new Promise(t=>{_.J.set(D,{...e,okCallback:()=>t(!0),cancelCallback:()=>t(!1)})})}function B(){let[e,t]=(0,f.fp)(D),i=(0,g.useCallback)(()=>{t(null)},[t]),n=(0,g.useCallback)(()=>{null==e||e.cancelCallback(),i()},[e,i]),a=(0,g.useCallback)(()=>{null==e||e.okCallback(),i()},[e,i]);return(e=>{let{enable:t=!0,onOk:i,onClose:n,level:a=100}=e,{addHotkey:r}=T(),o=(0,x.J)(i),s=(0,x.J)(n);(0,g.useEffect)(()=>{if(t)return r("Enter",(0,j.t)("hotkey.ok"),()=>{o.current()},{level:a})},[r,t,a,o]),W(()=>{var e;null==(e=s.current)||e.call(s)},{enable:!!t&&!!n})})({enable:!!e,onOk:a,onClose:n}),(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(w.A,{open:!!e,onOk:a,onCancel:i,title:(0,r.jsxs)(k.A,{children:[(0,r.jsx)(U,{icon:z.wRm,size:"lg",color:"#ff4d4f"}),null==e?void 0:e.title]}),footer:!1,children:(0,r.jsxs)(k.A,{direction:"vertical",children:[null==e?void 0:e.description,(0,r.jsxs)(k.A,{children:[(0,r.jsx)(b.Ay,{type:"primary",onClick:i,children:(0,j.t)("confirm.cancel")}),(0,r.jsx)(b.Ay,{type:"primary",onClick:a,children:(0,j.t)("confirm.ok")})]})]})})})}function K(){let[e]=(0,f.fp)(D);return e?(0,r.jsx)(B,{}):(0,r.jsx)(r.Fragment,{})}let H=(0,C.eU)(null);function V(){let[e]=(0,f.fp)(H);return(0,r.jsx)("div",{className:"hint-cMFGU8",style:{display:e?"inline-block":"none"},children:e})}var G=i(5938);function q(e,t){return Math.hypot(t.clientX-e.clientX,t.clientY-e.clientY)}function J(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function Y(e){let{onClose:t,children:i}=e,n=(0,g.useRef)(null),a=(0,g.useRef)(null),o=(0,g.useRef)(),{addHotkeys:s}=T();return W(()=>{var e;return null==(e=o.current)?void 0:e.call(o)}),(0,g.useEffect)(()=>{o.current=t},[t]),(0,g.useEffect)(()=>{let e=n.current,t=a.current;if(!e||!t)return;let{move:i,scale:r,reset:l,dispose:c}=((e,t,i)=>{let n=!1,a=null,r=e.getBoundingClientRect(),o={x:0,y:0,scale:1},s={x:0,y:0,scale:1},l=()=>{t.style.transform=`translate(${o.x}px, ${o.y}px) scale(${o.scale})`},c=()=>{s={...o={...J(r),scale:1}},l()};c();let d=e=>{Math.hypot(e.x,e.y)>=10&&(n=!0),o.x=s.x+e.x,o.y=s.y+e.y,l()},h=t=>{let i=s.scale*t.rate;if(i<.01)return;o.scale=i;let n=e.getBoundingClientRect(),a=t.pageX-n.left-s.x,r=t.pageY-n.top-s.y;o.x=s.x+a*(1-t.rate),o.y=s.y+r*(1-t.rate),l()},u=()=>{s.x=o.x,s.y=o.y,s.scale=o.scale},p=[];function f(t,i){e.addEventListener(t,i),p.push(()=>e.removeEventListener(t,i))}return f("touchstart",e=>{(0,A.aI)(e);let t=e.touches[0];if(!t)return;let i=e.touches[1];a=i?{type:"pinch",range:q(t,i)}:{type:"move",x:t.clientX,y:t.clientY},n=!1}),f("touchmove",e=>{if((0,A.aI)(e),!a)return;let t=e.touches[0];if(!t)return;let i=e.touches[1];switch(a.type){case"move":d({x:t.clientX-a.x,y:t.clientY-a.y});break;case"pinch":i&&h({...{pageX:(t.pageX+i.pageX)/2,pageY:(t.pageY+i.pageY)/2},rate:q(t,i)/a.range})}}),f("touchend",e=>{(0,A.aI)(e),a&&("move"!==a.type||n||i(),a=null,u())}),f("mousedown",e=>{(0,A.aI)(e),a={type:"move",x:e.clientX,y:e.clientY},n=!1}),f("mousemove",e=>{(0,A.aI)(e),a&&"move"===a.type&&d({x:e.clientX-a.x,y:e.clientY-a.y})}),f("mouseup",e=>{(0,A.aI)(e),a&&("move"!==a.type||n||i(),a=null,u(),n||i())}),f("wheel",e=>{let t;(0,A.aI)(e),h({pageX:e.pageX,pageY:e.pageY,rate:0===(t=e.deltaY)?0:t<0?1.1:.9}),u()}),{move:e=>{d(e),u()},scale:e=>{let t=J(r);h({...e,pageX:t.x,pageY:t.y}),u()},reset:()=>{c()},dispose:()=>{p.forEach(e=>e())}}})(e,t,()=>{var e;return null==(e=o.current)?void 0:e.call(o)}),d=()=>{i({x:0,y:-10})},h=()=>{i({x:0,y:10})},u=()=>{i({x:-10,y:0})},p=()=>{i({x:10,y:0})},f=s([["k",(0,j.t)("hotkey.pinchUp"),d],["j",(0,j.t)("hotkey.pinchDown"),h],["h",(0,j.t)("hotkey.pinchLeft"),u],["l",(0,j.t)("hotkey.pinchRight"),p],["ArrowUp",(0,j.t)("hotkey.pinchUp"),d],["ArrowDown",(0,j.t)("hotkey.pinchDown"),h],["ArrowLeft",(0,j.t)("hotkey.pinchLeft"),u],["ArrowRight",(0,j.t)("hotkey.pinchRight"),p],["=",(0,j.t)("hotkey.pinchZoomIn"),()=>{r({rate:1.1})}],["-",(0,j.t)("hotkey.pinchZoomOut"),()=>{r({rate:.9})}],["Backspace",(0,j.t)("hotkey.pinchReset"),l]],{level:100});return()=>{c(),f()}},[s]),(0,g.useEffect)(()=>{},[s]),(0,r.jsx)("div",{ref:n,className:"overlay-RAuidH",onKeyDown:e=>{var t;"escape"===e.key.toLowerCase()&&(null==(t=o.current)||t.call(o))},children:(0,r.jsx)("div",{className:"container-s1K_V6",ref:a,children:(0,r.jsx)("div",{className:"center-V6m0hj",children:i})})})}let X=(0,C.eU)(null);function Z(){let[e,t]=(0,f.fp)(X);return e?(0,r.jsx)(Y,{onClose:()=>{t(null)},children:(0,r.jsx)("img",{src:e,onLoad:e=>{let t=e.currentTarget,i=t.naturalWidth/t.naturalHeight;i>window.innerWidth/window.innerHeight?t.naturalWidth>window.innerWidth&&(t.width=window.innerWidth,t.height=window.innerWidth/i):t.naturalHeight>window.innerHeight&&(t.height=window.innerHeight,t.width=window.innerHeight*i)},alt:"preview"})}):(0,r.jsx)(r.Fragment,{})}var Q=i(7599);function ee(e){return(0,r.jsx)(Q.A,{fullscreen:!0,size:"large",...e})}function et(e){return(0,r.jsx)(Q.A,{...e,style:{width:"100%",padding:20,...e.style}})}var ei=i(8276);let en="Auditory Reader",ea=(0,C.eU)([]),er=(0,C.eU)(e=>{let t=e(ea).at(0);return null==t?void 0:t.title});function eo(){let[e]=(0,f.fp)(er);return e}function es(){let e=eo();return(0,g.useEffect)(()=>{document.title=e?`${e}: ${en}`:en},[e]),(0,r.jsx)(r.Fragment,{})}var el=i(543),ec=i(4669),ed=i(8240),eh=i(7666),eu=i(1421);let ep=(0,C.eU)([]);if(eu.Bd){let e=()=>{_.J.set(ep,speechSynthesis.getVoices())};e(),"addEventListener"in window.speechSynthesis&&window.speechSynthesis.addEventListener("voiceschanged",e)}function ef(e){let{storeKey:t,read:i,write:n}=e,a=(0,C.eU)(i(localStorage.getItem(t)));return()=>{let[e,i]=(0,f.fp)(a),r=(0,g.useCallback)(a=>{let r;i(r="function"==typeof a?a(e):a);let o=n(r);o?localStorage.setItem(t,o):localStorage.removeItem(t)},[e,i]);return[e,r]}}let eg=e=>"nav"===e||"annotation"===e||"keyword"===e?e:"none",em=ef({storeKey:"viewPanelType",read:eg,write:eg}),ev=ef({storeKey:"langVoiceURIDict",read:e=>e?JSON.parse(e):{},write:e=>JSON.stringify(e)}),ey=()=>{let[e]=ev(),[t]=(0,f.fp)(ep),i=(0,g.useCallback)(e=>(0,S.My)(t,"desc",t=>[t.lang.startsWith(`${e.langCode}-`),!t.localService]),[t]);return{getVoice:(0,g.useCallback)(t=>{let n=i(t),a=e[t.langCode];return(a?n.find(e=>e.voiceURI===a):null)??n.at(0)??null},[e,i]),getAllSortedVoices:i}},ex=e=>{let[t,i]=(e=>{let[t,i]=ev();return[(0,g.useMemo)(()=>t[e.langCode]??null,[e.langCode,t]),(0,g.useCallback)(n=>{let a={...t};n?a[e.langCode]=n:delete a[e.langCode],i(a)},[e.langCode,t,i])]})(e),{getAllSortedVoices:n,getVoice:a}=ey(),r=(0,g.useMemo)(()=>n(e),[e,n]),o=(0,g.useMemo)(()=>{var e;return t??(null==(e=r[0])?void 0:e.voiceURI)??null},[r,t]),s=(0,g.useCallback)(e=>{i(e)},[i]),l=(0,g.useMemo)(()=>a(e)??null,[e,a]),c=(0,g.useCallback)(e=>{s((null==e?void 0:e.voiceURI)??null)},[s]);return{voiceURI:o,setVoiceURI:s,voice:l,setVoice:c,allSortedVoices:r}},ew=ef({storeKey:"autoSection",read:e=>!e||"1"===e,write:e=>e?"1":"0"}),ek=ef({storeKey:"stopTimer",read:e=>!e||"1"===e,write:e=>e?"1":"0"}),eb=ef({storeKey:"stopTimerSeconds",read:e=>e?Number(e):1800,write:e=>e.toString()}),ej=ef({storeKey:"personReplace",read:e=>!!e&&"1"===e,write:e=>e?"1":"0"}),eC=ef({storeKey:"speechSpeed",read:e=>e?Number(e):1,write:e=>e.toString()}),eS=["system","dark","light"],eA=ef({storeKey:"userColorScheme",read:e=>e??"system",write:e=>e}),eL=ef({storeKey:"paragraphRepeat",read:e=>e?Number(e):1,write:e=>e.toString()}),eP=["none","auto","single","double"],e_=ef({storeKey:"pageList",read:e=>eP.includes(e)?e:"auto",write:e=>e}),eI=ef({storeKey:"fontSize",read:e=>e?Math.min(Math.max(Number(e),8),30):16,write:e=>e.toString()}),eE=ef({storeKey:"disabledVertical",read:e=>!!e&&"1"===e,write:e=>e?"1":"0"});function eN(e){let{title:t}=e,i=(0,el.Zp)(),{addHotkeys:n}=T();return(0,g.useEffect)(()=>n([["u",(0,j.t)("hotkey.goBack"),()=>i("../../")]]),[n,i]),(0,r.jsx)(p.A,{type:"error",message:`The ${t} not found`,description:`The ${t} not found`})}function eR(e){let{dir:t="column",gap:i=0,flex:n,style:a,children:o,...s}=e;return(0,r.jsx)("div",{style:{display:"flex",flexDirection:t,gap:i,flex:n,...a},...s,children:o})}function eT(e){let{to:t,children:i}=e;return i((0,el.$P)(t))}function eM(){let{uuid:e}=(0,el.g)();return e?(0,r.jsxs)(eR,{gap:4,children:[(0,r.jsx)(p.A,{type:"success",message:(0,j.t)("desc.bookAddedSuccessful")}),(0,r.jsx)(eT,{to:`/books/view/${e}`,children:e=>(0,r.jsx)(b.Ay,{type:"primary",href:e,icon:(0,r.jsx)(U,{icon:z.pS3}),children:(0,j.t)("view")})})]}):(0,r.jsx)(eN,{title:"book"})}var e$=i(2761),eW=i(5555),eF=i.n(eW),eU=i(4178),ez=i(1196),eD=i(4150),eO=i(5165),eB=i(254),eK=i(4576),eH=i(9105);function eV(e){return e.name.endsWith(".txt")||e.name.endsWith(".text")}function eG(e){return e.name.endsWith(".html")}function eq(e){return e.name.endsWith(".epub")}var eJ=i(692),eY=i(5860);let eX=e=>{let{accept:t,prompt:i,value:n,onChange:a}=e,[o,s]=(0,g.useState)();return(0,g.useEffect)(()=>{s(n)},[n]),(0,r.jsxs)("label",{className:"fileInput-jzkJ9C",children:[(0,r.jsx)("input",{style:{display:"none"},accept:t,type:"file",onChange:e=>{let t=[...e.target.files??[]];s(t[0]),null==a||a(t[0])}}),o?(0,r.jsx)(eR,{gap:5,children:(0,r.jsxs)(eR,{dir:"row",gap:5,style:{alignItems:"center"},children:[(0,r.jsx)(U,{icon:z.JmV}),(0,r.jsx)("div",{children:o.name})]})}):(0,r.jsx)(eR,{gap:2,style:{justifyContent:"center"},children:i&&(0,r.jsx)(eY.A,{children:i})})]})};var eZ=i(5930);let eQ=(e,t)=>!!t&&"string"==typeof t.label&&t.label.toLowerCase().includes(e.toLowerCase());function e0(e){let{value:t,onChange:i}=e,n=(0,eB.fB)(),[a,o]=(0,g.useState)(""),s=(0,g.useMemo)(()=>{if(!a)return n;let e=a.toLowerCase(),t=n.filter(t=>t.value===e);return t.length?t:n},[n,a]);return(0,r.jsx)(eZ.A,{showSearch:!0,filterOption:(e,t)=>(o(e),eQ(e,t)),popupMatchSelectWidth:!1,value:t,onChange:i,placeholder:(0,j.t)("prompt.selectLanguage"),options:s})}var e1=i(4972);function e2(){let e=(0,el.Zp)(),[t,i]=(0,g.useState)(!1),[n]=eU.A.useForm(),a=eU.A.useWatch("file",n);return(0,g.useEffect)(()=>{(0,eJ.bI)(async()=>{if(a){if(eq(a)){let e=await a.arrayBuffer(),t=await eD.s.read(e);if(!t)return;let i=eF().extname(a.name),r=eF().basename(a.name,i);n.setFieldValue("name",t.title??r);let o=(0,eB.R_)(t.language);o&&n.setFieldValue("langCode",o)}else if(eV(a)){let e=await a.text(),t=(0,eK.J3)(e);if(!t)return;n.setFieldValue("name",t)}else if(eG(a)){let e=await a.text(),t=await (0,eK.dM)(e);if(!t)return;n.setFieldValue("name",t)}}})},[a,n]),(0,r.jsxs)(eU.A,{form:n,style:{margin:"20px auto 0",maxWidth:"800px"},initialValues:{name:"",langCode:null,file:null},onFinish:t=>{(0,eJ.bI)(async()=>{try{let n,a;if(i(!0),!t.file)return;if(eq(t.file))n=await t.file.arrayBuffer();else if(eV(t.file)){let e=await t.file.text();n=await (0,eO.X)(e,t.name,t.langCode)}else eG(t.file)&&(a=await t.file.text());if(n){let i=(0,eH.Yi)(n),a=await l.G.json({name:t.name,langCode:t.langCode,bufferBase64:i});e(`/books/added-successful/${a.uuid}`)}else if(a){let i=await e1.k.json({name:t.name,langCode:t.langCode,html:a});e(`/books/added-successful/${i.uuid}`)}}finally{i(!1)}})},children:[(0,r.jsx)(eU.A.Item,{label:(0,j.t)("bookName"),name:"name",rules:[{required:!0}],children:(0,r.jsx)(ez.A,{placeholder:(0,j.t)("prompt.inputBookName")})}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("language"),name:"langCode",rules:[{required:!0}],children:(0,r.jsx)(e0,{})}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("file"),name:"file",rules:[{required:!0}],children:(0,r.jsx)(eX,{prompt:(0,j.t)("prompt.uploadBook")})}),(0,r.jsx)(eU.A.Item,{children:(0,r.jsx)(b.Ay,{block:!0,type:"primary",htmlType:"submit",loading:t,children:(0,j.t)("add")})})]})}var e3=i(4835),e5=i(8323),e4=i(9001),e8=i.n(e4),e6=i(2591),e9=i.n(e6),e7=i(4624),te=i(2895),tt=i(9432),ti=i(4121);let tn=new ti.F("books/import").routeLogined(async e=>{let{req:t,userInfo:i}=e,n=await t.body,a=(0,eK._b)(n.entity);a.uuid=(0,te.A)();let r=(0,eH.Ms)(n.bufferBase64);if(await tt.J.list(i.account).add(a,r),n.property){let e=await tt.J.entity(i.account,a.uuid);await e.writeProp(n.property)}return{ok:!0}});var ta=i(2409);let tr=e=>Math.floor(100*e),to=e=>`${e.name}${(0,eK.TI)()}`,ts=async(e,t)=>{let i=new(e8()),n=e.length,a=e.map(e=>({uuid:e.uuid,name:e.name,folder:`${e.name}-(${e.uuid})`}));for(let[r,o]of(i.file("list.json",JSON.stringify({list:a},null,2)),a.entries())){let a=e.find(e=>e.uuid===o.uuid);if(!a)continue;let s=await e7.u.file({uuid:o.uuid}),l=await ta.f.json({uuid:o.uuid}),c=to(o),d=o.folder;i.file(`${d}/property.json`,JSON.stringify(l,null,2)),i.file(`${d}/book.json`,JSON.stringify(a,null,2)),i.file(`${d}/${c}`,s.arrayBuffer()),t(tr((r+1)/n))}e9()(await i.generateAsync({type:"blob"}),"books.zip")},tl=async e=>{let t=e.file("list.json");return t?JSON.parse(await t.async("text")).list:((0,G.OT)().warning({message:"Warning",description:"Cannot find list.json in zip"}),Object.keys(e.files).filter(e=>e.endsWith("/")).map(e=>e.slice(0,-1)).map(e=>{let t=e.match(/^(.*?)-\((.*?)\)$/),i=t?t[1]:null,n=t?t[2]:null;return i&&n?{folder:e,name:i,uuid:n}:null}).filter(e=>null!==e))},tc=async(e,t,i)=>{let n=t.length;for(let[s,l]of t.entries()){var a,r,o;let t=await (null==(a=e.file(`${l.folder}/book.json`))?void 0:a.async("text"));if(!t)continue;let c=JSON.parse(t),d=to(c),h=await (null==(r=e.file(`${l.folder}/${d}`))?void 0:r.async("arraybuffer"));if(!h)continue;let u=await (null==(o=e.file(`${l.folder}/property.json`))?void 0:o.async("text")),p=u?JSON.parse(u):null;await tn.json({entity:c,property:p,bufferBase64:(0,eH.Yi)(h)}),i(tr((s+1)/n))}};function td(){let[e,t]=(0,g.useState)(!1),[i]=eU.A.useForm(),n=eU.A.useWatch("file",i),[a,o]=(0,g.useState)(null),[s,l]=(0,g.useState)(null);return(0,g.useEffect)(()=>{(0,eJ.bI)(async()=>{if(n){let e=await e8().loadAsync(await n.arrayBuffer()),t=await tl(e);o({zip:e,list:t})}else o(null)})},[n]),(0,r.jsxs)(r.Fragment,{children:[null!==s&&(0,r.jsx)(e3.A,{percent:s}),(0,r.jsxs)(eU.A,{form:i,style:{margin:"20px auto 0",maxWidth:"800px"},initialValues:{file:null},onFinish:()=>{(0,eJ.bI)(async()=>{try{if(!a)return;l(0),await tc(a.zip,a.list,e=>{l(e)})}finally{l(null),t(!1)}})},children:[(0,r.jsx)(eU.A.Item,{label:(0,j.t)("file"),name:"file",rules:[{required:!0}],children:(0,r.jsx)(eX,{accept:".zip",prompt:(0,j.t)("prompt.importBooks")})}),(0,r.jsx)(eU.A.Item,{children:(0,r.jsx)(b.Ay,{block:!0,type:"primary",htmlType:"submit",loading:e,children:(0,j.t)("import")})})]}),(null==a?void 0:a.list.length)&&(0,r.jsxs)(k.A,{direction:"vertical",style:{width:"100%",height:300,overflow:"auto"},children:[(0,r.jsx)("h3",{children:(0,j.t)("import")}),(0,r.jsx)(k.A,{direction:"vertical",children:a.list.map((e,t)=>(0,r.jsxs)(e5.A,{children:[e.name," (",e.uuid,")"]},t))})]})]})}function th(e){let{...t}=e;return(0,r.jsx)(ez.A.TextArea,{rows:4,onKeyDown:e=>{if(e.ctrlKey&&"Enter"===e.key){var t;let i=e.target;(0,A.aI)(e),null==(t=i.closest("form"))||t.dispatchEvent(new Event("submit",{bubbles:!0,cancelable:!0}))}},...t})}function tu(){let e=(0,el.Zp)(),[t,i]=(0,g.useState)(!1),[n]=eU.A.useForm(),a=eU.A.useWatch("content",n);return(0,g.useEffect)(()=>{if(a&&!n.getFieldValue("name")){let e=(0,eK.J3)(a);e&&n.setFieldValue("name",e)}},[a,n]),(0,r.jsxs)(eU.A,{form:n,style:{margin:"20px auto 0",maxWidth:"800px"},initialValues:{name:"",langCode:null,content:""},onFinish:t=>{(0,eJ.bI)(async()=>{try{i(!0);let n=await (0,eO.X)(t.content,t.name,t.langCode),a=(0,eH.Yi)(n),r=await l.G.json({name:t.name,langCode:t.langCode,bufferBase64:a});e(`/books/added-successful/${r.uuid}`)}finally{i(!1)}})},children:[(0,r.jsx)(eU.A.Item,{label:(0,j.t)("bookName"),name:"name",rules:[{required:!0}],children:(0,r.jsx)(ez.A,{placeholder:(0,j.t)("prompt.inputBookName")})}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("language"),name:"langCode",rules:[{required:!0}],children:(0,r.jsx)(e0,{})}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("bookContent"),name:"content",rules:[{required:!0}],children:(0,r.jsx)(th,{rows:6})}),(0,r.jsx)(eU.A.Item,{children:(0,r.jsx)(b.Ay,{block:!0,htmlType:"submit",type:"primary",loading:t,children:(0,j.t)("add")})})]})}function tp(){let e=(0,el.Zp)(),[t,i]=(0,g.useState)(!1),[n,a]=(0,g.useState)(!1),[o]=eU.A.useForm();return(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)(eU.A,{form:o,style:{margin:"20px auto 0",maxWidth:"800px"},initialValues:{name:"",langCode:null,url:""},onFinish:t=>{(0,eJ.bI)(async()=>{try{a(!0);let i=await s.K.json({name:t.name,langCode:t.langCode,url:t.url});e(`/books/added-successful/${i.uuid}`)}finally{a(!1)}})},children:[(0,r.jsx)(eU.A.Item,{label:(0,j.t)("bookName"),name:"name",rules:[{required:!0}],children:(0,r.jsx)(ez.A,{placeholder:(0,j.t)("prompt.inputBookName")})}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("language"),name:"langCode",rules:[{required:!0}],children:(0,r.jsx)(e0,{})}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("url"),name:"url",rules:[{required:!0}],children:(0,r.jsxs)(k.A.Compact,{style:{width:"100%"},children:[(0,r.jsx)(ez.A,{}),(0,r.jsx)(b.Ay,{style:{alignSelf:"center"},type:"primary",loading:t,onClick:()=>{let e=o.getFieldValue("url");e&&(i(!0),c.h.json({url:e}).then(e=>{o.setFieldValue("name",e.title),e.lang&&o.setFieldValue("langCode",e.lang)}).catch(console.error).finally(()=>i(!1)))},children:(0,j.t)("extractUrlInfo")})]})}),(0,r.jsx)(eU.A.Item,{children:(0,r.jsx)(b.Ay,{block:!0,htmlType:"submit",type:"primary",loading:n,children:(0,j.t)("add")})})]})})}function tf(){let[e,t]=(0,g.useState)("text");return(0,r.jsx)(e$.A,{defaultActiveKey:e,onChange:e=>t(e),destroyInactiveTabPane:!0,items:[{key:"text",label:(0,j.t)("text"),children:(0,r.jsx)(tu,{})},{key:"file",label:(0,j.t)("file"),children:(0,r.jsx)(e2,{})},{key:"url",label:(0,j.t)("url"),children:(0,r.jsx)(tp,{})},{key:"import",label:(0,j.t)("import"),children:(0,r.jsx)(td,{})}]})}var tg=i(8877);function tm(e){let{book:t,reload:i}=e,[n]=eU.A.useForm();return(0,r.jsxs)(eU.A,{form:n,initialValues:{name:t.name,langCode:t.langCode},onFinish:e=>{(0,eJ.bI)(async()=>{await u.N.json({uuid:t.uuid,update:{name:e.name,langCode:e.langCode}}),i()})},children:[(0,r.jsx)(eU.A.Item,{label:(0,j.t)("bookName"),name:"name",rules:[{required:!0}],children:(0,r.jsx)(ez.A,{autoFocus:!0,placeholder:(0,j.t)("prompt.inputBookName")})}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("language"),name:"langCode",rules:[{required:!0}],children:(0,r.jsx)(e0,{})}),(0,r.jsx)(eU.A.Item,{children:(0,r.jsx)(b.Ay,{block:!0,htmlType:"submit",type:"primary",children:(0,j.t)("update")})})]})}function tv(e){let{uuid:t,reload:i}=e,{data:n}=(0,eh.y3)(tg.z,{uuid:t});return n?(0,r.jsx)(tm,{book:n,reload:i}):(0,r.jsx)(et,{})}let ty=(0,C.eU)({uuid:null,reloads:[]});function tx(e){let t=(0,x.J)(e),[,i]=(0,f.fp)(ty),n=(0,g.useCallback)(e=>{i(t=>({...t,uuid:e}))},[i]);return(0,g.useEffect)(()=>{let e=()=>{t.current()};return i(t=>({...t,reloads:[...t.reloads,e]})),()=>{i(t=>({...t,reloads:t.reloads.filter(t=>t!==e)}))}},[t,i]),{openBookEdit:n}}function tw(){let[e,t]=(0,f.fp)(ty),i=(0,g.useCallback)(()=>{t(e=>({...e,uuid:null}))},[t]);return(0,r.jsx)(w.A,{open:!!e.uuid,onCancel:i,title:(0,j.t)("editBook"),footer:!1,children:e.uuid&&(0,r.jsx)(tv,{uuid:e.uuid,reload:()=>{i(),e.reloads.forEach(e=>e())}})})}var tk=i(5962),tb=i(8260),tj=i(8052),tC=i(2417),tS=i(647),tA=i(9124),tL=i(3503),tP=i(8930);let t_=new ti.F("books/cover",{method:"get"}).routeLogined(async e=>{let{req:t,res:i,userInfo:n}=e,a=t.searchParams.get("uuid");if(!a)throw new tP.li("uuid parameter required");let r=await tt.J.book(n.account,a),o=await r.cover();if(!o)throw new tP.li("cover in book not found");return o.mediaType&&i.header("Content-Type",o.mediaType.toString()),o.buffer});var tI=i(3226),tE=i(6255),tN=i(8311);let tR=["default","reverse","name","name-reverse"];var tT=i(1454),tM=i(4429);let t$=i.p+"static/media/keyboard.983b6fe1.mp3",tW=i.p+"static/media/rain-loop.769e8d4a.mp3",tF=i.p+"static/media/next-page.2cb810bd.mp3",tU=i.p+"static/media/shutter.37b7999d.mp3",tz=i.p+"static/media/rewind.3bbb7b0e.mp3";async function tD(e){e.play(),await new Promise(t=>{e.once("end",()=>t())})}let tO=new tM.Howl({src:[tU]});async function tB(){await tD(tO)}let tK=new tM.Howl({src:[t$]});async function tH(){await tD(tK)}let tV=new tM.Howl({src:[tF]});async function tG(){await tD(tV)}let tq=new tM.Howl({src:[tW]});function tJ(){tq.playing()&&tq.pause()}tq.loop(!0),tq.fade(0,.5,500);let tY=new tM.Howl({src:[tz],volume:.5});async function tX(){await tD(tY)}class tZ{aliasReplace(e,t){if(!t.length)return{text:e,highlightOffsets:[]};let i=[],n=new Map;for(let i of t){let t=-1;for(;-1!==(t=e.indexOf(i.source,t+1));)n.has(t)||n.set(t,i)}let a=(0,S.My)([...n.entries()],"asc",e=>{let[t]=e;return t}),r=0;for(let[t,{source:n,target:o}]of a){e=e.replace(n,o);let a=n.length-o.length;if(0===a)continue;let s=t-r;for(let e of(i.push([s,r]),(0,S.y1)(1,o.length)))i.push([s+e,r+Math.floor(a*(e/o.length))]);r+=a}return{text:e,highlightOffsets:i}}cancel(){this.state="cancel",speechSynthesis.speaking&&speechSynthesis.cancel()}async speak(e,t){let{speed:i,voice:n,isPersonReplace:a,quote:r=!0,alias:o,onBoundary:s}=t;this.state="speaking",e=a?function(e){for(let[t,i]of Object.entries(y.Xd))e=e.replaceAll(t,i.word);return e}(e):e;let l=[];if(r){let t=function(e){let t=[];for(let[i,n]of[...e.matchAll(/"|'/g)].entries())i%2==0?t.push({type:"start",charIndex:n.index}):t.push({type:"end",charIndex:n.index});for(let i of e.matchAll(/“|‘|「|『/g))t.push({type:"start",charIndex:i.index});for(let i of e.matchAll(/”|’|」|』/g))t.push({type:"end",charIndex:i.index});return(0,S.My)(t,"asc",e=>e.charIndex)}(e);l.push(e=>{let i=(0,S.Kl)(t,t=>t.charIndex<=e.charIndex);if(void 0===i)return tJ();let n=t.slice(0,i+1),a=n.filter(e=>"start"===e.type),r=n.filter(e=>"end"===e.type);a.length>r.length?tq.playing()||tq.play():tJ()})}if(s)if(o&&o.length){let t=this.aliasReplace(e,o);e=t.text;let i=t.highlightOffsets,n=i.length?e=>{let t=(0,S.Uk)(i,t=>{let[i]=t;return i<=e.charIndex});if(!t)return e;let n=e.charIndex+e.charLength,a=(0,S.Uk)(i,e=>{let[t]=e;return t<=n});if(!a)return e;let r=e.charIndex+(t.at(1)??0),o=n+(a.at(1)??0)-r;return{charIndex:r,charLength:o}}:e=>e;l.push(e=>{s(n(e))})}else l.push(e=>{s(e)});for(let e of l)this.utterance.addEventListener("boundary",e);this.utterance.rate=i,this.utterance.voice=n,this.utterance.text=e,speechSynthesis.speak(this.utterance);let c=await new Promise((e,t)=>{this.utterance.addEventListener("end",()=>{e("cancel"===this.state?"cancel":"done")},{once:!0}),this.utterance.addEventListener("error",i=>{"cancel"===this.state?e("cancel"):t(i)},{once:!0})});for(let e of l)this.utterance.removeEventListener("boundary",e);return tJ(),this.state="none",c}constructor(){(0,tT._)(this,"utterance",void 0),(0,tT._)(this,"state","none"),this.utterance=new SpeechSynthesisUtterance}}var tQ=i(6489),t0=i(3309);let t1=(0,C.eU)({topProgress:void 0,topLeft:null,topRight:null,settings:null,bottomLeft1:null,bottomLeft2:null,bottomRight1:null,bottomRight2:null}),t2=e=>{let{topProgress:t,topLeft:i,topRight:n,settings:a,bottomLeft1:r,bottomLeft2:o,bottomRight1:s,bottomRight2:l}=e,[,c]=(0,f.fp)(t1);(0,g.useEffect)(()=>{c({topProgress:t,topLeft:i,topRight:n,settings:a,bottomLeft1:r,bottomLeft2:o,bottomRight1:s,bottomRight2:l})},[t,i,n,a,r,c,o,s,l]),(0,t0.l)(()=>{c({topProgress:void 0,topLeft:null,topRight:null,settings:null,bottomLeft1:null,bottomLeft2:null,bottomRight1:null,bottomRight2:null})})},t3=(0,C.eU)(1),t5=(0,C.eU)(15),t4=(0,C.eU)(0),t8=(0,C.eU)(!1),t6=(0,C.eU)(!1),t9=(0,C.eU)(""),t7=(0,C.eU)("default"),ie=()=>{let[e,t]=(0,f.fp)(t3),[,i]=(0,f.fp)(t4);return[e,(0,g.useCallback)(e=>{i(0),t(e)},[i,t])]};var it=i(2543);let ii="book";function ia(e){return`/books/view/${e}`}let ir=async(e,t,i)=>{if(0===i)return;let n=e.at(t);if(!n)return;let a=n.uuid,r=t+i;if(r<=0)return await d.K.json({uuid:a});let o=e.at(r<t?r-1:r);o&&await tI.l.json({uuid:a,afterUuid:o.uuid})};function io(e){return(0,g.useCallback)(t=>{(0,eJ.bI)(async()=>{if(await O({title:(0,j.t)("remove"),description:(0,r.jsx)("ul",{children:t.map(e=>(0,r.jsx)("li",{children:e.name},e.uuid))})})){for(let e of t)await tN.I.json({uuid:e.uuid});e()}})},[e])}function is(e){let{book:t,reload:i}=e,{openBookEdit:n}=tx(i),a=(0,g.useCallback)(async()=>{let e=await e7.u.file({uuid:t.uuid}),i=(0,eK.TI)(),n=t.name,a=`${n}${i}`;(0,e6.saveAs)(e,a)},[t]),o=io(i);return(0,r.jsx)(tb.A,{trigger:["click"],menu:{items:[{key:"edit",label:(0,j.t)("edit"),onClick:()=>n(t.uuid)},{key:"archive",label:t.isArchived?(0,j.t)("unarchive"):(0,j.t)("archive"),onClick:()=>{(0,eJ.bI)(async()=>{await u.N.json({uuid:t.uuid,update:{isArchived:!t.isArchived}}),i()})}},{key:"export-epub",label:`${(0,j.t)("export")} EPUB`,onClick:()=>(0,eJ.bI)(()=>a())},{key:"remove",label:(0,j.t)("remove"),onClick:()=>o([t])}]},children:(0,r.jsx)(b.Ay,{shape:"circle",type:"text",children:(0,r.jsx)(U,{icon:z.nx5})})})}function il(e){let t,{index:i,activated:n,book:a,books:o,onHoverMove:s,onDrop:l,onCancel:c,selectedUuids:d,selectTo:h,reload:p,hasOrder:m}=e,v=(0,el.Zp)(),[,y]=(0,f.fp)(t4),x=(0,g.useRef)(null),[,w]=(0,tA.H)({accept:ii,hover(e){let t=o.findIndex(t=>t.uuid===e.uuid);-1===t||t!==i&&(s(t,i),e.hoverIndex=i)},drop(e){l(e)}}),[{isDragging:k},b]=(0,tL.i)({type:ii,item:()=>({name:a.name,uuid:a.uuid,startIndex:i,hoverIndex:i}),collect:e=>({isDragging:e.isDragging()}),end(e,t){t.didDrop()||c()}});(0,g.useEffect)(()=>{var e;n&&(null==(e=x.current)||e.scrollIntoView({block:"center"}))},[n,w]);let[C,S]=(0,g.useState)(!1),A=`${(t=a.uuid,`${t_.fullRoutePath}?uuid=${t}`)}`;return m||w(x),(0,r.jsxs)("tr",{ref:x,style:{opacity:k?.2:1,background:n?"var(--main-bg-active)":"var(--main-bg)"},children:[(0,r.jsx)("td",{ref:b,style:{cursor:"move"},children:!m&&(0,r.jsx)(U,{size:"lg",icon:z.S9g,style:{marginLeft:4}})}),(0,r.jsx)("td",{children:(0,r.jsx)(tj.A,{checked:d.includes(a.uuid),onClick:e=>{h(i,e.shiftKey)}})}),(0,r.jsx)("td",{align:"center",style:{cursor:"pointer"},children:a.isFavorited?(0,r.jsx)(U,{icon:z.yy,onClick:()=>{(0,eJ.bI)(async()=>{await u.N.json({uuid:a.uuid,update:{isFavorited:!1}}),p()})}}):(0,r.jsx)(U,{icon:tk.yy,onClick:()=>{(0,eJ.bI)(async()=>{await u.N.json({uuid:a.uuid,update:{isFavorited:!0}}),p()})}})}),(0,r.jsx)("td",{children:null!==a.progress&&(0,r.jsxs)("div",{style:{border:"1px solid var(--main-fg)",textAlign:"center",position:"relative"},children:[(100*a.progress).toFixed(),"%",(0,r.jsx)("div",{style:{left:0,top:0,width:`${100*a.progress}%`,height:"100%",position:"absolute",backgroundColor:"var(--main-bg-highlight)"}})]})}),(0,r.jsx)("td",{children:(0,r.jsx)("div",{className:"cell-center",children:(0,r.jsx)("img",{onClick:()=>{_.J.set(X,A)},onLoad:()=>{S(!0)},style:{visibility:C?"visible":"hidden",cursor:"pointer"},src:A,alt:`${a.name} ${(0,j.t)("cover")}`})})}),(0,r.jsx)("td",{className:"hover-MhvhD5",title:a.createdAt.toLocaleString(),onClick:()=>{y(i),v(ia(a.uuid))},children:a.name}),(0,r.jsx)("td",{children:(0,r.jsx)(is,{book:a,reload:p})})]},a.uuid)}function ic(e){let{onRemove:t}=e,[{canDrop:i,isOver:n},a]=(0,tA.H)({accept:ii,drop(e){t(e.uuid)},collect:e=>({isOver:e.isOver(),canDrop:e.canDrop()})});return i?(0,r.jsx)(e5.A,{ref:a,color:n?"error":"warning",icon:n?(0,r.jsx)(U,{icon:z.yLS}):null,children:(0,j.t)("prompt.dropHereToRemove")}):(0,r.jsx)(r.Fragment,{})}function id(){let[e,t]=ie(),[i,n]=(0,f.fp)(t5),[a,o]=(0,g.useState)(null),[s,l]=(0,f.fp)(t4),[c,h]=(0,f.fp)(t8),[m,v]=(0,f.fp)(t6),[y,x]=(0,f.fp)(t9),w=function(e,t,i){let[n,a]=(0,tQ.M)(e,500,void 0);return(0,g.useEffect)(()=>{a(e)},[a,e]),n}(y,0),C=(0,g.useRef)(null),[S,A]=(0,f.fp)(t7),L="default"!==S,{data:P,reload:_}=(0,eh.y3)(tE.n,{filter:{archive:c?"archived":"active",favorite:m?"favorited":"all",search:w,order:S},page:{page:e,perPage:i}},{clearWhenReload:!1}),[I,E]=(0,g.useState)(!1),[N,R]=(0,g.useState)(null),M=(0,g.useCallback)(()=>{R(P?[...P.items]:null)},[P]);(0,g.useEffect)(()=>{M()},[M]);let{selectedBooks:$,allSelected:W,selectedUuids:F,selectTo:D,selectAll:O}=function(e){let[t,i]=(0,g.useState)(),[n,a]=(0,g.useState)([]),r=(0,g.useMemo)(()=>(null==e?void 0:e.filter(e=>n.includes(e.uuid)))??[],[e,n]),o=(0,g.useMemo)(()=>null==e?void 0:e.every(e=>n.includes(e.uuid)),[e,n]);(0,g.useEffect)(()=>{e&&a([])},[e]);let s=(0,g.useCallback)((r,o)=>{let s,l=null==e?void 0:e[r];if(!l)return;i(r);let c=!1;void 0!==t&&t!==r&&o?(s=t<r?e.slice(t,r+1).map(e=>e.uuid):e.slice(r,t+1).map(e=>e.uuid),c=!0):(s=[l.uuid],c=!n.includes(l.uuid));let d=[...n];for(let e of s)c?d.includes(e)||(d=[...d,e]):d=d.filter(t=>t!==e),a(d)},[e,t,n]),l=(0,g.useCallback)(()=>{o?a([]):a((null==e?void 0:e.map(e=>e.uuid))??[])},[o,e]);return{selectedBooks:r,allSelected:o,selectedUuids:n,selectTo:s,selectAll:l}}(N),B=(0,g.useCallback)(()=>{C.current&&C.current.focus()},[]),K=(0,g.useCallback)(()=>{let e=tR.indexOf(S),t=tR[e-1];if(t)A(t);else{let e=tR[tR.length-1];e&&A(e)}},[S,A]),H=(0,g.useCallback)(()=>{let e=tR.indexOf(S),t=tR[e+1];t?A(t):A(tR["0"])},[S,A]),V=io(_),G=(0,g.useCallback)(async e=>{for(let t of[...e.reverse()])await d.K.json({uuid:t.uuid});t(1),_()},[_,t]);!function(e){let{focusSearchInput:t,orderSelectPrev:i,orderSelectNext:n,dataBooks:a,selectTo:r,selectAll:o,selectedBooks:s,reload:l,moveBooksTop:c,removeBooks:d,hasOrder:h}=e,[p,m]=(0,f.fp)(t4),[,v]=ie(),[,y]=(0,f.fp)(t8),[,x]=(0,f.fp)(t6),[w]=ej(),[k]=eC(),{getVoice:b}=ey(),{addHotkeys:C}=T(),{openBookEdit:S}=tx(l),A=(0,el.Zp)(),L=(0,g.useMemo)(()=>null==a?void 0:a.items[p],[p,a]),P=(0,g.useMemo)(()=>s.length?s:L?[L]:[],[L,s]);(0,g.useEffect)(()=>{let e=(null==a?void 0:a.items.length)??0,s=()=>{m(e=>e>0?e-1:0)},f=()=>{m(0)},g=()=>{m(t=>t<e-1?t+1:t)},_=()=>{m(e-1)},I=()=>{a&&v(e=>e>1?e-1:a.pageCount)},E=()=>{a&&v(1)},N=()=>{a&&v(e=>e<a.pageCount?e+1:1)},R=()=>{a&&v(a.pageCount)},T=async()=>{L&&a&&(s(),await ir(a.items,p,-1),l())},M=async()=>{L&&a&&(g(),await ir(a.items,p,1),l())},$=e=>{r(p,e)},W=()=>{L&&d(P)},F=new tZ,U=[["k",(0,j.t)("hotkey.goPrev"),s],["j",(0,j.t)("hotkey.goNext"),g],["ArrowUp",(0,j.t)("hotkey.goPrev"),s],["ArrowDown",(0,j.t)("hotkey.goNext"),g],["h",(0,j.t)("hotkey.goPagePrev"),I],["l",(0,j.t)("hotkey.goPageNext"),N],["ArrowLeft",(0,j.t)("hotkey.goPagePrev"),I],["ArrowRight",(0,j.t)("hotkey.goPageNext"),N],[["g","g"],(0,j.t)("hotkey.goTop"),f],[{shift:!0,key:"g"},(0,j.t)("hotkey.goBottom"),_],[{shift:!0,key:"h"},(0,j.t)("hotkey.goPageFirst"),E],[{shift:!0,key:"l"},(0,j.t)("hotkey.goPageLast"),R],[{shift:!0,key:"ArrowUp"},(0,j.t)("hotkey.goTop"),f],[{shift:!0,key:"ArrowDown"},(0,j.t)("hotkey.goBottom"),_],[{shift:!0,key:"ArrowLeft"},(0,j.t)("hotkey.goPageFirst"),E],[{shift:!0,key:"ArrowRight"},(0,j.t)("hotkey.goPageLast"),R],[["s",{shift:!0,key:"E"}],(0,j.t)("hotkey.listArchive"),()=>{y(e=>!e)}],[["s","b"],(0,j.t)("hotkey.listFavorite"),()=>{x(e=>!e)}],["b",(0,j.t)("hotkey.favorite"),()=>{(0,eJ.bI)(async()=>{for(let e of P)await u.N.json({uuid:e.uuid,update:{isFavorited:!e.isFavorited}});l()})}],[{shift:!0,key:"E"},(0,j.t)("hotkey.archive"),()=>{(0,eJ.bI)(async()=>{for(let e of P)await u.N.json({uuid:e.uuid,update:{isArchived:!e.isArchived}});l()})}],["/",(0,j.t)("hotkey.search"),t],[["s","s","n"],(0,j.t)("hotkey.sortOrder"),n],[["s","s","p"],(0,j.t)("hotkey.sortOrder"),i],["x",(0,j.t)("hotkey.select"),()=>$(!1)],["v",(0,j.t)("hotkey.select"),()=>$(!1)],[{shift:!0,key:"x"},(0,j.t)("hotkey.selectShift"),()=>$(!0)],[{shift:!0,key:"v"},(0,j.t)("hotkey.selectShift"),()=>$(!0)],[{shift:!0,key:"a"},(0,j.t)("hotkey.selectAll"),()=>o()],["t",(0,j.t)("hotkey.goMoveTop"),()=>{L&&c(P)}],["e",(0,j.t)("hotkey.edit"),()=>L&&S(L.uuid)],["Enter",(0,j.t)("hotkey.open"),()=>{L&&A(ia(L.uuid))}],[{shift:!0,key:"#"},(0,j.t)("hotkey.remove"),W],[["d","d"],(0,j.t)("hotkey.remove"),W],[{shift:!0,key:"K"},(0,j.t)("hotkey.speakBookName"),()=>{if(!L)return;let e=b(L);e&&F.speak(L.name,{voice:e,speed:k,isPersonReplace:w})}]];return h||U.push([{ctrl:!0,key:"k"},(0,j.t)("hotkey.goMovePrev"),T],[{ctrl:!0,key:"j"},(0,j.t)("hotkey.goMoveNext"),M],[{ctrl:!0,key:"ArrowUp"},(0,j.t)("hotkey.goMovePrev"),T],[{ctrl:!0,key:"ArrowDown"},(0,j.t)("hotkey.goMoveNext"),M]),C(U)},[P,p,C,L,a,t,b,h,w,c,A,S,n,i,l,d,o,r,m,y,x,v,k])}({focusSearchInput:B,orderSelectPrev:K,orderSelectNext:H,dataBooks:P,reload:_,selectTo:D,selectAll:O,selectedBooks:$,moveBooksTop:G,removeBooks:V,hasOrder:L});let q=(0,g.useCallback)((e,t)=>{if(!N)return;let i=[...N],[n]=i.splice(e,1);n&&i.splice(t,0,n),R(i)},[N]),J=(0,g.useCallback)(e=>{(0,eJ.bI)(async()=>{P&&(E(!0),await ir(P.items,e.startIndex,e.hoverIndex-e.startIndex),_(),E(!1))})},[P,_]),Y=(0,g.useCallback)(()=>{M()},[M]),X=(0,g.useCallback)(e=>{M();let t=null==N?void 0:N.find(t=>t.uuid===e);t&&V([t])},[N,V,M]),Z=(0,g.useMemo)(()=>(0,r.jsxs)(b.Ay.Group,{children:[!F.length&&(0,r.jsx)(b.Ay,{type:"primary",size:"small",onClick:()=>{(0,eJ.bI)(async()=>{let e=await it.u.json({filter:{archive:"all",favorite:"all"}});try{o(0),await ts(e.items,e=>{o(e)})}finally{o(null)}})},children:(0,j.t)("exportAll")}),!!F.length&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(b.Ay,{type:"primary",size:"small",onClick:()=>{(0,eJ.bI)(async()=>{await G($),_()})},children:(0,j.t)("top")}),(0,r.jsx)(b.Ay,{type:"primary",size:"small",onClick:()=>{(0,eJ.bI)(async()=>{let e=await it.u.json({filter:{uuids:F}});try{o(0),await ts(e.items,e=>{o(e)})}finally{o(null)}})},children:(0,j.t)("exportSelected")}),(0,r.jsx)(b.Ay,{type:"primary",size:"small",danger:!0,onClick:()=>{V($)},children:(0,j.t)("remove")})]})]}),[G,_,V,$,F]);if(t2({topRight:(0,g.useMemo)(()=>(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(ic,{onRemove:X}),Z]}),[Z,X]),bottomRight2:(0,g.useMemo)(()=>(0,r.jsx)(eT,{to:"/books/add",children:e=>(0,r.jsx)(b.Ay,{type:"text",shape:"circle",href:e,title:(0,j.t)("add"),children:(0,r.jsx)(U,{icon:z.vkJ})})}),[])}),(0,g.useEffect)(()=>{N&&(N.length<=0?e>1&&t(1):s>N.length-1&&l(N.length-1))},[s,N,e,l,t]),I||!P||!N)return(0,r.jsx)(et,{});let Q=P.pageCount>1?(0,r.jsx)(tC.A,{onChange:e=>t(e),pageSize:i,onShowSizeChange:(e,t)=>n(t),current:e,total:P.count}):null;return(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)(k.A,{direction:"vertical",style:{width:"100%"},children:[null!==a&&(0,r.jsx)(e3.A,{percent:a}),(0,r.jsxs)(eU.A,{layout:"inline",children:[(0,r.jsx)(eU.A.Item,{label:(0,j.t)("archive"),children:(0,r.jsx)(tS.A,{checked:c,onChange:e=>h(e)})}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("favorite"),children:(0,r.jsx)(tS.A,{checked:m,onChange:e=>v(e)})}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("search"),children:(0,r.jsx)(ez.A,{value:y,placeholder:(0,j.t)("search"),onChange:e=>x(e.target.value),ref:C,onKeyDown:e=>{var t;"Escape"===e.key&&(null==(t=C.current)||t.blur())}})}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("sortOrder.label"),children:(0,r.jsx)(eZ.A,{showSearch:!0,filterOption:eQ,popupMatchSelectWidth:!1,value:S,onChange:e=>A(e),options:[{label:(0,j.t)("sortOrder.item.default"),value:"default"},{label:(0,j.t)("sortOrder.item.reverse"),value:"reverse"},{label:(0,j.t)("sortOrder.item.name"),value:"name"},{label:(0,j.t)("sortOrder.item.nameReverse"),value:"name-reverse"}]})})]}),N.length<=0?(0,r.jsx)(p.A,{type:"warning",message:(0,j.t)("prompt.noBooks")}):(0,r.jsxs)(r.Fragment,{children:[Q,(0,r.jsxs)("table",{className:"table-OXXVHq",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{}),(0,r.jsx)("th",{children:(0,r.jsx)(tj.A,{title:(0,j.t)("all"),checked:W,onClick:()=>{O()}})}),(0,r.jsx)("th",{children:(0,j.t)("favorite")}),(0,r.jsx)("th",{children:(0,j.t)("progress")}),(0,r.jsx)("th",{children:(0,j.t)("cover")}),(0,r.jsx)("th",{children:(0,j.t)("bookName")}),(0,r.jsx)("th",{})]})}),(0,r.jsx)("tbody",{children:N.map((e,t)=>(0,r.jsx)(il,{book:e,books:N,index:t,activated:s===t,onHoverMove:q,onDrop:J,onCancel:Y,selectTo:D,selectedUuids:F,reload:_,hasOrder:L},e.uuid))})]}),Q]})]})})}var ih=i(6931),iu=i(7523),ip=i(1689);function ig(e,t){return function(e,t){let i=(0,g.useRef)(e),[n,a]=(0,g.useState)(),[r,o]=(0,g.useState)(),s=(0,g.useCallback)(e=>{i.current().then(t=>{e.aborted||a(t)}).catch(t=>{e.aborted||o(t)})},[]),l=(0,g.useCallback)(function(){let{signal:e,clean:t=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t&&a(void 0),o(void 0),s(e??new AbortController().signal)},[s]);return(0,g.useEffect)(()=>{i.current=e},[e]),(0,g.useEffect)(()=>{let e=new AbortController;return s(e.signal),()=>{e.abort()}},(null==t?void 0:t.deps)??[]),{data:n,error:r,reload:l}}(()=>t(...e),{deps:[JSON.stringify(e)]})}let im=(0,C.eU)(null),iv=()=>{let[e]=(0,f.fp)(im);if(!e)throw Error("BookContext must be used within a BookProvider");return e};var iy=i(4670),ix=i(918),iw=i(9724),ik=i(6145);let{defaultAlgorithm:ib,darkAlgorithm:ij}=ix.A,iC=()=>{let e=(0,iy.U)("(prefers-color-scheme: dark)"),[t]=eA();return"system"===t?e?"dark":"light":t},iS=e=>{let{children:t}=e,i=iC();return(0,r.jsx)(iw.Ay,{theme:{algorithm:"dark"===i?ij:ib,components:{InputNumber:{handleVisible:!0}}},children:(0,r.jsx)(ik.A,{className:"app",children:t})})};var iA=i(9511),iL=i(5129),iP=i(9035),i_=new WeakMap,iI=new WeakMap;class iE{get started(){return(0,iA._)(this,i_).started}set started(e){(0,iA._)(this,i_).started=e,this.events.fire("started",e)}get pos(){return(0,iA._)(this,i_).pos}set pos(e){(0,iA._)(this,i_).pos=e,this.events.fire("pos",e)}set activeNavs(e){(0,iA._)(this,i_).activeNavs=e,this.events.fire("activeNavs",e)}get loading(){return(0,iA._)(this,i_).loading}set loading(e){(0,iA._)(this,i_).loading=e,this.events.fire("loading",e)}get scrollPercent(){return(0,iA._)(this,i_).scrollPercent}set scrollPercent(e){(0,iA._)(this,i_).scrollPercent=e,this.events.fire("scrollPercent",e)}get selection(){return(0,iA._)(this,i_).selection}set selection(e){(0,iA._)(this,i_).selection=e,this.events.fire("selection",e)}get annotations(){return(0,iA._)(this,iI).annotations}get keywords(){return(0,iA._)(this,iI).keywords}get voice(){return(0,iA._)(this,iI).voice}get isPersonReplace(){return(0,iA._)(this,iI).isPersonReplace}get speechSpeed(){return(0,iA._)(this,iI).speechSpeed}get autoNextSection(){return(0,iA._)(this,iI).autoNextSection}get paragraphRepeat(){return(0,iA._)(this,iI).paragraphRepeat}get pageList(){return(0,iA._)(this,iI).pageList}get fontSize(){return(0,iA._)(this,iI).fontSize}get disabledVertical(){return(0,iA._)(this,iI).disabledVertical}get docVisible(){return"visible"===document.visibilityState}get canManipulateDOM(){return this.docVisible||!eu.Fr}syncUIState(e,t){(0,iA._)(this,iI)[e]=t,this.uiEvents.fire(e,t)}constructor(){(0,iL._)(this,i_,{writable:!0,value:{started:!1,pos:{section:0,paragraph:0},activeNavs:[],loading:!1,scrollPercent:void 0,selection:void 0}}),(0,tT._)(this,"events",new iP.Dw),(0,iL._)(this,iI,{writable:!0,value:{annotations:[],keywords:[],isPersonReplace:!1,speechSpeed:1,voice:null,autoNextSection:!1,paragraphRepeat:1,pageList:"double",fontSize:16,disabledVertical:!1}}),(0,tT._)(this,"uiEvents",new iP.Dw)}}var iN=i(2539),iR=i(9355),iT=i(2704),iM=i(6460),i$=i(5739),iW=i(7409);function iF(e){return parseFloat(e.toFixed(10))}function iU(e){if(eu.Fr){let t=1;return void 0!==e.step&&("number"==typeof e.step?t=e.step:"string"==typeof e.step&&(t=parseFloat(e.step))),(0,r.jsxs)(k.A.Compact,{children:[(0,r.jsx)(b.Ay,{size:e.size,onClick:()=>{var i;let n=(e.value??0)-t;null==(i=e.onChange)||i.call(e,iF(n))},children:(0,r.jsx)(F.g,{icon:z.B0C})}),(0,r.jsx)(iW.A,{...e}),(0,r.jsx)(b.Ay,{size:e.size,onClick:()=>{var i;let n=(e.value??0)+t;null==(i=e.onChange)||i.call(e,iF(n))},children:(0,r.jsx)(F.g,{icon:z.INu})})]})}return(0,r.jsx)(iW.A,{...e})}function iz(e){let{children:t}=e;return(0,r.jsx)(eR,{dir:"row",gap:8,style:{alignItems:"center",width:"100%"},children:t})}function iD(e){let{style:t,children:i}=e;return(0,r.jsx)(eY.A,{style:{alignSelf:"start",...t},children:i})}let iO=()=>{let[e,t]=ew();return(0,r.jsx)(iz,{children:(0,r.jsx)(tj.A,{checked:e,onChange:e=>t(e.target.checked),children:(0,j.t)("setting.autoNextSection")})})},iB=()=>{let[e,t]=ek(),[i,n]=eb();return(0,r.jsxs)(iz,{children:[(0,r.jsx)(tj.A,{checked:e,onChange:e=>{t(e.target.checked)},children:(0,j.t)("setting.timer")}),(0,r.jsx)(iU,{style:{width:"80px"},disabled:!e,value:Math.floor(i/60),onChange:e=>{null!==e&&n(Math.floor(60*e))}})]})};function iK(e){let{checked:t,onChange:i}=e;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(tj.A,{checked:t,onChange:e=>{i(e.target.checked)},children:(0,j.t)("setting.personReplace")}),(0,r.jsx)(iN.A,{style:{pointerEvents:"none"},content:(0,r.jsx)(iT.A,{children:Object.entries(y.Xd).map((e,t)=>{let[i,n]=e;return(0,r.jsx)(iT.A.Item,{children:(0,r.jsxs)(k.A,{children:[i,(0,r.jsx)(U,{icon:z.dmS}),n.word," (",n.pinyin,")"]})},t)})}),children:(0,r.jsx)("div",{children:(0,r.jsx)(U,{size:"lg",icon:z.wRm})})})]})}let iH=()=>{let[e,t]=ej();return(0,r.jsx)(iz,{children:(0,r.jsx)(iK,{checked:e,onChange:e=>{t(e)}})})};function iV(){let[e,t]=eE();return(0,r.jsx)(iz,{children:(0,r.jsx)(tj.A,{checked:e,onChange:e=>{t(e.target.checked)},children:(0,j.t)("setting.disabledVertical")})})}let iG=()=>{let[e,t]=eC();return(0,r.jsxs)(iz,{children:[(0,r.jsx)(iD,{children:(0,j.t)("setting.speed")}),(0,r.jsxs)(eR,{style:{flex:1},children:[(0,r.jsx)(iM.A,{value:e,onChange:e=>{t(e)},step:.1,min:.1,max:5}),(0,r.jsx)(iU,{type:"number",value:e,step:.1,onChange:e=>{null!==e&&t(e)}})]})]})},iq=()=>{let[e,t]=eA();return(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)(iz,{children:[(0,r.jsx)(iD,{style:{paddingTop:"4px"},children:(0,j.t)("setting.userColorScheme")}),(0,r.jsx)(i$.A.Group,{value:e,onChange:e=>{t(e.target.value)},children:(0,r.jsx)(k.A,{direction:"vertical",children:eS.map(e=>(0,r.jsx)(i$.A,{value:e,children:(0,j.t)(e)},e))})})]})})},iJ=()=>{let[e,t]=eL();return(0,r.jsxs)(iz,{children:[(0,r.jsxs)("span",{children:[(0,j.t)("setting.paragraphRepeat"),":"]}),(0,r.jsx)(iU,{style:{width:80},value:e,onChange:e=>{e&&t(e<1?1:Math.floor(e))}})]})};function iY(){let[e,t]=e_();return(0,r.jsxs)(iz,{children:[(0,r.jsx)(iD,{style:{paddingTop:"4px"},children:(0,j.t)("setting.pageList")}),(0,r.jsx)(i$.A.Group,{value:e,onChange:e=>{t(e.target.value)},children:(0,r.jsx)(k.A,{direction:"vertical",children:eP.map(e=>(0,r.jsx)(i$.A,{value:e,children:(0,j.t)(`setting.pageListType.${e}`)},e))})})]})}function iX(){let[e,t]=eI();return(0,r.jsxs)(iz,{children:[(0,r.jsx)("span",{children:(0,j.t)("setting.fontSize")}),(0,r.jsx)(iU,{style:{width:80},value:e,onChange:e=>{null!==e&&t(e<1?1:Math.floor(e))}})]})}let iZ=()=>(0,r.jsxs)(k.A,{direction:"vertical",children:[(0,r.jsx)(iO,{}),(0,r.jsx)(iB,{}),(0,r.jsx)(iH,{}),(0,r.jsx)(iV,{}),(0,r.jsx)(iG,{}),(0,r.jsx)(iq,{}),(0,r.jsx)(iJ,{}),(0,r.jsx)(iY,{}),(0,r.jsx)(iX,{})]});var iQ=i(1769);let i0=(0,C.eU)(!1),i1={};function i2(){return(0,g.useCallback)(async e=>{var t;null==(t=i1.callback)||t.call(i1,e)},[])}function i3(e){let{open:t,player:i,searchResponse:n}=e,[a,o]=(0,g.useState)(0),s=(0,g.useRef)(null),l=(0,g.useCallback)(async e=>{await i.gotoPos({section:e.section,paragraph:e.paragraph})},[i]);(0,g.useEffect)(()=>{if(a<0)return;let e=s.current;if(!e)return;let t=e.querySelector("li.text.selected");null==t||t.scrollIntoView({block:"center"})},[a]);let{addHotkeys:c}=T();if((0,g.useEffect)(()=>{if(!t||!n)return;let e=n.matches,i=async()=>{let t=e.at(a);t&&await l(t)};return c([["p",(0,j.t)("hotkey.prevSearchResult"),()=>{o(e=>e<=0?0:e-1)}],["n",(0,j.t)("hotkey.nextSearchResult"),()=>{o(t=>t>=e.length-1?e.length-1:t+1)}],["enter",(0,j.t)("hotkey.gotoSearchResult"),i]],{level:2})},[c,l,t,n,a]),!n)return null;if(0===n.matches.length)return(0,r.jsx)(p.A,{type:"warning",message:(0,j.t)("prompt.noSearchMatches")});let d=n.search.length;return(0,r.jsxs)("div",{className:"bookSearchResult-wN3fTI",ref:s,children:[(0,r.jsx)("ul",{children:n.matches.map((e,t)=>{let i=["text","clickable"];t===a&&i.push("selected");let s=e.text.slice(0,e.start),c=e.text.slice(e.start+d);return(0,r.jsxs)("li",{className:i.join(" "),onClick:()=>{l(e),o(t)},children:[e.nav&&(0,r.jsx)("strong",{children:e.nav}),(0,r.jsxs)("div",{children:[s,(0,r.jsx)("span",{className:"highlight",children:n.search}),c]})]},t)})}),(0,r.jsxs)("div",{className:"stats",children:[a+1," / ",n.matches.length]})]})}function i5(e){let{refSearchInput:t,player:i}=e,[n,a]=(0,f.fp)(i0),{uuid:o}=iv(),[s,l]=(0,g.useState)(""),[c,d]=(0,g.useState)(!1),[u,p]=(0,g.useState)(null),m=i2();return i1.callback=(0,g.useCallback)(async e=>{var i;a(!0),l(e),c||(p(null),d(!0),p(await h.O.json({uuid:o,search:e})),d(!1),null==(i=t.current)||i.blur())},[c,t,a,o]),(0,ei.u)(()=>{setTimeout(()=>{t.current&&t.current.focus()},100)}),(0,r.jsxs)(eR,{style:{width:"100%",height:"100%"},gap:8,children:[(0,r.jsxs)(eR,{dir:"row",gap:8,children:[(0,r.jsx)(ez.A,{className:"flex-1",ref:t,value:s,onChange:e=>l(e.target.value),onKeyDown:e=>{if("Escape"===e.key){var i;(0,A.aI)(e),null==(i=t.current)||i.blur()}else"Enter"===e.key&&m(s)}}),(0,r.jsx)(b.Ay,{onClick:()=>{m(s)},loading:c,children:(0,r.jsx)(F.g,{icon:z.MjD})})]}),(0,r.jsx)(i3,{open:n,player:i,searchResponse:u})]})}function i4(e){let{player:t}=e,[i,n]=(0,f.fp)(i0),a=(0,g.useRef)(null),o=(0,g.useCallback)(()=>{n(!0),setTimeout(()=>{var e;null==(e=a.current)||e.focus()},100)},[n]),{addHotkeys:s}=T();return(0,g.useEffect)(()=>s([["/",(0,j.t)("search"),o]],{level:2}),[s,o]),W(()=>{n(!1)},{enable:i}),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(b.Ay,{block:!0,type:"primary",icon:(0,r.jsx)(F.g,{icon:z.MjD}),onClick:()=>{o()},children:(0,j.t)("search")}),(0,r.jsx)(iQ.A,{forceRender:!0,title:(0,j.t)("search"),open:i,onClose:()=>n(!1),children:(0,r.jsx)(i5,{refSearchInput:a,player:t})})]})}var i8=i(56);let i6=e=>({position:"absolute",top:0,width:e.width+10,height:"100%",display:"flex",justifyContent:"center",alignItems:"center",color:e.color??"var(--main-fg-blue)",background:e.background??"var(--main-bg-blue)",opacity:0});function i9(e){let{children:t,left:i,right:n}=e,a=(0,g.useRef)(null),[o,s]=(0,g.useState)(),[l,c]=(0,g.useState)();return(0,g.useEffect)(()=>{if(a.current)return function(e,t){let{left:i,leftElement:n,right:a,rightElement:r}=t;if(!i&&!a)return;let o=null,s=null,l=e=>{e.touches[0]&&(o={x:e.touches[0].clientX,y:e.touches[0].clientY},s=0)},c=t=>{if(!o)return;let l=t.touches[0];if(!l)return;let[c,d]=(e=>{let{clientX:t,clientY:i}=e;return[t,i]})(l),h=c-o.x,u=Math.abs(h);if(!(Math.abs(d-o.y)>30)){if(u>5&&(0,A.aI)(t),i&&n&&h>0){let t=Math.min(u,i.width+10);s=t,e.style.transform=`translateX(${t}px)`,n.style.opacity=u>i.width?"1":"0.5"}else if(a&&r&&h<0){let t=Math.min(u,a.width+10);s=-t,e.style.transform=`translateX(${-t}px)`,r.style.opacity=u>a.width?"1":"0.5"}}},d=()=>{!o||(o=null,e.style.transform="",n&&(n.style.opacity="0"),r&&(r.style.opacity="0"),s&&(i&&s>i.width?i.trigger():a&&r&&s<-a.width&&a.trigger(),s=null))};return e.addEventListener("touchstart",l),e.addEventListener("touchmove",c),e.addEventListener("touchend",d),()=>{e.removeEventListener("touchstart",l),e.removeEventListener("touchmove",c),e.removeEventListener("touchend",d)}}(a.current,{left:i,leftElement:o,right:n,rightElement:l})},[i,o,n,l]),(0,r.jsxs)("div",{style:{position:"relative",willChange:"transform"},ref:a,children:[i&&(0,r.jsx)("div",{ref:e=>s(e??void 0),className:"swipe-left-node",style:{...i6(i),right:"100%"},children:i.node}),t,n&&(0,r.jsx)("div",{ref:e=>c(e??void 0),className:"swipe-right-node",style:{...i6(n),left:"100%"},children:n.node})]})}function i7(e){let{annotation:t,openNoteEdit:i,isSelected:n,isActivated:a,player:o}=e,s=["text","clickable"];a&&s.push("active"),n&&s.push("selected");let l=[{key:"note",icon:(0,r.jsx)(U,{icon:z.n0g,size:"sm"}),label:(0,j.t)("note"),onClick:()=>{i(t,o)}},{key:"remove",icon:(0,r.jsx)(U,{icon:z.yLS,size:"sm"}),label:(0,j.t)("remove"),onClick:()=>{o.annotations.remove(t)}}];return(0,r.jsx)("li",{"data-pos-section":t.pos.section,"data-pos-paragraph":t.pos.paragraph,children:(0,r.jsx)(i9,{left:{node:(0,r.jsx)(U,{icon:z.n0g,size:"sm"}),width:30,trigger:()=>{i(t,o)}},right:{node:(0,r.jsx)(U,{icon:z.yLS,size:"sm"}),width:30,trigger:()=>{o.annotations.remove(t)}},children:(0,r.jsx)(tb.A,{menu:{items:l},trigger:["contextMenu"],children:(0,r.jsxs)("div",{className:"item",children:[(0,r.jsxs)("div",{className:s.join(" "),style:{fontSize:13},onClick:e=>{(0,A.aI)(e),o.gotoSection(t.pos.section,t.pos.paragraph).catch(console.error)},children:[t.brief,t.range&&(0,r.jsx)("div",{className:"range",children:(0,r.jsx)("span",{className:"selected-text",children:t.range.selectedText})}),t.note&&(0,r.jsxs)("div",{className:"note",children:["note: ",t.note]})]}),!eu.Fr&&(0,r.jsx)("div",{className:"btn",children:(0,r.jsx)(tb.A,{menu:{items:l},children:(0,r.jsx)("div",{children:(0,r.jsx)(U,{icon:z.nx5,style:{paddingLeft:"8px",paddingRight:"8px"}})})})})]})})})})}function ne(e){let{annotations:t,activeAnnotationIndex:i,closestAnnotationIndex:n,player:a}=e,{addHotkeys:o}=T(),[s,l]=(0,g.useState)(0),c=(0,g.useRef)(null),{openNoteEdit:d,NoteEditDialog:h}=function(e){let{player:t}=e,[i,n]=(0,g.useState)(null),[a,o]=(0,g.useState)();(0,g.useEffect)(()=>{i&&o(i.note)},[i]);let s=(0,g.useCallback)(()=>{i&&t.annotations.upsert({pos:i.pos,range:i.range,uuid:i.uuid},{color:i.color,group:i.group,note:a}),n(null)},[i,a,t.annotations]),l=(0,g.useCallback)(()=>{n(null)},[]);return{openNoteEdit:n,NoteEditDialog:(0,r.jsxs)(w.A,{open:!!i,onCancel:l,footer:!1,title:`${(0,j.t)("annotation")} ${(0,j.t)("note")}`,children:[(0,r.jsx)(eY.A,{children:null==i?void 0:i.brief}),(0,r.jsxs)("form",{onSubmit:e=>{(0,A.aI)(e),s()},children:[(0,r.jsx)(eU.A.Item,{label:(0,j.t)("note"),children:(0,r.jsx)(eR,{gap:8,children:(0,r.jsx)(th,{autoFocus:!0,value:a,onChange:e=>o(e.target.value)})})}),(0,r.jsx)(eU.A.Item,{children:(0,r.jsx)(b.Ay,{type:"primary",htmlType:"submit",children:(0,j.t)("update")})})]})]})}}({player:a}),u=(0,g.useMemo)(()=>null==t?void 0:t.at(s),[t,s]),p=(0,g.useCallback)(async()=>{u&&await a.annotations.remove(u)},[a.annotations,u]);return(0,g.useEffect)(()=>o([["p",(0,j.t)("hotkey.prevAnnotation"),()=>{l(e=>e<=0?0:e-1)}],["n",(0,j.t)("hotkey.nextAnnotation"),()=>{t&&l(e=>e>=t.length-1?t.length-1:e+1)}],["enter",(0,j.t)("hotkey.gotoAnnotation"),()=>{let e=null==t?void 0:t[s];e&&a.gotoSection(e.pos.section,e.pos.paragraph).catch(console.error)}],[["d","b"],(0,j.t)("hotkey.annotationRemoveSelected"),()=>p()],[["g","n"],(0,j.t)("hotkey.annotationNote"),()=>d(u??null)],[{shift:!0,key:"K"},(0,j.t)("hotkey.speakAnnotation"),()=>{u&&a.utterer.speakText(u.brief).catch(console.error)}]]),[o,t,d,a,p,u,s]),(0,g.useEffect)(()=>{null!==n&&l(n)},[n]),(0,g.useEffect)(()=>{if(!u)return;let e=c.current;if(!e)return;let t=e.querySelector("div.text.selected");null==t||t.scrollIntoView({block:"center"})},[u]),(0,r.jsxs)("div",{className:"panel-content book-annotations",ref:c,children:[(null==t?void 0:t.length)?(0,r.jsx)("ul",{children:t.map((e,t)=>(0,r.jsx)(i7,{annotation:e,openNoteEdit:d,isActivated:i===t,isSelected:s===t,player:a},t))}):(0,j.t)("desc.annotationsEmpty"),h]})}var nt=i(2332);function ni(e){let{keyword:t,openEdit:i,isSelected:n,player:a}=e,o=i2(),s=["text","clickable"];n&&s.push("selected");let l=[{key:"note",icon:(0,r.jsx)(U,{icon:z.n0g,size:"sm"}),label:(0,j.t)("note"),onClick:()=>{i(t,a)}},{key:"remove",icon:(0,r.jsx)(U,{icon:z.yLS,size:"sm"}),label:(0,j.t)("remove"),onClick:()=>{a.keywords.remove(t)}},{key:"search",icon:(0,r.jsx)(U,{icon:z.MjD,size:"sm"}),label:(0,j.t)("search"),onClick:()=>{o(t.keyword)}}];return(0,r.jsx)("li",{children:(0,r.jsx)(i9,{left:{node:(0,r.jsx)(U,{icon:z.n0g,size:"sm"}),width:30,trigger:()=>{i(t,a)}},right:{node:(0,r.jsx)(U,{icon:z.yLS,size:"sm"}),width:30,trigger:()=>{a.keywords.remove(t)}},children:(0,r.jsx)(tb.A,{menu:{items:l},trigger:["contextMenu"],children:(0,r.jsxs)("div",{className:"item",children:[(0,r.jsxs)("div",{className:s.join(" "),style:{fontSize:13},onClick:e=>{(0,A.aI)(e),a.gotoSection(t.pos.section,t.pos.paragraph).catch(console.error)},children:[t.keyword,t.alias&&(0,r.jsx)("div",{className:"alias",children:(0,r.jsx)(k.A,{wrap:!0,children:t.alias.map((e,t)=>(0,r.jsx)("span",{className:"selected-text",children:e},t))})}),(0,r.jsx)("div",{className:"range",children:(0,r.jsx)("span",{className:"selected-text",children:t.brief})}),t.note&&(0,r.jsxs)("div",{className:"note",children:["note: ",t.note]})]}),(0,r.jsx)("div",{className:"btn",children:(0,r.jsx)(tb.A,{menu:{items:l},children:(0,r.jsx)("div",{children:(0,r.jsx)(U,{icon:z.nx5,style:{paddingLeft:"8px",paddingRight:"8px"}})})})})]})})})})}function nn(e){let{keywords:t,player:i}=e,{addHotkeys:n}=T(),[a,o]=(0,g.useState)(0),s=(0,g.useRef)(null),{openEdit:l,EditDialog:c}=function(e){let{player:t}=e,[i,n]=(0,g.useState)(null),[a,o]=(0,g.useState)(),[s,l]=(0,g.useState)();(0,g.useEffect)(()=>{var e;i&&(o(null==(e=i.alias)?void 0:e.join("\n")),l(i.note))},[i]);let c=(0,g.useCallback)(()=>{i&&t.keywords.upsert({pos:i.pos,uuid:i.uuid,keyword:i.keyword},{color:i.color,note:s,alias:null==a?void 0:a.split("\n").map(e=>e.trim()).filter(e=>e)}),n(null)},[a,i,s,t.keywords]),d=(0,g.useCallback)(()=>{n(null)},[]);return{openEdit:n,EditDialog:(0,r.jsxs)(w.A,{open:!!i,onCancel:d,footer:!1,title:`${(0,j.t)("keyword")} ${(0,j.t)("note")}`,children:[(0,r.jsx)(eY.A,{children:null==i?void 0:i.keyword}),(0,r.jsxs)("form",{onSubmit:e=>{(0,A.aI)(e),c()},children:[(0,r.jsx)(eU.A.Item,{label:(0,j.t)("alias"),children:(0,r.jsx)(eR,{gap:8,children:(0,r.jsx)(th,{autoFocus:!0,value:a,onChange:e=>o(e.target.value)})})}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("note"),children:(0,r.jsx)(eR,{gap:8,children:(0,r.jsx)(th,{value:s,onChange:e=>l(e.target.value)})})}),(0,r.jsx)(eU.A.Item,{children:(0,r.jsx)(b.Ay,{type:"primary",htmlType:"submit",children:(0,j.t)("update")})})]})]})}}({player:i}),d=(0,g.useMemo)(()=>null==t?void 0:t.at(a),[t,a]),h=(0,g.useCallback)(async()=>{d&&await i.keywords.remove(d)},[i.keywords,d]);return(0,g.useEffect)(()=>n([["p",(0,j.t)("hotkey.prevKeyword"),()=>{o(e=>e<=0?0:e-1)}],["n",(0,j.t)("hotkey.nextKeyword"),()=>{t&&o(e=>e>=t.length-1?t.length-1:e+1)}],["enter",(0,j.t)("hotkey.gotoKeyword"),()=>{let e=null==t?void 0:t[a];e&&i.gotoSection(e.pos.section,e.pos.paragraph).catch(console.error)}],[["d","b"],(0,j.t)("hotkey.keywordRemoveSelected"),()=>h()],[["g","n"],(0,j.t)("hotkey.keywordNote"),()=>l(d??null)],[{shift:!0,key:"K"},(0,j.t)("hotkey.speakKeyword"),()=>{d&&i.utterer.speakText(d.keyword).catch(console.error)}]]),[n,t,l,i,h,d,a]),(0,g.useEffect)(()=>{if(!d)return;let e=s.current;if(!e)return;let t=e.querySelector("div.text.selected");null==t||t.scrollIntoView({block:"center"})},[d]),(0,r.jsxs)("div",{className:"panel-content book-keywords",ref:s,children:[(null==t?void 0:t.length)?(0,r.jsx)("ul",{children:t.map((e,t)=>(0,r.jsx)(ni,{keyword:e,openEdit:l,isSelected:a===t,player:i},t))}):(0,j.t)("desc.keywordsEmpty"),c]})}function na(e){let{navs:t,activeNavs:i,selectedNav:n,player:a}=e;return t.length?(0,r.jsx)("ul",{children:t.map((e,t)=>{let o=n===e,s=void 0!==e.spineIndex&&i.includes(e),l=["text"];return s&&l.push("active"),e.href&&l.push("clickable"),o&&l.push("selected"),(0,r.jsxs)("li",{"data-href":e.href,"data-spine-index":e.spineIndex,children:[(0,r.jsx)("div",{className:"item",onClick:t=>{(0,A.aI)(t),e.href&&a.gotoUrlPath(e.href).catch(console.error)},children:(0,r.jsx)("div",{className:l.join(" "),children:e.label})}),(0,r.jsx)(na,{navs:e.children,activeNavs:i,selectedNav:n,player:a})]},t)})}):null}function nr(e){let{book:t,activeNavs:i,player:n}=e,{addHotkeys:a}=T(),o=(0,g.useRef)(null),[s,l]=(0,g.useState)(0),c=(0,g.useMemo)(()=>t.flattenedNavs[s],[t.flattenedNavs,s]);(0,g.useEffect)(()=>a([["p",(0,j.t)("hotkey.prevNav"),()=>{l(e=>e<=0?0:e-1)}],["n",(0,j.t)("hotkey.nextNav"),()=>{l(e=>e>=t.flattenedNavs.length-1?t.flattenedNavs.length-1:e+1)}],["enter",(0,j.t)("hotkey.gotoNav"),()=>{(null==c?void 0:c.href)&&n.gotoUrlPath(c.href).catch(console.error)}],[{shift:!0,key:"K"},(0,j.t)("hotkey.speakNav"),()=>{c&&n.utterer.speakText(c.label).catch(console.error)}]]),[a,t.flattenedNavs,n,c]);let d=(0,g.useMemo)(()=>null==i?void 0:i.at(-1),[i]);return(0,g.useEffect)(()=>{if(void 0===d)return;let e=t.flattenedNavs.indexOf(d);-1!==e&&l(e)},[t.flattenedNavs,d]),(0,g.useEffect)(()=>{if(!c)return;let e=o.current;if(!e)return;let t=e.querySelector("div.text.selected");null==t||t.scrollIntoView({block:"center"})},[c]),(0,r.jsx)("div",{ref:o,className:"panel-content book-nav",children:t.navs.length?(0,r.jsx)(na,{navs:t.navs,activeNavs:i??[],selectedNav:c,player:n}):(0,j.t)("desc.navEmpty")})}function no(e){return(0,r.jsx)(b.Ay,{style:{padding:"14px 4px"},size:"small",type:"primary",...e})}function ns(e){let{hotkey:t,description:i,...n}=e,a=(0,g.useMemo)(()=>(0,r.jsxs)(k.A,{children:[i,t?(0,r.jsx)("span",{className:"keyboard",children:t}):null]}),[i,t]);return(0,r.jsx)(no,{...n,children:(0,r.jsx)(iN.A,{style:{pointerEvents:"none"},content:eu.Fr?null:a,placement:"top",children:(0,r.jsx)("div",{children:n.children})})})}function nl(e){let{started:t,player:i,stopTimerEnabled:n,stopTimerSeconds:a}=e,o=(0,g.useRef)(),[s,l]=(0,g.useState)(0),[c,d]=(0,g.useState)(a);(0,g.useEffect)(()=>{let e;if(!t||!n)return;if(!s)return l(e=>e+1);let r=o.current??0,c=Date.now()/1e3,h=()=>{let t=Date.now()/1e3-c+r;o.current=t;let n=a-t;if(n<=0){i.pause(),o.current=0,e&&clearInterval(e),d(0);return}d(n)};return h(),e=setInterval(h,1e3),()=>{clearInterval(e)}},[s,i,t,n,a]);let h=(0,g.useMemo)(()=>`${Math.floor(c/60).toString().padStart(2,"0")}
      :${(c%60).toFixed(0).padStart(2,"0")}`,[c]);return n?(0,r.jsx)(e5.A,{onClick:()=>{o.current=0,l(e=>e+1),d(a)},children:h}):(0,r.jsx)(r.Fragment,{})}function nc(){let{book:e,reload:t}=iv(),{openBookEdit:i}=tx(t),{addHotkey:n}=T();return(0,g.useEffect)(()=>n("e",(0,j.t)("hotkey.editBook"),()=>{i(e.item.uuid)},{level:100}),[n,e.item.uuid,i]),(0,r.jsx)(b.Ay,{block:!0,type:"primary",onClick:()=>i(e.item.uuid),children:(0,j.t)("editBook")})}function nd(){let{book:e}=iv(),{voiceURI:t,setVoiceURI:i,allSortedVoices:n}=ex(e.item),a=(0,g.useMemo)(()=>n.map(e=>({label:e.name,value:e.voiceURI})),[n]);return(0,r.jsx)(iz,{children:(0,r.jsx)(eZ.A,{showSearch:!0,filterOption:eQ,popupMatchSelectWidth:!1,style:{width:"100%"},value:t,onChange:e=>i(e),options:a})})}var nh=i(4845),nu=i.n(nh),np=i(7782),nf=i(3281);class ng{async upsert(e,t){var i;let{uuid:n,pos:a,range:r}=e,{note:o,color:s,group:l}=t,c=this.player.iframeCtrler.readableParts.at(a.paragraph);if(!c)return;if("text"!==c.type)return void(0,G.iA)().error((0,j.t)("desc.annotationNoSupported"));let d=c.text.slice(0,30),h=await nf.h.json({annotations:[{uuid:n,pos:a,range:r??void 0,brief:d,type:"text",content:c.text,note:o||void 0,color:s,group:l}],uuid:this.uuid});return null==(i=this.reload)||i.call(this),(0,G.iA)().info(`${(0,j.t)("desc.annotationUpdated")} ${d}`),h.annotations.at(0)}async remove(e){var t;if(e.note||e.range){let t=e.color?nu()(e.color,{black:"#3a3a3a",white:"#fafafa"}):"var(--main-fg-blue)";if(!await O({title:(0,j.t)("prompt.annotationRemoveConfirm"),description:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("p",{children:e.brief}),e.note&&(0,r.jsxs)("p",{children:["Note: ",e.note]}),e.range&&(0,r.jsxs)("p",{children:["Selected:"," ",(0,r.jsx)("span",{style:{backgroundColor:e.color??"var(--main-bg-blue)",color:t},children:e.range.selectedText})]})]})}))return}await np.l.json({uuid:this.uuid,annotationUuids:[e.uuid]}),null==(t=this.reload)||t.call(this),(0,G.iA)().info(`${(0,j.t)("desc.annotationDeleted")} ${e.brief}`)}indexByPos(e,t){let i=this.player.states.annotations;if(!i)return null;let n=i.findIndex(i=>{var n,a;return i.pos.section===e.section&&i.pos.paragraph===e.paragraph&&(null==(n=i.range)?void 0:n.start)===(null==t?void 0:t.start)&&(null==(a=i.range)?void 0:a.end)===(null==t?void 0:t.end)});return -1===n?null:n}closestIndexByPos(e){let t=this.player.states.annotations;if(!t)return null;let i=t.findLastIndex(t=>t.pos.section===e.section&&t.pos.paragraph<=e.paragraph);return -1===i?null:i}byPos(e,t){var i;let n=this.indexByPos(e,t);return null===n?null:(null==(i=this.player.states.annotations)?void 0:i.at(n))??null}async toggle(e,t){let i=this.byPos(e,t);i?await this.remove(i):await this.upsert({pos:e,range:t,uuid:null},{})}constructor(e){(0,tT._)(this,"player",void 0),(0,tT._)(this,"uuid",void 0),(0,tT._)(this,"reload",void 0),this.player=e,this.uuid=e.book.item.uuid}}var nm=i(547),nv=i(1976);let ny=new ti.F("books/render",{method:"get",isDynamic:!0}).routeLogined(async e=>{let{req:t,res:i,userInfo:n}=e,[a,...r]=t.paths;if(!a)throw new tP.li("uuid not found");let o=await tt.J.book(n.account,a),s=decodeURI(eF().join(...r)),l=await o.file(s);if(!l)throw new tP.li("Path in book not found");let c=l.mediaType??nv.contentType(eF().basename(s));return c&&i.header("Content-Type",c),l.buffer}),nx=(e,t)=>eF().join(ny.fullRoutePath,e,t);var nw=i(5121);async function nk(e,t){let{iteration:i=10,duration:n=100,abortCtrl:a}=e,r=!1;null==a||a.signal.addEventListener("abort",()=>{r=!0});let o=n/i;for(let e of(0,S.y1)(0,i+1)){if(await (0,eJ.yy)(o),r)break;await t(e)}}var nb=i(8820);let nj=`
  :root {
    --main-bg: white;
    --main-bg-active: #ddd;
    --main-bg-hover: #e3e3e3;
    --main-fg: #111;
    --main-fg-active: #111;
    --main-fg-hover: #111;
    --main-border: #666;
    --main-bg-blue: #03c;
    --main-fg-blue: #DDD;
    --main-bg-highlight: rgba(10, 120, 220, 0.3);
    --main-bg-symbol: rgba(10, 120, 220, 0.6);
    --main-fg-highlight: var(--main-fg);
  }
  :root.${y.aK}  {
    --main-bg: #1a1b1e;
    --main-bg-active: #555;
    --main-bg-hover: #444;
    --main-fg: #ccc;
    --main-fg-active: #ccc;
    --main-fg-hover: #ccc;
    --main-border: #777;
  }
`;var nC=i(4904),nS=i(6844),nA=new WeakMap,nL=new WeakMap,nP=new WeakSet,n_=new WeakSet,nI=new WeakMap,nE=new WeakSet,nN=new WeakSet,nR=new WeakSet;class nT{get doc(){return this.iframeCtrl.doc}reCreateRoot(e){e.querySelectorAll(`.${this.rootClass}`).forEach(e=>e.remove()),(0,nm._)(this,nA,e.createElement("div")),(0,iA._)(this,nA).classList.add(this.rootClass),e.documentElement.appendChild((0,iA._)(this,nA)),(0,iA._)(this,nL).clear()}highlight(e,t){this.iframeCtrl.tryManipulateDOM(()=>{(0,nC._)(this,nR,nU).call(this,e,t)}).catch(console.error)}highlightHide(){this.iframeCtrl.tryManipulateDOM(()=>{(0,nC._)(this,nP,nM).call(this)}).catch(console.error)}constructor(e,t){(0,nS._)(this,nP),(0,nS._)(this,n_),(0,nS._)(this,nE),(0,nS._)(this,nN),(0,nS._)(this,nR),(0,tT._)(this,"iframeCtrl",void 0),(0,tT._)(this,"states",void 0),(0,tT._)(this,"highlightedElems",void 0),(0,iL._)(this,nA,{writable:!0,value:void 0}),(0,iL._)(this,nL,{writable:!0,value:void 0}),(0,iL._)(this,nI,{writable:!0,value:void 0}),this.iframeCtrl=e,this.states=t,this.highlightedElems=[],(0,nm._)(this,nL,new Map),(0,nm._)(this,nI,function(e,t){let i=!1;return function(){for(var n=arguments.length,a=Array(n),r=0;r<n;r++)a[r]=arguments[r];if(!i){let n=t(...a);return i=!0,setTimeout(()=>i=!1,e),n}}}(1e3,e=>{if(this.doc&&e.length)if(this.iframeCtrl.enabledPageList){let t=(0,S.cz)(e.map(e=>e.left))/e.length;this.iframeCtrl.pageListScrollToLeft(t).catch(console.error)}else if(this.iframeCtrl.isVertical){let t=(0,S.cz)(e.map(e=>e.right))/e.length;this.iframeCtrl.scrollToLeft(t).catch(console.error)}else{let t=(0,S.cz)(e.map(e=>e.top))/e.length;this.iframeCtrl.scrollToTop(t).catch(console.error)}}))}}function nM(){let e=(0,iA._)(this,nA);e&&Array.from(e.children).forEach(e=>{e.style.display="none"})}function n$(e,t){let i=this.doc,n=(0,iA._)(this,nA);if(!i||!n)return;let a=(e,t)=>{let a=(0,iA._)(this,nL).get(e);return a||(a=i.createElement("div"),t&&(a.style.backgroundColor=t),(0,iA._)(this,nL).set(e,a),n.appendChild(a)),a},r=i.documentElement.getBoundingClientRect(),o=e.map(e=>[...e.range.getClientRects()].map(e=>({width:e.width,height:e.height,left:e.left-r.left,right:e.right-r.right,top:e.top-r.top,bottom:e.bottom-r.top}))).flat();for(let[e,t]of((0,nC._)(this,nP,nM).call(this),o.entries())){let i=a(e,t.color);i.style.display="block",i.style.top=`${t.top}px`,i.style.left=`${t.left}px`,i.style.width=`${t.width}px`,i.style.height=`${t.height}px`}t&&(0,iA._)(this,nI).call(this,o)}function nW(e,t){if(!e.childNodes.length)return{type:1,remainIndex:t};let i=t;for(let t of e.childNodes){if((0,A.ir)(t)){if(!t.textContent)continue;if(i<=t.textContent.length)return{type:0,node:t,index:i};i-=t.textContent.length;continue}if(this.ignoreClass&&(0,A.vq)(t)&&t.closest(`.${this.ignoreClass}`))continue;let e=(0,nC._)(this,nE,nW).call(this,t,i);switch(e.type){case 0:return e;case 1:i=e.remainIndex;continue}}return{type:1,remainIndex:i}}function nF(e,t){let i=(0,nC._)(this,nE,nW).call(this,e,t);return 0===i.type?i:null}function nU(e,t){if(!this.doc)return;let i=[];for(let t of e){let{node:e,charIndex:n,charLength:a,color:r}=t,o=document.createRange(),s=(0,nC._)(this,nN,nF).call(this,e.elem,n);if(!s)continue;let l=(0,nC._)(this,nN,nF).call(this,e.elem,n+a);if(l){try{o.setStart(s.node,s.index),o.setEnd(l.node,l.index)}catch(e){console.error(e);continue}i.push({range:o,color:r})}}(0,nC._)(this,n_,n$).call(this,i,t)}class nz extends nT{constructor(...e){super(...e),(0,tT._)(this,"rootClass",y.b_),(0,tT._)(this,"ignoreClass",null)}}class nD extends nT{constructor(...e){super(...e),(0,tT._)(this,"rootClass",y.ZG),(0,tT._)(this,"ignoreClass",null)}}var nO=new WeakMap,nB=new WeakMap,nK=new WeakMap;class nH{get book(){return this.player.book}get iframe(){return this.iframeRef.current}get enabledPageList(){return"none"!==this.states.pageList&&!this.isVertical}get isFirstPageList(){return this.pageListCurIndex<=0}get isLastPageList(){return!this.pageListCount||this.pageListCurIndex>=this.pageListCount-1}pageListType(){if("auto"===this.states.pageList)if(this.win)return this.win.innerWidth>700?"double":"single";else return"single";return this.states.pageList}async tryManipulateDOM(e){await Promise.race([e(),(0,eJ.yy)(100)])}getReadablePartIndexByAnchorId(e){if(!e||!this.doc)return null;try{let t=this.readableParts.findIndex(t=>{var i;if(null==(i=t.anchorIds)?void 0:i.includes(e))return!0});return -1===t?null:t}catch{}return null}async scrollToCurParagraph(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0],t=this.readableParts.at(this.states.pos.paragraph);t?await this.scrollToElem(t.elem,{animated:e}):this.enabledPageList&&await this.pageListScrollToLeft(this.pageListScrollLeft,{animated:e})}async scrollToElem(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};await this.tryManipulateDOM(async()=>{if(!this.doc)return;let i=this.doc.documentElement.getBoundingClientRect(),n=e.getBoundingClientRect();if(this.enabledPageList){let a=n.left+e.offsetWidth/2-i.left;await this.pageListScrollToLeft(a,t)}else if(this.isVertical){let a=n.right+e.offsetWidth/2-i.right;await this.scrollToLeft(a,t)}else{let e=n.top-i.top;await this.scrollToTop(e,t)}})}async scrollToLeft(e){var t;let{iteration:i=10,duration:n=100,animated:a=!0,abortCtrl:r,position:o="center"}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.win)return;let s=null==(t=this.doc)?void 0:t.scrollingElement;if(!s)return;let l="center"===o?e+this.win.innerWidth/2:e;if(a){let e=s.scrollLeft,t=(l-e)/i;await nk({duration:n,iteration:i,abortCtrl:r},i=>{s.scrollLeft=e+i*t})}else s.scrollLeft=l}async scrollToTop(e){var t;let{iteration:i=10,duration:n=100,animated:a=!0,abortCtrl:r,position:o="center"}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.win)return;let s=null==(t=this.doc)?void 0:t.scrollingElement;if(!s)return;let l="center"===o?e-this.win.innerHeight/2:e;if(a){let e=s.scrollTop,t=(l-e)/i;await nk({duration:n,iteration:i,abortCtrl:r},i=>{s.scrollTop=e+i*t})}else s.scrollTop=l}pageListSetScrollLeft(e){this.doc&&(this.pageListScrollLeft=e,this.doc.documentElement.style.transform=`translateX(${-e}px)`,this.events.fire("scroll",null))}async pageListScrollToLeft(e){var t;let{iteration:i=10,duration:n=100,animated:a=!0,abortCtrl:r,userOperator:o=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.enabledPageList||!this.pageList)return;let s=null==(t=(0,S.Uk)(this.pageList,t=>t.offsetLeft<=e))?void 0:t.offsetLeft;if(void 0!==s){if(a){let e=this.pageListScrollLeft,t=(s-e)/i;await nk({duration:n,iteration:i,abortCtrl:r},i=>{this.pageListSetScrollLeft(e+i*t)})}else this.pageListSetScrollLeft(s);this.viewOffsetWidth&&(this.pageListCurIndex=Math.round(this.pageListScrollLeft/this.viewOffsetWidth)),o&&this.updatePageListCurFocus()}}async pageListScrollToPage(e,t){var i;let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!this.enabledPageList||!this.pageList)return;let a=this.pageList.at(e);a&&(t?await this.player.gotoParagraph((null==(i=a.topmost)?void 0:i.paragraph)??this.states.pos.paragraph):await this.pageListScrollToLeft(a.offsetLeft,n))}async pageListPushAdjust(e,t){var i;let n;if(!this.viewOffsetWidth||!this.pageListCount||!this.pageList)return;if(n=(0,iA._)(this,nO)?(0,iA._)(this,nO).pageIndex+e:this.pageListCurIndex+e,t){if(n<0)return await this.player.prevSection(-1);else if(n>=this.pageListCount)return await this.player.nextSection()}else n<0?n=0:n>=this.pageListCount&&(n=this.pageListCount-1);null==(i=(0,iA._)(this,nO))||i.abortCtrl.abort();let a=new AbortController;(0,nm._)(this,nO,{abortCtrl:a,pageIndex:n});let r=n*this.viewOffsetWidth;if(await this.pageListScrollToLeft(r,{abortCtrl:a}),t){let e=this.pageList.at(n);(null==e?void 0:e.topmost)&&await this.player.gotoParagraph(e.topmost.paragraph,!1)}(0,nm._)(this,nO,void 0)}async scrollToPercent(e,t){var i;let n=null==(i=this.doc)?void 0:i.scrollingElement;if(console.debug(`scrollElement: ${(null==n?void 0:n.tagName)??"null"}`),n)if(this.enabledPageList){if(!this.viewOffsetWidth)return;let i=Math.ceil(this.pageListScrollWidth*e/this.viewOffsetWidth)-1-this.pageListCurIndex;await this.pageListPushAdjust(i,t)}else if(this.isVertical){let t=-n.scrollWidth*e+n.clientWidth;await this.scrollToLeft(t,{position:"start"})}else{let t=n.scrollHeight*e-n.clientHeight;await this.scrollToTop(t,{position:"start"})}}async load(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.iframe;if(!t)return;let i=e.force??!1,n=e.section??this.states.pos.section,a=this.book.spines.at(n);if(a||(a=this.book.spines.at(0)),!a)return(0,G.iA)().error("book spine is empty");let r=a.href,o=i||r!==(0,iA._)(this,nB);(0,nm._)(this,nB,r);try{if(o){this.states.loading=!0,this.iframe.style.opacity="0",this.unmount.fire();let e=new Promise(e=>{t.addEventListener("load",()=>{e()},{once:!0})});t.src=nx(this.book.item.uuid,r),await e;let i=t.contentDocument;if(!i)return(0,G.iA)().error("iframe load failed");let n=new nw.B(i,this.book.flattenedNavs);this.readableParts=n.toReadableParts(),this.alias=n.alias(),await this.onLoaded(t)}let i=this.states.pos.paragraph;void 0!==e.paragraph?(i=e.paragraph<0?this.readableParts.length+e.paragraph:e.paragraph)<0?i=0:i>=this.readableParts.length&&(i=this.readableParts.length-1):e.anchorId&&(i=this.getReadablePartIndexByAnchorId(e.anchorId)??0),this.states.pos={section:n,paragraph:i},await this.scrollToCurParagraph(e.animated??!1)}finally{o&&(this.states.loading=!1,this.iframe.style.opacity="1")}}async gotoUrlPath(e){let[t,i]=(0,nb.R)(e),n=this.book.spines.findIndex(e=>e.href===t);-1!==n&&(i?await this.load({section:n,anchorId:i}):await this.load({section:n,paragraph:0}))}async onLoaded(e){let t=e.contentWindow,i=e.contentDocument;t&&i&&(this.win=t,this.doc=i,_.J.set(P,{win:t}),this.states.disabledVertical?this.isVertical=!1:this.isVertical=t.getComputedStyle(i.body).writingMode.startsWith("vertical"),this.updateColorTheme(this.colorScheme),this.injectCSS(i),this.updateFontSize(i),this.viewCalculate(i),this.hookResize(t,i),this.resizeImgs(i),this.enabledPageList&&(this.hookTouch(),await this.pageListCalculate(i),this.hookPageWheel(),this.hookSwipe()),this.isVertical&&this.hookVerticalWheel(),this.hookSelection(),this.hookScroll(),this.hookALinks(i),this.hookLinkClick(),this.hookImgs(i),this.hookParagraphClick(),this.player.utterer.hl.reCreateRoot(i),this.annotationHl.reCreateRoot(i),this.keywordHl.reCreateRoot(i),this.updateAnnotations(),this.updateKeywords())}updateColorTheme(e){this.colorScheme=e,this.doc&&("dark"===e?this.doc.documentElement.classList.add(y.aK):this.doc.documentElement.classList.remove(y.aK))}injectCSS(e){let t=e.createElement("style"),i="";this.enabledPageList?i+=`
        /* page list */
        html {
          width: 100% !important;
          height: 100% !important;
          box-sizing: border-box !important;
          margin: 0 !important;
          padding: 0 !important;
          overflow: hidden !important;
          will-change: transform !important;
        }
        body {
          width: auto !important;
          height: 100% !important;
          box-sizing: border-box !important;
          word-break: break-word !important;
          margin: 0 !important;
          padding: 0 !important;
          /* Safari iOS not support
            columns: var(--main-column-count) auto !important;
          */
          columns: var(--main-column-count) var(--main-column-width) !important;
          column-gap: ${this.pageListGap}px !important;
          column-fill: auto !important;
        }
        .${y.Gi} {
          content: ' ';
          break-before: column;
          ${eu.nr||eu.gm?"height: 100%":""}
        }
      `:i+=`
        html {
          width: 100%;
          height: 100%;
          box-sizing: border-box !important;
          margin: 0 !important;
          padding: 8px !important;
        }
        body {
          ${this.isVertical?`
                width: auto;
                height: 100%;
                overflow-y: hidden;
              `:`
                height: auto;
                width: 100%;
                overflow-x: hidden;
              `}
          box-sizing: border-box !important;
        }
      `,this.states.disabledVertical&&(i+=`
        body {
          writing-mode: initial !important;
        }
      `);let n="";eu.Fr||(n=`
        .${y.kG}:hover {
          outline: 1px dashed var(--main-fg-hover);
        }
      `),t.innerHTML=`
      ${nj}
      ${i}

      /* scrollbar */
      ::-webkit-scrollbar-thumb {
        background: var(--main-fg);
      }

      /* wrap */
      pre {
        white-space: pre-wrap;
      }

      /* image */
      svg {
        max-width: 90% !important;
        max-height: 90vh;
      }
      img.${y.lS} {
        max-width: 90% !important;
        height: auto;
      }
      img.${y.Mo} {
        width: auto;
        max-height: 90vh;
      }

      /* scheme */
      .${y.aK} body,
      .${y.aK} body * {
        background-color: var(--main-bg);
        color: var(--main-fg) !important;
      }

      /* paragraph */
      .${y.kG} {
        cursor: pointer;
      }

      .${y.kG}.${y.xm},
      .${y.kG}.${y.xm} * {
        background: var(--main-bg-active) !important;
      }

      ${n}

      .${y.R8} > div,
      .${y.b_} > div,
      .${y.ZG} > div {
        position: absolute;
        user-select: none;
        pointer-events: none;
      }

      .${y.R8} > div,
      .${y.b_} > div {
        background-color: var(--main-bg-highlight) !important;
        color: var(--main-fg-highlight) !important;
      }

      .${y.ZG} > div {
        border-bottom: 0.15em dotted var(--main-bg-symbol);
      }

      .${y.if} {
        text-decoration-line: underline;
        text-decoration-style: solid;
        text-decoration-thickness: 2px;
        text-decoration-color: var(--main-bg-blue);
        text-underline-offset: 4px;
      }
    `,e.head.appendChild(t),e.querySelectorAll("svg").forEach(e=>{e.setAttribute("preserveAspectRatio","xMinYMin meet")})}updateFontSize(e){this.tryManipulateDOM(()=>{e.documentElement.style.fontSize=`${this.states.fontSize}px`}).catch(console.error)}hookResize(e,t){let i=()=>this.onResized(t);e.addEventListener("resize",i),this.unmount.on(()=>{e.removeEventListener("resize",i)})}resizeImgs(e){let t=[y.lS,y.Mo],i=e.querySelectorAll("img");for(let e of i)e.classList.remove(...t);if(this.viewWidth&&"none"===this.pageListType())for(let e of i)e.width>this.viewWidth&&e.classList.add(y.lS)}hookTouch(){let e;if(!eu.WU)return;let t=this.doc,i=this.win,n=this.viewWidth;if(!t||!i||!n)return;let a=t=>{let i=t.touches[0];i&&(e={x:i.clientX,y:i.clientY,offsetLeft:this.pageListScrollLeft,timestamp:Date.now()})},r=i=>{if((0,A.aI)(i),void 0===e)return;let n=t.getSelection();if((null==n?void 0:n.type)==="Range"){e=void 0;return}let a=i.touches[0];if(!a)return;let r=a.clientX-e.x;this.pageListSetScrollLeft(e.offsetLeft-r)},o=t=>{if(void 0===e)return;let i=t.changedTouches[0];if(!i)return;let a=i.clientX-e.x,r=a/(Date.now()-e.timestamp),o=.2*n;if(r<-.3||a<-o){if(!this.isLastPageList||!this.player.isLastSection)return void this.events.fire("swipeRight",null)}else if((r>.3||a>o)&&(!this.isFirstPageList||!this.player.isFirstSection))return void this.events.fire("swipeLeft",null);this.pageListPushAdjust(0,!1)};t.addEventListener("touchstart",a),t.addEventListener("touchmove",r),t.addEventListener("touchend",o),this.unmount.on(()=>{t.removeEventListener("touchstart",a),t.removeEventListener("touchmove",r),t.removeEventListener("touchend",o)})}hookPageWheel(){let e=this.doc;if(!e)return;let t=e=>{(0,A.aI)(e),(0,A.B6)(e.target)||0!==e.deltaY&&(e.deltaY>0?this.events.fire("swipeRight",null):this.events.fire("swipeLeft",null))};e.documentElement.addEventListener("wheel",t),this.unmount.on(()=>{e.documentElement.removeEventListener("wheel",t)})}hookSwipe(){let e=this.events.on("swipeLeft",async()=>{await this.player.prevPage(1,!0)}),t=this.events.on("swipeRight",async()=>{await this.player.nextPage(1,!0)});this.unmount.on(()=>{e(),t()})}hookVerticalWheel(){var e;let t=this.doc,i=null==(e=this.doc)?void 0:e.scrollingElement;if(!t||!i)return;let n=e=>{(0,A.aI)(e),(0,A.B6)(e.target)||0!==e.deltaY&&(i.scrollLeft-=e.deltaY)};t.documentElement.addEventListener("wheel",n),this.unmount.on(()=>{t.documentElement.removeEventListener("wheel",n)})}hookSelection(){let e=this.win,t=this.doc;if(e&&t&&(t.addEventListener("selectionchange",()=>{let e=`.${y.kG}`,i=(()=>{let i=t.getSelection();if(!i||i.rangeCount<=0)return;let n=i.getRangeAt(0),a=n.toString(),r=a.length;if(!r)return;let o=n.commonAncestorContainer.parentElement;if(!o)return;let s=o.matches(e)?o:o.closest(e);if(!s)return;let l=this.readableParts.findIndex(e=>e.elem===s);if(-1===l)return;let c=n.cloneRange();c.selectNodeContents(s),c.setEnd(n.endContainer,n.endOffset);let d=c.toString().length-r;return{paragraph:l,start:d,end:d+r,selectedText:a}})();i?(this.states.pos={...this.states.pos,paragraph:i.paragraph},this.states.selection={start:i.start,end:i.end,selectedText:i.selectedText}):this.states.selection=void 0}),eu.Fr)){let i=()=>{var e;null==(e=t.getSelection())||e.removeAllRanges()};e.addEventListener("blur",i),this.unmount.on(()=>{e.removeEventListener("blur",i)})}}hookScroll(){var e;let t=null==(e=this.doc)?void 0:e.scrollingElement;if(!this.doc||!t)return;let i=()=>{let e,i,n;this.enabledPageList&&this.pageListCount?(e=(this.pageListScrollLeft+t.clientWidth)/this.pageListScrollWidth,i=this.pageListScrollLeft/this.pageListScrollWidth,n=1/this.pageListCount):this.isVertical?(e=(-t.scrollLeft+t.clientWidth)/t.scrollWidth,i=-t.scrollLeft/t.scrollWidth,n=t.clientWidth/t.scrollWidth):(e=(t.scrollTop+t.clientHeight)/t.scrollHeight,i=t.scrollTop/t.scrollHeight,n=t.clientHeight/t.scrollHeight),this.states.scrollPercent={percent:100*e,progress:100*i,length:100*n}};i();let n=this.events.on("scroll",()=>i());this.doc.addEventListener("scroll",()=>this.events.fire("scroll",null),{passive:!0}),this.unmount.on(()=>{n()})}hookALinks(e){for(let t of e.querySelectorAll("a"))t.href&&t.addEventListener("click",e=>{(0,A.aI)(e),this.events.fire("click",t)})}hookLinkClick(){let e=async e=>await O({title:(0,j.t)("confirm.openLink"),description:e}),t=t=>{(0,eJ.bI)(async()=>{let i;if(t.closest(eD.j)){let e=t.getAttribute("href");if(!e)return;i=eF().join("/",e)}else{let n=t.href;if(!n)return;if(!n.startsWith(this.mainContentRootUrl)&&await e(n))return window.open(n,"_blank","noopener,noreferrer");i=n.substring(this.mainContentRootUrl.length)}await e(i)&&(await this.gotoUrlPath(i),this.player.utterer.cancel())})},i=this.events.on("click",t);this.unmount.on(()=>{i()})}hookImgs(e){for(let t of e.querySelectorAll("img"))t.addEventListener("click",e=>{let i=t.src;i&&((0,A.aI)(e),_.J.set(X,i))});for(let t of e.querySelectorAll("svg"))t.addEventListener("click",i=>{(0,A.aI)(i),(0,eJ.bI)(async()=>{let i=await (0,A.Sh)(t,e.URL);_.J.set(X,i)})})}hookParagraphClick(){let e=this.win,t=this.doc;if(!e||!t)return;let i=(e,t)=>{(0,A.aI)(e),this.player.gotoParagraph(t,!1)},n=(e,i)=>{var n;(0,A.aI)(e),null==(n=t.getSelection())||n.removeAllRanges(),this.player.annotations.toggle({section:this.states.pos.section,paragraph:i},null)};this.readableParts.forEach((e,t)=>{"text"===e.type&&(e.elem.addEventListener("click",e=>i(e,t)),e.elem.addEventListener("dblclick",e=>n(e,t)))})}viewCalculate(e){let t=e.documentElement.getBoundingClientRect();this.viewWidth=t.width,this.viewOffsetWidth=t.width+this.pageListGap,this.viewHeight=t.height,console.debug(`viewWidth: ${this.viewWidth}`),console.debug(`viewOffsetWidth: ${this.viewOffsetWidth}`),console.debug(`viewHeight: ${this.viewHeight}`)}pageListScrollWidthCalculate(e,t){let i=1/0,n=-1/0;if(!this.readableParts.length)return e.scrollWidth;for(let e of[...this.readableParts.map(e=>e.elem),t]){if(!e)continue;let t=e.getBoundingClientRect();t.left<i&&(i=t.left),t.right>n&&(n=t.right)}return n-i}async pageListCalculate(e){var t;let i;if(!this.viewWidth||!this.viewOffsetWidth)return;let n=e.documentElement,a=this.pageListType(),r="single"===a?1:2,o=(this.viewWidth-this.pageListGap)/r;if(n.style.setProperty("--main-column-count",r.toString()),n.style.setProperty("--main-column-width",`${o}px`),this.pageListColumnWidth=o,this.pageListResizeImgs(e,this.pageListColumnWidth),this.pageListScrollWidth=this.pageListScrollWidthCalculate(n,null),null==(t=e.querySelector(`.${y.Gi}`))||t.remove(),"double"===a){if((i=Math.ceil(2*this.pageListScrollWidth/this.viewOffsetWidth))%2==1){i+=1;let t=e.createElement("p");t.classList.add(y.Gi),e.body.appendChild(t),this.pageListScrollWidth=this.pageListScrollWidthCalculate(n,t)}i/=2}else i=Math.ceil(this.pageListScrollWidth/this.viewOffsetWidth);i<1&&(i=1),this.pageListCount=i,console.debug(`pageListScrollWidth: ${this.pageListScrollWidth}`),console.debug(`pageListColumnWidth: ${this.pageListColumnWidth}`),console.debug(`pageListCount: ${this.pageListCount}`),this.parsePageList(n)}pageListResizeImgs(e,t){if(!this.viewHeight)return;let i=e.querySelectorAll("img"),n=t/this.viewHeight;for(let e of i)(e.width>t||e.height>this.viewHeight)&&e.classList.add(e.naturalWidth/e.naturalHeight>n?y.lS:y.Mo)}parsePageList(e){let t=this.viewOffsetWidth;if(!t||!this.pageListCount)return;this.pageList=(0,S.y1)(0,this.pageListCount).map(e=>e*t).map(e=>({offsetLeft:e}));let i=e.getBoundingClientRect().left;for(let[e,t]of this.readableParts.entries()){let n=t.elem.getBoundingClientRect().left+t.elem.offsetWidth/2-i,a=(0,S.Uk)(this.pageList,e=>e.offsetLeft<=n);a&&!a.topmost&&(a.topmost={readablePart:t,paragraph:e})}}updatePageListCurFocus(){if(!this.pageList)return;let e=this.states.pos.paragraph;if((0,S.Kl)(this.pageList,t=>!!t.topmost&&t.topmost.paragraph<=e)===this.pageListCurIndex)this.pageListResizeCurFocusPart=this.readableParts.at(e);else{var t,i;this.pageListResizeCurFocusPart=null==(i=this.pageList.at(this.pageListCurIndex))||null==(t=i.topmost)?void 0:t.readablePart}}updateParagraphActive(){this.tryManipulateDOM(()=>{var e;let t=this.readableParts.at(this.states.pos.paragraph);!t||(0,iA._)(this,nK)&&t===(0,iA._)(this,nK)||(null==(e=(0,iA._)(this,nK))||e.elem.classList.remove(y.xm),(0,nm._)(this,nK,t),t.elem.classList.add(y.xm))}).catch(console.error)}updateAnnotations(){this.tryManipulateDOM(()=>{if(!this.states.annotations||!this.doc)return;for(let e of Array.from(this.doc.querySelectorAll(`.${y.if}`)))e.classList.remove(y.if);let e=[];for(let t of this.states.annotations){if(t.pos.section!==this.states.pos.section)continue;let i=this.readableParts.at(t.pos.paragraph);if(i){if(!t.range){i.elem.classList.add(y.if);continue}e.push({node:i,charIndex:t.range.start,charLength:t.range.end-t.range.start,color:"var(--main-bg-blue)"})}}this.annotationHl.highlight(e,!1)}).catch(console.error)}updateKeywords(){this.tryManipulateDOM(()=>{if(!this.states.keywords||!this.doc)return;let e=[];for(let t of this.states.keywords){let i=this.readableParts.filter(e=>"text"===e.type);if(i.length)for(let n of i){let i=(0,L.JG)(n.text,t);if(i.length)for(let[t,a]of i)e.push({node:n,charIndex:t,charLength:a,color:"var(--main-bg-blue)"})}}this.keywordHl.highlight(e,!1)}).catch(console.error)}updateActiveNavs(){let e=this.book.flattenedNavs.filter(e=>e.spineIndex===this.states.pos.section),t=(()=>{var t;if(0===e.length)return(0,S.Uk)(this.book.flattenedNavs,e=>!!e.spineIndex&&e.spineIndex<this.states.pos.section);let i=this.readableParts,n=null==(t=(0,S.Uk)(i.slice(0,this.states.pos.paragraph+1),e=>!!e.navAnchorIds))?void 0:t.navAnchorIds,a=n&&n.length>0?n[n.length-1]:null;if(!a)return e[0];let r=(0,S.Uk)(e,e=>e.hrefAnchor===a);return r||e[0]})();if(!t){this.states.activeNavs=[];return}let i=this.book.flattenedNavs.indexOf(t);if(-1===i){this.states.activeNavs=[];return}let n=[t],a=i-1,r=t.level-1;for(;a>=0&&r>0;){let[e,t]=(0,S.UY)(this.book.flattenedNavs,e=>e.level===r,a);if(e)a=t-1,r=e.level-1,n.unshift(e);else break}this.states.activeNavs=n}constructor(e,t,i){(0,tT._)(this,"player",void 0),(0,tT._)(this,"states",void 0),(0,tT._)(this,"iframeRef",void 0),(0,tT._)(this,"readableParts",void 0),(0,tT._)(this,"alias",void 0),(0,tT._)(this,"doc",void 0),(0,tT._)(this,"events",void 0),(0,tT._)(this,"unmount",void 0),(0,tT._)(this,"isVertical",void 0),(0,tT._)(this,"annotationHl",void 0),(0,tT._)(this,"keywordHl",void 0),(0,tT._)(this,"mainContentRootPath",void 0),(0,tT._)(this,"mainContentRootUrl",void 0),(0,tT._)(this,"colorScheme",void 0),(0,tT._)(this,"viewWidth",void 0),(0,tT._)(this,"viewOffsetWidth",void 0),(0,tT._)(this,"viewHeight",void 0),(0,tT._)(this,"pageList",void 0),(0,tT._)(this,"pageListGap",void 0),(0,tT._)(this,"pageListScrollWidth",void 0),(0,tT._)(this,"pageListScrollLeft",void 0),(0,tT._)(this,"pageListColumnWidth",void 0),(0,tT._)(this,"pageListCount",void 0),(0,tT._)(this,"pageListCurIndex",void 0),(0,tT._)(this,"pageListResizeCurFocusPart",void 0),(0,tT._)(this,"win",void 0),(0,iL._)(this,nO,{writable:!0,value:void 0}),(0,iL._)(this,nB,{writable:!0,value:void 0}),(0,tT._)(this,"onResized",void 0),(0,iL._)(this,nK,{writable:!0,value:void 0}),this.player=e,this.states=t,this.iframeRef=i,this.readableParts=[],this.alias=[],this.events=new iP.vl,this.unmount=new iP.TP({once:!0}),this.isVertical=!1,this.colorScheme="light",this.pageListGap=12,this.pageListScrollWidth=0,this.pageListScrollLeft=0,this.pageListCurIndex=0,this.onResized=function(e,t){let i;return function(){for(var n=arguments.length,a=Array(n),r=0;r<n;r++)a[r]=arguments[r];clearTimeout(i),i=setTimeout(()=>t(...a),e)}}(300,e=>{(0,eJ.bI)(async()=>{if(this.viewCalculate(e),this.resizeImgs(e),this.enabledPageList){await this.pageListCalculate(e);let t=this.pageListResizeCurFocusPart;t?await this.scrollToElem(t.elem,{animated:!1,userOperator:!1}):await this.pageListScrollToLeft(this.pageListScrollLeft,{animated:!1,userOperator:!1}),this.player.utterer.hl.highlightHide(),this.updateAnnotations(),this.updateKeywords()}})}),this.mainContentRootPath=nx(this.book.item.uuid,""),this.mainContentRootUrl=new URL(this.mainContentRootPath,location.href).toString(),this.annotationHl=new nz(this,t),this.keywordHl=new nD(this,t),this.states.events.on("pos",()=>{this.updateParagraphActive(),this.updateActiveNavs()}),this.states.events.on("started",e=>{e||this.player.utterer.hl.highlightHide()}),this.states.uiEvents.on("annotations",()=>{this.updateAnnotations()}),this.states.uiEvents.on("keywords",()=>{this.updateKeywords()});let n=!0;this.states.uiEvents.on("pageList",async()=>{if(n){n=!1;return}this.iframe&&await this.load({force:!0})});let a=!0;this.states.uiEvents.on("disabledVertical",async()=>{if(a){a=!1;return}this.iframe&&await this.load({force:!0})}),this.states.uiEvents.on("fontSize",async()=>{this.doc&&(this.updateFontSize(this.doc),this.onResized(this.doc))}),this.player.unmount.on(()=>this.unmount.fire())}}var nV=i(2410),nG=i(4138);class nq{getBriefText(e){let t=this.player.iframeCtrler.readableParts.at(e.paragraph);if(!t)return;if("text"!==t.type)return(0,G.iA)().error((0,j.t)("desc.keywordNoSupported")),null;let i=t.text.slice(0,30);return{text:t.text,brief:i}}async add(e){var t;let{keyword:i,pos:n}=e,a=this.getBriefText(n);if(!a)return;let r=await nG.f.json({keywords:[{keyword:i,uuid:null,pos:n,brief:a.brief,content:a.text}],uuid:this.uuid});return null==(t=this.reload)||t.call(this),(0,G.iA)().info(`${(0,j.t)("desc.keywordUpdated")} ${i}`),r.keywords.at(0)}async upsert(e,t){var i;let{uuid:n,keyword:a,pos:r}=e,{alias:o,note:s,color:l}=t,c=this.getBriefText(r);if(!c)return;let d=await nG.f.json({keywords:[{uuid:n,keyword:a,pos:r,brief:c.brief,content:c.text,alias:o,note:s,color:l}],uuid:this.uuid});return null==(i=this.reload)||i.call(this),(0,G.iA)().info(`${(0,j.t)("desc.keywordUpdated")} ${a}`),d.keywords.at(0)}async remove(e){var t;let i=e.color?nu()(e.color,{black:"#3a3a3a",white:"#fafafa"}):"var(--main-fg-blue)";await O({title:(0,j.t)("prompt.keywordRemoveConfirm"),description:(0,r.jsx)("span",{style:{backgroundColor:e.color??"var(--main-bg-blue)",color:i},children:e.keyword})})&&(await nV.Z.json({uuid:this.uuid,keywordUuids:[e.uuid]}),null==(t=this.reload)||t.call(this),(0,G.iA)().info(`${(0,j.t)("desc.keywordDeleted")} ${e.keyword}`))}constructor(e){(0,tT._)(this,"player",void 0),(0,tT._)(this,"uuid",void 0),(0,tT._)(this,"reload",void 0),this.player=e,this.uuid=e.book.item.uuid}}class nJ extends nT{constructor(...e){super(...e),(0,tT._)(this,"rootClass",y.R8),(0,tT._)(this,"ignoreClass",y.JQ)}}class nY{cancel(){this.speech.cancel()}async speakNode(e){return this.states.voice?this.speech.speak(e.text,{voice:this.states.voice,speed:this.states.speechSpeed,isPersonReplace:this.states.isPersonReplace,alias:this.player.iframeCtrler.alias,onBoundary:t=>{this.hl.highlight([{node:e,charIndex:t.charIndex,charLength:t.charLength}],!0)}}):"done"}async speakText(e){return this.states.voice?this.speech.speak(e,{voice:this.states.voice,speed:this.states.speechSpeed,isPersonReplace:this.states.isPersonReplace,alias:this.player.iframeCtrler.alias}):"done"}async nextPart(){this.states.pos.paragraph>=this.player.iframeCtrler.readableParts.length-1?this.states.pos.section<this.player.book.spines.length-1&&this.states.autoNextSection?(await this.player.nextSection(),await tG()):this.player.pause():(await this.player.nextParagraph(),await tH())}async startLoop(){let e=0;for(;;){if(!this.states.started)return;try{let e=this.player.iframeCtrler.readableParts.at(this.states.pos.paragraph);if(e)switch(e.type){case"text":{let t=!1;for(let i=0;i<this.states.paragraphRepeat;i++){let n=await this.speakNode(e);if("cancel"===n){t=!0;break}i!==this.states.paragraphRepeat-1&&await tX()}if(t)continue;break}case"image":await tB()}await this.nextPart()}catch(t){console.error(t),(e+=1)>3&&(await this.nextPart(),e=0)}}}constructor(e,t,i){(0,tT._)(this,"player",void 0),(0,tT._)(this,"hl",void 0),(0,tT._)(this,"states",void 0),(0,tT._)(this,"speech",void 0),this.player=e,this.states=t,this.hl=new nJ(i,t),this.speech=new tZ}}class nX{start(){this.states.started=!0,this.utterer.startLoop().catch(console.error)}pause(){this.states.started=!1,this.utterer.cancel()}restart(e){this.pause(),e?setTimeout(()=>{this.start()},e):this.start()}toggle(){this.states.started?this.pause():this.start()}get isFirstSection(){return 0===this.states.pos.section}get isLastSection(){return this.states.pos.section===this.book.spines.length-1}async gotoPos(e){let{section:t,paragraph:i,scrollToParagraph:n=!0,animated:a=!0}=e;if(void 0===t||!(t<0)&&!(t>=this.book.spines.length)){if(t??(t=this.states.pos.section),i??(i=this.states.pos.paragraph),this.states.pos.section===t){if(this.states.pos.paragraph===i)return;this.states.pos={section:t,paragraph:i},n&&await this.iframeCtrler.scrollToCurParagraph(a)}else await this.iframeCtrler.load({section:t,paragraph:i,animated:a});this.utterer.cancel()}}async gotoSection(e,t){await this.gotoPos({section:e,paragraph:t})}async prevSection(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;await this.gotoPos({section:this.states.pos.section-1,paragraph:e,animated:!1})}async nextSection(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;await this.gotoPos({section:this.states.pos.section+1,paragraph:e,animated:!1})}async gotoUrlPath(e){await this.iframeCtrler.gotoUrlPath(e),this.utterer.cancel()}get isFirstPage(){return this.iframeCtrler.isFirstPageList}get isLastPage(){return this.iframeCtrler.isLastPageList}async gotoPage(e,t){await this.iframeCtrler.pageListScrollToPage(e,t)}async prevPage(e,t){await this.iframeCtrler.pageListPushAdjust(-e,t)}async nextPage(e,t){await this.iframeCtrler.pageListPushAdjust(e,t)}get isFirstParagraph(){return this.states.pos.paragraph<=0}get isLastParagraph(){return this.states.pos.paragraph>=this.iframeCtrler.readableParts.length-1}async gotoParagraph(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];await this.gotoPos({paragraph:e,scrollToParagraph:t})}async prevParagraph(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];0===this.states.pos.paragraph?await this.prevSection(-1):await this.gotoParagraph(this.states.pos.paragraph-1,e)}async nextParagraph(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];this.states.pos.paragraph>=this.iframeCtrler.readableParts.length-1?await this.nextSection():await this.gotoParagraph(this.states.pos.paragraph+1,e)}constructor(e,t,i){(0,tT._)(this,"book",void 0),(0,tT._)(this,"states",void 0),(0,tT._)(this,"utterer",void 0),(0,tT._)(this,"iframeCtrler",void 0),(0,tT._)(this,"annotations",void 0),(0,tT._)(this,"keywords",void 0),(0,tT._)(this,"unmount",void 0),this.book=e,this.unmount=new iP.TP({once:!0}),this.states=new iE,this.states.pos=t,this.iframeCtrler=new nH(this,this.states,i),this.utterer=new nY(this,this.states,this.iframeCtrler),this.annotations=new ng(this),this.keywords=new nq(this);const n=()=>{(0,eJ.bI)(async()=>{let e;await (null==e?void 0:e.release().catch(console.error)),e=void 0,this.states.started&&this.states.docVisible&&(e=await navigator.wakeLock.request("screen"))})};n(),document.addEventListener("visibilitychange",n);const a=this.states.events.on("started",n);this.unmount.on(()=>{document.removeEventListener("visibilitychange",n),a()})}}function nZ(e){let{scrollPercent:t,onClick:i}=e,n=(null==t?void 0:t.percent.toFixed(2))??"0",a=(null==t?void 0:t.progress)??"0",o=(null==t?void 0:t.length)??"0";return(0,r.jsx)("div",{style:{height:6,width:"100%",overflow:"hidden",borderRadius:6,background:"var(--main-bg-active)",position:"relative"},onClick:e=>{let t=e.currentTarget.getBoundingClientRect(),n=(e.clientX-t.left)/t.width;null==i||i(n)},title:`${n}%`,children:(0,r.jsx)("div",{style:{position:"absolute",transition:"width,left 0.2s",left:`${a}%`,width:`${o}%`,height:"100%",background:"var(--main-fg-active)"}})})}var nQ=i(3537);function n0(){let{book:e}=iv(),{BookPanelView:t,MainContent:i,activeNavs:n}=function(){var e;let t,{book:i,pos:n,setPos:a}=iv(),o=(0,g.useRef)(null),[s,l]=(0,g.useState)(!1),[c,d]=(0,g.useState)(),[h,u]=(0,g.useState)(!1),[p,f]=(0,g.useState)(),[m,v]=(0,g.useState)(),{addHotkeys:y}=T(),[,x]=em(),w=(0,el.Zp)(),C=((t=(0,g.useRef)()).current||(t.current=new nX(i,n,o)),(0,t0.l)(()=>{var e;null==(e=t.current)||e.unmount.fire()}),e=t.current,(0,ei.u)(async()=>{await e.iframeCtrler.load()}),t.current);!function(e,t){let{setPos:i,setStarted:n,setActiveNavs:a,setLoading:r,setScrollPercent:o,setSelection:s}=t;(0,g.useEffect)(()=>{let t=e.states.events,l=[t.on("pos",e=>{i(e)}),t.on("started",e=>{n(e)}),t.on("activeNavs",e=>{a(e)}),t.on("loading",e=>{r(e)}),t.on("scrollPercent",e=>{o(e)}),t.on("selection",e=>{s(e)})];return()=>{l.forEach(e=>e())}},[e,i,n,a,r,o,s])}(C,{setPos:a,setStarted:l,setActiveNavs:d,setLoading:u,setScrollPercent:f,setSelection:v});let S=iC();(0,g.useEffect)(()=>{C.iframeCtrler.updateColorTheme(S)},[C.iframeCtrler,S]);let{BookPanelView:A}=function(e){let{player:t,started:i,activeNavs:n,selection:a}=e,{book:o,pos:s,pageParagraphCounts:l}=iv(),c=(0,el.Zp)(),{annotations:d,keywords:h,setViewPanelType:u,BookPanelView:p}=function(e,t,i,n,a){let[o,s]=em(),{NavTreeView:l}={NavTreeView:(0,r.jsx)(nr,{book:e,player:t,activeNavs:i})},{annotations:c,AnnotationView:d}=function(e,t,i,n){let a=e.item.uuid,{data:o,reload:s}=(0,eh.y3)(i8.U,{uuid:a},{clearWhenReload:!1});(0,g.useEffect)(()=>(t.annotations.reload=s,()=>{t.annotations.reload=void 0}),[t.annotations,s]);let l=(0,g.useMemo)(()=>t.annotations.indexByPos(i,n??null),[t.annotations,i,n]),c=(0,g.useMemo)(()=>t.annotations.closestIndexByPos(i),[t.annotations,i]);(0,g.useMemo)(()=>null!==l?null==o?void 0:o.items.at(l):void 0,[o,l]);let d=(0,g.useMemo)(()=>null!==c?null==o?void 0:o.items.at(c):void 0,[o,c]);return{annotations:null==o?void 0:o.items,AnnotationView:(0,r.jsx)(ne,{annotations:null==o?void 0:o.items,closestAnnotationIndex:c,activeAnnotationIndex:l,player:t}),closestAnnotation:d}}(e,t,n,a),{keywords:h,KeywordView:u}=function(e,t){let i=e.item.uuid,{data:n,reload:a}=(0,eh.y3)(nt.y,{uuid:i},{clearWhenReload:!1});return(0,g.useEffect)(()=>(t.keywords.reload=a,()=>{t.keywords.reload=void 0}),[t.keywords,a]),{keywords:null==n?void 0:n.items,KeywordView:(0,r.jsx)(nn,{keywords:null==n?void 0:n.items,player:t})}}(e,t),p=(0,g.useMemo)(()=>(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:["book-panel","none"===o?"hidden":""].join(" "),children:["nav"===o&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("h3",{children:(0,j.t)("nav")}),l]}),"annotation"===o&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("h3",{children:(0,j.t)("annotation")}),d]}),"keyword"===o&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("h3",{children:(0,j.t)("keyword")}),u]})]}),(0,r.jsx)("div",{className:["book-panel-overlay","none"===o?"hidden":""].join(" "),onClick:()=>s("none")})]}),[d,u,l,s,o]);return(0,g.useMemo)(()=>({annotations:c,keywords:h,setViewPanelType:s,BookPanelView:p}),[c,h,s,p])}(o,t,n,s,a),{voice:f}=ex(o.item),[m]=ew(),[v]=ej(),[y]=ek(),[x]=eb(),[w]=eC(),[C]=eL(),[S]=e_(),[A]=eI(),[L]=eE(),[P,_]=(0,g.useState)(eu.Fr),{isFirstSection:I,isLastSection:E,isFirstParagraph:N,isLastParagraph:R}=function(e,t){let{annotations:i,keywords:n,isPersonReplace:a,speechSpeed:r,voice:o,autoNextSection:s,paragraphRepeat:l,pageList:c,fontSize:d,disabledVertical:h}=t;(0,g.useEffect)(()=>{e.states.syncUIState("annotations",i)},[e,i]),(0,g.useEffect)(()=>{e.states.syncUIState("keywords",n)},[e,n]),(0,g.useEffect)(()=>{e.states.syncUIState("isPersonReplace",a)},[e,a]),(0,g.useEffect)(()=>{e.states.syncUIState("speechSpeed",r)},[e,r]),(0,g.useEffect)(()=>{e.states.syncUIState("voice",o)},[e,o]),(0,g.useEffect)(()=>{e.states.syncUIState("autoNextSection",s)},[e,s]),(0,g.useEffect)(()=>{e.states.syncUIState("paragraphRepeat",l)},[e,l]),(0,g.useEffect)(()=>{e.states.syncUIState("pageList",c)},[e,c]),(0,g.useEffect)(()=>{e.states.syncUIState("fontSize",d)},[e,d]),(0,g.useEffect)(()=>{e.states.syncUIState("disabledVertical",h)},[e,h]);let u=(0,g.useMemo)(()=>e.isFirstSection,[e.isFirstSection]),p=(0,g.useMemo)(()=>e.isLastSection,[e.isLastSection]);return{isFirstSection:u,isLastSection:p,isFirstParagraph:(0,g.useMemo)(()=>e.isFirstParagraph,[e.isFirstParagraph]),isLastParagraph:(0,g.useMemo)(()=>e.isLastParagraph,[e.isLastParagraph])}}(t,{annotations:d,keywords:h,autoNextSection:m,isPersonReplace:v,speechSpeed:w,voice:f,paragraphRepeat:C,pageList:S,fontSize:A,disabledVertical:L}),T=(0,g.useMemo)(()=>{let e=[(0,r.jsx)(ns,{hotkey:"t",description:(0,j.t)("nav"),onClick:()=>{u(e=>"nav"===e?"none":"nav")},children:(0,r.jsx)(U,{icon:z.gDf})},"nav"),(0,r.jsx)(ns,{hotkey:"shift + ←",description:(0,j.t)("hotkey.prevSection"),disabled:I,onClick:()=>{t.prevSection().catch(console.error)},children:(0,r.jsx)(U,{icon:z.z04})},"prev-section")];return P||e.push((0,r.jsx)(ns,{hotkey:"↑",description:(0,j.t)("hotkey.prevParagraph"),disabled:I&&N,onClick:()=>{t.prevParagraph().catch(console.error)},children:(0,r.jsx)(U,{icon:z.TH3})},"prev-paragraph")),e.push((0,r.jsx)(ns,{hotkey:"Space",description:(0,j.t)("hotkey.playToggle"),onClick:()=>{i?t.pause():t.start()},children:i?(0,r.jsx)(U,{icon:z.G1Y}):(0,r.jsx)(U,{icon:z.ijD})},"play")),P||e.push((0,r.jsx)(ns,{hotkey:"↓",description:(0,j.t)("hotkey.nextParagraph"),disabled:E&&R,onClick:()=>{t.nextParagraph().catch(console.error)},children:(0,r.jsx)(U,{icon:z.vFJ})},"next-paragraph")),e.push((0,r.jsx)(ns,{hotkey:"shift + →",description:(0,j.t)("hotkey.nextSection"),disabled:E,onClick:()=>{t.nextSection().catch(console.error)},children:(0,r.jsx)(U,{icon:z.x5B})},"next-section")),eu.Fr&&e.push((0,r.jsx)(no,{onClick:()=>{_(e=>!e)},children:P?(0,r.jsx)(U,{icon:z.skf}):(0,r.jsx)(U,{icon:z.DOu})},"collapse")),(0,r.jsx)(b.Ay.Group,{children:e.filter(Boolean)})},[P,N,I,R,E,t,u,i]),M=(0,g.useMemo)(()=>{let e=[d&&d.length>0?(0,r.jsx)(ns,{hotkey:"m",description:(0,j.t)("annotation"),onClick:()=>{u(e=>"annotation"===e?"none":"annotation")},children:(0,r.jsx)(U,{icon:z.FgS})},"annotations"):null,h&&h.length>0?(0,r.jsx)(ns,{description:(0,j.t)("keyword"),hotkey:"M",onClick:()=>{u(e=>"keyword"===e?"none":"keyword")},children:(0,r.jsx)(U,{icon:z.bLf})},"keywords"):null];return(0,r.jsx)(b.Ay.Group,{children:e.filter(Boolean)})},[d,h,u]),$=(0,g.useMemo)(()=>{let e=[(0,r.jsx)(ns,{description:(0,j.t)("hotkey.annotationToggle"),hotkey:"b",onClick:()=>{t.annotations.toggle(s,a??null)},children:(0,r.jsx)(U,{icon:z.G06})},"annotation"),(null==a?void 0:a.selectedText)?(0,r.jsx)(ns,{description:(0,j.t)("hotkey.keywordAdd"),hotkey:"B",onClick:()=>{t.keywords.add({pos:s,keyword:a.selectedText})},children:(0,r.jsx)(U,{icon:z.oE6})},"keyword"):null];return(0,r.jsx)(b.Ay.Group,{children:e.filter(Boolean)})},[t,s,a]),W=(0,g.useMemo)(()=>(0,r.jsx)(nl,{player:t,started:i,stopTimerEnabled:y,stopTimerSeconds:x},"timer-remain-ui"),[t,i,y,x]),F=(0,g.useMemo)(()=>(0,r.jsx)(b.Ay,{shape:"circle",type:"text",title:(0,j.t)("tmpStore"),onClick:()=>{(0,eJ.bI)(async()=>{let e=await iR.Q.json({});c(`/books/added-successful/${e.uuid}`)})},icon:(0,r.jsx)(U,{icon:z.jkA})}),[c]),D=(0,g.useMemo)(()=>(0,r.jsx)(r.Fragment,{children:W}),[W]),O=(0,g.useMemo)(()=>(0,r.jsx)(r.Fragment,{children:o.item.isTmp&&F}),[F,o.item.isTmp]),B=(0,g.useMemo)(()=>(0,r.jsxs)(k.A,{direction:"vertical",children:[(0,r.jsx)(i4,{player:t}),(0,r.jsx)(nc,{}),(0,r.jsx)(nd,{})]}),[t]);return t2({topProgress:(0,g.useMemo)(()=>{if(l)return(0,eK.Nh)(l,s)},[l,s]),topRight:D,bottomLeft1:T,bottomLeft2:M,bottomRight1:$,bottomRight2:O,settings:B}),{voice:f,speechSpeed:w,autoNextSection:m,isPersonReplace:v,BookPanelView:p}}({player:C,started:s,activeNavs:c,selection:m}),L=1/i.spines.length*100,P=n.section/i.spines.length*100,_=(0,g.useMemo)(()=>(0,r.jsxs)(eR,{flex:1,gap:4,style:{position:"relative"},children:[(0,r.jsx)(nZ,{scrollPercent:{length:L,percent:P,progress:P},onClick:e=>{let t=Math.floor(e*i.spines.length);C.gotoSection(t,0)}}),h&&(0,r.jsx)("div",{style:{position:"absolute",zIndex:2,width:"100%",display:"flex",justifyContent:"center"},children:(0,r.jsx)(et,{})}),(0,r.jsx)("iframe",{style:{padding:"0 4px"},title:"viewer",ref:o}),(0,r.jsx)(nZ,{scrollPercent:p,onClick:e=>{C.iframeCtrler.scrollToPercent(e,!0)}})]}),[L,P,h,p,i.spines.length,C]);return(0,g.useEffect)(()=>{let e=()=>C.prevPage(1,!0),t=()=>C.nextPage(1,!0),i=()=>C.prevSection(),a=()=>C.nextSection(),r=()=>C.prevParagraph(),o=()=>C.nextParagraph();return y([["t",(0,j.t)("hotkey.navToggle"),()=>x(e=>"nav"===e?"none":"nav")],["m",(0,j.t)("hotkey.annotationsPanelToggle"),()=>x(e=>"annotation"===e?"none":"annotation")],["b",(0,j.t)("hotkey.annotationToggle"),()=>C.annotations.toggle(n,m??null)],[{shift:!0,key:"m"},(0,j.t)("hotkey.keywordPanelToggle"),()=>x(e=>"keyword"===e?"none":"keyword")],[{shift:!0,key:"b"},(0,j.t)("hotkey.keywordAdd"),()=>(null==m?void 0:m.selectedText)&&C.keywords.add({pos:n,keyword:m.selectedText})],["u",(0,j.t)("hotkey.goBack"),()=>w("../")],[" ",(0,j.t)("hotkey.playToggle"),()=>C.toggle()],[{shift:!0,key:"h"},(0,j.t)("hotkey.prevSection"),i],[{shift:!0,key:"l"},(0,j.t)("hotkey.nextSection"),a],[{shift:!0,key:"ArrowLeft"},(0,j.t)("hotkey.prevSection"),i],[{shift:!0,key:"ArrowRight"},(0,j.t)("hotkey.nextSection"),a],["h",(0,j.t)("hotkey.jumpPrevPage"),e],["l",(0,j.t)("hotkey.jumpNextPage"),t],["k",(0,j.t)("hotkey.prevParagraph"),r],["j",(0,j.t)("hotkey.nextParagraph"),o],["ArrowLeft",(0,j.t)("hotkey.jumpPrevPage"),e],["ArrowRight",(0,j.t)("hotkey.jumpNextPage"),t],["ArrowUp",(0,j.t)("hotkey.prevParagraph"),r],["ArrowDown",(0,j.t)("hotkey.nextParagraph"),o],["Home",(0,j.t)("hotkey.firstPage"),()=>C.gotoPage(0,!0)],["End",(0,j.t)("hotkey.lastPage"),()=>C.gotoPage(-1,!0)],["PageUp",(0,j.t)("hotkey.prevPage"),()=>C.prevPage(1,!1)],["PageDown",(0,j.t)("hotkey.nextPage"),()=>C.nextPage(1,!1)],[["g","g"],(0,j.t)("hotkey.firstParagraph"),()=>C.gotoParagraph(0)],[{shift:!0,key:"G"},(0,j.t)("hotkey.lastParagraph"),()=>C.gotoParagraph(-1)]])},[y,i,w,C,n,m,x]),(0,t0.l)(()=>{C.pause()}),{activeNavs:c,BookPanelView:A,MainContent:_}}(),a=function(){let e=(0,g.useId)(),[,t]=(0,f.fp)(ea);return(0,g.useEffect)(()=>()=>{t(t=>t.filter(t=>e!==t.id))},[e,t]),(0,g.useCallback)(i=>{t(t=>[{title:i,id:e},...t])},[e,t])}(),o=(0,g.useMemo)(()=>null==n?void 0:n.at(-1),[n]);return(0,g.useEffect)(()=>{let t=`${e.item.name}`;o&&(t=`${o.label} - ${t}`),a(t)},[e,o,a]),(0,r.jsxs)(eR,{dir:"row",className:"contentWrapper-xRbIAt",children:[t,i]})}function n1(e){let{uuid:t}=e,{error:i,pos:n,setPos:a,book:o,pageParagraphCounts:s,reload:l}=(e=>{let{data:t,error:i,reload:n}=(0,eh.y3)(ip.T,{uuid:e}),{data:a}=ig([t],async e=>{if(e&&!e.item.isTmp)return(await nQ.U.json({uuid:e.item.uuid})).pageParagraphCounts}),{data:r,error:o,reload:s}=ig([t],async e=>{if(e)return iu.Z.json({uuid:e.item.uuid})}),[l,c]=(0,g.useState)(),d=null==l?void 0:l.section,h=null==l?void 0:l.paragraph,u=(0,g.useMemo)(()=>{if(!t)return;let e=[],i=[...t.navs];for(;i.length;){let t=i.shift();e.push(t),i.unshift(...t.children)}return{...t,flattenedNavs:e}},[t]);return(0,g.useEffect)(()=>{r&&c(r)},[r]),(0,g.useEffect)(()=>{void 0!==u&&void 0!==d&&void 0!==h&&ih.i.json({uuid:u.item.uuid,pos:{section:d,paragraph:h}}).catch(console.error)},[u,h,d]),{error:i||o,pos:l,setPos:c,book:u,pageParagraphCounts:a,reload:(0,g.useCallback)(()=>{n(),s()},[n,s])}})(t),[c,d]=(0,f.fp)(im);return((0,g.useEffect)(()=>{o&&n?d({uuid:o.item.uuid,book:o,pageParagraphCounts:s??null,pos:n,setPos:a,reload:l}):d(null)},[o,s,n,l,d,a]),i)?(0,r.jsx)(eN,{title:"book"}):o&&n&&c?(0,r.jsx)(n0,{}):(0,r.jsx)(et,{})}function n2(){let{uuid:e}=(0,el.g)();return e?(0,r.jsx)(n1,{uuid:e}):(0,r.jsx)(eN,{title:"book"})}function n3(){return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(tw,{}),(0,r.jsxs)(el.BV,{children:[(0,r.jsx)(el.qh,{path:"/",element:(0,r.jsx)(id,{})}),(0,r.jsx)(el.qh,{path:"/add",element:(0,r.jsx)(tf,{})}),(0,r.jsx)(el.qh,{path:"/added-successful/:uuid",element:(0,r.jsx)(eM,{})}),(0,r.jsx)(el.qh,{path:"/view/:uuid",element:(0,r.jsx)(n2,{})}),(0,r.jsx)(el.qh,{path:"*",element:(0,r.jsx)(eN,{title:"page"})})]})]})}var n5=i(5681),n4=i(9648);function n8(e){return!!n6(e).length}function n6(e){return[...e.dataTransfer.items].filter(e=>"file"===e.kind||"string"===e.kind&&"text/uri-list"===e.type)}function n9(e){let{children:t}=e,[i,n]=(0,g.useState)(0),[a,o]=(0,g.useState)(null),[d,h]=(0,g.useState)(!1),[u,p]=(0,g.useState)(!1),f=(0,el.Zp)();return((0,g.useEffect)(()=>{(0,eJ.bI)(async()=>{let e,t,i;if(a){if(!a.langCode)return void h(!0);switch(p(!0),a.type){case"file-epub":e=a.buffer;break;case"file-html":i=a.html;break;case"file-text":e=await (0,eO.X)(a.content,a.title,a.langCode);break;case"url":t=a.url}e?await l.G.json({bufferBase64:(0,eH.Yi)(e),langCode:a.langCode,name:a.title,isTmp:!0}):t?await s.K.json({url:t,langCode:a.langCode,name:a.title,isTmp:!0}):i&&await e1.k.json({html:i,langCode:a.langCode,name:a.title,isTmp:!0}),p(!1),o(null),f("/books/view/$tmp")}})},[a,f]),u)?(0,r.jsx)(ee,{}):(0,r.jsxs)(eR,{style:{width:"100%",height:"100%",position:"relative"},gap:0,onDragEnter:e=>{n8(e)&&n(e=>e+1)},onDragLeave:e=>{n8(e)&&n(e=>e-1)},onDragOver:e=>{(0,A.aI)(e)},onDrop:e=>{e.preventDefault(),(0,eJ.bI)(async()=>{n(0),p(!0);try{for(let t of n6(e))if("file"===t.kind){let e=t.getAsFile();if(!e)continue;let i=function(e){let t=eF().extname(e.name);return eF().basename(e.name,t)}(e);if(eq(e)){let t=await e.arrayBuffer(),n=await eD.s.read(t);if(!n)continue;let a=(0,eB.R_)(n.language);return o({buffer:t,title:n.title??i,type:"file-epub",langCode:a})}if(eV(e)){let t=await e.text();return o({content:t,title:i,type:"file-text"})}if(eG(e)){let t=await e.text(),i=await (0,eK.dM)(t);return o({html:t,title:i,type:"file-html"})}}else if("string"===t.kind){let e=await new Promise(e=>{t.getAsString(e)});if(!(0,nb.g)(e))continue;let i=await c.h.json({url:e});return o({type:"url",url:e,title:i.title,langCode:i.lang})}}finally{p(!1)}})},children:[!!i&&(0,r.jsx)(eR,{style:{width:"100%",height:"100%",position:"absolute",justifyContent:"center",alignItems:"center",zIndex:1,backgroundColor:"var(--main-bg)"},children:(0,j.t)("prompt.dropHere")}),d&&(0,r.jsxs)("div",{style:{width:"100%",height:"100%",position:"absolute",zIndex:2,backgroundColor:"var(--main-bg)",padding:40},children:[(0,r.jsxs)(eR,{dir:"row",children:[(0,r.jsx)(eY.A,{style:{flex:1},children:(0,j.t)("prompt.selectLanguage")}),(0,r.jsx)(b.Ay,{shape:"circle",type:"text",onClick:()=>{o(null),h(!1)},icon:(0,r.jsx)(U,{icon:z.yYc})})]}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("language"),name:"langCode",required:!0,children:(0,r.jsx)(e0,{onChange:e=>{a&&e&&(o({...a,langCode:e}),h(!1))}})})]}),t]})}let n7="appBar-h5IaFg";function ae(e){let{progress:t}=e;return(0,r.jsx)("div",{style:{position:"absolute",top:0,left:0,height:"100%",width:`${100*t}%`,background:"var(--main-bg-highlight)",pointerEvents:"none"}})}let at=e=>{let{children:t}=e,i=eo()??en,[n]=(0,f.fp)(t1),[a,o]=(0,g.useState)(!1),s=(0,el.Zp)(),[l,c]=(0,g.useState)(!1),d=(0,r.jsxs)(eR,{className:[n7,"top"].join(" "),dir:"row",style:{justifyContent:"end",position:"relative"},gap:4,children:[!!n.topProgress&&(0,r.jsx)(ae,{progress:n.topProgress}),(0,r.jsxs)(eR,{dir:"row",style:{overflow:"hidden",alignItems:"center"},gap:4,children:[(0,r.jsx)(eT,{to:"/books",children:e=>(0,r.jsx)(b.Ay,{type:"link",size:"small",href:e,children:(0,r.jsx)(U,{size:"2xl",icon:z.LBj})})}),(0,r.jsx)(eY.A,{style:{flex:1,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",cursor:"pointer"},title:i,onClick:()=>{c(!0)},children:i}),(0,r.jsx)(w.A,{title:(0,j.t)("bookName"),open:l,footer:!1,onCancel:()=>c(!1),children:(0,r.jsx)(eY.A,{children:i})})]}),(0,r.jsx)(eR,{dir:"row",style:{alignItems:"center",flex:1},gap:4,children:n.topLeft}),(0,r.jsx)(eR,{dir:"row",style:{alignItems:"center"},gap:4,children:n.topRight})]}),h=(0,r.jsxs)(eR,{className:[n7,"bottom"].join(" "),dir:"row",style:{flexWrap:"wrap",justifyContent:"end"},gap:4,children:[(0,r.jsxs)(eR,{dir:"row",style:{alignItems:"center",flex:1},gap:4,children:[n.bottomLeft1,n.bottomLeft2]}),(0,r.jsxs)(eR,{dir:"row",style:{alignItems:"center"},gap:4,children:[n.bottomRight1,n.bottomRight2,(0,r.jsxs)(eR,{dir:"row",style:{alignItems:"center"},gap:4,children:[(0,r.jsx)(b.Ay,{shape:"circle",type:"text",onClick:()=>{o(e=>!e)},icon:(0,r.jsx)(U,{icon:z.BH7})}),(0,r.jsx)(iQ.A,{placement:"right",open:a,onClose:()=>o(!1),title:(0,j.t)("setting.title"),forceRender:!0,children:(0,r.jsxs)(eR,{style:{flex:1,minWidth:300,gap:6},children:[(0,r.jsxs)(eR,{style:{flex:1,gap:6},children:[n.settings,(0,r.jsx)(iZ,{})]}),(0,r.jsx)(eR,{children:"server"===n4._.appMode&&(0,r.jsx)(iz,{children:(0,r.jsx)(b.Ay,{type:"primary",block:!0,onClick:()=>{n5.S.json().then(()=>{s("/")}).catch(console.error)},children:(0,j.t)("logout")})})})]})})]})]})]});return(0,r.jsx)(n9,{children:(0,r.jsxs)(eR,{style:{width:"100%",height:"100%",alignContent:"space-around",justifyContent:"space-around"},children:[d,(0,r.jsx)("div",{style:{flex:1,padding:8,overflow:"hidden",overflowY:"auto"},children:t}),h]})})};var ai=i(1466);function an(){let e=(0,el.Zp)(),[t,i]=(0,g.useState)(),{data:n}=(0,eh.y3)(ed.h,null),[a]=eU.A.useForm();return(0,g.useEffect)(()=>{n&&n.info&&e("/")},[e,n]),(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("div",{style:{maxWidth:300,margin:"50px auto 0"},children:[(0,r.jsx)("h2",{children:"Auditory Reader"}),(0,r.jsx)("h4",{children:(0,j.t)("login")}),(0,r.jsxs)(eU.A,{form:a,initialValues:{account:"",password:""},onFinish:t=>{ai.H.json(t).then(async t=>{t.ok?e("/"):i((0,j.t)("error.login"))}).catch(console.error)},children:[(0,r.jsx)(eU.A.Item,{label:(0,j.t)("account"),name:"account",rules:[{required:!0}],children:(0,r.jsx)(ez.A,{placeholder:(0,j.t)("prompt.inputAccount")})}),(0,r.jsx)(eU.A.Item,{label:(0,j.t)("password"),name:"password",rules:[{required:!0}],validateStatus:t?"error":void 0,help:t,children:(0,r.jsx)(ez.A,{type:"password",placeholder:(0,j.t)("prompt.inputPassword")})}),(0,r.jsx)(eU.A.Item,{children:(0,r.jsx)(b.Ay,{type:"primary",block:!0,htmlType:"submit",children:(0,j.t)("submit")})})]})]})})}function aa(){let{data:e}=(0,eh.y3)(ed.h,null),t=(0,el.Zp)();return(0,g.useEffect)(()=>{e&&!e.info&&t("/login")},[t,e]),(0,r.jsx)(at,{children:(0,r.jsx)(n3,{})})}function ar(){let[,e]=eC(),[,t]=eI(),{addHotkeys:i}=T(),{openHint:n}=function(){let[,e]=(0,f.fp)(H),t=(0,g.useCallback)(function(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};clearTimeout(a);let n=i.timeout??3;e(t),a=setTimeout(()=>{e(null)},1e3*n)},[e]);return(0,g.useMemo)(()=>({openHint:t}),[t])}();return(0,g.useEffect)(()=>i([["[",(0,j.t)("hotkey.speedDown"),()=>e(e=>{let t=(10*e-1)/10;return n(`${(0,j.t)("speed")}: ${t}`),t})],["]",(0,j.t)("hotkey.speedUp"),()=>e(e=>{let t=(10*e+1)/10;return n(`${(0,j.t)("speed")}: ${t}`),t})],["-",(0,j.t)("hotkey.fontSizeDown"),()=>t(e=>{let t=e-1;return n(`${(0,j.t)("fontSize")}: ${t}`),t})],["=",(0,j.t)("hotkey.fontSizeUp"),()=>t(e=>{let t=e+1;return n(`${(0,j.t)("fontSize")}: ${t}`),t})],["r",(0,j.t)("hotkey.reload"),()=>{location.reload()}]]),[i,n,t,e]),(0,r.jsxs)(el.BV,{children:[(0,r.jsx)(el.qh,{path:"/login",element:(0,r.jsx)(an,{})}),(0,r.jsx)(el.qh,{path:"/books/*",element:(0,r.jsx)(aa,{})}),(0,r.jsx)(el.qh,{path:"/",element:(0,r.jsx)(el.C5,{to:"/books"})}),(0,r.jsx)(el.qh,{path:"*",element:(0,r.jsx)(at,{children:(0,r.jsx)(eN,{title:"page"})})})]})}function ao(){return(0,r.jsx)(ec.I9,{children:(0,r.jsx)(ar,{})})}async function as(){if("serviceWorker"in navigator)for(let e of(await navigator.serviceWorker.getRegistrations()))await e.unregister()}async function al(){if("server"===n4._.appMode)return await as(),"successful";if(!("serviceWorker"in navigator))return console.log("service-worker: unsupported"),"unsupported";await as();let e=n4._.appPublicRoot,t=await navigator.serviceWorker.register(new URL(i.p+i.u("705"),i.b),Object.assign({},{scope:e},{type:void 0}));return(await navigator.serviceWorker.ready,t.active)?(console.log("service-worker: registered"),"successful"):"failed"}function ac(){let e=iC(),[t,i]=(0,g.useState)(!1);return(0,g.useEffect)(()=>{al().then(e=>{"unsupported"===e?i("Service worker is unsupported"):"failed"===e?i("Service worker load failed"):i(!0)}).catch(e=>{i("Service worker load failed"),console.error(e)})},[]),(0,g.useEffect)(()=>{"dark"===e?document.documentElement.classList.add(y.aK):document.documentElement.classList.remove(y.aK)},[e]),(0,ei.u)(()=>{let e=document.createElement("style");e.innerHTML=nj;let t=document.head.querySelector("title");t&&t.nextSibling?document.head.insertBefore(e,t.nextSibling):document.head.prepend(e)}),(0,r.jsxs)(r.Fragment,{children:[!0===t&&(0,r.jsx)(ao,{}),!1===t&&(0,r.jsx)(ee,{}),"string"==typeof t&&(0,r.jsx)(p.A,{type:"error",message:t})]})}function ad(){return(0,r.jsx)(iS,{children:(0,r.jsxs)(m.Q,{backend:v.t,children:[(0,r.jsx)(ac,{}),(0,r.jsx)(G.ph,{}),(0,r.jsx)(G.p2,{}),(0,r.jsx)(V,{}),(0,r.jsx)(Z,{}),(0,r.jsx)(K,{}),(0,r.jsx)(es,{}),(0,r.jsx)($,{})]})})}j.Ay.init({resources:{en:{translation:{setting:{title:"Settings",autoNextSection:"Auto Next Section",timer:"Timer (Minute)",personReplace:"中文人称替换",speed:"$t(speed)",userColorScheme:"Color Scheme",paragraphRepeat:"Paragraph Repeat",disabledVertical:"Disable Vertical Direction",pageList:"Split Page",pageListType:{none:"None",auto:"Auto",single:"Single",double:"Double"},fontSize:"Font Size"},hotkey:{title:"Hotkeys",escape:"Quit / Cancel",ok:"Ok",speedUp:"Increase speed",speedDown:"Decrease speed",fontSizeUp:"Increase font size",fontSizeDown:"Decrease font size",reload:"Reload",helper:"Show the hotkeys",speakBookName:"Speak selected book name",playToggle:"Play / Pause",navToggle:"Toggle table contents panel",prevNav:"Select previous nav",nextNav:"Select next nav",gotoNav:"Go to selected nav",speakNav:"Speak selected nav",annotationsPanelToggle:"Toggle annotations panel",annotationToggle:"Add / Remove annotation for current paragraph",annotationNote:"Note current annotation",annotationRemoveSelected:"Remove selected annotation",prevAnnotation:"Select previous annotation",nextAnnotation:"Select next annotation",gotoAnnotation:"Go to selected annotation",speakAnnotation:"Speak selected annotation",keywordPanelToggle:"Toggle keywords panel",keywordAdd:"Add current selected keyword",keywordNote:"Note current keyword",keywordRemoveSelected:"Remove selected keyword",prevKeyword:"Select previous keyword",nextKeyword:"Select next keyword",gotoKeyword:"Go to selected keyword",speakKeyword:"Speak selected keyword",goBack:"Go back books index",prevSection:"Go to previous book section",nextSection:"Go to next book section",firstPage:"Scroll to first book page",lastPage:"Scroll to last book page",jumpPrevPage:"Go to previous book page",jumpNextPage:"Go to next book page",prevPage:"Scroll to previous book page",nextPage:"Scroll to next book page",firstParagraph:"Go to first paragraph",lastParagraph:"Go to last paragraph",prevParagraph:"Go to previous paragraph",nextParagraph:"Go to next paragraph",prevSearchResult:"Go to previous search result",nextSearchResult:"Go to next search result",gotoSearchResult:"Go to selected search result",goPrev:"Go to previous",goNext:"Go to next",goTop:"Go to the top",goBottom:"Move selection to bottom",goPagePrev:"Go to previous page",goPageNext:"Go to next page",goPageFirst:"Go to first page",goPageLast:"Go to last page",goMovePrev:"Move selection to previous",goMoveNext:"Move selection to next",goMoveTop:"Move selection to top",listArchive:"Toggle display of list archived books",listFavorite:"Toggle display of list favorited books",archive:"Toggle archive",favorite:"Toggle favorite",search:"Focus to search input",sortOrder:"Select sort order",edit:"Edit current selection",select:"Toggle select",selectShift:"Mark from last select to current as selected",selectAll:"Toggle select all",open:"Open current selection",editBook:"Edit book",remove:"Remove current selection",pinchUp:"Move up",pinchDown:"Move down",pinchLeft:"Move left",pinchRight:"Move right",pinchZoomOut:"Zoom out",pinchZoomIn:"Zoom in",pinchReset:"Reset zoom"},confirm:{ok:"Ok",cancel:"Cancel",openLink:"$t(open) $t(link)?"},desc:{bookAddedSuccessful:"Successfully added a new book",annotationUpdated:"Updated a $t(annotation)",annotationDeleted:"Deleted a $t(annotation)",annotationNoSupported:"No support $t(annotation) type",annotationsEmpty:"$t(annotation)s empty",keywordUpdated:"Updated a $t(keyword)",keywordDeleted:"Deleted a $t(keyword)",keywordNoSupported:"No support $t(keyword) type",keywordsEmpty:"$t(keywords) empty",navEmpty:"$t(nav) empty"},prompt:{inputBookName:"Please input $t(bookName).",selectLanguage:"Please select the $t(language).",inputAccount:"Please input your $t(account).",inputPassword:"Please input your $t(password).",dropHere:"drop .epub file、.txt file、text or URL to here.",dropHereToRemove:"Drop here to remove it.",annotationRemoveConfirm:"Remove this $t(annotation) with $t(note)?",keywordRemoveConfirm:"Remove this $t(keyword) with $t(note)?",uploadBook:"Support .epub and .txt.",importBooks:"Import .zip file.",noBooks:"No books here, Add your first book.",noSearchMatches:"No search matches"},sortOrder:{label:"Sort order",item:{default:"Default",reverse:"Reverse",name:"Name",nameReverse:"Name reverse"}},error:{login:"$t(account) or $t(password) error"},title:"Title",note:"Note",speed:"Speed",fontSize:"Font Size",view:"View",account:"Account",password:"Password",login:"Login",logout:"Logout",submit:"Submit",select:"Select",add:"Add",tmpStore:"Store temporary file",top:"Top",edit:"Edit",editBook:"Edit book",remove:"Remove",update:"Update",export:"Export",exportSelected:"Export selected",exportAll:"Export all",import:"Import",bookName:"Book name",favorite:"Favorite",archive:"Archive",unarchive:"Unarchive",progress:"Progress",search:"Search",cover:"Cover",nav:"Table contents",annotation:"Annotation",keyword:"Keyword",alias:"Alias",open:"open",url:"URL",extractUrlInfo:"Extract URL info",bookContent:"Book content",language:"Language",empty:"Empty",file:"File",text:"Text",system:"System",dark:"Dark",light:"Light",cancel:"Cancel",all:"All"}},zh:{translation:{setting:{title:"设置",autoNextSection:"自动下一章节",timer:"计时器 (分钟)",personReplace:"中文人称替换",speed:"$t(speed)",userColorScheme:"颜色主题",paragraphRepeat:"段落重复",disabledVertical:"禁用垂直方向",pageList:"分页",pageListType:{none:"无",auto:"自动",single:"单页",double:"双页"},fontSize:"字体大小"},hotkey:{title:"快捷键",escape:"退出 / 取消",ok:"确定",speedUp:"提高速度",speedDown:"降低速度",fontSizeUp:"提高字体大小",fontSizeDown:"降低字体大小",reload:"刷新页面",helper:"显示快捷键",speakBookName:"朗读选择的书名",playToggle:"播放 / 暂停",navToggle:"开关显示导航",prevNav:"选择上一个导航",nextNav:"选择下一个导航",gotoNav:"跳转到选择的导航",speakNav:"朗读选择的导航",annotationsPanelToggle:"开关显示注解",annotationToggle:"添加或删除当前段落的注解",annotationNote:"添加当前段落的注解的备注",annotationRemoveSelected:"删除选择的注解",prevAnnotation:"选择上一个注解",nextAnnotation:"选择下一个注解",gotoAnnotation:"跳转到选择的注解",speakAnnotation:"朗读选择的注解",keywordPanelToggle:"开关显示关键字",keywordAdd:"添加当前选择关键字",keywordNote:"添加当前关键字的备注",keywordRemoveSelected:"删除选择的关键字",prevKeyword:"选择上一个关键字",nextKeyword:"选择下一个关键字",gotoKeyword:"跳转到选择的关键字",speakKeyword:"朗读选择的关键字",goBack:"回到书本目录",prevSection:"跳到本书上一部份",nextSection:"跳到本书下一部份",firstPage:"滚动到本书第一页",lastPage:"滚动到本书最后一页",jumpPrevPage:"跳到本书上一页面",jumpNextPage:"跳到本书下一页面",prevPage:"滚动到本书上一页面",nextPage:"滚动到本书下一页面",firstParagraph:"跳到本书第一段落",lastParagraph:"跳到本书最后一段落",prevParagraph:"跳到本书上一段落",nextParagraph:"跳到本书下一段落",prevSearchResult:"选择上一个搜索结果",nextSearchResult:"选择下一个搜索结果",gotoSearchResult:"跳转到选择的搜索结果",goPrev:"去到上一个",goNext:"去到下一个",goTop:"去到顶部",goBottom:"去到底部",goPagePrev:"去到上一页面",goPageNext:"去到下一页面",goPageFirst:"去到第一页",goPageLast:"去到最后一页",goMovePrev:"挪到上一个",goMoveNext:"挪到下一个",goMoveTop:"挪到顶部",listArchive:"开关显示存档列表",listFavorite:"开关显示喜欢列表",archive:"开关存档",favorite:"开关喜欢",search:"聚焦到搜索输入框",sortOrder:"选择排序",edit:"编辑当前选择",select:"开关选择",selectShift:"把最后一次选择至当位置的标记为选择",selectAll:"开关选择全部",open:"打开当前选择",editBook:"编辑本书",remove:"删除当前选择",pinchUp:"上移",pinchDown:"下移",pinchLeft:"左移",pinchRight:"右移",pinchZoomOut:"缩小",pinchZoomIn:"放大",pinchReset:"重置"},confirm:{ok:"确定",cancel:"取消",openLink:"$t(open)$t(link)?"},desc:{bookAddedSuccessful:"成功添加了一本新书",annotationUpdated:"更新了一个$t(annotation)",annotationDeleted:"删除了一个$t(annotation)",annotationNoSupported:"不支持的$t(annotation)类型",annotationsEmpty:"$t(annotation)为空",keywordUpdated:"更新了一个$t(keyword)",keywordDeleted:"删除了一个$t(keyword)",keywordNoSupported:"No support $t(keyword) type",keywordsEmpty:"$t(keyword)为空",navEmpty:"$t(nav)为空"},prompt:{inputBookName:"请输入$t(bookName)",selectLanguage:"请选择$t(language)",inputAccount:"请输入$t(account)",inputPassword:"请输入$t(password)",dropHere:"拖动 .epub 文件、.txt 文件、文本或 URL 到这里。",dropHereToRemove:"拖放到这里删除。",annotationRemoveConfirm:"删除此$t(annotation)和$t(note)吗?",keywordRemoveConfirm:"删除此$t(keyword)吗?",uploadBook:"支持 .epub 和 .txt",importBooks:"导入 .zip 文件",noBooks:"这里没有书籍，添加你的第一本书吧。",noSearchMatches:"没有找到匹配项"},sortOrder:{label:"排序",item:{default:"默认",reverse:"反序",name:"名称",nameReverse:"名称反序"}},error:{login:"$t(account)或$t(password)错误"},title:"标题",note:"备注",speed:"速度",fontSize:"字体大小",view:"浏览",account:"帐号",password:"密码",login:"登录",logout:"登出",submit:"提交",select:"选择",add:"添加",tmpStore:"存储临时文件",top:"置顶",edit:"编辑",editBook:"编辑本书",remove:"删除",update:"更新",export:"导出",exportSelected:"导出选中的",exportAll:"导出全部",import:"导入",bookName:"书名",favorite:"喜欢",archive:"存档",unarchive:"取消存档",progress:"进度",search:"搜索",cover:"封面",nav:"导航",annotation:"注解",keyword:"关键词",alias:"别名",open:"打开",url:"URL",extractUrlInfo:"提取URL信息",bookContent:"文本内容",language:"语言",empty:"空",file:"文件",text:"文本",system:"系统",dark:"暗色",light:"亮色",cancel:"取消",all:"全部"}}},lng:i.g.navigator.languages.at(0)??"en"}).catch(console.error),o.createRoot(document.getElementById("root")).render((0,r.jsx)(function(){return(0,r.jsx)(f.Kq,{store:_.J,children:(0,r.jsx)(ad,{})})},{}))},697(e,t,i){i.d(t,{J:()=>n});let n=(0,i(8507).y$)()}},s={};function l(e){var t=s[e];if(void 0!==t)return t.exports;var i=s[e]={exports:{}};return o[e].call(i.exports,i,i.exports,l),i.exports}l.m=o,l.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return l.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,l.t=function(i,n){if(1&n&&(i=this(i)),8&n||"object"==typeof i&&i&&(4&n&&i.__esModule||16&n&&"function"==typeof i.then))return i;var a=Object.create(null);l.r(a);var r={};e=e||[null,t({}),t([]),t(t)];for(var o=2&n&&i;("object"==typeof o||"function"==typeof o)&&!~e.indexOf(o);o=t(o))Object.getOwnPropertyNames(o).forEach(e=>{r[e]=()=>i[e]});return r.default=()=>i,l.d(a,r),a},l.d=(e,t)=>{for(var i in t)l.o(t,i)&&!l.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},l.u=e=>""+e+".3e2f8104.js",l.g=(()=>{if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}})(),l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"u">typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i=[],l.O=(e,t,n,a)=>{if(t){a=a||0;for(var r=i.length;r>0&&i[r-1][2]>a;r--)i[r]=i[r-1];i[r]=[t,n,a];return}for(var o=1/0,r=0;r<i.length;r++){for(var[t,n,a]=i[r],s=!0,c=0;c<t.length;c++)(!1&a||o>=a)&&Object.keys(l.O).every(e=>l.O[e](t[c]))?t.splice(c--,1):(s=!1,a<o&&(o=a));if(s){i.splice(r--,1);var d=n();void 0!==d&&(e=d)}}return e},l.p="/auditory-reader/",l.b=document.baseURI||self.location.href,n={410:0},l.O.j=e=>0===n[e],a=(e,t)=>{var i,a,[r,o,s]=t,c=0;if(r.some(e=>0!==n[e])){for(i in o)l.o(o,i)&&(l.m[i]=o[i]);if(s)var d=s(l)}for(e&&e(t);c<r.length;c++)a=r[c],l.o(n,a)&&n[a]&&n[a][0](),n[a]=0;return l.O(d)},(r=self.webpackChunkauditory_reader=self.webpackChunkauditory_reader||[]).forEach(a.bind(null,0)),r.push=a.bind(null,r.push.bind(r));var c=l.O(void 0,["783","535","551","225","718"],()=>l(1993));c=l.O(c)})();