(()=>{"use strict";var e={9237:function(e,t,n){n.d(t,{P:function(){return j},n:function(){return f}});var i=n(2790),r=n(3747),a=n(1479),o=n(3062),s=n(6513),l=n.n(s),c=n(4210),d=n.n(c),u=n(6092),h=n(891);function*p(e,t,n){let[i,...r]=t;if(!i){if(n)for(let t of e.querySelectorAll(n))yield t;else yield e;return}for(let t of e.children)("*"===i||t.tagName.toLowerCase()===i.toLowerCase())&&(yield*p(t,r,n))}let f='nav[epub\\:type="toc"]';var g=new WeakMap,m=new WeakMap,v=new WeakMap,y=new WeakMap,x=new WeakMap,w=new WeakMap,k=new WeakMap,b=new WeakMap;class j{static async getRootPath(e){var t;let n=await e.htmlDom("META-INF/container.xml");if(!n){console.error("Parse META-INF/container.xml error");return}let i=null===(t=n.querySelector("rootfile"))||void 0===t?void 0:t.getAttribute("full-path");if(!i){console.error("rootfile full-path not found");return}return l().join("/",i)}static async read(e){let t=await d().loadAsync(e),n=new h.H(t),i=await this.getRootPath(n);if(!i){console.error(`epub root-path(${i}) not found`);return}let r=await n.xmlDom(i);if(!r){console.error("epub root document not found");return}return new j(t,n,r,l().dirname(i))}get version(){if(!(0,i._)(this,g)){let e=this.rootPkg.getAttribute("version")??"2.0";(0,a._)(this,g,parseFloat(e)>=3?3:2)}return(0,i._)(this,g)}get title(){if(!(0,i._)(this,m)){var e,t;let n=null===(e=this.rootPkg.findDescendant("metadata"))||void 0===e?void 0:e.findDescendant("dc:title");(0,a._)(this,m,(null==n?void 0:null===(t=n.text())||void 0===t?void 0:t.trim())??null)}return(0,i._)(this,m)}get language(){if(!(0,i._)(this,v)){var e,t;let n=null===(e=this.rootPkg.findDescendant("metadata"))||void 0===e?void 0:e.findDescendant("dc:language");(0,a._)(this,v,(null==n?void 0:null===(t=n.text())||void 0===t?void 0:t.trim())??null)}return(0,i._)(this,v)}get manifestItems(){if(!(0,i._)(this,y)){var e;let t=(null===(e=this.rootPkg.findDescendant("manifest"))||void 0===e?void 0:e.childrenFilter("item"))??[];(0,a._)(this,y,t.map(e=>({id:e.getAttribute("id"),href:l().join(this.rootDir,e.getAttribute("href")),mediaType:e.getAttribute("media-type"),properties:e.getAttribute("properties")??void 0})))}return(0,i._)(this,y)}get spine(){if(!(0,i._)(this,x)&&((0,a._)(this,x,this.rootPkg.findDescendant("spine")??void 0),!(0,i._)(this,x)))throw Error("spine not found");return(0,i._)(this,x)}get spineItems(){return!(0,i._)(this,w)&&(0,a._)(this,w,(0,u.oA)([...this.spine.childrenFilter("itemref")].map(e=>{let t=e.getAttribute("idref"),n=this.manifestItems.find(e=>e.id===t);if(n)return{manifest:n,idref:t,linear:e.getAttribute("linear")}}))),(0,i._)(this,w)}get spines(){return!(0,i._)(this,k)&&(0,a._)(this,k,this.spineItems.map(e=>({href:e.manifest.href,id:e.idref}))),(0,i._)(this,k)}async file(e){let t=await this.xmlLoader.file(e);if(!t)return;let n=await t.arrayBuffer(),i=e.startsWith("/")?e:`/${e}`,r=this.manifestItems.find(e=>e.href==i);return{buffer:n,mediaType:null==r?void 0:r.mediaType}}async cover(){var e;let t=null===(e=this.rootPkg.findDescendant("metadata"))||void 0===e?void 0:e.findDescendants("meta").find(e=>"cover"===e.getAttribute("name"));if(!t)return;let n=t.getAttribute("content");if(!n)return;let i=this.manifestItems.find(e=>e.id===n);if(!(null==i?void 0:i.href))return;let r=await this.xmlLoader.file(i.href);if(!!r)return{buffer:await r.arrayBuffer(),mediaType:i.mediaType}}async content(e){return this.xmlLoader.content(e)}async xmlDom(e){return this.xmlLoader.xmlDom(e)}async htmlDom(e){return this.xmlLoader.htmlDom(e)}dirBySpineIndex(e){let t=this.spineItems[e];if(t)return l().dirname(t.manifest.href)}getSpineIndexByHref(e){let t=this.spineItems.findIndex(t=>t.manifest.href===e);if(-1!==t)return t}async loadNav3(){let e=this.manifestItems.find(e=>"nav"===e.properties);if(!e)return this.loadNav2();let t=await this.htmlDom(e.href),n=l().dirname(e.href);if(!t)return[];let i=t.querySelector(`${f}>ol`);return i?this.parseNav3(i,n):[]}parseNav3(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return(0,u.oA)(Array.from(p(e,["li"])).map(e=>{var i;let r,a,o,s;let c=Array.from(e.children).find(e=>"ol"!==e.tagName.toLowerCase());if(!c)return;let d=c.textContent??"";if("a"===c.tagName.toLowerCase()){let e=c.getAttribute("href");e&&(r=l().join(t,e),[a,o]=r.split("#",2),a&&(s=this.getSpineIndexByHref(a)))}let u=p(e,["ol"],void 0).next().value??null;return{level:n,label:d,href:r,hrefBase:a,hrefAnchor:o,spineIndex:s,children:u?this.parseNav3(u,t,n+1):[]}}))}async loadNav2(){let e=this.spine.getAttribute("toc")??"ncx",t=this.manifestItems.find(t=>t.id===e);if(!t)return[];let n=await this.xmlDom(t.href),i=l().dirname(t.href);if(!n)return[];let r=n.findDescendant("navMap");return r?this.parseNav2(r,i):[]}parseNav2(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return(0,u.oA)(e.childrenFilter("navPoint").map(e=>{var i,r,a;let o,s,c,d;let u=null===(r=e.findChild("navLabel"))||void 0===r?void 0:null===(i=r.findChild("text"))||void 0===i?void 0:i.text();if(!u)return;let h=null===(a=e.findChild("content"))||void 0===a?void 0:a.getAttribute("src");return h&&(o=l().join(t,h),[s,c]=o.split("#",2),s&&(d=this.getSpineIndexByHref(s))),{level:n,label:u,href:o,hrefBase:s,hrefAnchor:c,spineIndex:d,children:this.parseNav2(e,t,n+1)}}))}async navs(){return!(0,i._)(this,b)&&(this.version>=3?(0,a._)(this,b,await this.loadNav3()):(0,a._)(this,b,await this.loadNav2())),(0,i._)(this,b)}constructor(e,t,n,i){(0,o._)(this,"zip",void 0),(0,o._)(this,"xmlLoader",void 0),(0,o._)(this,"rootPkg",void 0),(0,o._)(this,"rootDir",void 0),(0,r._)(this,g,{writable:!0,value:void 0}),(0,r._)(this,m,{writable:!0,value:void 0}),(0,r._)(this,v,{writable:!0,value:void 0}),(0,r._)(this,y,{writable:!0,value:void 0}),(0,r._)(this,x,{writable:!0,value:void 0}),(0,r._)(this,w,{writable:!0,value:void 0}),(0,r._)(this,k,{writable:!0,value:void 0}),(0,r._)(this,b,{writable:!0,value:void 0}),this.zip=e,this.xmlLoader=t,this.rootPkg=n,this.rootDir=i}}},107:function(e,t,n){n.d(t,{A4:function(){return u},DJ:function(){return i},HQ:function(){return f},JK:function(){return p},TO:function(){return c},TX:function(){return o},Xp:function(){return a},b6:function(){return r},i9:function(){return g},is:function(){return d},jM:function(){return h},lc:function(){return s},n1:function(){return m},pJ:function(){return l}});let i="auditory-reader",r="__para_box__",a="__para_ignore__",o="__para_active__",s="__para_annotation__",l="__root_annotation_highlight__",c="__root_keyword_highlight__",d="__root_utterer_highlight__",u="__img_max_width__",h="__img_max_height__",p="__color_scheme_dark__",f="__column_break__",g={妳:{word:"乃",pinyin:"naǐ"},她:{word:"伊",pinyin:"yī"},它:{word:"牠",pinyin:"tu\xf3"}},m="$tmp"},5860:function(e,t,n){n.d(t,{M:function(){return c},p:function(){return l}});var i=n(4933),r=n(5224),a=n(8205),o=n(6836),s=n(107);async function l(e,t,n){let i=(0,a.WM)(e).map(e=>`<p>${e}</p>`).join("\r\n");i=e.replace(/<p>/g,'<p class="para">').replace(/<h1>/g,'<h1 class="heading">');let r=`
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="UTF-8">
    <title>${t}</title>
  </head>
  <body>
    ${i}
  </body>
  </html>
  `;return await c(r,n)}async function c(e,t,n){let a=(0,r.rV)(e),l=await (0,r.w8)(a.doc),c=(0,i.Z)(),d=new Date;return await new o.k({title:a.doc.title,date:d,htmlContent:l,lang:t,publisher:s.DJ,sourceURL:n,uuid:c}).gen()}},3098:function(e,t,n){n.d(t,{Wx:function(){return s},sF:function(){return d}});var i=n(5271),r=n(6092);let a=[{code:"ab",name:"Abkhazian"},{code:"aa",name:"Afar"},{code:"af",name:"Afrikaans"},{code:"ak",name:"Akan"},{code:"sq",name:"Albanian"},{code:"am",name:"Amharic"},{code:"ar",name:"Arabic"},{code:"an",name:"Aragonese"},{code:"hy",name:"Armenian"},{code:"as",name:"Assamese"},{code:"av",name:"Avaric"},{code:"ae",name:"Avestan"},{code:"ay",name:"Aymara"},{code:"az",name:"Azerbaijani"},{code:"bm",name:"Bambara"},{code:"ba",name:"Bashkir"},{code:"eu",name:"Basque"},{code:"be",name:"Belarusian"},{code:"bn",name:"Bengali (Bangla)"},{code:"bh",name:"Bihari"},{code:"bi",name:"Bislama"},{code:"bs",name:"Bosnian"},{code:"br",name:"Breton"},{code:"bg",name:"Bulgarian"},{code:"my",name:"Burmese"},{code:"ca",name:"Catalan"},{code:"ch",name:"Chamorro"},{code:"ce",name:"Chechen"},{code:"ny",name:"Chichewa, Chewa, Nyanja"},{code:"zh",name:"Chinese"},{code:"cv",name:"Chuvash"},{code:"kw",name:"Cornish"},{code:"co",name:"Corsican"},{code:"cr",name:"Cree"},{code:"hr",name:"Croatian"},{code:"cs",name:"Czech"},{code:"da",name:"Danish"},{code:"dv",name:"Divehi, Dhivehi, Maldivian"},{code:"nl",name:"Dutch"},{code:"dz",name:"Dzongkha"},{code:"en",name:"English"},{code:"eo",name:"Esperanto"},{code:"et",name:"Estonian"},{code:"ee",name:"Ewe"},{code:"fo",name:"Faroese"},{code:"fj",name:"Fijian"},{code:"fi",name:"Finnish"},{code:"fr",name:"French"},{code:"ff",name:"Fula, Fulah, Pulaar, Pular"},{code:"gl",name:"Galician"},{code:"gd",name:"Gaelic (Scottish)"},{code:"gv",name:"Gaelic (Manx)"},{code:"ka",name:"Georgian"},{code:"de",name:"German"},{code:"el",name:"Greek"},{code:"kl",name:"Greenlandic"},{code:"gn",name:"Guarani"},{code:"gu",name:"Gujarati"},{code:"ht",name:"Haitian Creole"},{code:"ha",name:"Hausa"},{code:"he",name:"Hebrew"},{code:"hz",name:"Herero"},{code:"hi",name:"Hindi"},{code:"ho",name:"Hiri Motu"},{code:"hu",name:"Hungarian"},{code:"is",name:"Icelandic"},{code:"io",name:"Ido"},{code:"ig",name:"Igbo"},{code:"id, in",name:"Indonesian"},{code:"ia",name:"Interlingua"},{code:"ie",name:"Interlingue"},{code:"iu",name:"Inuktitut"},{code:"ik",name:"Inupiak"},{code:"ga",name:"Irish"},{code:"it",name:"Italian"},{code:"ja",name:"Japanese"},{code:"jv",name:"Javanese"},{code:"kl",name:"Kalaallisut, Greenlandic"},{code:"kn",name:"Kannada"},{code:"kr",name:"Kanuri"},{code:"ks",name:"Kashmiri"},{code:"kk",name:"Kazakh"},{code:"km",name:"Khmer"},{code:"ki",name:"Kikuyu"},{code:"rw",name:"Kinyarwanda (Rwanda)"},{code:"rn",name:"Kirundi"},{code:"ky",name:"Kyrgyz"},{code:"kv",name:"Komi"},{code:"kg",name:"Kongo"},{code:"ko",name:"Korean"},{code:"ku",name:"Kurdish"},{code:"kj",name:"Kwanyama"},{code:"lo",name:"Lao"},{code:"la",name:"Latin"},{code:"lv",name:"Latvian (Lettish)"},{code:"li",name:"Limburgish ( Limburger)"},{code:"ln",name:"Lingala"},{code:"lt",name:"Lithuanian"},{code:"lu",name:"Luga-Katanga"},{code:"lg",name:"Luganda, Ganda"},{code:"lb",name:"Luxembourgish"},{code:"gv",name:"Manx"},{code:"mk",name:"Macedonian"},{code:"mg",name:"Malagasy"},{code:"ms",name:"Malay"},{code:"ml",name:"Malayalam"},{code:"mt",name:"Maltese"},{code:"mi",name:"Maori"},{code:"mr",name:"Marathi"},{code:"mh",name:"Marshallese"},{code:"mo",name:"Moldavian"},{code:"mn",name:"Mongolian"},{code:"na",name:"Nauru"},{code:"nv",name:"Navajo"},{code:"ng",name:"Ndonga"},{code:"nd",name:"Northern Ndebele"},{code:"ne",name:"Nepali"},{code:"no",name:"Norwegian"},{code:"nb",name:"Norwegian bokm\xe5l"},{code:"nn",name:"Norwegian nynorsk"},{code:"ii",name:"Nuosu"},{code:"oc",name:"Occitan"},{code:"oj",name:"Ojibwe"},{code:"cu",name:"Old Church Slavonic, Old Bulgarian"},{code:"or",name:"Oriya"},{code:"om",name:"Oromo (Afaan Oromo)"},{code:"os",name:"Ossetian"},{code:"pi",name:"Pāli"},{code:"ps",name:"Pashto, Pushto"},{code:"fa",name:"Persian (Farsi)"},{code:"pl",name:"Polish"},{code:"pt",name:"Portuguese"},{code:"pa",name:"Punjabi (Eastern)"},{code:"qu",name:"Quechua"},{code:"rm",name:"Romansh"},{code:"ro",name:"Romanian"},{code:"ru",name:"Russian"},{code:"se",name:"Sami"},{code:"sm",name:"Samoan"},{code:"sg",name:"Sango"},{code:"sa",name:"Sanskrit"},{code:"sr",name:"Serbian"},{code:"sh",name:"Serbo-Croatian"},{code:"st",name:"Sesotho"},{code:"tn",name:"Setswana"},{code:"sn",name:"Shona"},{code:"ii",name:"Sichuan Yi"},{code:"sd",name:"Sindhi"},{code:"si",name:"Sinhalese"},{code:"ss",name:"Siswati"},{code:"sk",name:"Slovak"},{code:"sl",name:"Slovenian"},{code:"so",name:"Somali"},{code:"nr",name:"Southern Ndebele"},{code:"es",name:"Spanish"},{code:"su",name:"Sundanese"},{code:"sw",name:"Swahili (Kiswahili)"},{code:"ss",name:"Swati"},{code:"sv",name:"Swedish"},{code:"tl",name:"Tagalog"},{code:"ty",name:"Tahitian"},{code:"tg",name:"Tajik"},{code:"ta",name:"Tamil"},{code:"tt",name:"Tatar"},{code:"te",name:"Telugu"},{code:"th",name:"Thai"},{code:"bo",name:"Tibetan"},{code:"ti",name:"Tigrinya"},{code:"to",name:"Tonga"},{code:"ts",name:"Tsonga"},{code:"tr",name:"Turkish"},{code:"tk",name:"Turkmen"},{code:"tw",name:"Twi"},{code:"ug",name:"Uyghur"},{code:"uk",name:"Ukrainian"},{code:"ur",name:"Urdu"},{code:"uz",name:"Uzbek"},{code:"ve",name:"Venda"},{code:"vi",name:"Vietnamese"},{code:"vo",name:"Volap\xfck"},{code:"wa",name:"Wallon"},{code:"cy",name:"Welsh"},{code:"wo",name:"Wolof"},{code:"fy",name:"Western Frisian"},{code:"xh",name:"Xhosa"},{code:"yi",name:"Yiddish"},{code:"ji",name:"Yiddish"},{code:"yo",name:"Yoruba"},{code:"za",name:"Zhuang, Chuang"},{code:"zu",name:"Zulu"}],o=a.map(e=>e.code),s=e=>{if(!e)return;if(e.includes("-")&&(e=e.split("-")[0]),!!e){if(e.includes("_")&&(e=e.split("_")[0]),e){if(e=e.toLowerCase(),!o.includes(e))return;return e}}},l=()=>(0,i.useMemo)(()=>n.g.navigator.languages,[]),c=()=>{let e=l();return(0,i.useMemo)(()=>(0,r.Xo)(a,"asc",t=>-1===e.indexOf(t.code)?0:1),[e])},d=()=>{let e=c();return(0,i.useMemo)(()=>e.map((e,t)=>({key:t,value:e.code,label:`${e.name} (${e.code})`})),[e])}},5016:function(e,t,n){n.d(t,{A9:function(){return c},BH:function(){return p},Pk:function(){return d},Pq:function(){return h},sN:function(){return u}});var i=n(3062),r=n(6513),a=n.n(r),o=n(5271),s=n(5),l=n(3448);class c extends Error{constructor(){super()}}class d extends Error{constructor(e){super(),(0,i._)(this,"message",void 0),this.message=e}}class u extends Error{constructor(e){super(),(0,i._)(this,"data",void 0),this.data=e}}function h(e){return a().join(l.O.appApiRoot,e)}function p(e,t,n){let i=(0,s.s0)(),r=(0,o.useRef)(t);r.current=t;let a=JSON.stringify(t),l=(0,o.useRef)(n);l.current=n;let[d,u]=(0,o.useState)(),[h,p]=(0,o.useState)(),f=(0,o.useCallback)(t=>{e.json(r.current).then(e=>{!t.aborted&&u(e)}).catch(e=>{if(!t.aborted){if(e instanceof c)return i("/login"),null;else p(e)}})},[i,e]),g=(0,o.useCallback)(e=>{var t;(null===(t=l.current)||void 0===t?void 0:t.clearWhenReload)!==!1&&(u(void 0),p(void 0)),f((null==e?void 0:e.signal)??new AbortController().signal)},[f]);return(0,o.useEffect)(()=>{if(!a||(null==n?void 0:n.request)===!1)return;let e=new AbortController;return g({signal:e.signal}),()=>{e.abort()}},[a,null==n?void 0:n.request,g]),{data:d,reload:g,error:h}}},6689:function(e,t,n){n.d(t,{xx:function(){return i}}),n(3062),n(3448);class i extends Error{}},5128:function(e,t,n){n.d(t,{K3:function(){return d},Yy:function(){return l},jI:function(){return o},mA:function(){return s},xS:function(){return c}});var i=n(6092),r=n(5224),a=n(8205);function o(){return".epub"}function s(e){return(0,a.uq)(e).map(e=>e.trim()).find(e=>!!e)}async function l(e){return(0,r.rV)(e).doc.title}function c(e){return{name:e.name,langCode:e.langCode,isFavorited:e.isFavorited,isArchived:!!e.isArchived,uuid:e.uuid,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt),isTmp:e.isTmp,position:e.position??null,pageParagraphs:e.pageParagraphs??null}}function d(e){let t=0;if(e.position&&e.pageParagraphs){let n=e.position.section,r=(0,i.Sm)(e.pageParagraphs.slice(0,n).map(e=>e.paragraphCount))+e.position.paragraph;t=Math.round(r/(0,i.Sm)(e.pageParagraphs.map(e=>e.paragraphCount))*100)/100}return{name:e.name,langCode:e.langCode,isFavorited:e.isFavorited,isArchived:!!e.isArchived,uuid:e.uuid,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt),isTmp:e.isTmp,position:e.position??null,progress:t}}},9835:function(e,t,n){n.d(t,{G6:function(){return s},jU:function(){return r},oL:function(){return a},tq:function(){return o},vU:function(){return l}});var i=n(2257);let r="undefined"!=typeof self,a="ontouchstart"in(r?globalThis.window??{}:{}),o=r&&(0,i.Z)(navigator.userAgent).any,s=r&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent),l=r&&navigator.userAgent.toLowerCase().includes("firefox")},6092:function(e,t,n){function i(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e<t?1:-1,i=[];if(n>0)for(let r=e;r<t;r+=n)i.push(r);else if(n<0)for(let r=e;r>t;r+=n)i.push(r);return i}function r(e){return e.filter(e=>!!e)}function a(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length-1,i=n;for(;i>=0;){let n=e[i];if(!!n){if(t(n,i,e))return[n,i];i-=1}}return[void 0,void 0]}function o(e,t,n){return a(e,t,n)[1]}function s(e,t,n){return a(e,t,n)[0]}function l(e,t,n){let i=[...e.entries()],r=(e,t)=>{if("string"==typeof e&&"string"==typeof t)return e.localeCompare(t);if("number"==typeof e&&"number"==typeof t)return e-t;if("boolean"==typeof e&&"boolean"==typeof t)return Number(e)-Number(t);else if(Array.isArray(e)&&Array.isArray(t)){for(let[n,i]of e.entries()){let e=t.at(n);if(void 0===e)break;let a=r(i,e);if(0!==a)return a}return 0}else throw Error(`no support order by type(${typeof e} vs ${typeof t})`)};return i.sort((t,i)=>{let[a,o]=t,[s,l]=i,c=n(o,a,e);return r(c,n(l,s,e))}),"desc"===t&&i.reverse(),i.map(e=>e[1])}function c(e){return e.reduce((e,t)=>e+t,0)}n.d(t,{L_:function(){return a},Sm:function(){return c},Xo:function(){return l},dF:function(){return s},oA:function(){return r},qr:function(){return o},w6:function(){return i}})},9883:function(e,t,n){n.d(t,{RG:function(){return a},lE:function(){return o},sM:function(){return r}});var i=n(9835);function r(e){if(!i.jU)return Buffer.from(e).toString("base64");{let t="";for(let n of new Uint8Array(e))t+=String.fromCharCode(n);return self.btoa(t)}}function a(e){return i.jU?Uint8Array.from(self.atob(e),e=>e.charCodeAt(0)):Uint8Array.from(Buffer.from(e,"base64"))}function o(e){return new TextDecoder().decode(e)}},5224:function(e,t,n){n.d(t,{BM:function(){return u},cK:function(){return s},hO:function(){return v},kK:function(){return h},lJ:function(){return y},pC:function(){return p},rV:function(){return l},tp:function(){return d},w8:function(){return f}});var i=n(7791),r=n(2479),a=n(3448);let o=Symbol("DOMView");function s(e){return!!(e instanceof Element&&["textarea","input"].includes(e.tagName.toLowerCase()))||!1}function l(e){let t=new globalThis.JSDOM("",{pretendToBeVisual:!0}),n=new t.window.DOMParser().parseFromString(e,"text/html");return n[o]=t.window,{view:t.window,doc:n}}function c(e){var t,n;return(null==e?void 0:e.defaultView)||(null==e?void 0:null===(t=e.ownerDocument)||void 0===t?void 0:t.defaultView)||(null==e?void 0:null===(n=e.ownerDocument)||void 0===n?void 0:n[o])}function d(e){let t=c(e);if(!t)throw Error("no dom view");return t}function u(e){let t=c(e);return!!t&&e instanceof t.Text}function h(e){let t=c(e);return!!t&&e instanceof t.HTMLElement}function p(e){let t=c(e);return!!t&&e instanceof t.HTMLImageElement}async function f(e,t){let n=new r.Readability(e).parse();if(!n)throw Error("parse article error");let i=l(n.content),o=i.doc;return"server"===a.O.appMode&&await g(o.body,{baseURL:t}),function(e){let{view:t,doc:n}=e,i=Array.from(n.body.childNodes),r="";for(let e of i)e.nodeType===t.Node.TEXT_NODE?r+=e.textContent:r+=new t.XMLSerializer().serializeToString(e);return r}(i)}async function g(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.baseURL?new URL(t.baseURL):void 0,r=[...e.querySelectorAll("img")],a=new Headers({...t.referrer?{Referer:t.referrer??void 0}:{}});for(let e of r){let t=e.src||e.getAttribute("data-src")||e.getAttribute("data-original");if(!!t){if(!t.startsWith("data:"))try{if(t.startsWith("//")&&n&&(t=`${n.protocol}:${t}`),!(0,i.C)(t))return;let r=await fetch(t,{headers:a}),o=r.headers.get("Content-Type"),s=await r.arrayBuffer();e.src=`data:${o};base64,${Buffer.from(s).toString("base64")}`}catch(e){console.error(e)}}}}async function m(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=[...e.querySelectorAll("image")],i=new Headers({...t.referrer?{Referer:t.referrer??void 0}:{}});for(let e of n){let n=e.href.baseVal;if(!n)continue;let r=t.baseURL?new URL(n,t.baseURL):n;try{let t=await fetch(r,{headers:i}),n=t.headers.get("Content-Type"),a=await t.arrayBuffer();e.setAttribute("href",`data:${n};base64,${Buffer.from(a).toString("base64")}`)}catch(e){console.error(e)}}}async function v(e,t){let n=e.cloneNode(!0);await m(n,{baseURL:t}),n.setAttribute("width",`${e.clientWidth}px`);let i=new XMLSerializer().serializeToString(n);e.cloneNode();let r=window.btoa(i);return`data:image/svg+xml;base64,${r}`}function y(e){e.preventDefault(),e.stopPropagation()}},1999:function(e,t,n){n.d(t,{Q5:function(){return d},mX:function(){return l},pn:function(){return h}});var i=n(2790),r=n(3747),a=n(1479),o=n(3062),s=new WeakMap;class l{on(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={cb:e,options:{...this.defaultOptions,...t}};return(0,i._)(this,s).push(n),()=>{this.off(n)}}fire(e){for(let t of[...(0,i._)(this,s)])t.options.once&&this.off(t),Promise.resolve(t.cb(e)).catch(console.error)}off(e){let t=(0,i._)(this,s).findIndex(()=>e);-1!==t&&(0,i._)(this,s).splice(t,1)}constructor(e={}){(0,o._)(this,"defaultOptions",void 0),(0,r._)(this,s,{writable:!0,value:void 0}),this.defaultOptions=e,(0,a._)(this,s,[])}}var c=new WeakMap;class d{on(e,t){let n=(0,i._)(this,c).get(e);return!n&&(n=new l,(0,i._)(this,c).set(e,n)),n.on(t)}fire(e,t){let n=(0,i._)(this,c).get(e);n&&Promise.resolve(n.fire(t)).catch(console.error)}off(e){(0,i._)(this,c).delete(e)}constructor(){(0,r._)(this,c,{writable:!0,value:new Map})}}var u=new WeakMap;class h extends d{on(e,t){return super.on(e,n=>t(n,(0,i._)(this,u).get(e)))}fire(e,t){(!(0,i._)(this,u).has(e)||(0,i._)(this,u).get(e)!==t)&&((0,i._)(this,u).set(e,t),super.fire(e,t))}constructor(...e){super(...e),(0,r._)(this,u,{writable:!0,value:new Map})}}},4310:function(e,t,n){n.d(t,{PF:function(){return i},Y3:function(){return a},_v:function(){return r}});let i=e=>{e().catch(console.error)},r=e=>new Promise(t=>{setTimeout(t,e)}),a=()=>new Promise(e=>{setTimeout(()=>{e()})})},8205:function(e,t,n){function i(e){return e.split(/\r?\n/)}function r(e){return e.split(/\r?\n\r?\n/)}function a(e){return e.charAt(0).toUpperCase()+e.slice(1)}function o(e,t){function n(e,t){let n=[],i=0,r=e.length;for(;i<r;){let r=e.indexOf(t,i);if(-1===r)break;n.push(r),i=r+t.length}return n}let i=n(e,t.keyword).map(e=>[e,t.keyword.length]),r=[];if(t.alias)for(let a of t.alias){let t=a.length,o=n(e,a).filter(e=>!i.some(n=>n[0]<=e&&n[0]+n[1]>=e+t));r.push(...o.map(e=>[e,t]))}return[...i,...r]}n.d(t,{Rh:function(){return o},WM:function(){return r},kC:function(){return a},uq:function(){return i}})},7791:function(e,t,n){function i(e){let[t,n]=e.split("#",2);return[decodeURIComponent(t??""),decodeURIComponent(n??"")]}function r(e){try{return new URL(e),!0}catch{return!1}}n.d(t,{C:function(){return r},c:function(){return i}})},33:function(e,t,n){n.d(t,{E8:function(){return d},JB:function(){return u},c1:function(){return p},x1:function(){return f}});var i=n(4601),r=n(4861),a=n(1593),o=n(9937),s=n(2854),l=n(5271);let c=(0,i.cn)(null),d=()=>{let e=s.c.get(c);return e?e:a.ZP};function u(){let[e,t]=a.ZP.useNotification({placement:"top",duration:3}),[,n]=(0,r.KO)(c);return(0,l.useEffect)(()=>{n(e)},[e,n]),t}let h=(0,i.cn)(null),p=()=>{let e=s.c.get(h);return e?e:o.ZP};function f(){let[e,t]=o.ZP.useMessage({duration:3}),[,n]=(0,r.KO)(h);return(0,l.useEffect)(()=>{n(e)},[e,n]),t}},4253:function(e,t,n){let i,r;var a=n("2676");n("5167");var o=n("8751"),s=n("5811"),l=n("6444"),c=n("5683"),d=n("4790"),u=n("5291"),h=n("7363");window.API={book:{add:async e=>await l.Z.json(e),fetchUrlInfo:async e=>await c.z.json(e),addByUrl:async e=>await s.f.json(e),async update(e){await h.r.json(e)},async top(e){await d.s.json(e)},search:async e=>await u.g.json(e)}};var p=n("5032");n("1753");var f=n("4861"),g=n("5271"),m=n("4857"),v=n("4679"),y=n("107"),x=n("6258"),w=n("4068"),k=n("9030"),b=n("466"),j=n("5411"),C=n("4601"),S=n("6092"),P=n("5224"),L=n("8205");let _=(0,C.cn)({win:null});var E=n("2854");let A="hotkeyList-X2vODR",R=(0,C.cn)([]),N="";function T(e){if(Array.isArray(e))return e.map(T).join(" ");if("string"==typeof e)return e.toLowerCase();{let t="";return e.shift&&(t+="shift+"),e.ctrl&&(t+="ctrl+"),e.alt&&(t+="alt+"),t+=e.key.toLowerCase()}}function I(e){let t="";return e.length>1?t+=(0,L.kC)(e):" "===e?t+="Space":t+=e,t}function M(){let e=(0,g.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=E.c.get(R),i=[];for(let[r,a,o]of e){let e=T(r),s=function e(t){if(Array.isArray(t))return t.map(e).flat();if("string"==typeof t)return[I(t)];{let e="",n=t.shift||t.ctrl||t.alt;return n&&(e+="<"),t.shift&&(e+="Shift-"),t.ctrl&&(e+="Ctrl-"),t.alt&&(e+="Alt-"),e+=I(t.key),n&&(e+=">"),[e]}}(r),l=t.level??1,c=n.find(t=>{let[n]=t;return n===e});if(c){if(c[3].has(l))throw Error(`Hotkey ${JSON.stringify(r)} level: ${l} already exists`);c[3].set(l,o)}else c=[e,s,a,new Map([[l,o]])],n.push(c);i.push({item:c,level:l})}return E.c.set(R,[...n]),function(){let e=E.c.get(R),t=[];for(let{item:e,level:n}of i)e[3].delete(n),!e[3].size&&t.push(e);E.c.set(R,e.filter(e=>!t.includes(e)))}},[]);return{addHotkey:(0,g.useCallback)(function(t,n,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return e([[t,n,i]],r)},[e]),addHotkeys:e}}function Z(){return e=>{if((0,P.cK)(e.target))return;let t=E.c.get(R),n=T({shift:e.shiftKey,ctrl:e.ctrlKey,alt:e.altKey,key:e.key.toLowerCase()});console.log("triggered-key:",n);let r=N+n,a=r+" ",o=t.find(e=>{let[t]=e;return t===r}),s=t.find(e=>{let[t]=e;return t.startsWith(a)});if(o||s){if((0,P.lJ)(e),N="",clearTimeout(i),s)N=a,i=setTimeout(()=>{N=""},1e3);else if(o){var l;let e=Math.max(...o[3].keys());e&&(null===(l=o[3].get(e))||void 0===l||l())}}}}function $(){let[e,t]=(0,g.useState)(!1),{addHotkey:n}=M(),[i]=(0,f.KO)(R);return!function(){let[e]=(0,f.KO)(_);(0,g.useEffect)(()=>{let e=Z();return window.addEventListener("keydown",e,{passive:!1}),()=>{window.removeEventListener("keydown",e)}},[]),(0,g.useEffect)(()=>{if(!e.win)return;let t=Z();return e.win.addEventListener("keydown",t,{passive:!1}),()=>{var n;null===(n=e.win)||void 0===n||n.removeEventListener("keydown",t)}},[e])}(),(0,g.useEffect)(()=>n({shift:!0,key:"?"},(0,j.t)("hotkey.helper"),()=>{t(!0)}),[n]),O(()=>{t(!1)},{enable:e,level:200}),(0,a.jsx)(w.Z,{open:e,width:"auto",style:{maxWidth:"1000px"},onCancel:()=>{t(!1)},title:(0,j.t)("hotkey.title"),footer:!1,zIndex:1e4,children:(0,a.jsx)("ul",{className:A,children:(0,S.Xo)(i,"asc",e=>{let[t]=e;return t}).map((e,t)=>{let[,n,i]=e;return(0,a.jsxs)("li",{children:[(0,a.jsx)("div",{className:"keys",children:n.map((e,t)=>(0,a.jsx)("kbd",{children:e},t))}),(0,a.jsx)("div",{className:"desc",children:i})]},t)})})})}function O(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{enable:n=!0,level:i=100}=t,r=(0,g.useRef)(e),{addHotkey:a}=M();(0,g.useEffect)(()=>{r.current=e},[e]),(0,g.useEffect)(()=>{if(n)return a("escape",(0,j.t)("hotkey.escape"),()=>{r.current()},{level:i})},[a,n,i])}var F=n("2803");function W(e){let{icon:t,size:n,style:i,onClick:r,color:o}=e;return(0,a.jsx)(F.G,{icon:t,size:n??"lg",color:o,style:{paddingLeft:"6px",paddingRight:"6px",...i},onClick:r})}var z=n("3663");let D=(0,C.cn)(null);function B(e){return new Promise(t=>{E.c.set(D,{...e,okCallback:()=>t(!0),cancelCallback:()=>t(!1)})})}let K=e=>{let{enable:t=!0,onOk:n,onClose:i,level:r=100}=e,{addHotkey:a}=M(),o=(0,x.x)(n),s=(0,x.x)(i);(0,g.useEffect)(()=>{if(t)return a("Enter",(0,j.t)("hotkey.ok"),()=>{o.current()},{level:r})},[a,t,r,o]),O(()=>{var e;null===(e=s.current)||void 0===e||e.call(s)},{enable:!!t&&!!i})};function U(){let[e,t]=(0,f.KO)(D),n=(0,g.useCallback)(()=>{t(null)},[t]),i=(0,g.useCallback)(()=>{null==e||e.cancelCallback(),n()},[e,n]),r=(0,g.useCallback)(()=>{null==e||e.okCallback(),n()},[e,n]);return K({enable:!!e,onOk:r,onClose:i}),(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(w.Z,{open:!!e,onOk:r,onCancel:n,title:(0,a.jsxs)(k.Z,{children:[(0,a.jsx)(W,{icon:z.Fuz,size:"lg",color:"#ff4d4f"}),null==e?void 0:e.title]}),footer:!1,children:(0,a.jsxs)(k.Z,{direction:"vertical",children:[null==e?void 0:e.description,(0,a.jsxs)(k.Z,{children:[(0,a.jsx)(b.ZP,{type:"primary",onClick:n,children:(0,j.t)("confirm.cancel")}),(0,a.jsx)(b.ZP,{type:"primary",onClick:r,children:(0,j.t)("confirm.ok")})]})]})})})}function H(){let[e]=(0,f.KO)(D);return e?(0,a.jsx)(U,{}):(0,a.jsx)(a.Fragment,{})}let V="hint-cMFGU8",q=(0,C.cn)(null);function J(){let[e]=(0,f.KO)(q);return(0,a.jsx)("div",{className:V,style:{display:e?"inline-block":"none"},children:e})}var G=n("33");let X="overlay-RAuidH",Y="container-s1K_V6",Q="center-V6m0hj";function ee(e,t){return Math.hypot(t.clientX-e.clientX,t.clientY-e.clientY)}function et(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}let en=e=>{let t=e.deltaY;return 0===t?0:t<0?1.1:.9},ei=(e,t,n)=>{let i=!1,r=null,a=e.getBoundingClientRect(),o={x:0,y:0,scale:1},s={x:0,y:0,scale:1},l=()=>{t.style.transform=`translate(${o.x}px, ${o.y}px) scale(${o.scale})`},c=()=>{s={...o={...et(a),scale:1}},l()};c();let d=e=>{Math.hypot(e.x,e.y)>=10&&(i=!0),o.x=s.x+e.x,o.y=s.y+e.y,l()},u=t=>{let n=s.scale*t.rate;if(n<.01)return;o.scale=n;let i=e.getBoundingClientRect(),r=t.pageX-i.left-s.x,a=t.pageY-i.top-s.y;o.x=s.x+r*(1-t.rate),o.y=s.y+a*(1-t.rate),l()},h=()=>{s.x=o.x,s.y=o.y,s.scale=o.scale},p=[];function f(t,n){e.addEventListener(t,n),p.push(()=>e.removeEventListener(t,n))}return f("touchstart",e=>{(0,P.lJ)(e);let t=e.touches[0];if(!t)return;let n=e.touches[1];r=n?{type:"pinch",range:ee(t,n)}:{type:"move",x:t.clientX,y:t.clientY},i=!1}),f("touchmove",e=>{if((0,P.lJ)(e),!r)return;let t=e.touches[0];if(!t)return;let n=e.touches[1];switch(r.type){case"move":d({x:t.clientX-r.x,y:t.clientY-r.y});break;case"pinch":if(n){var i,a;u({...(i=t,a=n,{pageX:(i.pageX+a.pageX)/2,pageY:(i.pageY+a.pageY)/2}),rate:ee(t,n)/r.range})}}}),f("touchend",e=>{(0,P.lJ)(e),r&&("move"===r.type&&!i&&n(),r=null,h())}),f("mousedown",e=>{(0,P.lJ)(e),r={type:"move",x:e.clientX,y:e.clientY},i=!1}),f("mousemove",e=>{(0,P.lJ)(e),r&&"move"===r.type&&d({x:e.clientX-r.x,y:e.clientY-r.y})}),f("mouseup",e=>{(0,P.lJ)(e),r&&("move"===r.type&&!i&&n(),r=null,h(),!i&&n())}),f("wheel",e=>{(0,P.lJ)(e),u({pageX:e.pageX,pageY:e.pageY,rate:en(e)}),h()}),{move:e=>{d(e),h()},scale:e=>{let t=et(a);u({...e,pageX:t.x,pageY:t.y}),h()},reset:()=>{c()},dispose:()=>{p.forEach(e=>e())}}};function er(e){let{onClose:t,children:n}=e,i=(0,g.useRef)(null),r=(0,g.useRef)(null),o=(0,g.useRef)(),{addHotkeys:s}=M();return O(()=>{var e;return null===(e=o.current)||void 0===e?void 0:e.call(o)}),(0,g.useEffect)(()=>{o.current=t},[t]),(0,g.useEffect)(()=>{let e=i.current,t=r.current;if(!e||!t)return;let{move:n,scale:a,reset:l,dispose:c}=ei(e,t,()=>{var e;return null===(e=o.current)||void 0===e?void 0:e.call(o)}),d=()=>{n({x:0,y:-10})},u=()=>{n({x:0,y:10})},h=()=>{n({x:-10,y:0})},p=()=>{n({x:10,y:0})},f=s([["k",(0,j.t)("hotkey.pinchUp"),d],["j",(0,j.t)("hotkey.pinchDown"),u],["h",(0,j.t)("hotkey.pinchLeft"),h],["l",(0,j.t)("hotkey.pinchRight"),p],["ArrowUp",(0,j.t)("hotkey.pinchUp"),d],["ArrowDown",(0,j.t)("hotkey.pinchDown"),u],["ArrowLeft",(0,j.t)("hotkey.pinchLeft"),h],["ArrowRight",(0,j.t)("hotkey.pinchRight"),p],["=",(0,j.t)("hotkey.pinchZoomIn"),()=>{a({rate:1.1})}],["-",(0,j.t)("hotkey.pinchZoomOut"),()=>{a({rate:.9})}],["Backspace",(0,j.t)("hotkey.pinchReset"),l]],{level:100});return()=>{c(),f()}},[s]),(0,g.useEffect)(()=>{},[s]),(0,a.jsx)("div",{ref:i,className:X,onKeyDown:e=>{var t;"escape"===e.key.toLowerCase()&&(null===(t=o.current)||void 0===t||t.call(o))},children:(0,a.jsx)("div",{className:Y,ref:r,children:(0,a.jsx)("div",{className:Q,children:n})})})}let ea=(0,C.cn)(null);function eo(){let[e,t]=(0,f.KO)(ea);return e?(0,a.jsx)(er,{onClose:()=>{t(null)},children:(0,a.jsx)("img",{src:e,onLoad:e=>{let t=e.currentTarget,n=t.naturalWidth/t.naturalHeight;n>window.innerWidth/window.innerHeight?t.naturalWidth>window.innerWidth&&(t.width=window.innerWidth,t.height=window.innerWidth/n):t.naturalHeight>window.innerHeight&&(t.height=window.innerHeight,t.width=window.innerHeight*n)},alt:"preview"})}):(0,a.jsx)(a.Fragment,{})}var es=n("6816");function el(e){return(0,a.jsx)(es.Z,{fullscreen:!0,size:"large",...e})}function ec(e){return(0,a.jsx)(es.Z,{...e,style:{width:"100%",padding:20,...e.style}})}var ed=n("1484");let eu="Auditory Reader",eh=(0,C.cn)([]),ep=(0,C.cn)(e=>{let t=e(eh).at(0);return null==t?void 0:t.title});function ef(){let[e]=(0,f.KO)(ep);return e}function eg(){let e=ef();return(0,g.useEffect)(()=>{document.title=e?`${e}: ${eu}`:eu},[e]),(0,a.jsx)(a.Fragment,{})}var em=n("5"),ev=n("571"),ey=n("6917"),ex=n("5016"),ew=n("9835");let ek=(0,C.cn)([]);if(ew.jU){let e=()=>{E.c.set(ek,speechSynthesis.getVoices())};e(),"addEventListener"in window.speechSynthesis&&window.speechSynthesis.addEventListener("voiceschanged",e)}function eb(e){let{storeKey:t,read:n,write:i}=e,r=(0,C.cn)(n(localStorage.getItem(t)));return()=>{let[e,n]=(0,f.KO)(r),a=(0,g.useCallback)(r=>{let a;n(a="function"==typeof r?r(e):r);let o=i(a);o?localStorage.setItem(t,o):localStorage.removeItem(t)},[e,n]);return[e,a]}}let ej=e=>"nav"===e||"annotation"===e||"keyword"===e?e:"none",eC=eb({storeKey:"viewPanelType",read:ej,write:ej}),eS=eb({storeKey:"langVoiceURIDict",read:e=>e?JSON.parse(e):{},write:e=>JSON.stringify(e)}),eP=()=>{let[e]=eS(),[t]=(0,f.KO)(ek),n=(0,g.useCallback)(e=>(0,S.Xo)(t,"desc",t=>[t.lang.startsWith(`${e.langCode}-`),!t.localService]),[t]);return{getVoice:(0,g.useCallback)(t=>{let i=n(t),r=e[t.langCode];return(r?i.find(e=>e.voiceURI===r):null)??i.at(0)??null},[e,n]),getAllSortedVoices:n}},eL=e=>{let[t,n]=eS(),i=(0,g.useMemo)(()=>t[e.langCode]??null,[e.langCode,t]);return[i,(0,g.useCallback)(i=>{let r={...t};i?r[e.langCode]=i:delete r[e.langCode],n(r)},[e.langCode,t,n])]},e_=e=>{let[t,n]=eL(e),{getAllSortedVoices:i,getVoice:r}=eP(),a=(0,g.useMemo)(()=>i(e),[e,i]),o=(0,g.useMemo)(()=>{var e;return t??(null===(e=a[0])||void 0===e?void 0:e.voiceURI)??null},[a,t]),s=(0,g.useCallback)(e=>{n(e)},[n]),l=(0,g.useMemo)(()=>r(e)??null,[e,r]),c=(0,g.useCallback)(e=>{s((null==e?void 0:e.voiceURI)??null)},[s]);return{voiceURI:o,setVoiceURI:s,voice:l,setVoice:c,allSortedVoices:a}},eE=eb({storeKey:"autoSection",read:e=>!e||"1"===e,write:e=>e?"1":"0"}),eA=eb({storeKey:"stopTimer",read:e=>!e||"1"===e,write:e=>e?"1":"0"}),eR=eb({storeKey:"stopTimerSeconds",read:e=>e?Number(e):1800,write:e=>e.toString()}),eN=eb({storeKey:"personReplace",read:e=>!!e&&"1"===e,write:e=>e?"1":"0"}),eT=eb({storeKey:"speechSpeed",read:e=>e?Number(e):1,write:e=>e.toString()}),eI=["system","dark","light"],eM=eb({storeKey:"userColorScheme",read:e=>e??"system",write:e=>e}),eZ=eb({storeKey:"paragraphRepeat",read:e=>e?Number(e):1,write:e=>e.toString()}),e$=["none","auto","single","double"],eO=eb({storeKey:"pageList",read:e=>e$.includes(e)?e:"auto",write:e=>e}),eF=eb({storeKey:"fontSize",read:e=>e?Math.min(Math.max(Number(e),8),30):16,write:e=>e.toString()}),eW=eb({storeKey:"disabledVertical",read:e=>!!e&&"1"===e,write:e=>e?"1":"0"});function ez(e){let{title:t}=e,n=(0,em.s0)(),{addHotkeys:i}=M();return(0,g.useEffect)(()=>i([["u",(0,j.t)("hotkey.goBack"),()=>n("../../")]]),[i,n]),(0,a.jsx)(p.Z,{type:"error",message:`The ${t} not found`,description:`The ${t} not found`})}function eD(e){let{dir:t="column",gap:n=0,flex:i,style:r,children:o,...s}=e;return(0,a.jsx)("div",{style:{display:"flex",flexDirection:t,gap:n,flex:i,...r},...s,children:o})}function eB(e){let{to:t,children:n}=e;return n((0,em.oQ)(t))}function eK(){let{uuid:e}=(0,em.UO)();return e?(0,a.jsxs)(eD,{gap:4,children:[(0,a.jsx)(p.Z,{type:"success",message:(0,j.t)("desc.bookAddedSuccessful")}),(0,a.jsx)(eB,{to:`/books/view/${e}`,children:e=>(0,a.jsx)(b.ZP,{type:"primary",href:e,icon:(0,a.jsx)(W,{icon:z.Mdf}),children:(0,j.t)("view")})})]}):(0,a.jsx)(ez,{title:"book"})}var eU=n("9990"),eH=n("6513"),eV=n.n(eH),eq=n("7289"),eJ=n("290"),eG=n("9237"),eX=n("5860"),eY=n("3098"),eQ=n("5128"),e0=n("9883");function e1(e){return e.name.endsWith(".txt")||e.name.endsWith(".text")}function e2(e){return e.name.endsWith(".html")}function e3(e){return e.name.endsWith(".epub")}var e4=n("4310"),e6=n("3345");let e8="fileInput-jzkJ9C",e9=e=>{let{accept:t,prompt:n,value:i,onChange:r}=e,[o,s]=(0,g.useState)();return(0,g.useEffect)(()=>{s(i)},[i]),(0,a.jsxs)("label",{className:e8,children:[(0,a.jsx)("input",{style:{display:"none"},accept:t,type:"file",onChange:e=>{let t=[...e.target.files??[]];s(t[0]),null==r||r(t[0])}}),o?(0,a.jsx)(eD,{gap:5,children:(0,a.jsxs)(eD,{dir:"row",gap:5,style:{alignItems:"center"},children:[(0,a.jsx)(W,{icon:z.cf$}),(0,a.jsx)("div",{children:o.name})]})}):(0,a.jsx)(eD,{gap:2,style:{justifyContent:"center"},children:n&&(0,a.jsx)(e6.Z,{children:n})})]})};var e5=n("8051");let e7=(e,t)=>!!t&&"string"==typeof t.label&&t.label.toLowerCase().includes(e.toLowerCase());function te(e){let{value:t,onChange:n}=e,i=(0,eY.sF)(),[r,o]=(0,g.useState)(""),s=(0,g.useMemo)(()=>{if(!r)return i;let e=r.toLowerCase(),t=i.filter(t=>t.value===e);return t.length?t:i},[i,r]);return(0,a.jsx)(e5.Z,{showSearch:!0,filterOption:(e,t)=>(o(e),e7(e,t)),popupMatchSelectWidth:!1,value:t,onChange:n,placeholder:(0,j.t)("prompt.selectLanguage"),options:s})}var tt=n("9202");function tn(){let e=(0,em.s0)(),[t,n]=(0,g.useState)(!1),[i]=eq.Z.useForm(),r=eq.Z.useWatch("file",i);return(0,g.useEffect)(()=>{(0,e4.PF)(async()=>{if(r){if(e3(r)){let e=await r.arrayBuffer(),t=await eG.P.read(e);if(!t)return;let n=eV().extname(r.name),a=eV().basename(r.name,n);i.setFieldValue("name",t.title??a);let o=(0,eY.Wx)(t.language);o&&i.setFieldValue("langCode",o)}else if(e1(r)){let e=await r.text(),t=(0,eQ.mA)(e);if(!t)return;i.setFieldValue("name",t)}else if(e2(r)){let e=await r.text(),t=await (0,eQ.Yy)(e);if(!t)return;i.setFieldValue("name",t)}}})},[r,i]),(0,a.jsxs)(eq.Z,{form:i,style:{margin:"20px auto 0",maxWidth:"800px"},initialValues:{name:"",langCode:null,file:null},onFinish:t=>{(0,e4.PF)(async()=>{try{let i,r;if(n(!0),!t.file)return;if(e3(t.file))i=await t.file.arrayBuffer();else if(e1(t.file)){let e=await t.file.text();i=await (0,eX.p)(e,t.name,t.langCode)}else e2(t.file)&&(r=await t.file.text());if(i){let n=(0,e0.sM)(i),r=await l.Z.json({name:t.name,langCode:t.langCode,bufferBase64:n});e(`/books/added-successful/${r.uuid}`)}else if(r){let n=await tt.t.json({name:t.name,langCode:t.langCode,html:r});e(`/books/added-successful/${n.uuid}`)}}finally{n(!1)}})},children:[(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("bookName"),name:"name",rules:[{required:!0}],children:(0,a.jsx)(eJ.Z,{placeholder:(0,j.t)("prompt.inputBookName")})}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("language"),name:"langCode",rules:[{required:!0}],children:(0,a.jsx)(te,{})}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("file"),name:"file",rules:[{required:!0}],children:(0,a.jsx)(e9,{prompt:(0,j.t)("prompt.uploadBook")})}),(0,a.jsx)(eq.Z.Item,{children:(0,a.jsx)(b.ZP,{block:!0,type:"primary",htmlType:"submit",loading:t,children:(0,j.t)("add")})})]})}var ti=n("6054"),tr=n("9151"),ta=n("4210"),to=n.n(ta),ts=n("1227"),tl=n.n(ts),tc=n("7864"),td=n("1054"),tu=n("86");let th=e=>Math.floor(100*e),tp=e=>`${e.name}${(0,eQ.jI)()}`,tf=async(e,t)=>{let n=new(to()),i=e.length;for(let[r,a]of e.entries()){let e=await tc.c.file({uuid:a.uuid}),o=await td.o.json({uuid:a.uuid}),s={...a},l=s.name,c=tp(a),d=`${l}-(${s.uuid})`;n.file(`${d}/property.json`,JSON.stringify(o,null,2)),n.file(`${d}/book.json`,JSON.stringify(s,null,2)),n.file(`${d}/${c}`,e.arrayBuffer()),t(th((r+1)/i))}tl()(await n.generateAsync({type:"blob"}),"books.zip")},tg=e=>Object.keys(e.files).filter(e=>e.endsWith("/")).map(e=>e.slice(0,-1)).map(e=>({folder:e,basename:eV().basename(e)})),tm=async(e,t,n)=>{let i=t.length;for(let[s,l]of t.entries()){var r,a,o;let t=await (null===(r=e.file(`${l.folder}/book.json`))||void 0===r?void 0:r.async("text"));if(!t)continue;let c=JSON.parse(t),d=tp(c),u=await (null===(a=e.file(`${l.folder}/${d}`))||void 0===a?void 0:a.async("arraybuffer"));if(!u)continue;let h=await (null===(o=e.file(`${l.folder}/property.json`))||void 0===o?void 0:o.async("text")),p=h?JSON.parse(h):null;await tu.P.json({entity:c,property:p,bufferBase64:(0,e0.sM)(u)}),n(th((s+1)/i))}};function tv(){let[e,t]=(0,g.useState)(!1),[n]=eq.Z.useForm(),i=eq.Z.useWatch("file",n),[r,o]=(0,g.useState)(null),s=(0,g.useMemo)(()=>r?tg(r):[],[r]),[l,c]=(0,g.useState)(null);return(0,g.useEffect)(()=>{(0,e4.PF)(async()=>{i?o(await to().loadAsync(await i.arrayBuffer())):o(null)})},[i]),(0,a.jsxs)(a.Fragment,{children:[!!l&&(0,a.jsx)(ti.Z,{percent:l}),(0,a.jsxs)(eq.Z,{form:n,style:{margin:"20px auto 0",maxWidth:"800px"},initialValues:{file:null},onFinish:()=>{(0,e4.PF)(async()=>{try{if(!r)return;c(null),await tm(r,s,e=>{c(e)})}finally{c(null),t(!1)}})},children:[(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("file"),name:"file",rules:[{required:!0}],children:(0,a.jsx)(e9,{accept:".zip",prompt:(0,j.t)("prompt.importBooks")})}),(0,a.jsx)(eq.Z.Item,{children:(0,a.jsx)(b.ZP,{block:!0,type:"primary",htmlType:"submit",loading:e,children:(0,j.t)("import")})})]}),!!s.length&&(0,a.jsxs)(k.Z,{direction:"vertical",style:{width:"100%",height:300,overflow:"auto"},children:[(0,a.jsx)("h3",{children:(0,j.t)("import")}),(0,a.jsx)(k.Z,{direction:"vertical",children:s.map((e,t)=>(0,a.jsx)(tr.Z,{children:e.basename},t))})]})]})}function ty(e){let{...t}=e;return(0,a.jsx)(eJ.Z.TextArea,{rows:4,onKeyDown:e=>{if(e.ctrlKey&&"Enter"===e.key){var t;let n=e.target;(0,P.lJ)(e),null===(t=n.closest("form"))||void 0===t||t.dispatchEvent(new Event("submit",{bubbles:!0,cancelable:!0}))}},...t})}function tx(){let e=(0,em.s0)(),[t,n]=(0,g.useState)(!1),[i]=eq.Z.useForm(),r=eq.Z.useWatch("content",i);return(0,g.useEffect)(()=>{if(!!r){if(!i.getFieldValue("name")){let e=(0,eQ.mA)(r);e&&i.setFieldValue("name",e)}}},[r,i]),(0,a.jsxs)(eq.Z,{form:i,style:{margin:"20px auto 0",maxWidth:"800px"},initialValues:{name:"",langCode:null,content:""},onFinish:t=>{(0,e4.PF)(async()=>{try{n(!0);let i=await (0,eX.p)(t.content,t.name,t.langCode),r=(0,e0.sM)(i),a=await l.Z.json({name:t.name,langCode:t.langCode,bufferBase64:r});e(`/books/added-successful/${a.uuid}`)}finally{n(!1)}})},children:[(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("bookName"),name:"name",rules:[{required:!0}],children:(0,a.jsx)(eJ.Z,{placeholder:(0,j.t)("prompt.inputBookName")})}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("language"),name:"langCode",rules:[{required:!0}],children:(0,a.jsx)(te,{})}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("bookContent"),name:"content",rules:[{required:!0}],children:(0,a.jsx)(ty,{rows:6})}),(0,a.jsx)(eq.Z.Item,{children:(0,a.jsx)(b.ZP,{block:!0,htmlType:"submit",type:"primary",loading:t,children:(0,j.t)("add")})})]})}function tw(){let e=(0,em.s0)(),[t,n]=(0,g.useState)(!1),[i,r]=(0,g.useState)(!1),[o]=eq.Z.useForm();return(0,a.jsx)(a.Fragment,{children:(0,a.jsxs)(eq.Z,{form:o,style:{margin:"20px auto 0",maxWidth:"800px"},initialValues:{name:"",langCode:null,url:""},onFinish:t=>{(0,e4.PF)(async()=>{try{r(!0);let n=await s.f.json({name:t.name,langCode:t.langCode,url:t.url});e(`/books/added-successful/${n.uuid}`)}finally{r(!1)}})},children:[(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("bookName"),name:"name",rules:[{required:!0}],children:(0,a.jsx)(eJ.Z,{placeholder:(0,j.t)("prompt.inputBookName")})}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("language"),name:"langCode",rules:[{required:!0}],children:(0,a.jsx)(te,{})}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("url"),name:"url",rules:[{required:!0}],children:(0,a.jsxs)(k.Z.Compact,{style:{width:"100%"},children:[(0,a.jsx)(eJ.Z,{}),(0,a.jsx)(b.ZP,{style:{alignSelf:"center"},type:"primary",loading:t,onClick:()=>{let e=o.getFieldValue("url");e&&(n(!0),c.z.json({url:e}).then(e=>{o.setFieldValue("name",e.title),e.lang&&o.setFieldValue("langCode",e.lang)}).catch(console.error).finally(()=>n(!1)))},children:(0,j.t)("extractUrlInfo")})]})}),(0,a.jsx)(eq.Z.Item,{children:(0,a.jsx)(b.ZP,{block:!0,htmlType:"submit",type:"primary",loading:i,children:(0,j.t)("add")})})]})})}function tk(){let[e,t]=(0,g.useState)("text");return(0,a.jsx)(eU.Z,{defaultActiveKey:e,onChange:e=>t(e),destroyInactiveTabPane:!0,items:[{key:"text",label:(0,j.t)("text"),children:(0,a.jsx)(tx,{})},{key:"file",label:(0,j.t)("file"),children:(0,a.jsx)(tn,{})},{key:"url",label:(0,j.t)("url"),children:(0,a.jsx)(tw,{})},{key:"import",label:(0,j.t)("import"),children:(0,a.jsx)(tv,{})}]})}var tb=n("4254");function tj(e){let{book:t,reload:n}=e,[i]=eq.Z.useForm();return(0,a.jsxs)(eq.Z,{form:i,initialValues:{name:t.name,langCode:t.langCode},onFinish:e=>{(0,e4.PF)(async()=>{await h.r.json({uuid:t.uuid,update:{name:e.name,langCode:e.langCode}}),n()})},children:[(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("bookName"),name:"name",rules:[{required:!0}],children:(0,a.jsx)(eJ.Z,{autoFocus:!0,placeholder:(0,j.t)("prompt.inputBookName")})}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("language"),name:"langCode",rules:[{required:!0}],children:(0,a.jsx)(te,{})}),(0,a.jsx)(eq.Z.Item,{children:(0,a.jsx)(b.ZP,{block:!0,htmlType:"submit",type:"primary",children:(0,j.t)("update")})})]})}function tC(e){let{uuid:t,reload:n}=e,{data:i}=(0,ex.BH)(tb._,{uuid:t});return i?(0,a.jsx)(tj,{book:i,reload:n}):(0,a.jsx)(ec,{})}let tS=(0,C.cn)({uuid:null,reloads:[]});function tP(e){let t=(0,x.x)(e),[,n]=(0,f.KO)(tS),i=(0,g.useCallback)(e=>{n(t=>({...t,uuid:e}))},[n]);return(0,g.useEffect)(()=>{let e=()=>{t.current()};return n(t=>({...t,reloads:[...t.reloads,e]})),()=>{n(t=>({...t,reloads:t.reloads.filter(t=>t!==e)}))}},[t,n]),{openBookEdit:i}}function tL(){let[e,t]=(0,f.KO)(tS),n=(0,g.useCallback)(()=>{t(e=>({...e,uuid:null}))},[t]);return(0,a.jsx)(w.Z,{open:!!e.uuid,onCancel:n,title:(0,j.t)("editBook"),footer:!1,children:e.uuid&&(0,a.jsx)(tC,{uuid:e.uuid,reload:()=>{n(),e.reloads.forEach(e=>e())}})})}var t_=n("690"),tE=n("2929"),tA=n("1168"),tR=n("4229"),tN=n("6475"),tT=n("6764"),tI=n("4074"),tM=n("3815"),tZ=n("6504"),t$=n("6689");let tO=new tZ.p("books/cover",{method:"get"}).routeLogined(async e=>{let{req:t,res:n,userInfo:i}=e,r=t.searchParams.get("uuid");if(!r)throw new t$.xx("uuid parameter required");let a=await tM.E.book(i.account,r),o=await a.cover();if(!o)throw new t$.xx("cover in book not found");return o.mediaType&&n.header("Content-Type",o.mediaType.toString()),o.buffer}),tF=e=>`${tO.fullRoutePath}?uuid=${e}`;var tW=n("5719"),tz=n("9878"),tD=n("390");let tB=["default","reverse","name","name-reverse"];var tK=n("3062"),tU=n("7356");let tH=n.p+"static/media/keyboard.983b6fe1.mp3",tV=n.p+"static/media/rain-loop.769e8d4a.mp3",tq=n.p+"static/media/next-page.2cb810bd.mp3",tJ=n.p+"static/media/shutter.37b7999d.mp3",tG=n.p+"static/media/rewind.3bbb7b0e.mp3",tX=new tU.Howl({src:[tJ]});async function tY(){tX.play(),await new Promise(e=>{tX.once("end",e)})}let tQ=new tU.Howl({src:[tH]});async function t0(){tQ.play(),await new Promise(e=>{tQ.once("end",e)})}let t1=new tU.Howl({src:[tq]});async function t2(){t1.play(),await new Promise(e=>{t1.once("end",e)})}let t3=new tU.Howl({src:[tV]});t3.loop(!0),t3.fade(0,.5,500);function t4(){t3.playing()&&t3.pause()}let t6=new tU.Howl({src:[tG],volume:.5});async function t8(){t6.play(),await new Promise(e=>{t6.once("end",e)})}class t9{aliasReplace(e,t){if(!t.length)return{text:e,highlightOffsets:[]};let n=[],i=new Map;for(let n of t){let t=-1;for(;-1!==(t=e.indexOf(n.source,t+1));){;!i.has(t)&&i.set(t,n)}}let r=(0,S.Xo)([...i.entries()],"asc",e=>{let[t]=e;return t}),a=0;for(let[t,{source:i,target:o}]of r){e=e.replace(i,o);let r=i.length-o.length;if(0===r)continue;let s=t-a;for(let e of(n.push([s,a]),(0,S.w6)(1,o.length)))n.push([s+e,a+Math.floor(r*(e/o.length))]);a+=r}return{text:e,highlightOffsets:n}}cancel(){this.state="cancel",speechSynthesis.speaking&&speechSynthesis.cancel()}async speak(e,t){let{speed:n,voice:i,isPersonReplace:r,quote:a=!0,alias:o,onBoundary:s}=t;this.state="speaking",e=r?function(e){for(let[t,n]of Object.entries(y.i9))e=e.replaceAll(t,n.word);return e}(e):e;let l=[];if(a){let t=function(e){let t=[];for(let[n,i]of[...e.matchAll(/"|'/g)].entries())n%2==0?t.push({type:"start",charIndex:i.index}):t.push({type:"end",charIndex:i.index});for(let n of e.matchAll(/“|‘|「|『/g))t.push({type:"start",charIndex:n.index});for(let n of e.matchAll(/”|’|」|』/g))t.push({type:"end",charIndex:n.index});return(0,S.Xo)(t,"asc",e=>e.charIndex)}(e);l.push(e=>{let n=(0,S.qr)(t,t=>t.charIndex<=e.charIndex);if(void 0===n)return t4();let i=t.slice(0,n+1),r=i.filter(e=>"start"===e.type),a=i.filter(e=>"end"===e.type);r.length>a.length?t3.playing()||t3.play():t4()})}if(s){if(o&&o.length){let t=this.aliasReplace(e,o);e=t.text;let n=t.highlightOffsets,i=n.length?e=>{let t=(0,S.dF)(n,t=>{let[n]=t;return n<=e.charIndex});if(!t)return e;let i=e.charIndex+e.charLength,r=(0,S.dF)(n,e=>{let[t]=e;return t<=i});if(!r)return e;let a=e.charIndex+(t.at(1)??0),o=i+(r.at(1)??0)-a;return{charIndex:a,charLength:o}}:e=>e;l.push(e=>{s(i(e))})}else l.push(e=>{s(e)})}for(let e of l)this.utterance.addEventListener("boundary",e);this.utterance.rate=n,this.utterance.voice=i,this.utterance.text=e,speechSynthesis.speak(this.utterance);let c=await new Promise((e,t)=>{this.utterance.addEventListener("end",()=>{e("cancel"===this.state?"cancel":"done")},{once:!0}),this.utterance.addEventListener("error",n=>{"cancel"===this.state?e("cancel"):t(n)},{once:!0})});for(let e of l)this.utterance.removeEventListener("boundary",e);return t4(),this.state="none",c}constructor(){(0,tK._)(this,"utterance",void 0),(0,tK._)(this,"state","none"),this.utterance=new SpeechSynthesisUtterance}}var t5=n("7207"),t7=n("9693");let ne=(0,C.cn)({topLeft:null,topRight:null,settings:null,bottomLeft1:null,bottomLeft2:null,bottomRight1:null,bottomRight2:null}),nt=e=>{let{topLeft:t,topRight:n,settings:i,bottomLeft1:r,bottomLeft2:a,bottomRight1:o,bottomRight2:s}=e,[,l]=(0,f.KO)(ne);(0,g.useEffect)(()=>{l({topLeft:t,topRight:n,settings:i,bottomLeft1:r,bottomLeft2:a,bottomRight1:o,bottomRight2:s})},[t,n,i,r,l,a,o,s]),(0,t7.z)(()=>{l({topLeft:null,topRight:null,settings:null,bottomLeft1:null,bottomLeft2:null,bottomRight1:null,bottomRight2:null})})},nn=(0,C.cn)(1),ni=(0,C.cn)(15),nr=(0,C.cn)(0),na=(0,C.cn)(!1),no=(0,C.cn)(!1),ns=(0,C.cn)(""),nl=(0,C.cn)("default"),nc=()=>{let[e,t]=(0,f.KO)(nn),[,n]=(0,f.KO)(nr);return[e,(0,g.useCallback)(e=>{n(0),t(e)},[n,t])]},nd={hover:"hover-MhvhD5",table:"table-OXXVHq"};var nu=n("9619");let nh="book";function np(e){return`/books/view/${e}`}let nf=async(e,t,n)=>{if(0===n)return;let i=e.at(t);if(!i)return;let r=i.uuid,a=t+n;if(a<=0)return await d.s.json({uuid:r});let o=e.at(a<t?a-1:a);o&&await tW.y.json({uuid:r,afterUuid:o.uuid})};function ng(e){return(0,g.useCallback)(t=>{(0,e4.PF)(async()=>{if(await B({title:(0,j.t)("remove"),description:(0,a.jsx)("ul",{children:t.map(e=>(0,a.jsx)("li",{children:e.name},e.uuid))})})){for(let e of t)await tD.f.json({uuid:e.uuid});e()}})},[e])}function nm(e){let{book:t,reload:n}=e,{openBookEdit:i}=tP(n),r=(0,g.useCallback)(async()=>{let e=await tc.c.file({uuid:t.uuid}),n=(0,eQ.jI)(),i=t.name,r=`${i}${n}`;(0,ts.saveAs)(e,r)},[t]),o=ng(n);return(0,a.jsx)(tE.Z,{trigger:["click"],menu:{items:[{key:"edit",label:(0,j.t)("edit"),onClick:()=>i(t.uuid)},{key:"archive",label:t.isArchived?(0,j.t)("unarchive"):(0,j.t)("archive"),onClick:()=>{(0,e4.PF)(async()=>{await h.r.json({uuid:t.uuid,update:{isArchived:!t.isArchived}}),n()})}},{key:"export-epub",label:`${(0,j.t)("export")} EPUB`,onClick:()=>(0,e4.PF)(()=>r())},{key:"remove",label:(0,j.t)("remove"),onClick:()=>o([t])}]},children:(0,a.jsx)(b.ZP,{shape:"circle",type:"text",children:(0,a.jsx)(W,{icon:z.Uwo})})})}function nv(e){let{index:t,activated:n,book:i,books:r,onHoverMove:o,onDrop:s,onCancel:l,selectedUuids:c,selectTo:d,reload:u,hasOrder:p}=e,m=(0,em.s0)(),[,v]=(0,f.KO)(nr),y=(0,g.useRef)(null),[,x]=(0,tT.L)({accept:nh,hover(e){let n=r.findIndex(t=>t.uuid===e.uuid);if(-1===n)return;if(n!==t)o(n,t),e.hoverIndex=t},drop(e){s(e)}}),[{isDragging:w},k]=(0,tI.c)({type:nh,item:()=>({name:i.name,uuid:i.uuid,startIndex:t,hoverIndex:t}),collect:e=>({isDragging:e.isDragging()}),end(e,t){!t.didDrop()&&l()}});(0,g.useEffect)(()=>{var e;n&&(null===(e=y.current)||void 0===e||e.scrollIntoView({block:"center"}))},[n,x]);let[b,C]=(0,g.useState)(!1),S=`${tF(i.uuid)}`;return!p&&x(y),(0,a.jsxs)("tr",{ref:y,style:{opacity:w?.2:1,background:n?"var(--main-bg-active)":"var(--main-bg)"},children:[(0,a.jsx)("td",{ref:k,style:{cursor:"move"},children:!p&&(0,a.jsx)(W,{size:"lg",icon:z.g$q,style:{marginLeft:4}})}),(0,a.jsx)("td",{children:(0,a.jsx)(tA.Z,{checked:c.includes(i.uuid),onClick:e=>{d(t,e.shiftKey)}})}),(0,a.jsx)("td",{align:"center",style:{cursor:"pointer"},children:i.isFavorited?(0,a.jsx)(W,{icon:z.Tab,onClick:()=>{(0,e4.PF)(async()=>{await h.r.json({uuid:i.uuid,update:{isFavorited:!1}}),u()})}}):(0,a.jsx)(W,{icon:t_.Tab,onClick:()=>{(0,e4.PF)(async()=>{await h.r.json({uuid:i.uuid,update:{isFavorited:!0}}),u()})}})}),(0,a.jsx)("td",{children:(0,a.jsxs)("div",{style:{border:"1px solid var(--main-fg)",textAlign:"center",position:"relative"},children:[(100*i.progress).toFixed(),"%",(0,a.jsx)("div",{style:{left:0,top:0,width:`${100*i.progress}%`,height:"100%",position:"absolute",backgroundColor:"var(--main-bg-highlight)"}})]})}),(0,a.jsx)("td",{children:(0,a.jsx)("div",{className:"cell-center",children:(0,a.jsx)("img",{onClick:()=>{E.c.set(ea,S)},onLoad:()=>{C(!0)},style:{visibility:b?"visible":"hidden",cursor:"pointer"},src:S,alt:`${i.name} ${(0,j.t)("cover")}`})})}),(0,a.jsx)("td",{className:nd.hover,title:i.createdAt.toLocaleString(),onClick:()=>{v(t),m(np(i.uuid))},children:i.name}),(0,a.jsx)("td",{children:(0,a.jsx)(nm,{book:i,reload:u})})]},i.uuid)}function ny(e){let{onRemove:t}=e,[{canDrop:n,isOver:i},r]=(0,tT.L)({accept:nh,drop(e){t(e.uuid)},collect:e=>({isOver:e.isOver(),canDrop:e.canDrop()})});return n?(0,a.jsx)(tr.Z,{ref:r,color:i?"error":"warning",icon:i?(0,a.jsx)(W,{icon:z.$aW}):null,children:(0,j.t)("prompt.dropHereToRemove")}):(0,a.jsx)(a.Fragment,{})}function nx(){let[e,t]=nc(),[n,i]=(0,f.KO)(ni),[r,o]=(0,g.useState)(null),[s,l]=(0,f.KO)(nr),[c,u]=(0,f.KO)(na),[m,v]=(0,f.KO)(no),[y,x]=(0,f.KO)(ns),w=function(e,t,n){let[i,r]=(0,t5.G)(e,500,void 0);return(0,g.useEffect)(()=>{r(e)},[r,e]),i}(y,500),C=(0,g.useRef)(null),[S,P]=(0,f.KO)(nl),L="default"!==S,{data:_,reload:E}=(0,ex.BH)(tz.N,{filter:{archive:c?"archived":"active",favorite:m?"favorited":"all",search:w,order:S},page:{page:e,perPage:n}},{clearWhenReload:!1}),[A,R]=(0,g.useState)(!1),[N,T]=(0,g.useState)(null),I=(0,g.useCallback)(()=>{T(_?[..._.items]:null)},[_]);(0,g.useEffect)(()=>{I()},[I]);let{selectedBooks:Z,allSelected:$,selectedUuids:O,selectTo:F,selectAll:D}=function(e){let[t,n]=(0,g.useState)(),[i,r]=(0,g.useState)([]),a=(0,g.useMemo)(()=>(null==e?void 0:e.filter(e=>i.includes(e.uuid)))??[],[e,i]),o=(0,g.useMemo)(()=>null==e?void 0:e.every(e=>i.includes(e.uuid)),[e,i]);(0,g.useEffect)(()=>{e&&r([])},[e]);let s=(0,g.useCallback)((a,o)=>{let s;let l=null==e?void 0:e[a];if(!l)return;n(a);let c=!1;void 0!==t&&t!==a&&o?(s=t<a?e.slice(t,a+1).map(e=>e.uuid):e.slice(a,t+1).map(e=>e.uuid),c=!0):(s=[l.uuid],c=!i.includes(l.uuid));let d=[...i];for(let e of s)c?!d.includes(e)&&(d=[...d,e]):d=d.filter(t=>t!==e),r(d)},[e,t,i]),l=(0,g.useCallback)(()=>{o?r([]):r((null==e?void 0:e.map(e=>e.uuid))??[])},[o,e]);return{selectedBooks:a,allSelected:o,selectedUuids:i,selectTo:s,selectAll:l}}(N),B=(0,g.useCallback)(()=>{C.current&&C.current.focus()},[]),K=(0,g.useCallback)(()=>{let e=tB.indexOf(S),t=tB[e-1];if(t)P(t);else{let e=tB[tB.length-1];e&&P(e)}},[S,P]),U=(0,g.useCallback)(()=>{let e=tB.indexOf(S),t=tB[e+1];t?P(t):P(tB["0"])},[S,P]),H=ng(E),V=(0,g.useCallback)(async e=>{for(let t of[...e.reverse()])await d.s.json({uuid:t.uuid});t(1),E()},[E,t]);!function(e){let{focusSearchInput:t,orderSelectPrev:n,orderSelectNext:i,dataBooks:r,selectTo:a,selectAll:o,selectedBooks:s,reload:l,moveBooksTop:c,removeBooks:d,hasOrder:u}=e,[p,m]=(0,f.KO)(nr),[,v]=nc(),[,y]=(0,f.KO)(na),[,x]=(0,f.KO)(no),[w]=eN(),[k]=eT(),{getVoice:b}=eP(),{addHotkeys:C}=M(),{openBookEdit:S}=tP(l),P=(0,em.s0)(),L=(0,g.useMemo)(()=>null==r?void 0:r.items[p],[p,r]),_=(0,g.useMemo)(()=>s.length?s:L?[L]:[],[L,s]);(0,g.useEffect)(()=>{let e=(null==r?void 0:r.items.length)??0,s=()=>{m(e=>e>0?e-1:0)},f=()=>{m(0)},g=()=>{m(t=>t<e-1?t+1:t)},E=()=>{m(e-1)},A=()=>{r&&v(e=>e>1?e-1:r.pageCount)},R=()=>{r&&v(1)},N=()=>{r&&v(e=>e<r.pageCount?e+1:1)},T=()=>{r&&v(r.pageCount)},I=async()=>{L&&r&&(s(),await nf(r.items,p,-1),l())},M=async()=>{L&&r&&(g(),await nf(r.items,p,1),l())},Z=e=>{a(p,e)},$=()=>{L&&d(_)},O=new t9,F=[["k",(0,j.t)("hotkey.goPrev"),s],["j",(0,j.t)("hotkey.goNext"),g],["ArrowUp",(0,j.t)("hotkey.goPrev"),s],["ArrowDown",(0,j.t)("hotkey.goNext"),g],["h",(0,j.t)("hotkey.goPagePrev"),A],["l",(0,j.t)("hotkey.goPageNext"),N],["ArrowLeft",(0,j.t)("hotkey.goPagePrev"),A],["ArrowRight",(0,j.t)("hotkey.goPageNext"),N],[["g","g"],(0,j.t)("hotkey.goTop"),f],[{shift:!0,key:"g"},(0,j.t)("hotkey.goBottom"),E],[{shift:!0,key:"h"},(0,j.t)("hotkey.goPageFirst"),R],[{shift:!0,key:"l"},(0,j.t)("hotkey.goPageLast"),T],[{shift:!0,key:"ArrowUp"},(0,j.t)("hotkey.goTop"),f],[{shift:!0,key:"ArrowDown"},(0,j.t)("hotkey.goBottom"),E],[{shift:!0,key:"ArrowLeft"},(0,j.t)("hotkey.goPageFirst"),R],[{shift:!0,key:"ArrowRight"},(0,j.t)("hotkey.goPageLast"),T],[["s",{shift:!0,key:"E"}],(0,j.t)("hotkey.listArchive"),()=>{y(e=>!e)}],[["s","b"],(0,j.t)("hotkey.listFavorite"),()=>{x(e=>!e)}],["b",(0,j.t)("hotkey.favorite"),()=>{(0,e4.PF)(async()=>{for(let e of _)await h.r.json({uuid:e.uuid,update:{isFavorited:!e.isFavorited}});l()})}],[{shift:!0,key:"E"},(0,j.t)("hotkey.archive"),()=>{(0,e4.PF)(async()=>{for(let e of _)await h.r.json({uuid:e.uuid,update:{isArchived:!e.isArchived}});l()})}],["/",(0,j.t)("hotkey.search"),t],[["s","s","n"],(0,j.t)("hotkey.sortOrder"),i],[["s","s","p"],(0,j.t)("hotkey.sortOrder"),n],["x",(0,j.t)("hotkey.select"),()=>Z(!1)],["v",(0,j.t)("hotkey.select"),()=>Z(!1)],[{shift:!0,key:"x"},(0,j.t)("hotkey.selectShift"),()=>Z(!0)],[{shift:!0,key:"v"},(0,j.t)("hotkey.selectShift"),()=>Z(!0)],[{shift:!0,key:"a"},(0,j.t)("hotkey.selectAll"),()=>o()],["t",(0,j.t)("hotkey.goMoveTop"),()=>{L&&c(_)}],["e",(0,j.t)("hotkey.edit"),()=>L&&S(L.uuid)],["Enter",(0,j.t)("hotkey.open"),()=>{L&&P(np(L.uuid))}],[{shift:!0,key:"#"},(0,j.t)("hotkey.remove"),$],[["d","d"],(0,j.t)("hotkey.remove"),$],[{shift:!0,key:"K"},(0,j.t)("hotkey.speakBookName"),()=>{if(!L)return;let e=b(L);e&&O.speak(L.name,{voice:e,speed:k,isPersonReplace:w})}]];return!u&&F.push([{ctrl:!0,key:"k"},(0,j.t)("hotkey.goMovePrev"),I],[{ctrl:!0,key:"j"},(0,j.t)("hotkey.goMoveNext"),M],[{ctrl:!0,key:"ArrowUp"},(0,j.t)("hotkey.goMovePrev"),I],[{ctrl:!0,key:"ArrowDown"},(0,j.t)("hotkey.goMoveNext"),M]),C(F)},[_,p,C,L,r,t,b,u,w,c,P,S,i,n,l,d,o,a,m,y,x,v,k])}({focusSearchInput:B,orderSelectPrev:K,orderSelectNext:U,dataBooks:_,reload:E,selectTo:F,selectAll:D,selectedBooks:Z,moveBooksTop:V,removeBooks:H,hasOrder:L});let q=(0,g.useCallback)((e,t)=>{if(!N)return;let n=[...N],[i]=n.splice(e,1);i&&n.splice(t,0,i),T(n)},[N]),J=(0,g.useCallback)(e=>{(0,e4.PF)(async()=>{_&&(R(!0),await nf(_.items,e.startIndex,e.hoverIndex-e.startIndex),E(),R(!1))})},[_,E]),G=(0,g.useCallback)(()=>{I()},[I]),X=(0,g.useCallback)(e=>{I();let t=null==N?void 0:N.find(t=>t.uuid===e);t&&H([t])},[N,H,I]),Y=(0,g.useMemo)(()=>(0,a.jsxs)(b.ZP.Group,{children:[!O.length&&(0,a.jsx)(b.ZP,{type:"primary",size:"small",onClick:()=>{(0,e4.PF)(async()=>{let e=await nu.V.json({filter:{archive:"all",favorite:"all"}});try{o(0),await tf(e.items,e=>{o(e)})}finally{o(null)}})},children:(0,j.t)("exportAll")}),!!O.length&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(b.ZP,{type:"primary",size:"small",onClick:()=>{(0,e4.PF)(async()=>{await V(Z),E()})},children:(0,j.t)("top")}),(0,a.jsx)(b.ZP,{type:"primary",size:"small",onClick:()=>{(0,e4.PF)(async()=>{let e=await nu.V.json({filter:{uuids:O}});try{o(0),await tf(e.items,e=>{o(e)})}finally{o(null)}})},children:(0,j.t)("exportSelected")}),(0,a.jsx)(b.ZP,{type:"primary",size:"small",danger:!0,onClick:()=>{H(Z)},children:(0,j.t)("remove")})]})]}),[V,E,H,Z,O]),Q=(0,g.useMemo)(()=>(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(ny,{onRemove:X}),Y]}),[Y,X]);if(nt({topRight:Q,bottomRight2:(0,g.useMemo)(()=>(0,a.jsx)(eB,{to:"/books/add",children:e=>(0,a.jsx)(b.ZP,{type:"text",shape:"circle",href:e,title:(0,j.t)("add"),children:(0,a.jsx)(W,{icon:z.XSk})})}),[])}),(0,g.useEffect)(()=>{N&&(N.length<=0?e>1&&t(1):s>N.length-1&&l(N.length-1))},[s,N,e,l,t]),A||!_||!N)return(0,a.jsx)(ec,{});let ee=_.pageCount>1?(0,a.jsx)(tR.Z,{onChange:e=>t(e),pageSize:n,onShowSizeChange:(e,t)=>i(t),current:e,total:_.count}):null;return(0,a.jsx)(a.Fragment,{children:(0,a.jsxs)(k.Z,{direction:"vertical",style:{width:"100%"},children:[!!r&&(0,a.jsx)(ti.Z,{percent:r}),(0,a.jsxs)(eq.Z,{layout:"inline",children:[(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("archive"),children:(0,a.jsx)(tN.Z,{checked:c,onChange:e=>u(e)})}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("favorite"),children:(0,a.jsx)(tN.Z,{checked:m,onChange:e=>v(e)})}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("search"),children:(0,a.jsx)(eJ.Z,{value:y,placeholder:(0,j.t)("search"),onChange:e=>x(e.target.value),ref:C,onKeyDown:e=>{var t;"Escape"===e.key&&(null===(t=C.current)||void 0===t||t.blur())}})}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("sortOrder.label"),children:(0,a.jsx)(e5.Z,{showSearch:!0,filterOption:e7,popupMatchSelectWidth:!1,value:S,onChange:e=>P(e),options:[{label:(0,j.t)("sortOrder.item.default"),value:"default"},{label:(0,j.t)("sortOrder.item.reverse"),value:"reverse"},{label:(0,j.t)("sortOrder.item.name"),value:"name"},{label:(0,j.t)("sortOrder.item.nameReverse"),value:"name-reverse"}]})})]}),N.length<=0?(0,a.jsx)(p.Z,{type:"warning",message:(0,j.t)("prompt.noBooks")}):(0,a.jsxs)(a.Fragment,{children:[ee,(0,a.jsxs)("table",{className:nd.table,children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{}),(0,a.jsx)("th",{children:(0,a.jsx)(tA.Z,{title:(0,j.t)("all"),checked:$,onClick:()=>{D()}})}),(0,a.jsx)("th",{children:(0,j.t)("favorite")}),(0,a.jsx)("th",{children:(0,j.t)("progress")}),(0,a.jsx)("th",{children:(0,j.t)("cover")}),(0,a.jsx)("th",{children:(0,j.t)("bookName")}),(0,a.jsx)("th",{})]})}),(0,a.jsx)("tbody",{children:N.map((e,t)=>(0,a.jsx)(nv,{book:e,books:N,index:t,activated:s===t,onHoverMove:q,onDrop:J,onCancel:G,selectTo:F,selectedUuids:O,reload:E,hasOrder:L},e.uuid))})]}),ee]})]})})}var nw=n("3130"),nk=n("5627"),nb=n("1832");let nj=(0,C.cn)(null),nC=()=>{let[e]=(0,f.KO)(nj);if(!e)throw Error("BookContext must be used within a BookProvider");return e},nS="contentWrapper-xRbIAt";var nP=n("2610"),nL=n("3941"),n_=n("2493"),nE=n("683");let{defaultAlgorithm:nA,darkAlgorithm:nR}=nL.Z,nN=()=>{let e=(0,nP.a)("(prefers-color-scheme: dark)"),[t]=eM();return"system"===t?e?"dark":"light":t},nT=e=>{let{children:t}=e,n=nN();return(0,a.jsx)(n_.ZP,{theme:{algorithm:"dark"===n?nR:nA,components:{InputNumber:{handleVisible:!0}}},children:(0,a.jsx)(nE.Z,{className:"app",children:t})})};var nI=n("2790"),nM=n("3747"),nZ=n("1999"),n$=new WeakMap,nO=new WeakMap;class nF{get started(){return(0,nI._)(this,n$).started}set started(e){(0,nI._)(this,n$).started=e,this.events.fire("started",e)}get pos(){return(0,nI._)(this,n$).pos}set pos(e){(0,nI._)(this,n$).pos=e,this.events.fire("pos",e)}set activeNavs(e){(0,nI._)(this,n$).activeNavs=e,this.events.fire("activeNavs",e)}get loading(){return(0,nI._)(this,n$).loading}set loading(e){(0,nI._)(this,n$).loading=e,this.events.fire("loading",e)}get scrollPercent(){return(0,nI._)(this,n$).scrollPercent}set scrollPercent(e){(0,nI._)(this,n$).scrollPercent=e,this.events.fire("scrollPercent",e)}get selection(){return(0,nI._)(this,n$).selection}set selection(e){(0,nI._)(this,n$).selection=e,this.events.fire("selection",e)}get annotations(){return(0,nI._)(this,nO).annotations}get keywords(){return(0,nI._)(this,nO).keywords}get voice(){return(0,nI._)(this,nO).voice}get isPersonReplace(){return(0,nI._)(this,nO).isPersonReplace}get speechSpeed(){return(0,nI._)(this,nO).speechSpeed}get autoNextSection(){return(0,nI._)(this,nO).autoNextSection}get paragraphRepeat(){return(0,nI._)(this,nO).paragraphRepeat}get pageList(){return(0,nI._)(this,nO).pageList}get fontSize(){return(0,nI._)(this,nO).fontSize}get disabledVertical(){return(0,nI._)(this,nO).disabledVertical}get docVisible(){return"visible"===document.visibilityState}get canManipulateDOM(){return this.docVisible||!ew.tq}syncUIState(e,t){(0,nI._)(this,nO)[e]=t,this.uiEvents.fire(e,t)}constructor(){(0,nM._)(this,n$,{writable:!0,value:{started:!1,pos:{section:0,paragraph:0},activeNavs:[],loading:!1,scrollPercent:void 0,selection:void 0}}),(0,tK._)(this,"events",new nZ.pn),(0,nM._)(this,nO,{writable:!0,value:{annotations:[],keywords:[],isPersonReplace:!1,speechSpeed:1,voice:null,autoNextSection:!1,paragraphRepeat:1,pageList:"double",fontSize:16,disabledVertical:!1}}),(0,tK._)(this,"uiEvents",new nZ.pn)}}var nW=n("1774"),nz=n("1142"),nD=n("6072"),nB=n("7902"),nK=n("8586"),nU=n("2733");function nH(e){return parseFloat(e.toFixed(10))}function nV(e){if(ew.tq){let t=1;return void 0!==e.step&&("number"==typeof e.step?t=e.step:"string"==typeof e.step&&(t=parseFloat(e.step))),(0,a.jsxs)(k.Z.Compact,{children:[(0,a.jsx)(b.ZP,{size:e.size,onClick:()=>{var n;let i=(e.value??0)-t;null===(n=e.onChange)||void 0===n||n.call(e,nH(i))},children:(0,a.jsx)(F.G,{icon:z.r5q})}),(0,a.jsx)(nU.Z,{...e}),(0,a.jsx)(b.ZP,{size:e.size,onClick:()=>{var n;let i=(e.value??0)+t;null===(n=e.onChange)||void 0===n||n.call(e,nH(i))},children:(0,a.jsx)(F.G,{icon:z.FPD})})]})}return(0,a.jsx)(nU.Z,{...e})}function nq(e){let{children:t}=e;return(0,a.jsx)(eD,{dir:"row",gap:8,style:{alignItems:"center",width:"100%"},children:t})}function nJ(e){let{style:t,children:n}=e;return(0,a.jsx)(e6.Z,{style:{alignSelf:"start",...t},children:n})}let nG=()=>{let[e,t]=eE();return(0,a.jsx)(nq,{children:(0,a.jsx)(tA.Z,{checked:e,onChange:e=>t(e.target.checked),children:(0,j.t)("setting.autoNextSection")})})},nX=()=>{let[e,t]=eA(),[n,i]=eR();return(0,a.jsxs)(nq,{children:[(0,a.jsx)(tA.Z,{checked:e,onChange:e=>{t(e.target.checked)},children:(0,j.t)("setting.timer")}),(0,a.jsx)(nV,{style:{width:"80px"},disabled:!e,value:Math.floor(n/60),onChange:e=>{null!==e&&i(Math.floor(60*e))}})]})};function nY(e){let{checked:t,onChange:n}=e;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(tA.Z,{checked:t,onChange:e=>{n(e.target.checked)},children:(0,j.t)("setting.personReplace")}),(0,a.jsx)(nW.Z,{style:{pointerEvents:"none"},content:(0,a.jsx)(nD.Z,{children:Object.entries(y.i9).map((e,t)=>{let[n,i]=e;return(0,a.jsx)(nD.Z.Item,{children:(0,a.jsxs)(k.Z,{children:[n,(0,a.jsx)(W,{icon:z.eFW}),i.word," (",i.pinyin,")"]})},t)})}),children:(0,a.jsx)("div",{children:(0,a.jsx)(W,{size:"lg",icon:z.Fuz})})})]})}let nQ=()=>{let[e,t]=eN();return(0,a.jsx)(nq,{children:(0,a.jsx)(nY,{checked:e,onChange:e=>{t(e)}})})};function n0(){let[e,t]=eW();return(0,a.jsx)(nq,{children:(0,a.jsx)(tA.Z,{checked:e,onChange:e=>{t(e.target.checked)},children:(0,j.t)("setting.disabledVertical")})})}let n1=()=>{let[e,t]=eT();return(0,a.jsxs)(nq,{children:[(0,a.jsx)(nJ,{children:(0,j.t)("setting.speed")}),(0,a.jsxs)(eD,{style:{flex:1},children:[(0,a.jsx)(nB.Z,{value:e,onChange:e=>{t(e)},step:.1,min:.1,max:5}),(0,a.jsx)(nV,{type:"number",value:e,step:.1,onChange:e=>{null!==e&&t(e)}})]})]})},n2=()=>{let[e,t]=eM();return(0,a.jsx)(a.Fragment,{children:(0,a.jsxs)(nq,{children:[(0,a.jsx)(nJ,{style:{paddingTop:"4px"},children:(0,j.t)("setting.userColorScheme")}),(0,a.jsx)(nK.ZP.Group,{value:e,onChange:e=>{t(e.target.value)},children:(0,a.jsx)(k.Z,{direction:"vertical",children:eI.map(e=>(0,a.jsx)(nK.ZP,{value:e,children:(0,j.t)(e)},e))})})]})})},n3=()=>{let[e,t]=eZ();return(0,a.jsxs)(nq,{children:[(0,a.jsxs)("span",{children:[(0,j.t)("setting.paragraphRepeat"),":"]}),(0,a.jsx)(nV,{style:{width:80},value:e,onChange:e=>{e&&t(e<1?1:Math.floor(e))}})]})};function n4(){let[e,t]=eO();return(0,a.jsxs)(nq,{children:[(0,a.jsx)(nJ,{style:{paddingTop:"4px"},children:(0,j.t)("setting.pageList")}),(0,a.jsx)(nK.ZP.Group,{value:e,onChange:e=>{t(e.target.value)},children:(0,a.jsx)(k.Z,{direction:"vertical",children:e$.map(e=>(0,a.jsx)(nK.ZP,{value:e,children:(0,j.t)(`setting.pageListType.${e}`)},e))})})]})}function n6(){let[e,t]=eF();return(0,a.jsxs)(nq,{children:[(0,a.jsx)("span",{children:(0,j.t)("setting.fontSize")}),(0,a.jsx)(nV,{style:{width:80},value:e,onChange:e=>{null!==e&&t(e<1?1:Math.floor(e))}})]})}let n8=()=>(0,a.jsxs)(k.Z,{direction:"vertical",children:[(0,a.jsx)(nG,{}),(0,a.jsx)(nX,{}),(0,a.jsx)(nQ,{}),(0,a.jsx)(n0,{}),(0,a.jsx)(n1,{}),(0,a.jsx)(n2,{}),(0,a.jsx)(n3,{}),(0,a.jsx)(n4,{}),(0,a.jsx)(n6,{})]});var n9=n("2065");let n5={bookSearchResult:"bookSearchResult-wN3fTI"},n7=(0,C.cn)(!1),ie={};function it(){return(0,g.useCallback)(async e=>{var t;null===(t=ie.callback)||void 0===t||t.call(ie,e)},[])}function ii(e){let{open:t,player:n,searchResponse:i}=e,[r,o]=(0,g.useState)(0),s=(0,g.useRef)(null),l=(0,g.useCallback)(async e=>{await n.gotoPos({section:e.section,paragraph:e.paragraph})},[n]);(0,g.useEffect)(()=>{if(r<0)return;let e=s.current;if(!e)return;let t=e.querySelector("li.text.selected");null==t||t.scrollIntoView({block:"center"})},[r]);let{addHotkeys:c}=M();if((0,g.useEffect)(()=>{if(!t||!i)return;let e=i.matches,n=async()=>{let t=e.at(r);t&&await l(t)};return c([["p",(0,j.t)("hotkey.prevSearchResult"),()=>{o(e=>e<=0?0:e-1)}],["n",(0,j.t)("hotkey.nextSearchResult"),()=>{o(t=>t>=e.length-1?e.length-1:t+1)}],["enter",(0,j.t)("hotkey.gotoSearchResult"),n]],{level:2})},[c,l,t,i,r]),!i)return null;if(0===i.matches.length)return(0,a.jsx)(p.Z,{type:"warning",message:(0,j.t)("prompt.noSearchMatches")});let d=i.search.length;return(0,a.jsxs)("div",{className:n5.bookSearchResult,ref:s,children:[(0,a.jsx)("ul",{children:i.matches.map((e,t)=>{let n=["text","clickable"];t===r&&n.push("selected");let s=e.text.slice(0,e.start),c=e.text.slice(e.start+d);return(0,a.jsxs)("li",{className:n.join(" "),onClick:()=>{l(e),o(t)},children:[e.nav&&(0,a.jsx)("strong",{children:e.nav}),(0,a.jsxs)("div",{children:[s,(0,a.jsx)("span",{className:"highlight",children:i.search}),c]})]},t)})}),(0,a.jsxs)("div",{className:"stats",children:[r+1," / ",i.matches.length]})]})}function ir(e){let{refSearchInput:t,player:n}=e,[i,r]=(0,f.KO)(n7),{uuid:o}=nC(),[s,l]=(0,g.useState)(""),[c,d]=(0,g.useState)(!1),[h,p]=(0,g.useState)(null),m=it();return ie.callback=(0,g.useCallback)(async e=>{var n;if(r(!0),l(e),!c)p(null),d(!0),p(await u.g.json({uuid:o,search:e})),d(!1),null===(n=t.current)||void 0===n||n.blur()},[c,t,r,o]),(0,ed.n)(()=>{setTimeout(()=>{t.current&&t.current.focus()},100)}),(0,a.jsxs)(eD,{style:{width:"100%",height:"100%"},gap:8,children:[(0,a.jsxs)(eD,{dir:"row",gap:8,children:[(0,a.jsx)(eJ.Z,{className:"flex-1",ref:t,value:s,onChange:e=>l(e.target.value),onKeyDown:e=>{if("Escape"===e.key){var n;(0,P.lJ)(e),null===(n=t.current)||void 0===n||n.blur()}else"Enter"===e.key&&m(s)}}),(0,a.jsx)(b.ZP,{onClick:()=>{m(s)},loading:c,children:(0,a.jsx)(F.G,{icon:z.wn1})})]}),(0,a.jsx)(ii,{open:i,player:n,searchResponse:h})]})}function ia(e){let{player:t}=e,[n,i]=(0,f.KO)(n7),r=(0,g.useRef)(null),o=(0,g.useCallback)(()=>{i(!0),setTimeout(()=>{var e;null===(e=r.current)||void 0===e||e.focus()},100)},[i]),{addHotkeys:s}=M();return(0,g.useEffect)(()=>s([["/",(0,j.t)("search"),o]],{level:2}),[s,o]),O(()=>{i(!1)},{enable:n}),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(b.ZP,{block:!0,type:"primary",icon:(0,a.jsx)(F.G,{icon:z.wn1}),onClick:()=>{o()},children:(0,j.t)("search")}),(0,a.jsx)(n9.Z,{forceRender:!0,title:(0,j.t)("search"),open:n,onClose:()=>i(!1),children:(0,a.jsx)(ir,{refSearchInput:r,player:t})})]})}var io=n("6903");let is=e=>({position:"absolute",top:0,width:e.width+10,height:"100%",display:"flex",justifyContent:"center",alignItems:"center",color:e.color??"var(--main-fg-blue)",background:e.background??"var(--main-bg-blue)",opacity:0});function il(e){let{children:t,left:n,right:i}=e,r=(0,g.useRef)(null),[o,s]=(0,g.useState)(),[l,c]=(0,g.useState)();return(0,g.useEffect)(()=>{if(r.current)return function(e,t){let{left:n,leftElement:i,right:r,rightElement:a}=t;if(!n&&!r)return;let o=null,s=null,l=e=>{let{clientX:t,clientY:n}=e;return[t,n]},c=e=>{e.touches[0]&&(o={x:e.touches[0].clientX,y:e.touches[0].clientY},s=0)},d=t=>{if(!o)return;let c=t.touches[0];if(!c)return;let[d,u]=l(c),h=d-o.x,p=Math.abs(h);if(!(Math.abs(u-o.y)>30)){if(p>5&&(0,P.lJ)(t),n&&i&&h>0){let t=Math.min(p,n.width+10);s=t,e.style.transform=`translateX(${t}px)`,i.style.opacity=p>n.width?"1":"0.5"}else if(r&&a&&h<0){let t=Math.min(p,r.width+10);s=-t,e.style.transform=`translateX(${-t}px)`,a.style.opacity=p>r.width?"1":"0.5"}}},u=()=>{if(!!o)o=null,e.style.transform="",i&&(i.style.opacity="0"),a&&(a.style.opacity="0"),s&&(n&&s>n.width?n.trigger():r&&a&&s<-r.width&&r.trigger(),s=null)};return e.addEventListener("touchstart",c),e.addEventListener("touchmove",d),e.addEventListener("touchend",u),()=>{e.removeEventListener("touchstart",c),e.removeEventListener("touchmove",d),e.removeEventListener("touchend",u)}}(r.current,{left:n,leftElement:o,right:i,rightElement:l})},[n,o,i,l]),(0,a.jsxs)("div",{style:{position:"relative",willChange:"transform"},ref:r,children:[n&&(0,a.jsx)("div",{ref:e=>s(e??void 0),className:"swipe-left-node",style:{...is(n),right:"100%"},children:n.node}),t,i&&(0,a.jsx)("div",{ref:e=>c(e??void 0),className:"swipe-right-node",style:{...is(i),left:"100%"},children:i.node})]})}function ic(e){let{annotation:t,openNoteEdit:n,isSelected:i,isActivated:r,player:o}=e,s=["text","clickable"];r&&s.push("active"),i&&s.push("selected");let l=[{key:"note",icon:(0,a.jsx)(W,{icon:z.Ykk,size:"sm"}),label:(0,j.t)("note"),onClick:()=>{n(t,o)}},{key:"remove",icon:(0,a.jsx)(W,{icon:z.$aW,size:"sm"}),label:(0,j.t)("remove"),onClick:()=>{o.annotations.remove(t)}}];return(0,a.jsx)("li",{"data-pos-section":t.pos.section,"data-pos-paragraph":t.pos.paragraph,children:(0,a.jsx)(il,{left:{node:(0,a.jsx)(W,{icon:z.Ykk,size:"sm"}),width:30,trigger:()=>{n(t,o)}},right:{node:(0,a.jsx)(W,{icon:z.$aW,size:"sm"}),width:30,trigger:()=>{o.annotations.remove(t)}},children:(0,a.jsx)(tE.Z,{menu:{items:l},trigger:["contextMenu"],children:(0,a.jsxs)("div",{className:"item",children:[(0,a.jsxs)("div",{className:s.join(" "),style:{fontSize:13},onClick:e=>{(0,P.lJ)(e),o.gotoSection(t.pos.section,t.pos.paragraph).catch(console.error)},children:[t.brief,t.range&&(0,a.jsx)("div",{className:"range",children:(0,a.jsx)("span",{className:"selected-text",children:t.range.selectedText})}),t.note&&(0,a.jsxs)("div",{className:"note",children:["note: ",t.note]})]}),!ew.tq&&(0,a.jsx)("div",{className:"btn",children:(0,a.jsx)(tE.Z,{menu:{items:l},children:(0,a.jsx)("div",{children:(0,a.jsx)(W,{icon:z.Uwo,style:{paddingLeft:"8px",paddingRight:"8px"}})})})})]})})})})}function id(e){let{annotations:t,activeAnnotationIndex:n,closestAnnotationIndex:i,player:r}=e,{addHotkeys:o}=M(),[s,l]=(0,g.useState)(0),c=(0,g.useRef)(null),{openNoteEdit:d,NoteEditDialog:u}=function(e){let{player:t}=e,[n,i]=(0,g.useState)(null),[r,o]=(0,g.useState)();(0,g.useEffect)(()=>{n&&o(n.note)},[n]);let s=(0,g.useCallback)(()=>{n&&t.annotations.upsert({pos:n.pos,range:n.range,uuid:n.uuid},{color:n.color,group:n.group,note:r}),i(null)},[n,r,t.annotations]),l=(0,g.useCallback)(()=>{i(null)},[]);return{openNoteEdit:i,NoteEditDialog:(0,a.jsxs)(w.Z,{open:!!n,onCancel:l,footer:!1,title:`${(0,j.t)("annotation")} ${(0,j.t)("note")}`,children:[(0,a.jsx)(e6.Z,{children:null==n?void 0:n.brief}),(0,a.jsxs)("form",{onSubmit:e=>{(0,P.lJ)(e),s()},children:[(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("note"),children:(0,a.jsx)(eD,{gap:8,children:(0,a.jsx)(ty,{autoFocus:!0,value:r,onChange:e=>o(e.target.value)})})}),(0,a.jsx)(eq.Z.Item,{children:(0,a.jsx)(b.ZP,{type:"primary",htmlType:"submit",children:(0,j.t)("update")})})]})]})}}({player:r}),h=(0,g.useMemo)(()=>null==t?void 0:t.at(s),[t,s]),p=(0,g.useCallback)(async()=>{h&&await r.annotations.remove(h)},[r.annotations,h]);return(0,g.useEffect)(()=>o([["p",(0,j.t)("hotkey.prevAnnotation"),()=>{l(e=>e<=0?0:e-1)}],["n",(0,j.t)("hotkey.nextAnnotation"),()=>{t&&l(e=>e>=t.length-1?t.length-1:e+1)}],["enter",(0,j.t)("hotkey.gotoAnnotation"),()=>{let e=null==t?void 0:t[s];e&&r.gotoSection(e.pos.section,e.pos.paragraph).catch(console.error)}],[["d","b"],(0,j.t)("hotkey.annotationRemoveSelected"),()=>p()],[["g","n"],(0,j.t)("hotkey.annotationNote"),()=>d(h??null)],[{shift:!0,key:"K"},(0,j.t)("hotkey.speakAnnotation"),()=>{h&&r.utterer.speakText(h.brief).catch(console.error)}]]),[o,t,d,r,p,h,s]),(0,g.useEffect)(()=>{null!==i&&l(i)},[i]),(0,g.useEffect)(()=>{if(!h)return;let e=c.current;if(!e)return;let t=e.querySelector("div.text.selected");null==t||t.scrollIntoView({block:"center"})},[h]),(0,a.jsxs)("div",{className:"panel-content book-annotations",ref:c,children:[(null==t?void 0:t.length)?(0,a.jsx)("ul",{children:t.map((e,t)=>(0,a.jsx)(ic,{annotation:e,openNoteEdit:d,isActivated:n===t,isSelected:s===t,player:r},t))}):(0,j.t)("desc.annotationsEmpty"),u]})}var iu=n("6049");function ih(e){let{keyword:t,openEdit:n,isSelected:i,player:r}=e,o=it(),s=["text","clickable"];i&&s.push("selected");let l=[{key:"note",icon:(0,a.jsx)(W,{icon:z.Ykk,size:"sm"}),label:(0,j.t)("note"),onClick:()=>{n(t,r)}},{key:"remove",icon:(0,a.jsx)(W,{icon:z.$aW,size:"sm"}),label:(0,j.t)("remove"),onClick:()=>{r.keywords.remove(t)}},{key:"search",icon:(0,a.jsx)(W,{icon:z.wn1,size:"sm"}),label:(0,j.t)("search"),onClick:()=>{o(t.keyword)}}];return(0,a.jsx)("li",{children:(0,a.jsx)(il,{left:{node:(0,a.jsx)(W,{icon:z.Ykk,size:"sm"}),width:30,trigger:()=>{n(t,r)}},right:{node:(0,a.jsx)(W,{icon:z.$aW,size:"sm"}),width:30,trigger:()=>{r.keywords.remove(t)}},children:(0,a.jsx)(tE.Z,{menu:{items:l},trigger:["contextMenu"],children:(0,a.jsxs)("div",{className:"item",children:[(0,a.jsxs)("div",{className:s.join(" "),style:{fontSize:13},onClick:e=>{(0,P.lJ)(e),r.gotoSection(t.pos.section,t.pos.paragraph).catch(console.error)},children:[t.keyword,t.alias&&(0,a.jsx)("div",{className:"alias",children:(0,a.jsx)(k.Z,{wrap:!0,children:t.alias.map((e,t)=>(0,a.jsx)("span",{className:"selected-text",children:e},t))})}),(0,a.jsx)("div",{className:"range",children:(0,a.jsx)("span",{className:"selected-text",children:t.brief})}),t.note&&(0,a.jsxs)("div",{className:"note",children:["note: ",t.note]})]}),(0,a.jsx)("div",{className:"btn",children:(0,a.jsx)(tE.Z,{menu:{items:l},children:(0,a.jsx)("div",{children:(0,a.jsx)(W,{icon:z.Uwo,style:{paddingLeft:"8px",paddingRight:"8px"}})})})})]})})})})}function ip(e){let{keywords:t,player:n}=e,{addHotkeys:i}=M(),[r,o]=(0,g.useState)(0),s=(0,g.useRef)(null),{openEdit:l,EditDialog:c}=function(e){let{player:t}=e,[n,i]=(0,g.useState)(null),[r,o]=(0,g.useState)(),[s,l]=(0,g.useState)();(0,g.useEffect)(()=>{var e;n&&(o(null===(e=n.alias)||void 0===e?void 0:e.join("\n")),l(n.note))},[n]);let c=(0,g.useCallback)(()=>{n&&t.keywords.upsert({pos:n.pos,uuid:n.uuid,keyword:n.keyword},{color:n.color,note:s,alias:null==r?void 0:r.split("\n").map(e=>e.trim()).filter(e=>e)}),i(null)},[r,n,s,t.keywords]),d=(0,g.useCallback)(()=>{i(null)},[]);return{openEdit:i,EditDialog:(0,a.jsxs)(w.Z,{open:!!n,onCancel:d,footer:!1,title:`${(0,j.t)("keyword")} ${(0,j.t)("note")}`,children:[(0,a.jsx)(e6.Z,{children:null==n?void 0:n.keyword}),(0,a.jsxs)("form",{onSubmit:e=>{(0,P.lJ)(e),c()},children:[(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("alias"),children:(0,a.jsx)(eD,{gap:8,children:(0,a.jsx)(ty,{autoFocus:!0,value:r,onChange:e=>o(e.target.value)})})}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("note"),children:(0,a.jsx)(eD,{gap:8,children:(0,a.jsx)(ty,{value:s,onChange:e=>l(e.target.value)})})}),(0,a.jsx)(eq.Z.Item,{children:(0,a.jsx)(b.ZP,{type:"primary",htmlType:"submit",children:(0,j.t)("update")})})]})]})}}({player:n}),d=(0,g.useMemo)(()=>null==t?void 0:t.at(r),[t,r]),u=(0,g.useCallback)(async()=>{d&&await n.keywords.remove(d)},[n.keywords,d]);return(0,g.useEffect)(()=>i([["p",(0,j.t)("hotkey.prevKeyword"),()=>{o(e=>e<=0?0:e-1)}],["n",(0,j.t)("hotkey.nextKeyword"),()=>{t&&o(e=>e>=t.length-1?t.length-1:e+1)}],["enter",(0,j.t)("hotkey.gotoKeyword"),()=>{let e=null==t?void 0:t[r];e&&n.gotoSection(e.pos.section,e.pos.paragraph).catch(console.error)}],[["d","b"],(0,j.t)("hotkey.keywordRemoveSelected"),()=>u()],[["g","n"],(0,j.t)("hotkey.keywordNote"),()=>l(d??null)],[{shift:!0,key:"K"},(0,j.t)("hotkey.speakKeyword"),()=>{d&&n.utterer.speakText(d.keyword).catch(console.error)}]]),[i,t,l,n,u,d,r]),(0,g.useEffect)(()=>{if(!d)return;let e=s.current;if(!e)return;let t=e.querySelector("div.text.selected");null==t||t.scrollIntoView({block:"center"})},[d]),(0,a.jsxs)("div",{className:"panel-content book-keywords",ref:s,children:[(null==t?void 0:t.length)?(0,a.jsx)("ul",{children:t.map((e,t)=>(0,a.jsx)(ih,{keyword:e,openEdit:l,isSelected:r===t,player:n},t))}):(0,j.t)("desc.keywordsEmpty"),c]})}function ig(e){let{navs:t,activeNavs:n,selectedNav:i,player:r}=e;return t.length?(0,a.jsx)("ul",{children:t.map((e,t)=>{let o=i===e,s=void 0!==e.spineIndex&&n.includes(e),l=["text"];return s&&l.push("active"),e.href&&l.push("clickable"),o&&l.push("selected"),(0,a.jsxs)("li",{"data-href":e.href,"data-spine-index":e.spineIndex,children:[(0,a.jsx)("div",{className:"item",onClick:t=>{(0,P.lJ)(t),e.href&&r.gotoUrlPath(e.href).catch(console.error)},children:(0,a.jsx)("div",{className:l.join(" "),children:e.label})}),(0,a.jsx)(ig,{navs:e.children,activeNavs:n,selectedNav:i,player:r})]},t)})}):null}function im(e){let{book:t,activeNavs:n,player:i}=e,{addHotkeys:r}=M(),o=(0,g.useRef)(null),[s,l]=(0,g.useState)(0),c=(0,g.useMemo)(()=>t.flattenedNavs[s],[t.flattenedNavs,s]);(0,g.useEffect)(()=>r([["p",(0,j.t)("hotkey.prevNav"),()=>{l(e=>e<=0?0:e-1)}],["n",(0,j.t)("hotkey.nextNav"),()=>{l(e=>e>=t.flattenedNavs.length-1?t.flattenedNavs.length-1:e+1)}],["enter",(0,j.t)("hotkey.gotoNav"),()=>{(null==c?void 0:c.href)&&i.gotoUrlPath(c.href).catch(console.error)}],[{shift:!0,key:"K"},(0,j.t)("hotkey.speakNav"),()=>{c&&i.utterer.speakText(c.label).catch(console.error)}]]),[r,t.flattenedNavs,i,c]);let d=(0,g.useMemo)(()=>null==n?void 0:n.at(-1),[n]);return(0,g.useEffect)(()=>{if(void 0===d)return;let e=t.flattenedNavs.indexOf(d);-1!==e&&l(e)},[t.flattenedNavs,d]),(0,g.useEffect)(()=>{if(!c)return;let e=o.current;if(!e)return;let t=e.querySelector("div.text.selected");null==t||t.scrollIntoView({block:"center"})},[c]),(0,a.jsx)("div",{ref:o,className:"panel-content book-nav",children:t.navs.length?(0,a.jsx)(ig,{navs:t.navs,activeNavs:n??[],selectedNav:c,player:i}):(0,j.t)("desc.navEmpty")})}function iv(e){return(0,a.jsx)(b.ZP,{style:{padding:"14px 4px"},size:"small",type:"primary",...e})}function iy(e){let{hotkey:t,description:n,...i}=e,r=(0,g.useMemo)(()=>(0,a.jsxs)(k.Z,{children:[n,t?(0,a.jsx)("span",{className:"keyboard",children:t}):null]}),[n,t]);return(0,a.jsx)(iv,{...i,children:(0,a.jsx)(nW.Z,{style:{pointerEvents:"none"},content:ew.tq?null:r,placement:"top",children:(0,a.jsx)("div",{children:i.children})})})}function ix(e){let{started:t,player:n,stopTimerEnabled:i,stopTimerSeconds:r}=e,o=(0,g.useRef)(),[s,l]=(0,g.useState)(0),[c,d]=(0,g.useState)(r);(0,g.useEffect)(()=>{let e;if(!t||!i)return;if(!s)return l(e=>e+1);let a=o.current??0,c=Date.now()/1e3;let u=()=>{let t=Date.now()/1e3-c+a;o.current=t;let i=r-t;if(i<=0){n.pause(),o.current=0,e&&clearInterval(e),d(0);return}d(i)};return u(),e=setInterval(u,1e3),()=>{clearInterval(e)}},[s,n,t,i,r]);let u=(0,g.useMemo)(()=>`${Math.floor(c/60).toString().padStart(2,"0")}
      :${(c%60).toFixed(0).padStart(2,"0")}`,[c]);return i?(0,a.jsx)(tr.Z,{onClick:()=>{o.current=0,l(e=>e+1),d(r)},children:u}):(0,a.jsx)(a.Fragment,{})}function iw(){let{book:e,reload:t}=nC(),{openBookEdit:n}=tP(t),{addHotkey:i}=M();return(0,g.useEffect)(()=>i("e",(0,j.t)("hotkey.editBook"),()=>{n(e.item.uuid)},{level:100}),[i,e.item.uuid,n]),(0,a.jsx)(b.ZP,{block:!0,type:"primary",onClick:()=>n(e.item.uuid),children:(0,j.t)("editBook")})}function ik(){let{book:e}=nC(),{voiceURI:t,setVoiceURI:n,allSortedVoices:i}=e_(e.item),r=(0,g.useMemo)(()=>i.map(e=>({label:e.name,value:e.voiceURI})),[i]);return(0,a.jsx)(nq,{children:(0,a.jsx)(e5.Z,{showSearch:!0,filterOption:e7,popupMatchSelectWidth:!1,style:{width:"100%"},value:t,onChange:e=>n(e),options:r})})}var ib=n("4450"),ij=n.n(ib),iC=n("887"),iS=n("8954");class iP{async upsert(e,t){var n;let{uuid:i,pos:r,range:a}=e,{note:o,color:s,group:l}=t,c=this.player.iframeCtrler.readableParts.at(r.paragraph);if(!c)return;if("text"!==c.type){(0,G.c1)().error((0,j.t)("desc.annotationNoSupported"));return}let d=c.text.slice(0,30),u=await iS.I.json({annotations:[{uuid:i,pos:r,range:a??void 0,brief:d,type:"text",content:c.text,note:o||void 0,color:s,group:l}],uuid:this.uuid});return null===(n=this.reload)||void 0===n||n.call(this),(0,G.c1)().info(`${(0,j.t)("desc.annotationUpdated")} ${d}`),u.annotations.at(0)}async remove(e){var t;if(e.note||e.range){let t=e.color?ij()(e.color,{black:"#3a3a3a",white:"#fafafa"}):"var(--main-fg-blue)";if(!await B({title:(0,j.t)("prompt.annotationRemoveConfirm"),description:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("p",{children:e.brief}),e.note&&(0,a.jsxs)("p",{children:["Note: ",e.note]}),e.range&&(0,a.jsxs)("p",{children:["Selected:"," ",(0,a.jsx)("span",{style:{backgroundColor:e.color??"var(--main-bg-blue)",color:t},children:e.range.selectedText})]})]})}))return}await iC.v.json({uuid:this.uuid,annotationUuids:[e.uuid]}),null===(t=this.reload)||void 0===t||t.call(this),(0,G.c1)().info(`${(0,j.t)("desc.annotationDeleted")} ${e.brief}`)}indexByPos(e,t){let n=this.player.states.annotations;if(!n)return null;let i=n.findIndex(n=>{var i,r;return n.pos.section===e.section&&n.pos.paragraph===e.paragraph&&(null===(i=n.range)||void 0===i?void 0:i.start)===(null==t?void 0:t.start)&&(null===(r=n.range)||void 0===r?void 0:r.end)===(null==t?void 0:t.end)});return -1===i?null:i}closestIndexByPos(e){let t=this.player.states.annotations;if(!t)return null;let n=t.findLastIndex(t=>t.pos.section===e.section&&t.pos.paragraph<=e.paragraph);return -1===n?null:n}byPos(e,t){var n;let i=this.indexByPos(e,t);return null===i?null:(null===(n=this.player.states.annotations)||void 0===n?void 0:n.at(i))??null}async toggle(e,t){let n=this.byPos(e,t);n?await this.remove(n):await this.upsert({pos:e,range:t,uuid:null},{})}constructor(e){(0,tK._)(this,"player",void 0),(0,tK._)(this,"uuid",void 0),(0,tK._)(this,"reload",void 0),this.player=e,this.uuid=e.book.item.uuid}}var iL=n("1479"),i_=n("4667");let iE=new tZ.p("books/render",{method:"get",isDynamic:!0}).routeLogined(async e=>{let{req:t,res:n,userInfo:i}=e,[r,...a]=t.paths;if(!r)throw new t$.xx("uuid not found");let o=await tM.E.book(i.account,r),s=decodeURI(eV().join(...a)),l=await o.file(s);if(!l)throw new t$.xx("Path in book not found");let c=l.mediaType??i_.contentType(eV().basename(s));return c&&n.header("Content-Type",c),l.buffer}),iA=(e,t)=>eV().join(iE.fullRoutePath,e,t);var iR=n("3309");async function iN(e,t){let{iteration:n=10,duration:i=100,abortCtrl:r}=e,a=!1;null==r||r.signal.addEventListener("abort",()=>{a=!0});let o=i/n;for(let e of(0,S.w6)(0,n+1)){if(await (0,e4._v)(o),a)break;await t(e)}}var iT=n("7791");let iI=`
  :root {
    --main-bg: white;
    --main-bg-active: #ddd;
    --main-bg-hover: #e3e3e3;
    --main-fg: #111;
    --main-fg-active: #111;
    --main-fg-hover: #111;
    --main-border: #666;
    --main-bg-blue: #03c;
    --main-fg-blue: #DDD;
    --main-bg-highlight: rgba(10, 120, 220, 0.3);
    --main-bg-symbol: rgba(10, 120, 220, 0.6);
    --main-fg-highlight: var(--main-fg);
  }
  :root.${y.JK}  {
    --main-bg: #1a1b1e;
    --main-bg-active: #555;
    --main-bg-hover: #444;
    --main-fg: #ccc;
    --main-fg-active: #ccc;
    --main-fg-hover: #ccc;
    --main-border: #777;
  }
`;var iM=n("1754"),iZ=n("8669"),i$=new WeakMap,iO=new WeakMap,iF=new WeakSet,iW=new WeakSet,iz=new WeakMap,iD=new WeakSet,iB=new WeakSet,iK=new WeakSet;class iU{get doc(){return this.iframeCtrl.doc}reCreateRoot(e){e.querySelectorAll(`.${this.rootClass}`).forEach(e=>e.remove()),(0,iL._)(this,i$,e.createElement("div")),(0,nI._)(this,i$).classList.add(this.rootClass),e.documentElement.appendChild((0,nI._)(this,i$)),(0,nI._)(this,iO).clear()}highlight(e,t){this.iframeCtrl.tryManipulateDOM(()=>{(0,iM._)(this,iK,iG).call(this,e,t)}).catch(console.error)}highlightHide(){this.iframeCtrl.tryManipulateDOM(()=>{(0,iM._)(this,iF,iH).call(this)}).catch(console.error)}constructor(e,t){var n;let i;(0,iZ._)(this,iF),(0,iZ._)(this,iW),(0,iZ._)(this,iD),(0,iZ._)(this,iB),(0,iZ._)(this,iK),(0,tK._)(this,"iframeCtrl",void 0),(0,tK._)(this,"states",void 0),(0,tK._)(this,"highlightedElems",void 0),(0,nM._)(this,i$,{writable:!0,value:void 0}),(0,nM._)(this,iO,{writable:!0,value:void 0}),(0,nM._)(this,iz,{writable:!0,value:void 0}),this.iframeCtrl=e,this.states=t,this.highlightedElems=[],(0,iL._)(this,iO,new Map);(0,iL._)(this,iz,(n=e=>{if(!!this.doc){if(e.length){if(this.iframeCtrl.enabledPageList){let t=(0,S.Sm)(e.map(e=>e.left))/e.length;this.iframeCtrl.pageListScrollToLeft(t).catch(console.error)}else if(this.iframeCtrl.isVertical){let t=(0,S.Sm)(e.map(e=>e.right))/e.length;this.iframeCtrl.scrollToLeft(t).catch(console.error)}else{let t=(0,S.Sm)(e.map(e=>e.top))/e.length;this.iframeCtrl.scrollToTop(t).catch(console.error)}}}},i=!1,function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];if(!i){let e=n(...t);return i=!0,setTimeout(()=>i=!1,1e3),e}}))}}function iH(){let e=(0,nI._)(this,i$);e&&Array.from(e.children).forEach(e=>{e.style.display="none"})}function iV(e,t){let n=this.doc,i=(0,nI._)(this,i$);if(!n||!i)return;let r=(e,t)=>{let r=(0,nI._)(this,iO).get(e);return!r&&(r=n.createElement("div"),t&&(r.style.backgroundColor=t),(0,nI._)(this,iO).set(e,r),i.appendChild(r)),r},a=n.documentElement.getBoundingClientRect(),o=e.map(e=>[...e.range.getClientRects()].map(e=>({width:e.width,height:e.height,left:e.left-a.left,right:e.right-a.right,top:e.top-a.top,bottom:e.bottom-a.top}))).flat();for(let[e,t]of((0,iM._)(this,iF,iH).call(this),o.entries())){let n=r(e,t.color);n.style.display="block",n.style.top=`${t.top}px`,n.style.left=`${t.left}px`,n.style.width=`${t.width}px`,n.style.height=`${t.height}px`}t&&(0,nI._)(this,iz).call(this,o)}function iq(e,t){if(!e.childNodes.length)return{type:1,remainIndex:t};let n=t;for(let t of e.childNodes){if((0,P.BM)(t)){if(!t.textContent)continue;if(n<=t.textContent.length)return{type:0,node:t,index:n};n-=t.textContent.length;continue}if(this.ignoreClass&&(0,P.kK)(t)&&t.closest(`.${this.ignoreClass}`))continue;let e=(0,iM._)(this,iD,iq).call(this,t,n);switch(e.type){case 0:return e;case 1:n=e.remainIndex;continue}}return{type:1,remainIndex:n}}function iJ(e,t){let n=(0,iM._)(this,iD,iq).call(this,e,t);return 0===n.type?n:null}function iG(e,t){if(!this.doc)return;let n=[];for(let t of e){let{node:e,charIndex:i,charLength:r,color:a}=t,o=document.createRange(),s=(0,iM._)(this,iB,iJ).call(this,e.elem,i);if(!s)continue;let l=(0,iM._)(this,iB,iJ).call(this,e.elem,i+r);if(l){try{o.setStart(s.node,s.index),o.setEnd(l.node,l.index)}catch(e){console.error(e);continue}n.push({range:o,color:a})}}(0,iM._)(this,iW,iV).call(this,n,t)}class iX extends iU{constructor(...e){super(...e),(0,tK._)(this,"rootClass",y.pJ),(0,tK._)(this,"ignoreClass",null)}}class iY extends iU{constructor(...e){super(...e),(0,tK._)(this,"rootClass",y.TO),(0,tK._)(this,"ignoreClass",null)}}var iQ=new WeakMap,i0=new WeakMap,i1=new WeakMap;class i2{get book(){return this.player.book}get iframe(){return this.iframeRef.current}get enabledPageList(){return"none"!==this.states.pageList&&!this.isVertical}get isFirstPageList(){return this.pageListCurIndex<=0}get isLastPageList(){return!this.pageListCount||this.pageListCurIndex>=this.pageListCount-1}pageListType(){if("auto"===this.states.pageList)return this.win?this.win.innerWidth>700?"double":"single":"single";return this.states.pageList}async tryManipulateDOM(e){await Promise.race([e(),(0,e4._v)(100)])}getReadablePartIndexByAnchorId(e){if(!e||!this.doc)return null;try{let t=this.readableParts.findIndex(t=>{var n;if(null===(n=t.anchorIds)||void 0===n?void 0:n.includes(e))return!0});return -1===t?null:t}catch{}return null}async scrollToCurParagraph(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0],t=this.readableParts.at(this.states.pos.paragraph);t?await this.scrollToElem(t.elem,{animated:e}):this.enabledPageList&&await this.pageListScrollToLeft(this.pageListScrollLeft,{animated:e})}async scrollToElem(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};await this.tryManipulateDOM(async()=>{if(!this.doc)return;let n=this.doc.documentElement.getBoundingClientRect(),i=e.getBoundingClientRect();if(this.enabledPageList){let r=i.left+e.offsetWidth/2-n.left;await this.pageListScrollToLeft(r,t)}else if(this.isVertical){let r=i.right+e.offsetWidth/2-n.right;await this.scrollToLeft(r,t)}else{let e=i.top-n.top;await this.scrollToTop(e,t)}})}async scrollToLeft(e){var t;let{iteration:n=10,duration:i=100,animated:r=!0,abortCtrl:a,position:o="center"}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.win)return;let s=null===(t=this.doc)||void 0===t?void 0:t.scrollingElement;if(!s)return;let l="center"===o?e+this.win.innerWidth/2:e;if(r){let e=s.scrollLeft,t=(l-e)/n;await iN({duration:i,iteration:n,abortCtrl:a},n=>{s.scrollLeft=e+n*t})}else s.scrollLeft=l}async scrollToTop(e){var t;let{iteration:n=10,duration:i=100,animated:r=!0,abortCtrl:a,position:o="center"}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.win)return;let s=null===(t=this.doc)||void 0===t?void 0:t.scrollingElement;if(!s)return;let l="center"===o?e-this.win.innerHeight/2:e;if(r){let e=s.scrollTop,t=(l-e)/n;await iN({duration:i,iteration:n,abortCtrl:a},n=>{s.scrollTop=e+n*t})}else s.scrollTop=l}pageListSetScrollLeft(e){this.doc&&(this.pageListScrollLeft=e,this.doc.documentElement.style.transform=`translateX(${-e}px)`,this.events.fire("scroll",null))}async pageListScrollToLeft(e){var t;let{iteration:n=10,duration:i=100,animated:r=!0,abortCtrl:a,userOperator:o=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.enabledPageList||!this.pageList)return;let s=null===(t=(0,S.dF)(this.pageList,t=>t.offsetLeft<=e))||void 0===t?void 0:t.offsetLeft;if(void 0!==s){if(r){let e=this.pageListScrollLeft,t=(s-e)/n;await iN({duration:i,iteration:n,abortCtrl:a},n=>{this.pageListSetScrollLeft(e+n*t)})}else this.pageListSetScrollLeft(s);this.viewOffsetWidth&&(this.pageListCurIndex=Math.round(this.pageListScrollLeft/this.viewOffsetWidth)),o&&this.updatePageListCurFocus()}}async pageListScrollToPage(e,t){var n;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!this.enabledPageList||!this.pageList)return;let r=this.pageList.at(e);r&&(t?await this.player.gotoParagraph((null===(n=r.topmost)||void 0===n?void 0:n.paragraph)??this.states.pos.paragraph):await this.pageListScrollToLeft(r.offsetLeft,i))}async pageListPushAdjust(e,t){var n;let i;if(!this.viewOffsetWidth||!this.pageListCount||!this.pageList)return;if(i=(0,nI._)(this,iQ)?(0,nI._)(this,iQ).pageIndex+e:this.pageListCurIndex+e,t){if(i<0)return await this.player.prevSection(-1);if(i>=this.pageListCount)return await this.player.nextSection()}else i<0?i=0:i>=this.pageListCount&&(i=this.pageListCount-1);null===(n=(0,nI._)(this,iQ))||void 0===n||n.abortCtrl.abort();let r=new AbortController;(0,iL._)(this,iQ,{abortCtrl:r,pageIndex:i});let a=i*this.viewOffsetWidth;if(await this.pageListScrollToLeft(a,{abortCtrl:r}),t){let e=this.pageList.at(i);(null==e?void 0:e.topmost)&&await this.player.gotoParagraph(e.topmost.paragraph,!1)}(0,iL._)(this,iQ,void 0)}async scrollToPercent(e,t){var n;let i=null===(n=this.doc)||void 0===n?void 0:n.scrollingElement;if(console.debug(`scrollElement: ${(null==i?void 0:i.tagName)??"null"}`),i){if(this.enabledPageList){if(!this.viewOffsetWidth)return;let n=Math.ceil(this.pageListScrollWidth*e/this.viewOffsetWidth)-1-this.pageListCurIndex;await this.pageListPushAdjust(n,t)}else if(this.isVertical){let t=-i.scrollWidth*e+i.clientWidth;await this.scrollToLeft(t,{position:"start"})}else{let t=i.scrollHeight*e-i.clientHeight;await this.scrollToTop(t,{position:"start"})}}}async load(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.iframe;if(!t)return;let n=e.force??!1,i=e.section??this.states.pos.section,r=this.book.spines.at(i);if(!r&&(r=this.book.spines.at(0)),!r)return(0,G.c1)().error("book spine is empty");this.states.pos={...this.states.pos,section:i};let a=r.href,o=n||a!==(0,nI._)(this,i0);(0,iL._)(this,i0,a);try{if(o){this.states.loading=!0,this.iframe.style.opacity="0",this.unmount.fire();let e=new Promise(e=>{t.addEventListener("load",()=>{e()},{once:!0})});t.src=iA(this.book.item.uuid,a),await e;let n=t.contentDocument;if(!n)return(0,G.c1)().error("iframe load failed");let i=new iR.b(n,this.book.flattenedNavs);this.readableParts=i.toReadableParts(),this.alias=i.alias(),await this.onLoaded(t)}let n=this.states.pos.paragraph;void 0!==e.paragraph?(n=e.paragraph<0?this.readableParts.length+e.paragraph:e.paragraph)<0?n=0:n>=this.readableParts.length&&(n=this.readableParts.length-1):e.anchorId&&(n=this.getReadablePartIndexByAnchorId(e.anchorId)??0),this.states.pos={...this.states.pos,paragraph:n},await this.scrollToCurParagraph(e.animated??!1)}finally{o&&(this.states.loading=!1,this.iframe.style.opacity="1")}}async gotoUrlPath(e){let[t,n]=(0,iT.c)(e),i=this.book.spines.findIndex(e=>e.href===t);-1!==i&&(n?await this.load({section:i,anchorId:n}):await this.load({section:i,paragraph:0}))}async onLoaded(e){let t=e.contentWindow,n=e.contentDocument;t&&n&&(this.win=t,this.doc=n,E.c.set(_,{win:t}),this.states.disabledVertical?this.isVertical=!1:this.isVertical=t.getComputedStyle(n.body).writingMode.startsWith("vertical"),this.updateColorTheme(this.colorScheme),this.injectCSS(n),this.updateFontSize(n),this.viewCalculate(n),this.hookResize(t,n),this.resizeImgs(n),this.hookTouch(),this.enabledPageList&&(await this.pageListCalculate(n),this.hookPageWheel(),this.hookSwipe()),this.isVertical&&this.hookVerticalWheel(),this.hookSelection(),this.hookScroll(),this.hookALinks(n),this.hookLinkClick(),this.hookImgs(n),this.hookParagraphClick(),this.player.utterer.hl.reCreateRoot(n),this.annotationHl.reCreateRoot(n),this.keywordHl.reCreateRoot(n),this.updateAnnotations(),this.updateKeywords())}updateColorTheme(e){this.colorScheme=e,this.doc&&("dark"===e?this.doc.documentElement.classList.add(y.JK):this.doc.documentElement.classList.remove(y.JK))}injectCSS(e){let t=e.createElement("style"),n="";this.enabledPageList?n+=`
        /* page list */
        html {
          width: 100% !important;
          height: 100% !important;
          box-sizing: border-box !important;
          margin: 0 !important;
          padding: 0 !important;
          overflow: hidden !important;
          will-change: transform !important;
        }
        body {
          width: auto !important;
          height: 100% !important;
          box-sizing: border-box !important;
          word-break: break-word !important;
          margin: 0 !important;
          padding: 0 !important;
          /* Safari iOS not support
            columns: var(--main-column-count) auto !important;
          */
          columns: var(--main-column-count) var(--main-column-width) !important;
          column-gap: ${this.pageListGap}px !important;
          column-fill: auto !important;
        }
        .${y.HQ} {
          content: ' ';
          break-before: column;
          ${ew.G6||ew.vU?"height: 100%":""}
        }
      `:n+=`
        html {
          width: 100%;
          height: 100%;
          box-sizing: border-box !important;
          margin: 0 !important;
          padding: 8px !important;
        }
        body {
          ${this.isVertical?`
                width: auto;
                height: 100%;
                overflow-y: hidden;
              `:`
                height: auto;
                width: 100%;
                overflow-x: hidden;
              `}
          box-sizing: border-box !important;
        }
      `,this.states.disabledVertical&&(n+=`
        body {
          writing-mode: initial !important;
        }
      `);let i="";!ew.tq&&(i=`
        .${y.b6}:hover {
          outline: 1px dashed var(--main-fg-hover);
        }
      `),t.innerHTML=`
      ${iI}
      ${n}

      /* scrollbar */
      ::-webkit-scrollbar-thumb {
        background: var(--main-fg);
      }

      /* wrap */
      pre {
        white-space: pre-wrap;
      }

      /* image */
      svg {
        max-width: 90% !important;
        max-height: 90vh;
      }
      img.${y.A4} {
        max-width: 90% !important;
        height: auto;
      }
      img.${y.jM} {
        width: auto;
        max-height: 90vh;
      }

      /* scheme */
      .${y.JK} body,
      .${y.JK} body * {
        background-color: var(--main-bg);
        color: var(--main-fg) !important;
      }

      /* paragraph */
      .${y.b6} {
        cursor: pointer;
      }

      .${y.b6}.${y.TX},
      .${y.b6}.${y.TX} * {
        background: var(--main-bg-active) !important;
      }

      ${i}

      .${y.is} > div,
      .${y.pJ} > div,
      .${y.TO} > div {
        position: absolute;
        user-select: none;
        pointer-events: none;
      }

      .${y.is} > div,
      .${y.pJ} > div {
        background-color: var(--main-bg-highlight) !important;
        color: var(--main-fg-highlight) !important;
      }

      .${y.TO} > div {
        border-bottom: 0.15em dotted var(--main-bg-symbol);
      }

      .${y.lc} {
        text-decoration-line: underline;
        text-decoration-style: solid;
        text-decoration-thickness: 2px;
        text-decoration-color: var(--main-bg-blue);
        text-underline-offset: 4px;
      }
    `,e.head.appendChild(t),e.querySelectorAll("svg").forEach(e=>{e.setAttribute("preserveAspectRatio","xMinYMin meet")})}updateFontSize(e){this.tryManipulateDOM(()=>{e.documentElement.style.fontSize=`${this.states.fontSize}px`}).catch(console.error)}hookResize(e,t){let n=()=>this.onResized(t);e.addEventListener("resize",n),this.unmount.on(()=>{e.removeEventListener("resize",n)})}resizeImgs(e){let t=[y.A4,y.jM],n=e.querySelectorAll("img");for(let e of n)e.classList.remove(...t);if(this.viewWidth&&"none"===this.pageListType())for(let e of n)e.width>this.viewWidth&&e.classList.add(y.A4)}hookTouch(){let e;if(!ew.oL)return;let t=this.doc,n=this.win,i=this.viewWidth;if(!t||!n||!i)return;let r=t=>{let n=t.touches[0];n&&(e={x:n.clientX,y:n.clientY,offsetLeft:this.pageListScrollLeft,timestamp:Date.now()})},a=n=>{if((0,P.lJ)(n),void 0===e)return;let i=t.getSelection();if((null==i?void 0:i.type)==="Range"){e=void 0;return}let r=n.touches[0];if(!r)return;let a=r.clientX-e.x;this.pageListSetScrollLeft(e.offsetLeft-a)},o=t=>{if(void 0===e)return;let n=t.changedTouches[0];if(!n)return;let r=n.clientX-e.x,a=r/(Date.now()-e.timestamp),o=.2*i;if(a<-.3||r<-o){if(!this.isLastPageList||!this.player.isLastSection){this.events.fire("swipeRight",null);return}}else if((a>.3||r>o)&&(!this.isFirstPageList||!this.player.isFirstSection)){this.events.fire("swipeLeft",null);return}this.pageListPushAdjust(0,!1)};t.addEventListener("touchstart",r),t.addEventListener("touchmove",a),t.addEventListener("touchend",o),this.unmount.on(()=>{t.removeEventListener("touchstart",r),t.removeEventListener("touchmove",a),t.removeEventListener("touchend",o)})}hookPageWheel(){let e=this.doc;if(!e)return;let t=e=>{if((0,P.lJ)(e),!(0,P.cK)(e.target))0!==e.deltaY&&(e.deltaY>0?this.events.fire("swipeRight",null):this.events.fire("swipeLeft",null))};e.documentElement.addEventListener("wheel",t),this.unmount.on(()=>{e.documentElement.removeEventListener("wheel",t)})}hookSwipe(){let e=this.events.on("swipeLeft",async()=>{await this.player.prevPage(1,!0)}),t=this.events.on("swipeRight",async()=>{await this.player.nextPage(1,!0)});this.unmount.on(()=>{e(),t()})}hookVerticalWheel(){var e;let t=this.doc,n=null===(e=this.doc)||void 0===e?void 0:e.scrollingElement;if(!t||!n)return;let i=e=>{if((0,P.lJ)(e),!(0,P.cK)(e.target))0!==e.deltaY&&(n.scrollLeft-=e.deltaY)};t.documentElement.addEventListener("wheel",i),this.unmount.on(()=>{t.documentElement.removeEventListener("wheel",i)})}hookSelection(){let e=this.win,t=this.doc;if(e&&t&&(t.addEventListener("selectionchange",()=>{let e=`.${y.b6}`,n=(()=>{let n=t.getSelection();if(!n||n.rangeCount<=0)return;let i=n.getRangeAt(0),r=i.toString(),a=r.length;if(!a)return;let o=i.commonAncestorContainer.parentElement;if(!o)return;let s=o.matches(e)?o:o.closest(e);if(!s)return;let l=this.readableParts.findIndex(e=>e.elem===s);if(-1===l)return;let c=i.cloneRange();c.selectNodeContents(s),c.setEnd(i.endContainer,i.endOffset);let d=c.toString().length-a;return{paragraph:l,start:d,end:d+a,selectedText:r}})();n?(this.states.pos={...this.states.pos,paragraph:n.paragraph},this.states.selection={start:n.start,end:n.end,selectedText:n.selectedText}):this.states.selection=void 0}),ew.tq)){let n=()=>{var e;null===(e=t.getSelection())||void 0===e||e.removeAllRanges()};e.addEventListener("blur",n),this.unmount.on(()=>{e.removeEventListener("blur",n)})}}hookScroll(){var e;let t=null===(e=this.doc)||void 0===e?void 0:e.scrollingElement;if(!this.doc||!t)return;let n=()=>{let e,n,i;this.enabledPageList&&this.pageListCount?(e=(this.pageListScrollLeft+t.clientWidth)/this.pageListScrollWidth,n=this.pageListScrollLeft/this.pageListScrollWidth,i=1/this.pageListCount):this.isVertical?(e=(-t.scrollLeft+t.clientWidth)/t.scrollWidth,n=-t.scrollLeft/t.scrollWidth,i=t.clientWidth/t.scrollWidth):(e=(t.scrollTop+t.clientHeight)/t.scrollHeight,n=t.scrollTop/t.scrollHeight,i=t.clientHeight/t.scrollHeight),this.states.scrollPercent={percent:100*e,progress:100*n,length:100*i}};n();let i=this.events.on("scroll",()=>n());this.doc.addEventListener("scroll",()=>this.events.fire("scroll",null),{passive:!0}),this.unmount.on(()=>{i()})}hookALinks(e){for(let t of e.querySelectorAll("a"))t.href&&t.addEventListener("click",e=>{(0,P.lJ)(e),this.events.fire("click",t)})}hookLinkClick(){let e=async e=>await B({title:(0,j.t)("confirm.openLink"),description:e}),t=this.events.on("click",t=>{(0,e4.PF)(async()=>{let n;if(t.closest(eG.n)){let e=t.getAttribute("href");if(!e)return;n=eV().join("/",e)}else{let i=t.href;if(!i)return;if(!i.startsWith(this.mainContentRootUrl)&&await e(i))return window.open(i,"_blank","noopener,noreferrer");n=i.substring(this.mainContentRootUrl.length)}await e(n)&&(await this.gotoUrlPath(n),this.player.utterer.cancel())})});this.unmount.on(()=>{t()})}hookImgs(e){for(let t of e.querySelectorAll("img"))t.addEventListener("click",e=>{let n=t.src;n&&((0,P.lJ)(e),E.c.set(ea,n))});for(let t of e.querySelectorAll("svg"))t.addEventListener("click",n=>{(0,P.lJ)(n),(0,e4.PF)(async()=>{let n=await (0,P.hO)(t,e.URL);E.c.set(ea,n)})})}hookParagraphClick(){let e=this.win,t=this.doc;if(!e||!t)return;let n=(e,t)=>{(0,P.lJ)(e),this.player.gotoParagraph(t,!1)},i=(e,n)=>{var i;(0,P.lJ)(e),null===(i=t.getSelection())||void 0===i||i.removeAllRanges(),this.player.annotations.toggle({section:this.states.pos.section,paragraph:n},null)};this.readableParts.forEach((e,t)=>{"text"===e.type&&(e.elem.addEventListener("click",e=>n(e,t)),e.elem.addEventListener("dblclick",e=>i(e,t)))})}viewCalculate(e){let t=e.documentElement.getBoundingClientRect();this.viewWidth=t.width,this.viewOffsetWidth=t.width+this.pageListGap,this.viewHeight=t.height,console.debug(`viewWidth: ${this.viewWidth}`),console.debug(`viewOffsetWidth: ${this.viewOffsetWidth}`),console.debug(`viewHeight: ${this.viewHeight}`)}pageListScrollWidthCalculate(e,t){let n=1/0,i=-1/0;if(!this.readableParts.length)return e.scrollWidth;for(let e of[...this.readableParts.map(e=>e.elem),t]){if(!e)continue;let t=e.getBoundingClientRect();t.left<n&&(n=t.left),t.right>i&&(i=t.right)}return i-n}async pageListCalculate(e){var t;let n;if(!this.viewWidth||!this.viewOffsetWidth)return;let i=e.documentElement,r=this.pageListType(),a="single"===r?1:2,o=(this.viewWidth-this.pageListGap)/a;if(i.style.setProperty("--main-column-count",a.toString()),i.style.setProperty("--main-column-width",`${o}px`),this.pageListColumnWidth=o,this.pageListResizeImgs(e,this.pageListColumnWidth),this.pageListScrollWidth=this.pageListScrollWidthCalculate(i,null),null===(t=e.querySelector(`.${y.HQ}`))||void 0===t||t.remove(),"double"===r){if((n=Math.round(2*this.pageListScrollWidth/this.viewOffsetWidth))%2==1){n+=1;let t=e.createElement("p");t.classList.add(y.HQ),e.body.appendChild(t),this.pageListScrollWidth=this.pageListScrollWidthCalculate(i,t)}n/=2}else n=Math.round(this.pageListScrollWidth/this.viewOffsetWidth);n<1&&(n=1),this.pageListCount=n,console.debug(`pageListScrollWidth: ${this.pageListScrollWidth}`),console.debug(`pageListColumnWidth: ${this.pageListColumnWidth}`),console.debug(`pageListCount: ${this.pageListCount}`),this.parsePageList(i)}pageListResizeImgs(e,t){if(!this.viewHeight)return;let n=e.querySelectorAll("img"),i=t/this.viewHeight;for(let e of n)(e.width>t||e.height>this.viewHeight)&&e.classList.add(e.naturalWidth/e.naturalHeight>i?y.A4:y.jM)}parsePageList(e){let t=this.viewOffsetWidth;if(!t||!this.pageListCount)return;this.pageList=(0,S.w6)(0,this.pageListCount).map(e=>e*t).map(e=>({offsetLeft:e}));let n=e.getBoundingClientRect().left;for(let[e,t]of this.readableParts.entries()){let i=t.elem.getBoundingClientRect().left+t.elem.offsetWidth/2-n,r=(0,S.dF)(this.pageList,e=>e.offsetLeft<=i);r&&!r.topmost&&(r.topmost={readablePart:t,paragraph:e})}}updatePageListCurFocus(){if(!this.pageList)return;let e=this.states.pos.paragraph;if((0,S.qr)(this.pageList,t=>!!t.topmost&&t.topmost.paragraph<=e)===this.pageListCurIndex)this.pageListResizeCurFocusPart=this.readableParts.at(e);else{var t,n;this.pageListResizeCurFocusPart=null===(n=this.pageList.at(this.pageListCurIndex))||void 0===n?void 0:null===(t=n.topmost)||void 0===t?void 0:t.readablePart}}updateParagraphActive(){this.tryManipulateDOM(()=>{var e;let t=this.readableParts.at(this.states.pos.paragraph);!(!t||(0,nI._)(this,i1)&&t===(0,nI._)(this,i1))&&(null===(e=(0,nI._)(this,i1))||void 0===e||e.elem.classList.remove(y.TX),(0,iL._)(this,i1,t),t.elem.classList.add(y.TX))}).catch(console.error)}updateAnnotations(){this.tryManipulateDOM(()=>{if(!this.states.annotations||!this.doc)return;for(let e of Array.from(this.doc.querySelectorAll(`.${y.lc}`)))e.classList.remove(y.lc);let e=[];for(let t of this.states.annotations){if(t.pos.section!==this.states.pos.section)continue;let n=this.readableParts.at(t.pos.paragraph);if(n){if(!t.range){n.elem.classList.add(y.lc);continue}e.push({node:n,charIndex:t.range.start,charLength:t.range.end-t.range.start,color:"var(--main-bg-blue)"})}}this.annotationHl.highlight(e,!1)}).catch(console.error)}updateKeywords(){this.tryManipulateDOM(()=>{if(!this.states.keywords||!this.doc)return;let e=[];for(let t of this.states.keywords){let n=this.readableParts.filter(e=>"text"===e.type);if(n.length)for(let i of n){let n=(0,L.Rh)(i.text,t);if(n.length)for(let[t,r]of n)e.push({node:i,charIndex:t,charLength:r,color:"var(--main-bg-blue)"})}}this.keywordHl.highlight(e,!1)}).catch(console.error)}updateActiveNavs(){let e=this.book.flattenedNavs.filter(e=>e.spineIndex===this.states.pos.section),t=(()=>{var t;if(0===e.length)return(0,S.dF)(this.book.flattenedNavs,e=>!!e.spineIndex&&e.spineIndex<this.states.pos.section);let n=this.readableParts,i=null===(t=(0,S.dF)(n.slice(0,this.states.pos.paragraph+1),e=>!!e.navAnchorIds))||void 0===t?void 0:t.navAnchorIds,r=i&&i.length>0?i[i.length-1]:null;if(!r)return e[0];let a=(0,S.dF)(e,e=>e.hrefAnchor===r);return a?a:e[0]})();if(!t){this.states.activeNavs=[];return}let n=this.book.flattenedNavs.indexOf(t);if(-1===n){this.states.activeNavs=[];return}let i=[t],r=n-1,a=t.level-1;for(;r>=0&&a>0;){let[e,t]=(0,S.L_)(this.book.flattenedNavs,e=>e.level===a,r);if(e)r=t-1,a=e.level-1,i.unshift(e);else break}this.states.activeNavs=i}constructor(e,t,n){var i;let r;(0,tK._)(this,"player",void 0),(0,tK._)(this,"states",void 0),(0,tK._)(this,"iframeRef",void 0),(0,tK._)(this,"readableParts",void 0),(0,tK._)(this,"alias",void 0),(0,tK._)(this,"doc",void 0),(0,tK._)(this,"events",void 0),(0,tK._)(this,"unmount",void 0),(0,tK._)(this,"isVertical",void 0),(0,tK._)(this,"annotationHl",void 0),(0,tK._)(this,"keywordHl",void 0),(0,tK._)(this,"mainContentRootPath",void 0),(0,tK._)(this,"mainContentRootUrl",void 0),(0,tK._)(this,"colorScheme",void 0),(0,tK._)(this,"viewWidth",void 0),(0,tK._)(this,"viewOffsetWidth",void 0),(0,tK._)(this,"viewHeight",void 0),(0,tK._)(this,"pageList",void 0),(0,tK._)(this,"pageListGap",void 0),(0,tK._)(this,"pageListScrollWidth",void 0),(0,tK._)(this,"pageListScrollLeft",void 0),(0,tK._)(this,"pageListColumnWidth",void 0),(0,tK._)(this,"pageListCount",void 0),(0,tK._)(this,"pageListCurIndex",void 0),(0,tK._)(this,"pageListResizeCurFocusPart",void 0),(0,tK._)(this,"win",void 0),(0,nM._)(this,iQ,{writable:!0,value:void 0}),(0,nM._)(this,i0,{writable:!0,value:void 0}),(0,tK._)(this,"onResized",void 0),(0,nM._)(this,i1,{writable:!0,value:void 0}),this.player=e,this.states=t,this.iframeRef=n,this.readableParts=[],this.alias=[],this.events=new nZ.Q5,this.unmount=new nZ.mX({once:!0}),this.isVertical=!1,this.colorScheme="light",this.pageListGap=12,this.pageListScrollWidth=0,this.pageListScrollLeft=0,this.pageListCurIndex=0;this.onResized=(i=e=>{(0,e4.PF)(async()=>{if(this.viewCalculate(e),this.resizeImgs(e),this.enabledPageList){await this.pageListCalculate(e);let t=this.pageListResizeCurFocusPart;t?await this.scrollToElem(t.elem,{animated:!1,userOperator:!1}):await this.pageListScrollToLeft(this.pageListScrollLeft,{animated:!1,userOperator:!1}),this.player.utterer.hl.highlightHide(),this.updateAnnotations(),this.updateKeywords()}})},function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];clearTimeout(r),r=setTimeout(()=>i(...t),300)}),this.mainContentRootPath=iA(this.book.item.uuid,""),this.mainContentRootUrl=new URL(this.mainContentRootPath,location.href).toString(),this.annotationHl=new iX(this,t),this.keywordHl=new iY(this,t),this.states.events.on("pos",()=>{this.updateParagraphActive(),this.updateActiveNavs()}),this.states.events.on("started",e=>{!e&&this.player.utterer.hl.highlightHide()}),this.states.uiEvents.on("annotations",()=>{this.updateAnnotations()}),this.states.uiEvents.on("keywords",()=>{this.updateKeywords()});let a=!0;this.states.uiEvents.on("pageList",async()=>{if(a){a=!1;return}this.iframe&&await this.load({force:!0})});let o=!0;this.states.uiEvents.on("disabledVertical",async()=>{if(o){o=!1;return}this.iframe&&await this.load({force:!0})}),this.states.uiEvents.on("fontSize",async()=>{this.doc&&(this.updateFontSize(this.doc),this.onResized(this.doc))}),this.player.unmount.on(()=>this.unmount.fire())}}var i3=n("3918"),i4=n("945");class i6{getBriefText(e){let t=this.player.iframeCtrler.readableParts.at(e.paragraph);if(!t)return;if("text"!==t.type)return(0,G.c1)().error((0,j.t)("desc.keywordNoSupported")),null;let n=t.text.slice(0,30);return{text:t.text,brief:n}}async add(e){var t;let{keyword:n,pos:i}=e,r=this.getBriefText(i);if(!r)return;let a=await i4.L.json({keywords:[{keyword:n,uuid:null,pos:i,brief:r.brief,content:r.text}],uuid:this.uuid});return null===(t=this.reload)||void 0===t||t.call(this),(0,G.c1)().info(`${(0,j.t)("desc.keywordUpdated")} ${n}`),a.keywords.at(0)}async upsert(e,t){var n;let{uuid:i,keyword:r,pos:a}=e,{alias:o,note:s,color:l}=t,c=this.getBriefText(a);if(!c)return;let d=await i4.L.json({keywords:[{uuid:i,keyword:r,pos:a,brief:c.brief,content:c.text,alias:o,note:s,color:l}],uuid:this.uuid});return null===(n=this.reload)||void 0===n||n.call(this),(0,G.c1)().info(`${(0,j.t)("desc.keywordUpdated")} ${r}`),d.keywords.at(0)}async remove(e){var t;let n=e.color?ij()(e.color,{black:"#3a3a3a",white:"#fafafa"}):"var(--main-fg-blue)";await B({title:(0,j.t)("prompt.keywordRemoveConfirm"),description:(0,a.jsx)("span",{style:{backgroundColor:e.color??"var(--main-bg-blue)",color:n},children:e.keyword})})&&(await i3.p.json({uuid:this.uuid,keywordUuids:[e.uuid]}),null===(t=this.reload)||void 0===t||t.call(this),(0,G.c1)().info(`${(0,j.t)("desc.keywordDeleted")} ${e.keyword}`))}constructor(e){(0,tK._)(this,"player",void 0),(0,tK._)(this,"uuid",void 0),(0,tK._)(this,"reload",void 0),this.player=e,this.uuid=e.book.item.uuid}}class i8 extends iU{constructor(...e){super(...e),(0,tK._)(this,"rootClass",y.is),(0,tK._)(this,"ignoreClass",y.Xp)}}class i9{cancel(){this.speech.cancel()}async speakNode(e){return this.states.voice?this.speech.speak(e.text,{voice:this.states.voice,speed:this.states.speechSpeed,isPersonReplace:this.states.isPersonReplace,alias:this.player.iframeCtrler.alias,onBoundary:t=>{this.hl.highlight([{node:e,charIndex:t.charIndex,charLength:t.charLength}],!0)}}):"done"}async speakText(e){return this.states.voice?this.speech.speak(e,{voice:this.states.voice,speed:this.states.speechSpeed,isPersonReplace:this.states.isPersonReplace,alias:this.player.iframeCtrler.alias}):"done"}async nextPart(){this.states.pos.paragraph>=this.player.iframeCtrler.readableParts.length-1?this.states.pos.section<this.player.book.spines.length-1&&this.states.autoNextSection?(await this.player.nextSection(),await t2()):this.player.pause():(await this.player.nextParagraph(),await t0())}async startLoop(){let e=0;for(;;){if(!this.states.started)return;try{let e=this.player.iframeCtrler.readableParts.at(this.states.pos.paragraph);if(e)switch(e.type){case"text":{let t=!1;for(let n=0;n<this.states.paragraphRepeat;n++){let i=await this.speakNode(e);if("cancel"===i){t=!0;break}n!==this.states.paragraphRepeat-1&&await t8()}if(t)continue;break}case"image":await tY()}await this.nextPart()}catch(t){console.error(t),(e+=1)>3&&(await this.nextPart(),e=0)}}}constructor(e,t,n){(0,tK._)(this,"player",void 0),(0,tK._)(this,"hl",void 0),(0,tK._)(this,"states",void 0),(0,tK._)(this,"speech",void 0),this.player=e,this.states=t,this.hl=new i8(n,t),this.speech=new t9}}class i5{start(){this.states.started=!0,this.utterer.startLoop().catch(console.error)}pause(){this.states.started=!1,this.utterer.cancel()}restart(e){this.pause(),e?setTimeout(()=>{this.start()},e):this.start()}toggle(){this.states.started?this.pause():this.start()}get isFirstSection(){return 0===this.states.pos.section}get isLastSection(){return this.states.pos.section===this.book.spines.length-1}async gotoPos(e){let{section:t,paragraph:n,scrollToParagraph:i=!0,animated:r=!0}=e;if(void 0===t||!(t<0)&&!(t>=this.book.spines.length)){if(t??(t=this.states.pos.section),n??(n=this.states.pos.paragraph),this.states.pos.section===t){if(this.states.pos.paragraph===n)return;this.states.pos={section:t,paragraph:n},i&&await this.iframeCtrler.scrollToCurParagraph(r)}else await this.iframeCtrler.load({section:t,paragraph:n,animated:r});this.utterer.cancel()}}async gotoSection(e,t){await this.gotoPos({section:e,paragraph:t})}async prevSection(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;await this.gotoPos({section:this.states.pos.section-1,paragraph:e,animated:!1})}async nextSection(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;await this.gotoPos({section:this.states.pos.section+1,paragraph:e,animated:!1})}async gotoUrlPath(e){await this.iframeCtrler.gotoUrlPath(e),this.utterer.cancel()}get isFirstPage(){return this.iframeCtrler.isFirstPageList}get isLastPage(){return this.iframeCtrler.isLastPageList}async gotoPage(e,t){await this.iframeCtrler.pageListScrollToPage(e,t)}async prevPage(e,t){await this.iframeCtrler.pageListPushAdjust(-e,t)}async nextPage(e,t){await this.iframeCtrler.pageListPushAdjust(e,t)}get isFirstParagraph(){return this.states.pos.paragraph<=0}get isLastParagraph(){return this.states.pos.paragraph>=this.iframeCtrler.readableParts.length-1}async gotoParagraph(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];await this.gotoPos({paragraph:e,scrollToParagraph:t})}async prevParagraph(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];0===this.states.pos.paragraph?await this.prevSection(-1):await this.gotoParagraph(this.states.pos.paragraph-1,e)}async nextParagraph(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];this.states.pos.paragraph>=this.iframeCtrler.readableParts.length-1?await this.nextSection():await this.gotoParagraph(this.states.pos.paragraph+1,e)}constructor(e,t,n){(0,tK._)(this,"book",void 0),(0,tK._)(this,"states",void 0),(0,tK._)(this,"utterer",void 0),(0,tK._)(this,"iframeCtrler",void 0),(0,tK._)(this,"annotations",void 0),(0,tK._)(this,"keywords",void 0),(0,tK._)(this,"unmount",void 0),this.book=e,this.unmount=new nZ.mX({once:!0}),this.states=new nF,this.states.pos=t,this.iframeCtrler=new i2(this,this.states,n),this.utterer=new i9(this,this.states,this.iframeCtrler),this.annotations=new iP(this),this.keywords=new i6(this);let i=()=>{(0,e4.PF)(async()=>{let e;await (null==e?void 0:e.release().catch(console.error)),e=void 0,this.states.started&&this.states.docVisible&&(e=await navigator.wakeLock.request("screen"))})};i(),document.addEventListener("visibilitychange",i);let r=this.states.events.on("started",i);this.unmount.on(()=>{document.removeEventListener("visibilitychange",i),r()})}}function i7(e){let{scrollPercent:t,onClick:n}=e,i=(null==t?void 0:t.percent.toFixed(2))??"0",r=(null==t?void 0:t.progress)??"0",o=(null==t?void 0:t.length)??"0";return(0,a.jsx)("div",{style:{height:6,width:"100%",overflow:"hidden",borderRadius:6,background:"var(--main-bg-active)",position:"relative"},onClick:e=>{let t=e.currentTarget.getBoundingClientRect(),i=(e.clientX-t.left)/t.width;null==n||n(i)},title:`${i}%`,children:(0,a.jsx)("div",{style:{position:"absolute",transition:"width,left 0.2s",left:`${r}%`,width:`${o}%`,height:"100%",background:"var(--main-fg-active)"}})})}let re=e=>{var t,n;let{data:i,error:r,reload:a}=(0,ex.BH)(nb.X,{uuid:e});let{data:o,error:s,reload:l}=(t=[i],n=async e=>{if(e)return nk.C.json({uuid:e.item.uuid})},function(e,t){let n=(0,g.useRef)(e),[i,r]=(0,g.useState)(),[a,o]=(0,g.useState)(),s=(0,g.useCallback)(e=>{n.current().then(t=>{!e.aborted&&r(t)}).catch(t=>{!e.aborted&&o(t)})},[]),l=(0,g.useCallback)(function(){let{signal:e,clean:t=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t&&r(void 0),o(void 0),s(e??new AbortController().signal)},[s]);return(0,g.useEffect)(()=>{n.current=e},[e]),(0,g.useEffect)(()=>{let e=new AbortController;return s(e.signal),()=>{e.abort()}},(null==t?void 0:t.deps)??[]),{data:i,error:a,reload:l}}(()=>n(...t),{deps:[JSON.stringify(t)]})),[c,d]=(0,g.useState)(),u=null==c?void 0:c.section,h=null==c?void 0:c.paragraph,p=(0,g.useMemo)(()=>{if(!i)return;let e=[],t=[...i.navs];for(;t.length;){let n=t.shift();e.push(n),t.unshift(...n.children)}return{...i,flattenedNavs:e}},[i]);return(0,g.useEffect)(()=>{o&&d(o)},[o]),(0,g.useEffect)(()=>{void 0!==p&&void 0!==u&&void 0!==h&&nw.u.json({uuid:p.item.uuid,pos:{section:u,paragraph:h}}).catch(console.error)},[p,h,u]),{error:r||s,pos:c,setPos:d,book:p,reload:(0,g.useCallback)(()=>{a(),l()},[a,l])}};function rt(){let{book:e}=nC(),{BookPanelView:t,MainContent:n,activeNavs:i}=function(){let{book:e,pos:t,setPos:n}=nC(),i=(0,g.useRef)(null),[r,o]=(0,g.useState)(!1),[s,l]=(0,g.useState)(),[c,d]=(0,g.useState)(!1),[u,h]=(0,g.useState)(),[p,f]=(0,g.useState)(),{addHotkeys:m}=M(),[,v]=eC(),y=(0,em.s0)(),x=function(e,t,n){var i;let r=(0,g.useRef)();return!r.current&&(r.current=new i5(e,t,n)),(0,t7.z)(()=>{var e;null===(e=r.current)||void 0===e||e.unmount.fire()}),i=r.current,(0,ed.n)(async()=>{await i.iframeCtrler.load()}),r.current}(e,t,i);!function(e,t){let{setPos:n,setStarted:i,setActiveNavs:r,setLoading:a,setScrollPercent:o,setSelection:s}=t;(0,g.useEffect)(()=>{let t=e.states.events,l=[t.on("pos",e=>{n(e)}),t.on("started",e=>{i(e)}),t.on("activeNavs",e=>{r(e)}),t.on("loading",e=>{a(e)}),t.on("scrollPercent",e=>{o(e)}),t.on("selection",e=>{s(e)})];return()=>{l.forEach(e=>e())}},[e,n,i,r,a,o,s])}(x,{setPos:n,setStarted:o,setActiveNavs:l,setLoading:d,setScrollPercent:h,setSelection:f});let w=nN();(0,g.useEffect)(()=>{x.iframeCtrler.updateColorTheme(w)},[x.iframeCtrler,w]);let{BookPanelView:C}=function(e){let{player:t,started:n,activeNavs:i,selection:r}=e,{book:o,pos:s}=nC(),l=(0,em.s0)(),{annotations:c,keywords:d,setViewPanelType:u,BookPanelView:h}=function(e,t,n,i,r){var o,s,l;let[c,d]=eC();let{NavTreeView:u}=(o=e,s=t,l=n,{NavTreeView:(0,a.jsx)(im,{book:o,player:s,activeNavs:l})}),{annotations:h,AnnotationView:p}=function(e,t,n,i){let r=e.item.uuid,{data:o,reload:s}=(0,ex.BH)(io.i,{uuid:r},{clearWhenReload:!1});(0,g.useEffect)(()=>(t.annotations.reload=s,()=>{t.annotations.reload=void 0}),[t.annotations,s]);let l=(0,g.useMemo)(()=>t.annotations.indexByPos(n,i??null),[t.annotations,n,i]),c=(0,g.useMemo)(()=>t.annotations.closestIndexByPos(n),[t.annotations,n]);(0,g.useMemo)(()=>null!==l?null==o?void 0:o.items.at(l):void 0,[o,l]);let d=(0,g.useMemo)(()=>null!==c?null==o?void 0:o.items.at(c):void 0,[o,c]);return{annotations:null==o?void 0:o.items,AnnotationView:(0,a.jsx)(id,{annotations:null==o?void 0:o.items,closestAnnotationIndex:c,activeAnnotationIndex:l,player:t}),closestAnnotation:d}}(e,t,i,r),{keywords:f,KeywordView:m}=function(e,t){let n=e.item.uuid,{data:i,reload:r}=(0,ex.BH)(iu.a,{uuid:n},{clearWhenReload:!1});return(0,g.useEffect)(()=>(t.keywords.reload=r,()=>{t.keywords.reload=void 0}),[t.keywords,r]),{keywords:null==i?void 0:i.items,KeywordView:(0,a.jsx)(ip,{keywords:null==i?void 0:i.items,player:t})}}(e,t),v=(0,g.useMemo)(()=>(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:["book-panel","none"===c?"hidden":""].join(" "),children:["nav"===c&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h3",{children:(0,j.t)("nav")}),u]}),"annotation"===c&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h3",{children:(0,j.t)("annotation")}),p]}),"keyword"===c&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h3",{children:(0,j.t)("keyword")}),m]})]}),(0,a.jsx)("div",{className:["book-panel-overlay","none"===c?"hidden":""].join(" "),onClick:()=>d("none")})]}),[p,m,u,d,c]);return(0,g.useMemo)(()=>({annotations:h,keywords:f,setViewPanelType:d,BookPanelView:v}),[h,f,d,v])}(o,t,i,s,r),{voice:p}=e_(o.item),[f]=eE(),[m]=eN(),[v]=eA(),[y]=eR(),[x]=eT(),[w]=eZ(),[C]=eO(),[S]=eF(),[P]=eW(),[L,_]=(0,g.useState)(ew.tq),{isFirstSection:E,isLastSection:A,isFirstParagraph:R,isLastParagraph:N}=function(e,t){let{annotations:n,keywords:i,isPersonReplace:r,speechSpeed:a,voice:o,autoNextSection:s,paragraphRepeat:l,pageList:c,fontSize:d,disabledVertical:u}=t;(0,g.useEffect)(()=>{e.states.syncUIState("annotations",n)},[e,n]),(0,g.useEffect)(()=>{e.states.syncUIState("keywords",i)},[e,i]),(0,g.useEffect)(()=>{e.states.syncUIState("isPersonReplace",r)},[e,r]),(0,g.useEffect)(()=>{e.states.syncUIState("speechSpeed",a)},[e,a]),(0,g.useEffect)(()=>{e.states.syncUIState("voice",o)},[e,o]),(0,g.useEffect)(()=>{e.states.syncUIState("autoNextSection",s)},[e,s]),(0,g.useEffect)(()=>{e.states.syncUIState("paragraphRepeat",l)},[e,l]),(0,g.useEffect)(()=>{e.states.syncUIState("pageList",c)},[e,c]),(0,g.useEffect)(()=>{e.states.syncUIState("fontSize",d)},[e,d]),(0,g.useEffect)(()=>{e.states.syncUIState("disabledVertical",u)},[e,u]);let h=(0,g.useMemo)(()=>e.isFirstSection,[e.isFirstSection]),p=(0,g.useMemo)(()=>e.isLastSection,[e.isLastSection]),f=(0,g.useMemo)(()=>e.isFirstParagraph,[e.isFirstParagraph]);return{isFirstSection:h,isLastSection:p,isFirstParagraph:f,isLastParagraph:(0,g.useMemo)(()=>e.isLastParagraph,[e.isLastParagraph])}}(t,{annotations:c,keywords:d,autoNextSection:f,isPersonReplace:m,speechSpeed:x,voice:p,paragraphRepeat:w,pageList:C,fontSize:S,disabledVertical:P}),T=(0,g.useMemo)(()=>{let e=[(0,a.jsx)(iy,{hotkey:"t",description:(0,j.t)("nav"),onClick:()=>{u(e=>"nav"===e?"none":"nav")},children:(0,a.jsx)(W,{icon:z.lCn})},"nav"),(0,a.jsx)(iy,{hotkey:"shift + ←",description:(0,j.t)("hotkey.prevSection"),disabled:E,onClick:()=>{t.prevSection().catch(console.error)},children:(0,a.jsx)(W,{icon:z.x$5})},"prev-section")];return!L&&e.push((0,a.jsx)(iy,{hotkey:"↑",description:(0,j.t)("hotkey.prevParagraph"),disabled:E&&R,onClick:()=>{t.prevParagraph().catch(console.error)},children:(0,a.jsx)(W,{icon:z.DYF})},"prev-paragraph")),e.push((0,a.jsx)(iy,{hotkey:"Space",description:(0,j.t)("hotkey.playToggle"),onClick:()=>{n?t.pause():t.start()},children:n?(0,a.jsx)(W,{icon:z.XQY}):(0,a.jsx)(W,{icon:z.zc})},"play")),!L&&e.push((0,a.jsx)(iy,{hotkey:"↓",description:(0,j.t)("hotkey.nextParagraph"),disabled:A&&N,onClick:()=>{t.nextParagraph().catch(console.error)},children:(0,a.jsx)(W,{icon:z.irl})},"next-paragraph")),e.push((0,a.jsx)(iy,{hotkey:"shift + →",description:(0,j.t)("hotkey.nextSection"),disabled:A,onClick:()=>{t.nextSection().catch(console.error)},children:(0,a.jsx)(W,{icon:z.cZy})},"next-section")),ew.tq&&e.push((0,a.jsx)(iv,{onClick:()=>{_(e=>!e)},children:L?(0,a.jsx)(W,{icon:z.K96}):(0,a.jsx)(W,{icon:z.Qbq})},"collapse")),(0,a.jsx)(b.ZP.Group,{children:e.filter(Boolean)})},[L,R,E,N,A,t,u,n]),I=(0,g.useMemo)(()=>{let e=[c&&c.length>0?(0,a.jsx)(iy,{hotkey:"m",description:(0,j.t)("annotation"),onClick:()=>{u(e=>"annotation"===e?"none":"annotation")},children:(0,a.jsx)(W,{icon:z.ZWV})},"annotations"):null,d&&d.length>0?(0,a.jsx)(iy,{description:(0,j.t)("keyword"),hotkey:"M",onClick:()=>{u(e=>"keyword"===e?"none":"keyword")},children:(0,a.jsx)(W,{icon:z.nfZ})},"keywords"):null];return(0,a.jsx)(b.ZP.Group,{children:e.filter(Boolean)})},[c,d,u]),M=(0,g.useMemo)(()=>{let e=[(0,a.jsx)(iy,{description:(0,j.t)("hotkey.annotationToggle"),hotkey:"b",onClick:()=>{t.annotations.toggle(s,r??null)},children:(0,a.jsx)(W,{icon:z.xVw})},"annotation"),(null==r?void 0:r.selectedText)?(0,a.jsx)(iy,{description:(0,j.t)("hotkey.keywordAdd"),hotkey:"B",onClick:()=>{t.keywords.add({pos:s,keyword:r.selectedText})},children:(0,a.jsx)(W,{icon:z.Elr})},"keyword"):null];return(0,a.jsx)(b.ZP.Group,{children:e.filter(Boolean)})},[t,s,r]),Z=(0,g.useMemo)(()=>(0,a.jsx)(ix,{player:t,started:n,stopTimerEnabled:v,stopTimerSeconds:y},"timer-remain-ui"),[t,n,v,y]),$=(0,g.useMemo)(()=>(0,a.jsx)(b.ZP,{shape:"circle",type:"text",title:(0,j.t)("tmpStore"),onClick:()=>{(0,e4.PF)(async()=>{let e=await nz.F.json({});l(`/books/added-successful/${e.uuid}`)})},icon:(0,a.jsx)(W,{icon:z.EdJ})}),[l]),O=(0,g.useMemo)(()=>(0,a.jsx)(a.Fragment,{children:Z}),[Z]),F=(0,g.useMemo)(()=>(0,a.jsx)(a.Fragment,{children:o.item.isTmp&&$}),[$,o.item.isTmp]);return nt({topRight:O,bottomLeft1:T,bottomLeft2:I,bottomRight1:M,bottomRight2:F,settings:(0,g.useMemo)(()=>(0,a.jsxs)(k.Z,{direction:"vertical",children:[(0,a.jsx)(ia,{player:t}),(0,a.jsx)(iw,{}),(0,a.jsx)(ik,{})]}),[t])}),{voice:p,speechSpeed:x,autoNextSection:f,isPersonReplace:m,BookPanelView:h}}({player:x,started:r,activeNavs:s,selection:p}),S=1/e.spines.length*100,P=t.section/e.spines.length*100,L=(0,g.useMemo)(()=>(0,a.jsxs)(eD,{flex:1,gap:4,style:{position:"relative"},children:[(0,a.jsx)(i7,{scrollPercent:{length:S,percent:P,progress:P},onClick:t=>{let n=Math.floor(t*e.spines.length);x.gotoSection(n,0)}}),c&&(0,a.jsx)("div",{style:{position:"absolute",zIndex:2,width:"100%",display:"flex",justifyContent:"center"},children:(0,a.jsx)(ec,{})}),(0,a.jsx)("iframe",{style:{padding:"0 4px"},title:"viewer",ref:i}),(0,a.jsx)(i7,{scrollPercent:u,onClick:e=>{x.iframeCtrler.scrollToPercent(e,!0)}})]}),[S,P,c,u,e.spines.length,x]);return(0,g.useEffect)(()=>{let e=()=>x.prevPage(1,!0),n=()=>x.nextPage(1,!0),i=()=>x.prevSection(),r=()=>x.nextSection(),a=()=>x.prevParagraph(),o=()=>x.nextParagraph();return m([["t",(0,j.t)("hotkey.navToggle"),()=>v(e=>"nav"===e?"none":"nav")],["m",(0,j.t)("hotkey.annotationsPanelToggle"),()=>v(e=>"annotation"===e?"none":"annotation")],["b",(0,j.t)("hotkey.annotationToggle"),()=>x.annotations.toggle(t,p??null)],[{shift:!0,key:"m"},(0,j.t)("hotkey.keywordPanelToggle"),()=>v(e=>"keyword"===e?"none":"keyword")],[{shift:!0,key:"b"},(0,j.t)("hotkey.keywordAdd"),()=>(null==p?void 0:p.selectedText)&&x.keywords.add({pos:t,keyword:p.selectedText})],["u",(0,j.t)("hotkey.goBack"),()=>y("../")],[" ",(0,j.t)("hotkey.playToggle"),()=>x.toggle()],[{shift:!0,key:"h"},(0,j.t)("hotkey.prevSection"),i],[{shift:!0,key:"l"},(0,j.t)("hotkey.nextSection"),r],[{shift:!0,key:"ArrowLeft"},(0,j.t)("hotkey.prevSection"),i],[{shift:!0,key:"ArrowRight"},(0,j.t)("hotkey.nextSection"),r],["h",(0,j.t)("hotkey.jumpPrevPage"),e],["l",(0,j.t)("hotkey.jumpNextPage"),n],["k",(0,j.t)("hotkey.prevParagraph"),a],["j",(0,j.t)("hotkey.nextParagraph"),o],["ArrowLeft",(0,j.t)("hotkey.jumpPrevPage"),e],["ArrowRight",(0,j.t)("hotkey.jumpNextPage"),n],["ArrowUp",(0,j.t)("hotkey.prevParagraph"),a],["ArrowDown",(0,j.t)("hotkey.nextParagraph"),o],["Home",(0,j.t)("hotkey.firstPage"),()=>x.gotoPage(0,!0)],["End",(0,j.t)("hotkey.lastPage"),()=>x.gotoPage(-1,!0)],["PageUp",(0,j.t)("hotkey.prevPage"),()=>x.prevPage(1,!1)],["PageDown",(0,j.t)("hotkey.nextPage"),()=>x.nextPage(1,!1)],[["g","g"],(0,j.t)("hotkey.firstParagraph"),()=>x.gotoParagraph(0)],[{shift:!0,key:"G"},(0,j.t)("hotkey.lastParagraph"),()=>x.gotoParagraph(-1)]])},[m,e,y,x,t,p,v]),(0,t7.z)(()=>{x.pause()}),{activeNavs:s,BookPanelView:C,MainContent:L}}(),r=function(){let e=(0,g.useId)(),[,t]=(0,f.KO)(eh);return(0,g.useEffect)(()=>()=>{t(t=>t.filter(t=>e!==t.id))},[e,t]),(0,g.useCallback)(n=>{t(t=>[{title:n,id:e},...t])},[e,t])}(),o=(0,g.useMemo)(()=>null==i?void 0:i.at(-1),[i]);return(0,g.useEffect)(()=>{let t=`${e.item.name}`;o&&(t=`${o.label} - ${t}`),r(t)},[e,o,r]),(0,a.jsxs)(eD,{dir:"row",className:nS,children:[t,n]})}function rn(e){let{uuid:t}=e,{error:n,pos:i,setPos:r,book:o,reload:s}=re(t),[l,c]=(0,f.KO)(nj);return((0,g.useEffect)(()=>{o&&i?c({uuid:o.item.uuid,book:o,pos:i,setPos:r,reload:s}):c(null)},[o,i,s,c,r]),n)?(0,a.jsx)(ez,{title:"book"}):o&&i&&l?(0,a.jsx)(rt,{}):(0,a.jsx)(ec,{})}function ri(){let{uuid:e}=(0,em.UO)();return e?(0,a.jsx)(rn,{uuid:e}):(0,a.jsx)(ez,{title:"book"})}function rr(){return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(tL,{}),(0,a.jsxs)(em.Z5,{children:[(0,a.jsx)(em.AW,{path:"/",element:(0,a.jsx)(nx,{})}),(0,a.jsx)(em.AW,{path:"/add",element:(0,a.jsx)(tk,{})}),(0,a.jsx)(em.AW,{path:"/added-successful/:uuid",element:(0,a.jsx)(eK,{})}),(0,a.jsx)(em.AW,{path:"/view/:uuid",element:(0,a.jsx)(ri,{})}),(0,a.jsx)(em.AW,{path:"*",element:(0,a.jsx)(ez,{title:"page"})})]})]})}var ra=n("7497"),ro=n("3448");function rs(e){return!!rl(e).length}function rl(e){return[...e.dataTransfer.items].filter(e=>"file"===e.kind||"string"===e.kind&&"text/uri-list"===e.type||!1)}function rc(e){let{children:t}=e,[n,i]=(0,g.useState)(0),[r,o]=(0,g.useState)(null),[d,u]=(0,g.useState)(!1),[h,p]=(0,g.useState)(!1),f=(0,em.s0)();return((0,g.useEffect)(()=>{(0,e4.PF)(async()=>{let e,t,n;if(r){if(!r.langCode){u(!0);return}switch(p(!0),r.type){case"file-epub":e=r.buffer;break;case"file-html":n=r.html;break;case"file-text":e=await (0,eX.p)(r.content,r.title,r.langCode);break;case"url":t=r.url}e?await l.Z.json({bufferBase64:(0,e0.sM)(e),langCode:r.langCode,name:r.title,isTmp:!0}):t?await s.f.json({url:t,langCode:r.langCode,name:r.title,isTmp:!0}):n&&await tt.t.json({html:n,langCode:r.langCode,name:r.title,isTmp:!0}),p(!1),o(null),f(`/books/view/${y.n1}`)}})},[r,f]),h)?(0,a.jsx)(el,{}):(0,a.jsxs)(eD,{style:{width:"100%",height:"100%",position:"relative"},gap:0,onDragEnter:e=>{rs(e)&&i(e=>e+1)},onDragLeave:e=>{rs(e)&&i(e=>e-1)},onDragOver:e=>{(0,P.lJ)(e)},onDrop:e=>{e.preventDefault(),(0,e4.PF)(async()=>{i(0),p(!0);try{for(let t of rl(e))if("file"===t.kind){let e=t.getAsFile();if(!e)continue;let n=function(e){let t=eV().extname(e.name);return eV().basename(e.name,t)}(e);if(e3(e)){let t=await e.arrayBuffer(),i=await eG.P.read(t);if(!i)continue;let r=(0,eY.Wx)(i.language);return o({buffer:t,title:i.title??n,type:"file-epub",langCode:r})}if(e1(e)){let t=await e.text();return o({content:t,title:n,type:"file-text"})}else if(e2(e)){let t=await e.text(),n=await (0,eQ.Yy)(t);return o({html:t,title:n,type:"file-html"})}}else if("string"===t.kind){let e=await new Promise(e=>{t.getAsString(e)});if(!(0,iT.C)(e))continue;let n=await c.z.json({url:e});return o({type:"url",url:e,title:n.title,langCode:n.lang})}}finally{p(!1)}})},children:[!!n&&(0,a.jsx)(eD,{style:{width:"100%",height:"100%",position:"absolute",justifyContent:"center",alignItems:"center",zIndex:1,backgroundColor:"var(--main-bg)"},children:(0,j.t)("prompt.dropHere")}),d&&(0,a.jsxs)("div",{style:{width:"100%",height:"100%",position:"absolute",zIndex:2,backgroundColor:"var(--main-bg)",padding:40},children:[(0,a.jsxs)(eD,{dir:"row",children:[(0,a.jsx)(e6.Z,{style:{flex:1},children:(0,j.t)("prompt.selectLanguage")}),(0,a.jsx)(b.ZP,{shape:"circle",type:"text",onClick:()=>{o(null),u(!1)},icon:(0,a.jsx)(W,{icon:z.YIN})})]}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("language"),name:"langCode",required:!0,children:(0,a.jsx)(te,{onChange:e=>{r&&e&&(o({...r,langCode:e}),u(!1))}})})]}),t]})}let rd="appBar-h5IaFg",ru=e=>{let{children:t}=e,n=ef()??eu,[i]=(0,f.KO)(ne),[r,o]=(0,g.useState)(!1),s=(0,em.s0)(),[l,c]=(0,g.useState)(!1),d=(0,a.jsxs)(eD,{className:[rd,"top"].join(" "),dir:"row",style:{justifyContent:"end"},gap:4,children:[(0,a.jsxs)(eD,{dir:"row",style:{overflow:"hidden",alignItems:"center"},gap:4,children:[(0,a.jsx)(eB,{to:"/books",children:e=>(0,a.jsx)(b.ZP,{type:"link",size:"small",href:e,children:(0,a.jsx)(W,{size:"2xl",icon:z.FL8})})}),(0,a.jsx)(e6.Z,{style:{flex:1,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",cursor:"pointer"},title:n,onClick:()=>{c(!0)},children:n}),(0,a.jsx)(w.Z,{title:(0,j.t)("bookName"),open:l,footer:!1,onCancel:()=>c(!1),children:(0,a.jsx)(e6.Z,{children:n})})]}),(0,a.jsx)(eD,{dir:"row",style:{alignItems:"center",flex:1},gap:4,children:i.topLeft}),(0,a.jsx)(eD,{dir:"row",style:{alignItems:"center"},gap:4,children:i.topRight})]}),u=(0,a.jsxs)(eD,{className:[rd,"bottom"].join(" "),dir:"row",style:{flexWrap:"wrap",justifyContent:"end"},gap:4,children:[(0,a.jsxs)(eD,{dir:"row",style:{alignItems:"center",flex:1},gap:4,children:[i.bottomLeft1,i.bottomLeft2]}),(0,a.jsxs)(eD,{dir:"row",style:{alignItems:"center"},gap:4,children:[i.bottomRight1,i.bottomRight2,(0,a.jsxs)(eD,{dir:"row",style:{alignItems:"center"},gap:4,children:[(0,a.jsx)(b.ZP,{shape:"circle",type:"text",onClick:()=>{o(e=>!e)},icon:(0,a.jsx)(W,{icon:z.gr5})}),(0,a.jsx)(n9.Z,{placement:"right",open:r,onClose:()=>o(!1),title:(0,j.t)("setting.title"),forceRender:!0,children:(0,a.jsxs)(eD,{style:{flex:1,minWidth:300,gap:6},children:[(0,a.jsxs)(eD,{style:{flex:1,gap:6},children:[i.settings,(0,a.jsx)(n8,{})]}),(0,a.jsx)(eD,{children:"server"===ro.O.appMode&&(0,a.jsx)(nq,{children:(0,a.jsx)(b.ZP,{type:"primary",block:!0,onClick:()=>{ra.Z.json().then(()=>{s("/")}).catch(console.error)},children:(0,j.t)("logout")})})})]})})]})]})]});return(0,a.jsx)(rc,{children:(0,a.jsxs)(eD,{style:{width:"100%",height:"100%",alignContent:"space-around",justifyContent:"space-around"},children:[d,(0,a.jsx)("div",{style:{flex:1,padding:8,overflow:"hidden",overflowY:"auto"},children:t}),u]})})};var rh=n("7071");function rp(){let e=(0,em.s0)(),[t,n]=(0,g.useState)(),{data:i}=(0,ex.BH)(ey.O,null),[r]=eq.Z.useForm();return(0,g.useEffect)(()=>{i&&i.info&&e("/")},[e,i]),(0,a.jsx)(a.Fragment,{children:(0,a.jsxs)("div",{style:{maxWidth:300,margin:"50px auto 0"},children:[(0,a.jsx)("h2",{children:"Auditory Reader"}),(0,a.jsx)("h4",{children:(0,j.t)("login")}),(0,a.jsxs)(eq.Z,{form:r,initialValues:{account:"",password:""},onFinish:t=>{rh.t.json(t).then(async t=>{t.ok?e("/"):n((0,j.t)("error.login"))}).catch(console.error)},children:[(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("account"),name:"account",rules:[{required:!0}],children:(0,a.jsx)(eJ.Z,{placeholder:(0,j.t)("prompt.inputAccount")})}),(0,a.jsx)(eq.Z.Item,{label:(0,j.t)("password"),name:"password",rules:[{required:!0}],validateStatus:t?"error":void 0,help:t,children:(0,a.jsx)(eJ.Z,{type:"password",placeholder:(0,j.t)("prompt.inputPassword")})}),(0,a.jsx)(eq.Z.Item,{children:(0,a.jsx)(b.ZP,{type:"primary",block:!0,htmlType:"submit",children:(0,j.t)("submit")})})]})]})})}function rf(){let{data:e}=(0,ex.BH)(ey.O,null),t=(0,em.s0)();return(0,g.useEffect)(()=>{e&&!e.info&&t("/login")},[t,e]),(0,a.jsx)(ru,{children:(0,a.jsx)(rr,{})})}function rg(){let[,e]=eT(),[,t]=eF(),{addHotkeys:n}=M(),{openHint:i}=function(){let[,e]=(0,f.KO)(q),t=(0,g.useCallback)(function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};clearTimeout(r);let i=n.timeout??3;e(t),r=setTimeout(()=>{e(null)},1e3*i)},[e]);return(0,g.useMemo)(()=>({openHint:t}),[t])}();return(0,g.useEffect)(()=>n([["[",(0,j.t)("hotkey.speedDown"),()=>e(e=>{let t=(10*e-1)/10;return i(`${(0,j.t)("speed")}: ${t}`),t})],["]",(0,j.t)("hotkey.speedUp"),()=>e(e=>{let t=(10*e+1)/10;return i(`${(0,j.t)("speed")}: ${t}`),t})],["-",(0,j.t)("hotkey.fontSizeDown"),()=>t(e=>{let t=e-1;return i(`${(0,j.t)("fontSize")}: ${t}`),t})],["=",(0,j.t)("hotkey.fontSizeUp"),()=>t(e=>{let t=e+1;return i(`${(0,j.t)("fontSize")}: ${t}`),t})],["r",(0,j.t)("hotkey.reload"),()=>{location.reload()}]]),[n,i,t,e]),(0,a.jsxs)(em.Z5,{children:[(0,a.jsx)(em.AW,{path:"/login",element:(0,a.jsx)(rp,{})}),(0,a.jsx)(em.AW,{path:"/books/*",element:(0,a.jsx)(rf,{})}),(0,a.jsx)(em.AW,{path:"/",element:(0,a.jsx)(em.Fg,{to:"/books"})}),(0,a.jsx)(em.AW,{path:"*",element:(0,a.jsx)(ru,{children:(0,a.jsx)(ez,{title:"page"})})})]})}function rm(){return(0,a.jsx)(ev.UT,{children:(0,a.jsx)(rg,{})})}async function rv(){if("serviceWorker"in navigator)for(let e of(await navigator.serviceWorker.getRegistrations()))await e.unregister()}async function ry(){if("server"===ro.O.appMode)return await rv(),"successful";if(!("serviceWorker"in navigator))return console.log("service-worker: unsupported"),"unsupported";await rv();let e=ro.O.appPublicRoot,t=await navigator.serviceWorker.register(new URL(n.p+n.u("762"),n.b),Object.assign({},{scope:e},{type:void 0}));return(await navigator.serviceWorker.ready,t.active)?(console.log("service-worker: registered"),"successful"):"failed"}function rx(){var e;let t=nN(),[n,i]=(0,g.useState)(!1);return(0,g.useEffect)(()=>{ry().then(e=>{"unsupported"===e?i("Service worker is unsupported"):"failed"===e?i("Service worker load failed"):i(!0)}).catch(e=>{i("Service worker load failed"),console.error(e)})},[]),(0,g.useEffect)(()=>{"dark"===t?document.documentElement.classList.add(y.JK):document.documentElement.classList.remove(y.JK)},[t]),e=iI,(0,ed.n)(()=>{let t=document.createElement("style");t.innerHTML=e;let n=document.head.querySelector("title");n&&n.nextSibling?document.head.insertBefore(t,n.nextSibling):document.head.prepend(t)}),(0,a.jsxs)(a.Fragment,{children:[!0===n&&(0,a.jsx)(rm,{}),!1===n&&(0,a.jsx)(el,{}),"string"==typeof n&&(0,a.jsx)(p.Z,{type:"error",message:n})]})}function rw(){return(0,a.jsx)(nT,{children:(0,a.jsxs)(m.W,{backend:v.PD,children:[(0,a.jsx)(rx,{}),(0,a.jsx)(G.JB,{}),(0,a.jsx)(G.x1,{}),(0,a.jsx)(J,{}),(0,a.jsx)(eo,{}),(0,a.jsx)(H,{}),(0,a.jsx)(eg,{}),(0,a.jsx)($,{})]})})}j.ZP.init({resources:{en:{translation:{setting:{title:"Settings",autoNextSection:"Auto Next Section",timer:"Timer (Minute)",personReplace:"中文人称替换",speed:"$t(speed)",userColorScheme:"Color Scheme",paragraphRepeat:"Paragraph Repeat",disabledVertical:"Disable Vertical Direction",pageList:"Split Page",pageListType:{none:"None",auto:"Auto",single:"Single",double:"Double"},fontSize:"Font Size"},hotkey:{title:"Hotkeys",escape:"Quit / Cancel",ok:"Ok",speedUp:"Increase speed",speedDown:"Decrease speed",fontSizeUp:"Increase font size",fontSizeDown:"Decrease font size",reload:"Reload",helper:"Show the hotkeys",speakBookName:"Speak selected book name",playToggle:"Play / Pause",navToggle:"Toggle table contents panel",prevNav:"Select previous nav",nextNav:"Select next nav",gotoNav:"Go to selected nav",speakNav:"Speak selected nav",annotationsPanelToggle:"Toggle annotations panel",annotationToggle:"Add / Remove annotation for current paragraph",annotationNote:"Note current annotation",annotationRemoveSelected:"Remove selected annotation",prevAnnotation:"Select previous annotation",nextAnnotation:"Select next annotation",gotoAnnotation:"Go to selected annotation",speakAnnotation:"Speak selected annotation",keywordPanelToggle:"Toggle keywords panel",keywordAdd:"Add current selected keyword",keywordNote:"Note current keyword",keywordRemoveSelected:"Remove selected keyword",prevKeyword:"Select previous keyword",nextKeyword:"Select next keyword",gotoKeyword:"Go to selected keyword",speakKeyword:"Speak selected keyword",goBack:"Go back books index",prevSection:"Go to previous book section",nextSection:"Go to next book section",firstPage:"Scroll to first book page",lastPage:"Scroll to last book page",jumpPrevPage:"Go to previous book page",jumpNextPage:"Go to next book page",prevPage:"Scroll to previous book page",nextPage:"Scroll to next book page",firstParagraph:"Go to first paragraph",lastParagraph:"Go to last paragraph",prevParagraph:"Go to previous paragraph",nextParagraph:"Go to next paragraph",prevSearchResult:"Go to previous search result",nextSearchResult:"Go to next search result",gotoSearchResult:"Go to selected search result",goPrev:"Go to previous",goNext:"Go to next",goTop:"Go to the top",goBottom:"Move selection to bottom",goPagePrev:"Go to previous page",goPageNext:"Go to next page",goPageFirst:"Go to first page",goPageLast:"Go to last page",goMovePrev:"Move selection to previous",goMoveNext:"Move selection to next",goMoveTop:"Move selection to top",listArchive:"Toggle display of list archived books",listFavorite:"Toggle display of list favorited books",archive:"Toggle archive",favorite:"Toggle favorite",search:"Focus to search input",sortOrder:"Select sort order",edit:"Edit current selection",select:"Toggle select",selectShift:"Mark from last select to current as selected",selectAll:"Toggle select all",open:"Open current selection",editBook:"Edit book",remove:"Remove current selection",pinchUp:"Move up",pinchDown:"Move down",pinchLeft:"Move left",pinchRight:"Move right",pinchZoomOut:"Zoom out",pinchZoomIn:"Zoom in",pinchReset:"Reset zoom"},confirm:{ok:"Ok",cancel:"Cancel",openLink:"$t(open) $t(link)?"},desc:{bookAddedSuccessful:"Successfully added a new book",annotationUpdated:"Updated a $t(annotation)",annotationDeleted:"Deleted a $t(annotation)",annotationNoSupported:"No support $t(annotation) type",annotationsEmpty:"$t(annotation)s empty",keywordUpdated:"Updated a $t(keyword)",keywordDeleted:"Deleted a $t(keyword)",keywordNoSupported:"No support $t(keyword) type",keywordsEmpty:"$t(keywords) empty",navEmpty:"$t(nav) empty"},prompt:{inputBookName:"Please input $t(bookName).",selectLanguage:"Please select the $t(language).",inputAccount:"Please input your $t(account).",inputPassword:"Please input your $t(password).",dropHere:"drop .epub file、.txt file、text or URL to here.",dropHereToRemove:"Drop here to remove it.",annotationRemoveConfirm:"Remove this $t(annotation) with $t(note)?",keywordRemoveConfirm:"Remove this $t(keyword) with $t(note)?",uploadBook:"Support .epub and .txt.",importBooks:"Import .zip file.",noBooks:"No books here, Add your first book.",noSearchMatches:"No search matches"},sortOrder:{label:"Sort order",item:{default:"Default",reverse:"Reverse",name:"Name",nameReverse:"Name reverse"}},error:{login:"$t(account) or $t(password) error"},title:"Title",note:"Note",speed:"Speed",fontSize:"Font Size",view:"View",account:"Account",password:"Password",login:"Login",logout:"Logout",submit:"Submit",select:"Select",add:"Add",tmpStore:"Store temporary file",top:"Top",edit:"Edit",editBook:"Edit book",remove:"Remove",update:"Update",export:"Export",exportSelected:"Export selected",exportAll:"Export all",import:"Import",bookName:"Book name",favorite:"Favorite",archive:"Archive",unarchive:"Unarchive",progress:"Progress",search:"Search",cover:"Cover",nav:"Table contents",annotation:"Annotation",keyword:"Keyword",alias:"Alias",open:"open",url:"URL",extractUrlInfo:"Extract URL info",bookContent:"Book content",language:"Language",empty:"Empty",file:"File",text:"Text",system:"System",dark:"Dark",light:"Light",cancel:"Cancel",all:"All"}},zh:{translation:{setting:{title:"设置",autoNextSection:"自动下一章节",timer:"计时器 (分钟)",personReplace:"中文人称替换",speed:"$t(speed)",userColorScheme:"颜色主题",paragraphRepeat:"段落重复",disabledVertical:"禁用垂直方向",pageList:"分页",pageListType:{none:"无",auto:"自动",single:"单页",double:"双页"},fontSize:"字体大小"},hotkey:{title:"快捷键",escape:"退出 / 取消",ok:"确定",speedUp:"提高速度",speedDown:"降低速度",fontSizeUp:"提高字体大小",fontSizeDown:"降低字体大小",reload:"刷新页面",helper:"显示快捷键",speakBookName:"朗读选择的书名",playToggle:"播放 / 暂停",navToggle:"开关显示导航",prevNav:"选择上一个导航",nextNav:"选择下一个导航",gotoNav:"跳转到选择的导航",speakNav:"朗读选择的导航",annotationsPanelToggle:"开关显示注解",annotationToggle:"添加或删除当前段落的注解",annotationNote:"添加当前段落的注解的备注",annotationRemoveSelected:"删除选择的注解",prevAnnotation:"选择上一个注解",nextAnnotation:"选择下一个注解",gotoAnnotation:"跳转到选择的注解",speakAnnotation:"朗读选择的注解",keywordPanelToggle:"开关显示关键字",keywordAdd:"添加当前选择关键字",keywordNote:"添加当前关键字的备注",keywordRemoveSelected:"删除选择的关键字",prevKeyword:"选择上一个关键字",nextKeyword:"选择下一个关键字",gotoKeyword:"跳转到选择的关键字",speakKeyword:"朗读选择的关键字",goBack:"回到书本目录",prevSection:"跳到本书上一部份",nextSection:"跳到本书下一部份",firstPage:"滚动到本书第一页",lastPage:"滚动到本书最后一页",jumpPrevPage:"跳到本书上一页面",jumpNextPage:"跳到本书下一页面",prevPage:"滚动到本书上一页面",nextPage:"滚动到本书下一页面",firstParagraph:"跳到本书第一段落",lastParagraph:"跳到本书最后一段落",prevParagraph:"跳到本书上一段落",nextParagraph:"跳到本书下一段落",prevSearchResult:"选择上一个搜索结果",nextSearchResult:"选择下一个搜索结果",gotoSearchResult:"跳转到选择的搜索结果",goPrev:"去到上一个",goNext:"去到下一个",goTop:"去到顶部",goBottom:"去到底部",goPagePrev:"去到上一页面",goPageNext:"去到下一页面",goPageFirst:"去到第一页",goPageLast:"去到最后一页",goMovePrev:"挪到上一个",goMoveNext:"挪到下一个",goMoveTop:"挪到顶部",listArchive:"开关显示存档列表",listFavorite:"开关显示喜欢列表",archive:"开关存档",favorite:"开关喜欢",search:"聚焦到搜索输入框",sortOrder:"选择排序",edit:"编辑当前选择",select:"开关选择",selectShift:"把最后一次选择至当位置的标记为选择",selectAll:"开关选择全部",open:"打开当前选择",editBook:"编辑本书",remove:"删除当前选择",pinchUp:"上移",pinchDown:"下移",pinchLeft:"左移",pinchRight:"右移",pinchZoomOut:"缩小",pinchZoomIn:"放大",pinchReset:"重置"},confirm:{ok:"确定",cancel:"取消",openLink:"$t(open)$t(link)?"},desc:{bookAddedSuccessful:"成功添加了一本新书",annotationUpdated:"更新了一个$t(annotation)",annotationDeleted:"删除了一个$t(annotation)",annotationNoSupported:"不支持的$t(annotation)类型",annotationsEmpty:"$t(annotation)为空",keywordUpdated:"更新了一个$t(keyword)",keywordDeleted:"删除了一个$t(keyword)",keywordNoSupported:"No support $t(keyword) type",keywordsEmpty:"$t(keyword)为空",navEmpty:"$t(nav)为空"},prompt:{inputBookName:"请输入$t(bookName)",selectLanguage:"请选择$t(language)",inputAccount:"请输入$t(account)",inputPassword:"请输入$t(password)",dropHere:"拖动 .epub 文件、.txt 文件、文本或 URL 到这里。",dropHereToRemove:"拖放到这里删除。",annotationRemoveConfirm:"删除此$t(annotation)和$t(note)吗?",keywordRemoveConfirm:"删除此$t(keyword)吗?",uploadBook:"支持 .epub 和 .txt",importBooks:"导入 .zip 文件",noBooks:"这里没有书籍，添加你的第一本书吧。",noSearchMatches:"没有找到匹配项"},sortOrder:{label:"排序",item:{default:"默认",reverse:"反序",name:"名称",nameReverse:"名称反序"}},error:{login:"$t(account)或$t(password)错误"},title:"标题",note:"备注",speed:"速度",fontSize:"字体大小",view:"浏览",account:"帐号",password:"密码",login:"登录",logout:"登出",submit:"提交",select:"选择",add:"添加",tmpStore:"存储临时文件",top:"置顶",edit:"编辑",editBook:"编辑本书",remove:"删除",update:"更新",export:"导出",exportSelected:"导出选中的",exportAll:"导出全部",import:"导入",bookName:"书名",favorite:"喜欢",archive:"存档",unarchive:"取消存档",progress:"进度",search:"搜索",cover:"封面",nav:"导航",annotation:"注解",keyword:"关键词",alias:"别名",open:"打开",url:"URL",extractUrlInfo:"提取URL信息",bookContent:"文本内容",language:"语言",empty:"空",file:"文件",text:"文本",system:"系统",dark:"暗色",light:"亮色",cancel:"取消",all:"全部"}}},lng:n.g.navigator.languages.at(0)??"en"}).catch(console.error),o.createRoot(document.getElementById("root")).render((0,a.jsx)(function(){return(0,a.jsx)(f.zt,{store:E.c,children:(0,a.jsx)(rw,{})})},{}))},2854:function(e,t,n){n.d(t,{c:function(){return i}});let i=(0,n(4601).MT)()}},t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var a=t[i]={exports:{}};return e[i].call(a.exports,a,a.exports,n),a.exports}n.m=e,n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,{a:t}),t},(()=>{var e,t=Object.getPrototypeOf?function(e){return Object.getPrototypeOf(e)}:function(e){return e.__proto__};n.t=function(i,r){if(1&r&&(i=this(i)),8&r||"object"==typeof i&&i&&(4&r&&i.__esModule||16&r&&"function"==typeof i.then))return i;var a=Object.create(null);n.r(a);var o={};e=e||[null,t({}),t([]),t(t)];for(var s=2&r&&i;"object"==typeof s&&!~e.indexOf(s);s=t(s))Object.getOwnPropertyNames(s).forEach(function(e){o[e]=function(){return i[e]}});return o.default=function(){return i},n.d(a,o),a}})(),n.d=function(e,t){for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.u=function(e){return""+e+".9859d853.js"},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e=[];n.O=function(t,i,r,a){if(i){a=a||0;for(var o=e.length;o>0&&e[o-1][2]>a;o--)e[o]=e[o-1];e[o]=[i,r,a];return}for(var s=1/0,o=0;o<e.length;o++){for(var i=e[o][0],r=e[o][1],a=e[o][2],l=!0,c=0;c<i.length;c++)(!1&a||s>=a)&&Object.keys(n.O).every(function(e){return n.O[e](i[c])})?i.splice(c--,1):(l=!1,a<s&&(s=a));if(l){e.splice(o--,1);var d=r();void 0!==d&&(t=d)}}return t}})(),n.p="/auditory-reader/",n.rv=function(){return"1.0.8"},(()=>{n.b=document.baseURI||self.location.href;var e={980:0};n.O.j=function(t){return 0===e[t]};var t=function(t,i){var r=i[0],a=i[1],o=i[2],s,l,c=0;if(r.some(function(t){return 0!==e[t]})){for(s in a)n.o(a,s)&&(n.m[s]=a[s]);if(o)var d=o(n)}for(t&&t(i);c<r.length;c++)l=r[c],n.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return n.O(d)},i=self.webpackChunkauditory_reader=self.webpackChunkauditory_reader||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})(),n.ruid="bundler=rspack@1.0.8";var i=n.O(void 0,["361","118","434","748","949"],function(){return n("4253")});i=n.O(i)})();