"use strict";(self.webpackChunkauditory_reader=self.webpackChunkauditory_reader||[]).push([["617"],{2218:function(t,e,i){i.d(e,{v:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/annotations-delete").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body,o=await n.E.entity(i.account,a.uuid);return await o.annotationsDelete(a.annotationUuids),{ok:!0}})},8954:function(t,e,i){i.d(e,{I:function(){return o}});var n=i(4933),a=i(9418);let o=new(i(6504)).p("books/annotations-upsert").routeLogined(async t=>{let{req:e,userInfo:i}=t,o=await e.body,s=await a.E.entity(i.account,o.uuid),r=o.annotations.map(t=>(t.uuid=t.uuid||(0,n.Z)(),t));return{ok:!0,annotations:await s.annotationsUpsert(r)}})},6903:function(t,e,i){i.d(e,{i:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/annotations").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body;return(await n.E.entity(i.account,a.uuid)).annotationsGet()})},5525:function(t,e,i){i.d(e,{f:()=>y});var n=i("2479"),a=i("4933"),o=i("9418"),s=i("6340"),r=i("3062"),l=i("3742"),u=i("4210"),d=i.n(u),c=i("107");class h{genContainer(){this.zip.file("META-INF/container.xml",(0,l.Z)`
        <?xml version="1.0"?>
        <container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
          <rootfiles>
            <rootfile full-path="content.opf" media-type="application/oebps-package+xml"/>
          </rootfiles>
        </container>
      `)}genContentOpf(){this.zip.file("content.opf",(0,l.Z)`
        <package xmlns="http://www.idpf.org/2007/opf" unique-identifier="${this.options.uuid}" version="3.0" >
          <metadata
            xmlns:dc="http://purl.org/dc/elements/1.1/"
            xmlns:dcterms="http://purl.org/dc/terms/"
            xmlns:opf="http://www.idpf.org/2007/opf"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <dc:title>${this.options.title}</dc:title>
            <dc:creator>unknown</dc:creator>
            <dc:language>${this.options.lang}</dc:language>
            <dc:date>${this.options.date.toISOString()}</dc:date>
            <dc:publisher>${this.options.publisher}</dc:publisher>
          </metadata>
          <manifest>
            <item href="page-styles.css" id="page-styles" media-type="text/css"/>
            <item href="stylesheet.css" id="stylesheet" media-type="text/css"/>
            <item href="text/content.html" id="html-content" media-type="application/xhtml+xml"/>
          </manifest>
          <spine>
            <itemref idref="html-content"/>
          </spine>
        </package>
      `)}genStyle(){this.zip.file("page-styles.css",(0,l.Z)`
        @page {
          margin-bottom: 5pt;
          margin-top: 5pt
        }
      `),this.zip.file("stylesheet.css",(0,l.Z)`
        rt {
          user-select: none;
        }
        img {
          max-width: 100%;
        }
      `)}genContentHTML(){this.zip.file("text/content.html",(0,l.Z)`
        <?xml version='1.0' encoding='utf-8'?>
        <html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="${this.options.lang}">
          <head>
            <title>${this.options.title}</title>
            <link href="../stylesheet.css" rel="stylesheet" type="text/css"/>
            <link href="../page-styles.css" rel="stylesheet" type="text/css"/>
            <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
          </head>
          <body>
            ${this.options.sourceURL?`<p class="${c.Xp}"><a target="_blank" href="${this.options.sourceURL}">
                  ${this.options.sourceURL}
                </a></p>`:""}
            <h1>${this.options.title}</h1>
            ${this.options.htmlContent}
          </body>
        </html>
      `)}async gen(){return this.zip.file("mimetype","application/epub+zip"),this.genContainer(),this.genContentOpf(),this.genStyle(),this.genContentHTML(),await this.zip.generateAsync({type:"arraybuffer"})}constructor(t){(0,r._)(this,"options",void 0),(0,r._)(this,"zip",void 0),this.options=t,this.zip=new(d())}}var p=i("6504"),w=i("5224"),f=i("9273");let y=new p.p("books/create-by-url").routeLogined(async t=>{let{req:e,userInfo:i}=t,r=await e.body,l=(0,a.Z)(),u=new Date,d={uuid:l,name:r.name,type:"epub",langCode:r.langCode,isFavorited:!1,isArchived:!1,createdAt:u,updatedAt:u,isTmp:r.isTmp??!1},c=(await (0,f.Z)(r.url)).doc,p=new n.Readability(c).parse();if(!p)throw Error("parse article error");let y=await (0,w.rV)(p.content),m=y.doc;"server"===s.O.appMode&&await (0,w.eP)(r.url,m.body);let g=new y.view.XMLSerializer().serializeToString(m.body),b=await new h({title:r.name,date:u,htmlContent:g,lang:r.langCode,publisher:r.url,sourceURL:r.url,uuid:l}).gen();return await o.E.list(i.account).add(d,b)})},6444:function(t,e,i){i.d(e,{Z:function(){return r}});var n=i(4933),a=i(9418),o=i(6504),s=i(9883);let r=new o.p("books/create").routeLogined(async t=>{let{req:e,userInfo:i}=t,o=await e.body,r=(0,s.RG)(o.bufferBase64),l={uuid:(0,n.Z)(),name:o.name,type:o.type,langCode:o.langCode,isFavorited:!1,isArchived:!1,createdAt:new Date,updatedAt:new Date,isTmp:o.isTmp??!1};return await a.E.list(i.account).add(l,r)})},7864:function(t,e,i){i.d(e,{c:function(){return s}});var n=i(9418),a=i(6504),o=i(6689);let s=new a.p("books/download",{method:"get"}).routeLogined(async t=>{let{req:e,res:i,userInfo:a}=t,s=e.searchParams.get("uuid");if(!s)throw new o.xx("uuid parameter required");let r=await n.E.entity(a.account,s),{contentType:l,buffer:u,filename:d}=await r.download();return i.header("Content-Type",l),i.header("Content-Disposition",`attachment; filename="${encodeURI(d)}"`),u})},5683:function(t,e,i){i.d(e,{z:function(){return r}});var n=i(2479),a=i(3098),o=i(6504),s=i(9273);let r=new o.p("books/fetch-url-info").routeLogined(async t=>{var e,i;let o,r,{req:l}=t,u=await l.body,d=(await (0,s.Z)(u.url)).doc,c=new n.Readability(d).parse();if(c)o=c.title,r=c.lang;else{let t=d.querySelector("article h1")??d.querySelector("h1")??d.querySelector("meta[name=og\\:title]")??d.querySelector("head>title");o=(null==t?void 0:null===(i=t.textContent)||void 0===i?void 0:i.trim())??""}return r??(r=(null===(e=d.activeElement)||void 0===e?void 0:e.getAttribute("lang"))??void 0),{title:o,lang:(0,a.Wx)(r)}})},3918:function(t,e,i){i.d(e,{p:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/keywords-delete").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body,o=await n.E.entity(i.account,a.uuid);return await o.keywordsDelete(a.keywordUuids),{ok:!0}})},945:function(t,e,i){i.d(e,{L:function(){return o}});var n=i(4933),a=i(9418);let o=new(i(6504)).p("books/keywords-upsert").routeLogined(async t=>{let{req:e,userInfo:i}=t,o=await e.body,s=await a.E.entity(i.account,o.uuid),r=o.keywords.map(t=>(t.uuid=t.uuid||(0,n.Z)(),t));return{ok:!0,keywords:await s.keywordsUpsert(r)}})},6049:function(t,e,i){i.d(e,{a:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/keywords").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body;return(await n.E.entity(i.account,a.uuid)).keywordsGet()})},5719:function(t,e,i){i.d(e,{y:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/move-after").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body,o=n.E.list(i.account);return await o.moveAfter(a.uuid,a.afterUuid),{ok:!0}})},4790:function(t,e,i){i.d(e,{s:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/move-top").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body,o=n.E.list(i.account);return await o.moveTop(a.uuid),{ok:!0}})},9878:function(t,e,i){i.d(e,{N:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/page").routeLogined(async t=>{let{req:e,userInfo:i}=t,{page:a,filter:o}=await e.body,s=await n.E.list(i.account).page(o,a);return{items:s.items,current:s.page,pageCount:s.pageCount,count:s.count}})},4196:function(t,e,i){i.d(e,{u:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/position-sync").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body,o=await n.E.entity(i.account,a.uuid);return await o.posSet(a.pos),{ok:!0}})},5627:function(t,e,i){i.d(e,{C:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/position").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body,o=await n.E.entity(i.account,a.uuid);return await o.posGet()})},390:function(t,e,i){i.d(e,{f:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/remove").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body;return await n.E.delete(i.account,a.uuid),{ok:!0}})},5291:function(t,e,i){i.d(e,{g:function(){return d}});var n=i(4667),a=i(6513),o=i.n(a),s=i(9418),r=i(6504),l=i(5224),u=i(3309);let d=new r.p("books/search").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body,r=await s.E.book(i.account,a.uuid),d=await r.navs(),c=[];for(let[t,e]of r.spines.entries()){let i=e.href,s=await r.file(i);if(!s)continue;let h=s.buffer.toString("utf-8"),p=s.mediaType??n.contentType(o().basename(i));if(p&&["/xml","/html","/xhtml"].some(t=>p.includes(t))){let{doc:e}=await (0,l.rV)(h),i=new u.b(e,d).toReadableParts(),n=d.find(e=>e.spineIndex===t);for(let[e,o]of i.entries()){if("text"!==o.type)continue;let i=function(t,e){let i=[],n=0;for(;-1!==n;)-1!==(n=t.indexOf(e,n))&&(i.push(n),n+=e.length);return i}(o.text,a.search);if(i.length)for(let a of i)c.push({text:o.text,section:t,paragraph:e,start:a,nav:null==n?void 0:n.label})}}}return{search:a.search,matches:c}})},4254:function(t,e,i){i.d(e,{_:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/show").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body;return(await n.E.entity(i.account,a.uuid)).entity})},1142:function(t,e,i){i.d(e,{F:function(){return s}});var n=i(4933),a=i(9418),o=i(107);let s=new(i(6504)).p("books/tmp-store").routeLogined(async t=>{let{userInfo:e}=t,i=await a.E.entity(e.account,o.n1),s={uuid:(0,n.Z)(),name:i.entity.name,type:i.entity.type,langCode:i.entity.langCode,isFavorited:i.entity.isFavorited,isArchived:i.entity.isArchived,createdAt:new Date,updatedAt:new Date,isTmp:!1},r=await i.readFileBuffer(),l=await i.posGet(),u=await i.annotationsGet(),d=await a.E.list(e.account).add(s,r),c=await a.E.entity(e.account,d.uuid);return await c.posSet(l),await c.annotationsUpsert(u),d})},7363:function(t,e,i){i.d(e,{r:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/update").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body;return await n.E.update(i.account,a.uuid,a.update),{ok:!0}})},1636:function(t,e,i){i.d(e,{X:function(){return a}});var n=i(9418);let a=new(i(6504)).p("books/view").routeLogined(async t=>{let{req:e,userInfo:i}=t,a=await e.body,o=await n.E.entity(i.account,a.uuid),s=await n.E.book(i.account,a.uuid);return{item:o.entity,navs:await s.navs(),spines:s.spines}})},6107:function(t,e,i){i.d(e,{t:function(){return n}});let n=new(i(6504)).p("login").route(async t=>{let{req:e}=t,i=e.session,n=await e.body;return{ok:await i.userLogin(n.account,n.password)}})},7497:function(t,e,i){i.d(e,{Z:function(){return n}});let n=new(i(6504)).p("logout").route(async t=>{let{req:e}=t,i=e.session;return await i.userLogout(),{ok:!0}})},6917:function(t,e,i){i.d(e,{O:function(){return n}});let n=new(i(6504)).p("user").route(t=>{let{req:e}=t;return{info:e.session.userInfo()}})},2359:function(t,e,i){i.d(e,{L:function(){return n}});class n{}},9418:function(t,e,i){i.d(e,{E:()=>F});var n,a=i("3062"),o=i("8925"),s=i("107"),r=i("6340"),l=i("6689"),u=i("9237"),d=i("8205"),c=i("2359");class h extends c.L{static async read(t,e){let i=(0,d.WM)(t).map(t=>`<p>${t}</p>`).join("\r\n");return new h(t,i=`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>${e}</title>
    </head>
    <body>
      ${i}
    </body>
    </html>
    `)}async navs(){return[]}async file(){return{buffer:Buffer.from(this.html,"utf8")}}async cover(){}constructor(t,e){super(),(0,a._)(this,"text",void 0),(0,a._)(this,"html",void 0),(0,a._)(this,"spines",void 0),this.text=t,this.html=e,this.spines=[{href:"/main.html",id:"main"}]}}var p=i("7638"),w=i.n(p),f=i("6513"),y=i.n(f),m=i("2333"),g=i.n(m),b=i("4667"),v=i("6092");class k{async download(){let t;let e=await this.readFileBuffer(),i=!1;switch(this.entity.type){case"epub":t=".epub";break;case"text":t=".txt"}let n="Book type unknown";if(!t||!(i=b.contentType(t)))throw new l.xx(n);return{contentType:i,buffer:e,filename:this.entity.name+t}}async reset(){await this.posSet({section:0,paragraph:0}),await this.annotationsDeleteAll()}async posGet(){return(await this.readProp()).position??{section:0,paragraph:0}}async posSet(t){let e=await this.readProp();e.position=t,await this.writeProp(e)}sortAnnotations(t){return(0,v.Xo)(t,"asc",t=>{var e;return[t.pos.section,t.pos.paragraph,(null===(e=t.range)||void 0===e?void 0:e.start)??0]})}async annotationsGet(){return(await this.readProp()).annotations??[]}async annotationsUpsert(t){let e=await this.readProp();for(let i of(e.annotations??(e.annotations=[]),t)){let t=e.annotations.findIndex(t=>t.uuid===i.uuid);-1!==t?e.annotations[t]=i:e.annotations.push(i)}return e.annotations=this.sortAnnotations(e.annotations),await this.writeProp(e),e.annotations}async annotationsDelete(t){let e=await this.readProp();e.annotations&&(e.annotations=e.annotations.filter(e=>!t.includes(e.uuid))),await this.writeProp(e)}async annotationsDeleteAll(){let t=await this.readProp();t.annotations&&(t.annotations=[]),await this.writeProp(t)}sortKeywords(t){return(0,v.Xo)(t,"asc",t=>[t.pos.section,t.pos.paragraph,t.keyword])}async keywordsGet(){return(await this.readProp()).keywords??[]}async keywordsUpsert(t){let e=await this.readProp();for(let i of(e.keywords??(e.keywords=[]),t)){let t=e.keywords.findIndex(t=>t.uuid===i.uuid);-1!==t?e.keywords[t]=i:e.keywords.push(i)}return e.keywords=this.sortKeywords(e.keywords),await this.writeProp(e),e.keywords}async keywordsDelete(t){let e=await this.readProp();e.keywords&&(e.keywords=e.keywords.filter(e=>!t.includes(e.uuid))),await this.writeProp(e)}constructor(t){(0,a._)(this,"entity",void 0),this.entity=t}}class x extends k{static async create(t,e,i){let n=new x(t,e);await n.mkdir(),await n.writeFile(i);let a=await n.readProp();await n.writeProp(a)}async mkdir(){await g().promises.mkdir(this.bookDir,{recursive:!0})}async writeFile(t){await g().promises.writeFile(this.bufferPath,Buffer.from(t))}async readFileBuffer(){return g().promises.readFile(this.bufferPath)}async readFileText(){return g().promises.readFile(this.bufferPath,"utf8")}async delete(){g().existsSync(this.bufferPath)&&await g().promises.rm(this.bufferPath),g().existsSync(this.propJsonPath)&&await g().promises.rm(this.propJsonPath),g().existsSync(this.bookDir)&&0===(await g().promises.readdir(this.bookDir)).length&&await g().promises.rmdir(this.bookDir)}async readProp(){if(!this.propJson){if(g().existsSync(this.propJsonPath)){let t=await g().promises.readFile(this.propJsonPath,"utf8");try{this.propJson=JSON.parse(t)}catch{this.propJson={}}}else this.propJson={}}return this.propJson}async writeProp(t){await g().promises.writeFile(this.propJsonPath,JSON.stringify(t),"utf8")}constructor(t,e){super(e),(0,a._)(this,"allBooksDir",void 0),(0,a._)(this,"bookDir",void 0),(0,a._)(this,"bookBaseNamePath",void 0),(0,a._)(this,"bufferPath",void 0),(0,a._)(this,"propJsonPath",void 0),(0,a._)(this,"propJson",void 0),this.allBooksDir=t;let i=e.uuid.slice(0,2),n=e.uuid.slice(2);this.entity.isTmp?(this.bookDir=y().join(this.allBooksDir,"$"),this.bookBaseNamePath=y().join(this.bookDir,"tmp")):(this.bookDir=y().join(this.allBooksDir,i),this.bookBaseNamePath=y().join(this.bookDir,n)),this.bufferPath=`${this.bookBaseNamePath}.data`,this.propJsonPath=`${this.bookBaseNamePath}.prop.json`}}class P{get tmpUuid(){var t,e;return null===(e=this.json)||void 0===e?void 0:null===(t=e.tmp)||void 0===t?void 0:t.uuid}isTmpUuid(t){var e,i;return(null===(i=this.json)||void 0===i?void 0:null===(e=i.tmp)||void 0===e?void 0:e.uuid)===t}getDefaultJson(){return{version:this.version,list:[]}}async getJson(){return this.json??(this.json=await this.readJson()),this.json}async list(){return(await this.getJson()).list}async listFilter(t){let{archive:e="active",favorite:i="all",search:n,order:a}=t,o=await this.list();if("all"!==e&&(o=o.filter(t=>"archived"===e?t.isArchived:!t.isArchived)),"all"!==i&&(o=o.filter(t=>"favorited"===i?t.isFavorited:!t.isFavorited)),n&&(o=o.filter(t=>t.name.toLowerCase().includes(n.toLowerCase()))),a&&"default"!==a)switch(a){case"reverse":o=[...o].reverse();break;case"name":o=(0,v.Xo)(o,"asc",t=>t.name);break;case"name-reverse":o=(0,v.Xo)(o,"desc",t=>t.name)}return o}async getTmp(){return(await this.getJson()).tmp}async setTmp(t){(await this.getJson()).tmp=t}async write(){await this.writeJson(await this.getJson())}async moveOffset(t,e){if(0===e)return;let i=await this.list(),n=i.findIndex(e=>e.uuid===t);if(-1===n)return;let a=n+e;if(a<0||a>=i.length)return;let[o]=i.splice(n,1);o&&i.splice(a,0,o),await this.write()}async moveAfter(t,e){if(t===e)return;let i=await this.list(),n=i.findIndex(e=>e.uuid===t);if(-1===n)return;let a=i.findIndex(t=>t.uuid===e);if(-1===a)return;let o=a>n?a:a+1;if(o===n||o<0||o>=i.length)return;let[s]=i.splice(n,1);s&&i.splice(o,0,s),await this.write()}async moveTop(t){let e=await this.list(),i=e.findIndex(e=>e.uuid===t);if(-1===i)return;let[n]=e.splice(i,1);n&&e.unshift(n),await this.write()}async page(t){let{page:e=1,perPage:i=this.defaultPerPage}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await this.listFilter(t),a=i*(e-1),o=n.slice(a,a+i).map(t=>this.toEntity(t)),s=n.length;return{page:e,perPage:i,items:o,count:s,pageCount:Math.ceil(s/i)}}async entityJson(t){return(await this.list()).find(e=>e.uuid===t)}toEntity(t){return{name:t.name,type:t.type,langCode:t.langCode,isFavorited:t.isFavorited,isArchived:!!t.isArchived,uuid:t.uuid,createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt),isTmp:t.isTmp}}async update(t,e){let i=(await this.list()).find(e=>e.uuid===t);i&&(e.langCode&&(i.langCode=e.langCode),e.name&&(i.name=e.name),void 0!==e.isFavorited&&(i.isFavorited=e.isFavorited),void 0!==e.isArchived&&(i.isArchived=e.isArchived),await this.write())}async add(t,e){let i={name:t.name,uuid:t.uuid,type:t.type,langCode:t.langCode,isFavorited:t.isFavorited,createdAt:t.createdAt.toISOString(),updatedAt:t.updatedAt.toISOString(),isTmp:t.isTmp};if(t.isTmp){await F.delete(this.account,s.n1);let t=this.entity2bookEntity(i);await t.reset(),await this.setTmp(i)}else(await this.list()).push(i);return await this.write(),await this.bookAdd(t,e),i}async delete(t){let e=await this.list(),i=e.findIndex(e=>e.uuid===t);if(-1===i)return;let n=e[i];n&&await this.bookDelete(n),e.splice(i,1),await this.write()}async book(t){let e=this.isTmpUuid(t)?await this.getTmp():await this.entityJson(t);if(e)return this.entity2bookEntity(e)}constructor(t){(0,a._)(this,"account",void 0),(0,a._)(this,"json",void 0),(0,a._)(this,"version",void 0),(0,a._)(this,"defaultPerPage",void 0),this.account=t,this.version=1,this.defaultPerPage=15}}class D extends P{async readJson(){let t=this.jsonPath;return w().existsSync(t)?JSON.parse(await w().promises.readFile(t,"utf8")):this.getDefaultJson()}async writeJson(t){!w().existsSync(this.accountDir)&&await w().promises.mkdir(this.accountDir,{recursive:!0}),await w().promises.writeFile(this.jsonPath,JSON.stringify(t),"utf8")}entity2bookEntity(t){return new x(this.allBooksDir,this.toEntity(t))}async bookAdd(t,e){await x.create(this.allBooksDir,t,e)}async bookDelete(t){let e=new x(this.allBooksDir,this.toEntity(t));await e.delete()}constructor(t){super(t),(0,a._)(this,"accountDir",void 0),(0,a._)(this,"jsonPath",void 0),(0,a._)(this,"allBooksDir",void 0),this.accountDir=y().join(r.O.dataPath,"users",t),this.allBooksDir=y().join(this.accountDir,"books"),this.jsonPath=y().join(this.accountDir,"books.json")}}var _=i("7958");async function A(){return await (0,_.X3)("auditory-reader",1,{upgrade(t){t.createObjectStore("book-json",{autoIncrement:!1}),t.createObjectStore("book-data",{autoIncrement:!1}),t.createObjectStore("book-properties",{autoIncrement:!1})}})}class C extends k{static async create(t,e){let i=new C(t);await i.writeFile(e);let n=await i.readProp();await i.writeProp(n)}async readFileBuffer(){let t=await A(),e=await t.get("book-data",this.uid);if(!e)throw Error(`book(${this.uid}) data not found`);return e.data}async readFileText(){let t=await this.readFileBuffer();return new TextDecoder("utf-8").decode(t)}async writeFile(t){let e=await A();await e.put("book-data",{data:t},this.uid)}async delete(){let t=await A();await t.delete("book-data",this.uid)}async readProp(){if(!this.propJson){let t=await A();this.propJson=await t.get("book-properties",this.uid)??{}}return this.propJson}async writeProp(t){let e=await A();await e.put("book-properties",t,this.uid)}constructor(t){super(t),(0,a._)(this,"propJson",void 0),(0,a._)(this,"uid",void 0),this.entity.isTmp?this.uid="$tmp":this.uid=t.uuid}}class E extends P{async readJson(){let t=await A(),e=await t.get("book-json","default");if(!e){let e=this.getDefaultJson();return await t.add("book-json",e,"default"),e}return e}async writeJson(t){let e=await A();await e.put("book-json",t,"default")}entity2bookEntity(t){return new C(this.toEntity(t))}async bookAdd(t,e){await C.create(t,e)}async bookDelete(t){let e=new C(this.toEntity(t));await e.delete()}}let T=(t,e)=>{let i=e.name;e.addInitializer(function(){this[i]=function(e,i){for(var n=arguments.length,a=Array(n>2?n-2:0),o=2;o<n;o++)a[o-2]=arguments[o];let r=i===s.n1?F.reqTmpUuid(e):i;return t.call(this,e,r,...a)}})};class L{reqTmpUuid(t){return this.list(t).tmpUuid??s.n1}list(t){let e=this.cacheList.get(t);return!e&&(e="server"===r.O.appMode?new D(t):new E(t),this.cacheList.set(t,e)),e}async delete(t,e){this.cacheEntity.delete(e),this.cacheBook.delete(e),await this.list(t).delete(e)}async entity(t,e){let i=this.cacheEntity.get(e);if(!i){if(!(i=await this.list(t).book(e)))throw new l.xx(`book entity(${e}) not found`);this.cacheEntity.set(e,i)}return i}async update(t,e,i){await this.list(t).update(e,i),this.cacheEntity.delete(e)}async book(t,e){let i=this.cacheBook.get(e);if(!i){let n=await this.entity(t,e);i=await this.parseBook(n),this.cacheBook.set(e,i)}return i}async parseBook(t){switch(t.entity.type){case"epub":{let e=await u.P.read(await t.readFileBuffer());if(!e)throw new l.xx("Parse epub error");return e}case"text":return await h.read(await t.readFileText(),t.entity.name);default:throw new l.xx(`Unsupported type ${t.entity.type}`)}}constructor(){(0,a._)(this,"cacheList",new Map),(0,a._)(this,"cacheEntity",new Map),(0,a._)(this,"cacheBook",new Map),n(this)}}({e:[n]}=(0,o._)(L,[[T,2,"delete"],[T,2,"entity"],[T,2,"update"],[T,2,"book"]],[]));let F=new L},6504:function(t,e,i){i.d(e,{p:function(){return s}});var n=i(3062),a=i(33),o=i(5016);class s{isMatch(t){return this.method===t.method.toLowerCase()&&(this.isDynamic?t.pathname.startsWith(this.fullRoutePath):this.fullRoutePath===t.pathname)}getDynamicPaths(t){if(!this.isDynamic)return[];if(!t.startsWith(this.fullRoutePath))throw Error("getDynamicPaths pathname not match");return t.slice(this.fullRoutePath.length).replace(/^\/*/,"").split("/")}async action(t,e){let i=await fetch(this.fullRoutePath,{method:"POST",headers:{"Content-Type":"application/json"},signal:e,body:t?JSON.stringify(t):null});if(401===i.status)throw new o.A9;if(i.status.toString().startsWith("4")){let t=await i.json();throw(0,a.E8)().error({message:"Error",description:t.message}),new o.Pk(t.message)}if(!i.status.toString().startsWith("2"))throw new o.sN(await i.json());return await i.json()}route(t){return this.handler=t,this}routeLogined(t){return this.route(e=>{let i=e.req.session.userInfo();return i?t({...e,userInfo:i}):(e.res.status(401),{})}),this}constructor(t,{method:e="post",responseType:i="json",isDynamic:a=!1}={}){(0,n._)(this,"routePath",void 0),(0,n._)(this,"fullRoutePath",void 0),(0,n._)(this,"method",void 0),(0,n._)(this,"responseType",void 0),(0,n._)(this,"isDynamic",void 0),(0,n._)(this,"handler",void 0),this.routePath=t,this.fullRoutePath=(0,o.Pq)(t),this.method=e,this.responseType=i,this.isDynamic=a}}},9273:function(t,e,i){i.d(e,{Z:function(){return s}});var n=i(6689),a=i(5224);async function o(t){try{let e=await fetch(t);return await e.text()}catch(e){let t=e instanceof Error?e.message:null==e?void 0:e.toString();throw new n.xx(t)}}async function s(t){let e=await o(t);return(0,a.rV)(e)}},6756:function(t,e,i){i.d(e,{O1:function(){return o}});var n=i(6092);let a=[...(0,n.w6)(0,26).map(t=>t+65),...(0,n.w6)(0,26).map(t=>t+97),...(0,n.w6)(0,10).map(t=>t+48),33,44,46,58,59,63,64,95];function o(t){return(0,n.w6)(0,t).map(()=>(function(){var t;let e=(t=0,Math.floor(Math.random()*(a.length-1-0+1))+t);return String.fromCharCode(a[e])})()).join()}},3309:function(t,e,i){i.d(e,{b:function(){return k}});var n=i(2790),a=i(3747),o=i(1479),s=i(3062),r=i(107),l=i(6092),u=i(5224);function*d(t,e){let i=(0,u.tp)(e),n=t.createTreeWalker(e,i.NodeFilter.SHOW_ALL);for(;;){let t=n.nextNode();if(t)yield t;else break}}function c(t){return(0,u.tp)(t).getComputedStyle(t)}let h=["a","abbr","acronym","b","bdo","big","br","button","cite","code","dfn","em","i","img","input","kbd","label","map","object","output","q","samp","script","select","small","span","strong","sub","sup","textarea","time","tt","var"];function p(t){let e=c(t).getPropertyValue("display");return e?!["inline","inline-block"].includes(e):!h.includes(t.tagName.toLowerCase())}let w=t=>{let e=c(t).getPropertyValue("vertical-align");return e&&["top","bottom"].includes(e)},f=["rt","noscript"];var y=new WeakMap,m=new WeakMap,g=new WeakMap,b=new WeakMap,v=new WeakMap;class k{walk(){for(let e of d(this.doc,this.doc.body)){var t;if((0,u.kK)(e)){if(e.id&&this.addAnchor(e.id,(0,n._)(this,v).has(e.id)),"ruby"===e.tagName.toLowerCase()&&this.addRuby(e),!function(t){let e=c(t);[e.getPropertyValue("page-break-before"),e.getPropertyValue("break-before")].some(t=>"always"===t)&&(t.style.breakBefore="column"),[e.getPropertyValue("page-break-after"),e.getPropertyValue("break-after")].some(t=>"always"===t)&&(t.style.breakAfter="column")}(e),(0,u.pC)(e)){this.addImage(e);continue}let t=e.tagName.toLowerCase();if(f.includes(t)||w(e)||!(!e.checkVisibility||e.checkVisibility({contentVisibilityAuto:!0,checkOpacity:!0,visibilityProperty:!0}))){e.classList.add(r.Xp);continue}}if(!!(0,u.BM)(e))(null===(t=e.textContent)||void 0===t?void 0:t.trim())&&this.addText(e)}}popAccAnchors(){let t=(0,n._)(this,m),e=(0,n._)(this,g);return(0,o._)(this,m,void 0),(0,o._)(this,g,void 0),{anchors:t,navAnchors:e}}addAnchor(t,e){(0,o._)(this,m,(0,n._)(this,m)??[]),(0,n._)(this,m).push(t),e&&((0,o._)(this,g,(0,n._)(this,g)??[]),(0,n._)(this,g).push(t))}addRuby(t){let e="",i="";for(let n of d(this.doc,t)){var a;(0,u.kK)(n)&&"rt"===n.tagName.toLowerCase()?i+=n.textContent:(0,u.BM)(n)&&!(null===(a=n.parentElement)||void 0===a?void 0:a.closest("rt"))&&(e+=n.textContent)}e&&i&&(t.dataset.isAlias="1",(0,n._)(this,b).push({source:e,target:i}))}addImage(t){let{anchors:e,navAnchors:i}=this.popAccAnchors();(0,n._)(this,y).push({type:"image",elem:t,anchors:e,navAnchors:i})}addText(t){let{anchors:e,navAnchors:i}=this.popAccAnchors();(0,n._)(this,y).push({type:"text",elem:t,anchors:e,navAnchors:i})}getContentText(t){let e="";for(let i of d(t.ownerDocument,t)){if(!!(0,u.BM)(i)&&!!i.parentElement)!i.parentElement.closest(`.${r.Xp}`)&&(e+=i.textContent)}return e}toReadableParts(){let t=new Map,e=(e,n,a)=>{e.classList.add(r.b6);let o=this.getContentText(e);if(o.trim()){let s={elem:e,type:"text",text:o,anchorIds:n,navAnchorIds:a};t.set(e,s),i.push(s)}else t.set(e,null)},i=[];for(let{type:a,elem:o,anchors:s,navAnchors:l}of(0,n._)(this,y))switch(a){case"image":o.classList.add(r.b6),i.push({elem:o,type:"image",anchorIds:s,navAnchorIds:l});break;case"text":{let i=function t(e){if(e){if(p(e))return e;else if(e.parentElement)return t(e.parentElement)}}(o.parentElement);if(!i||i.classList.contains(r.Xp))continue;let n=t.get(i);if(n){s&&(n.anchorIds??(n.anchorIds=[]),n.anchorIds.push(...s)),l&&(n.navAnchorIds??(n.navAnchorIds=[]),n.navAnchorIds.push(...l));continue}if(function t(e){if(void 0!==e.dataset.isAllInlineChild)return"1"===e.dataset.isAllInlineChild;for(let i of e.childNodes)if((0,u.kK)(i)&&!i.classList.contains(r.Xp)&&(p(i)||!t(i)))return e.dataset.isAllInlineChild="0",!1;return e.dataset.isAllInlineChild="1",!0}(i)&&i!==this.doc.body)e(i,s,l);else{if(!o.parentElement)continue;let t=this.doc.createElement("span");o.after(t),t.appendChild(o),e(t,s,l)}}}return i}alias(){return(0,l.Xo)((0,n._)(this,b),"desc",t=>t.source.length)}constructor(t,e){(0,s._)(this,"doc",void 0),(0,s._)(this,"flattenedNavs",void 0),(0,a._)(this,y,{writable:!0,value:void 0}),(0,a._)(this,m,{writable:!0,value:void 0}),(0,a._)(this,g,{writable:!0,value:void 0}),(0,a._)(this,b,{writable:!0,value:void 0}),(0,a._)(this,v,{writable:!0,value:void 0}),this.doc=t,this.flattenedNavs=e,(0,o._)(this,y,[]),(0,o._)(this,b,[]),(0,o._)(this,v,new Set((0,l.oA)(this.flattenedNavs.map(t=>t.hrefAnchor)))),this.walk()}}},891:function(t,e,i){i.d(e,{H:function(){return h}});var n=i(3062),a=i(7516),o=i.n(a),s=i(43),r=i(4210),l=i.n(r),u=i(9835),d=i(6092),c=i(5224);globalThis.Blob=u.jU?Blob:o().Blob,l().support.blob=!0;class h{async htmlToDOM(t){return(await (0,c.rV)(t)).doc}async xmlToDOM(t){return new p(await function(t){return new Promise((e,i)=>{let n,a;let o=[],r=new s._b({ontext(t){var e;a&&((e=a).children??(e.children=[]),a.children.push(t))},onopentag(t,e){let i={name:t,attributes:e,children:void 0};if(a){var s;(s=a).children??(s.children=[]),a.children.push(i)}else n=i;o.push(i),a=i},onclosetag(){o.pop(),a=o[o.length-1]},onend(){e(n)},onerror(t){i(t)}},{xmlMode:!0});r.write(t),r.end()})}(t))}getFinalPath(t){return t.startsWith("/")?t.slice(1):t}async file(t){let e=this.zip.file(this.getFinalPath(t));if(e)return await e.async("blob")}async content(t){let e=this.zip.file(this.getFinalPath(t));if(e)return await e.async("string")}async htmlDom(t){let e=await this.content(t);if(!!e)return await this.htmlToDOM(e)}async xmlDom(t){let e=await this.content(t);if(!!e)return await this.xmlToDOM(e)}constructor(t){(0,n._)(this,"zip",void 0),this.zip=t}}class p{static getDescendantsText(t){if("string"==typeof t)return t;if(!t.children)return;let e="";for(let i of t.children)e+=this.getDescendantsText(i);return e}get tagName(){return this.node.name}getAttribute(t){return this.node.attributes[t]}text(){return p.getDescendantsText(this.node)}children(){var t;return(0,d.oA)((null===(t=this.node.children)||void 0===t?void 0:t.map(t=>"object"==typeof t?new p(t):void 0))??[])}childrenFilter(t){return this.children().filter(e=>e.tagName===t)}findChild(t){return this.children().find(e=>e.tagName===t)}findDescendants(t){let e=[];for(let i of this.children())i.tagName===t&&e.push(i),e.push(...i.findDescendants(t));return e}findDescendant(t){for(let e of this.children()){if(e.tagName===t)return e;let i=e.findDescendant(t);if(i)return i}}constructor(t){(0,n._)(this,"node",void 0),this.node=t}}},2333:function(){},7638:function(){},9296:function(){},7516:function(){}}]);